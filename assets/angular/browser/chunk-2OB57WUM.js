import{a as y}from"./chunk-4XK4N5WV.js";import{a as _e}from"./chunk-44R4R5AU.js";import{b as me}from"./chunk-IOZ5TDSV.js";import"./chunk-N4MEOVMH.js";import{e as le,h as W,k as Z}from"./chunk-LEW5N4EV.js";import"./chunk-OXGEW5OA.js";import{b as de,c as w,f as D,k as R,m as ce,r as B,s as G,t as z}from"./chunk-TKGN7DBU.js";import"./chunk-JISGPZ2J.js";import{Aa as ee,Cc as oe,Ea as o,Ec as M,Fc as A,Lb as a,Ma as x,Mb as u,Nb as S,Nc as re,Ob as ne,Pb as O,Ra as E,Sa as Q,Sb as f,Tb as _,Ub as h,Wa as p,Yb as se,Zb as ae,_ as V,ab as te,ga as v,ha as b,ib as d,jb as i,kb as t,lb as ie,sb as T,vb as g,xb as m}from"./chunk-SGF3PIFW.js";import{f as fe,m as F}from"./chunk-GG76335P.js";var Se=r=>["/asistenciasestudiantes/sesion",r];function ve(r,s){if(r&1&&(i(0,"option",12),a(1),t()),r&2){let e=s.$implicit;d("ngValue",e.id),o(),u(e.nombre||e.Nombre||"Aula #"+e.id)}}function be(r,s){if(r&1&&(i(0,"div",30),a(1),t()),r&2){let e=m();o(),u(e.errorMsg)}}function xe(r,s){r&1&&(i(0,"div",31),a(1,"Cargando..."),t())}function Ee(r,s){if(r&1&&(i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6),t(),i(7,"td"),a(8),t(),i(9,"td"),a(10),t(),i(11,"td",34)(12,"a",37),a(13,"Abrir"),t()()()),r&2){let e=s.$implicit;o(2),u(e.id),o(2),u(e.aulas_virtuales_id),o(2),u(e.fecha),o(2),u(e.hora_ingreso),o(2),u(e.estado),o(2),d("routerLink",ae(6,Se,e.id))}}function Ae(r,s){r&1&&(i(0,"tr")(1,"td",38),a(2,"Sin sesiones para la fecha."),t()())}function ye(r,s){if(r&1&&(i(0,"div",32)(1,"table",33)(2,"thead")(3,"tr")(4,"th"),a(5,"ID"),t(),i(6,"th"),a(7,"Aula"),t(),i(8,"th"),a(9,"Fecha"),t(),i(10,"th"),a(11,"Hora ingreso"),t(),i(12,"th"),a(13,"Estado"),t(),i(14,"th",34),a(15,"Acci\xF3n"),t()()(),i(16,"tbody"),p(17,Ee,14,8,"tr",35)(18,Ae,3,0,"tr",36),t()()()),r&2){let e=m();o(17),d("ngForOf",e.sesiones),o(),d("ngIf",e.sesiones.length===0)}}var L=class L{constructor(s){this.api=s;this.isLoading=!1;this.errorMsg=null;this.fecha=new Date().toISOString().slice(0,10);this.aulas=[];this.sesiones=[];this.form={instituciones_id:null,aulas_virtuales_id:null,tiempo_espera_minutos:10,gps_requerido:!0,radio_metros:150}}ngOnInit(){this.cargarAulas(),this.cargarSesiones()}cargarAulas(){this.api.getAulasDisponibles().subscribe({next:s=>{if(this.aulas=s?.aulas||s?.data||[],this.aulas.length===1){let e=this.aulas[0];this.form.aulas_virtuales_id=e?.id??null,this.form.instituciones_id=e?.instituciones_id??this.form.instituciones_id}},error:()=>{this.aulas=[]}})}cargarSesiones(){this.isLoading=!0,this.errorMsg=null,this.api.listSesiones(this.fecha).subscribe({next:s=>{this.sesiones=s?.sesiones||[],this.isLoading=!1},error:()=>{this.errorMsg="No se pudieron cargar las sesiones.",this.isLoading=!1}})}onChangeAula(){let s=this.aulas.find(e=>e?.id===this.form.aulas_virtuales_id);s?.instituciones_id&&(this.form.instituciones_id=s.instituciones_id)}crearSesion(){if(this.errorMsg=null,!this.form.instituciones_id||!this.form.aulas_virtuales_id){this.errorMsg="Seleccione instituci\xF3n y aula.";return}this.isLoading=!0,this.api.crearSesion({instituciones_id:this.form.instituciones_id,aulas_virtuales_id:this.form.aulas_virtuales_id,fecha:this.fecha,tiempo_espera_minutos:this.form.tiempo_espera_minutos,gps_requerido:this.form.gps_requerido,radio_metros:this.form.radio_metros}).subscribe({next:()=>{this.cargarSesiones()},error:s=>{this.errorMsg=s?.error?.message||"No se pudo crear la sesi\xF3n.",this.isLoading=!1}})}};L.\u0275fac=function(e){return new(e||L)(x(y))},L.\u0275cmp=E({type:L,selectors:[["app-asistencia-sesiones"]],standalone:!1,decls:51,vars:13,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"row","g-2","align-items-end"],[1,"col-12","col-md-3"],[1,"form-label"],["type","date",1,"form-control",3,"ngModelChange","change","ngModel"],[1,"form-select",3,"ngModelChange","change","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"col-12","col-md-2"],["type","number","placeholder","ID",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-6","col-md-2"],["type","number",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-4","mt-2"],[1,"form-check"],["type","checkbox","id","gpsReq",1,"form-check-input",3,"ngModelChange","ngModel"],["for","gpsReq",1,"form-check-label"],[1,"col-12","col-md-8","mt-2","d-flex","justify-content-end"],[1,"btn","btn-primary",3,"click","disabled"],["class","alert alert-warning mt-3",4,"ngIf"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["class","text-center my-3",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"alert","alert-warning","mt-3"],[1,"text-center","my-3"],[1,"table-responsive"],[1,"table","table-sm","table-striped","align-middle","mt-2"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"btn","btn-sm","btn-outline-primary",3,"routerLink"],["colspan","6",1,"text-center","text-muted"]],template:function(e,n){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),a(4,"Sesiones de asistencia"),t(),i(5,"p",4),a(6,"Crear y gestionar la asistencia del d\xEDa"),t()()(),i(7,"div",5)(8,"div",6)(9,"div",7)(10,"div",8)(11,"label",9),a(12,"Fecha"),t(),i(13,"input",10),h("ngModelChange",function(l){return _(n.fecha,l)||(n.fecha=l),l}),g("change",function(){return n.cargarSesiones()}),t()(),i(14,"div",8)(15,"label",9),a(16,"Aula"),t(),i(17,"select",11),h("ngModelChange",function(l){return _(n.form.aulas_virtuales_id,l)||(n.form.aulas_virtuales_id=l),l}),g("change",function(){return n.onChangeAula()}),i(18,"option",12),a(19,"Seleccione"),t(),p(20,ve,2,2,"option",13),t()(),i(21,"div",14)(22,"label",9),a(23,"Instituci\xF3n"),t(),i(24,"input",15),h("ngModelChange",function(l){return _(n.form.instituciones_id,l)||(n.form.instituciones_id=l),l}),t()(),i(25,"div",16)(26,"label",9),a(27,"PRESENTE (min)"),t(),i(28,"input",17),h("ngModelChange",function(l){return _(n.form.tiempo_espera_minutos,l)||(n.form.tiempo_espera_minutos=l),l}),t()(),i(29,"div",16)(30,"label",9),a(31,"Radio (m)"),t(),i(32,"input",17),h("ngModelChange",function(l){return _(n.form.radio_metros,l)||(n.form.radio_metros=l),l}),t()(),i(33,"div",18)(34,"div",19)(35,"input",20),h("ngModelChange",function(l){return _(n.form.gps_requerido,l)||(n.form.gps_requerido=l),l}),t(),i(36,"label",21),a(37,"GPS requerido"),t()()(),i(38,"div",22)(39,"button",23),g("click",function(){return n.crearSesion()}),a(40,"Crear sesi\xF3n"),t()()(),p(41,be,2,1,"div",24),t()(),i(42,"div",5)(43,"div",6)(44,"div",25)(45,"h2",26),a(46,"Sesiones"),t(),i(47,"button",27),g("click",function(){return n.cargarSesiones()}),a(48," Actualizar "),t()(),p(49,xe,2,0,"div",28)(50,ye,19,2,"div",29),t()()()),e&2&&(o(13),f("ngModel",n.fecha),o(4),f("ngModel",n.form.aulas_virtuales_id),o(),d("ngValue",null),o(2),d("ngForOf",n.aulas),o(4),f("ngModel",n.form.instituciones_id),o(4),f("ngModel",n.form.tiempo_espera_minutos),o(4),f("ngModel",n.form.radio_metros),o(3),f("ngModel",n.form.gps_requerido),o(4),d("disabled",n.isLoading),o(2),d("ngIf",n.errorMsg),o(6),d("disabled",n.isLoading),o(2),d("ngIf",n.isLoading),o(),d("ngIf",!n.isLoading))},dependencies:[M,A,G,z,w,ce,de,B,D,R,W],encapsulation:2});var U=L;var ue=fe(_e());var Ce=()=>["/asistenciasestudiantes/sesiones"];function Ie(r,s){if(r&1&&(i(0,"div",28),a(1),t()),r&2){let e=m();o(),O("Aula: ",e.sesion.aulas_virtuales_id," \xB7 Fecha: ",e.sesion.fecha," \xB7 Estado: ",e.sesion.estado)}}function Te(r,s){if(r&1&&(i(0,"div",29),a(1),t()),r&2){let e=m();o(),O(" Materia: ",(e.materia==null?null:e.materia.sigla_materia)||""," ",(e.materia==null?null:e.materia.nombre_materia)||""," \xB7 Modo: ",e.modoAsistencia()," ")}}function Me(r,s){if(r&1&&(i(0,"div",30),a(1),t()),r&2){let e=m();o(),u(e.errorMsg)}}function we(r,s){r&1&&(i(0,"div",28),a(1,"Sesi\xF3n cerrada: no se genera QR."),t())}function De(r,s){if(r&1&&ie(0,"img",44),r&2){let e=m(3);d("src",e.qrDataUrl,ee)}}function Re(r,s){if(r&1){let e=T();i(0,"div",35),p(1,De,1,1,"img",36),i(2,"div",37),a(3),t(),i(4,"div",38)(5,"span",28),a(6,"Estado QR:"),t(),i(7,"span",39),a(8),t(),i(9,"span",28),a(10," \xB7 Restante:"),t(),i(11,"span",39),a(12),t()(),i(13,"div",40)(14,"button",41),g("click",function(){v(e);let c=m(2);return b(c.iniciarQr())}),a(15,"Iniciar"),t(),i(16,"button",42),g("click",function(){v(e);let c=m(2);return b(c.detenerQr())}),a(17,"Detener"),t(),i(18,"button",43),g("click",function(){v(e);let c=m(2);return b(c.refrescarQr())}),a(19,"Actualizar"),t()()()}if(r&2){let e=m(2);o(),d("ngIf",e.qrDataUrl),o(2),S("Expira: ",e.qrExpiresAt||"-"),o(5),u(e.qrStatusTexto),o(4),u(e.restanteTexto),o(2),d("disabled",(e.sesion==null?null:e.sesion.estado)!=="ABIERTA"||e.qrDetenido()),o(2),d("disabled",(e.sesion==null?null:e.sesion.estado)!=="ABIERTA"||!e.qrIniciado()||e.qrDetenido()),o(2),d("disabled",(e.sesion==null?null:e.sesion.estado)!=="ABIERTA"||!e.qrIniciado()||e.qrDetenido())}}function Le(r,s){if(r&1&&(i(0,"div",31)(1,"div",12)(2,"div",13)(3,"h2",32),a(4,"QR rotativo"),t(),p(5,we,2,0,"div",3)(6,Re,20,7,"div",33),i(7,"div",34),a(8),t()()()()),r&2){let e=m();o(5),d("ngIf",(e.sesion==null?null:e.sesion.estado)!=="ABIERTA"),o(),d("ngIf",(e.sesion==null?null:e.sesion.estado)==="ABIERTA"),o(2),S(" Reglas: PRESENTE dentro de ",(e.sesion==null?null:e.sesion.tiempo_espera_minutos)||10," min; luego ATRASO; a los 30 min ya no registra. ")}}function ke(r,s){r&1&&(i(0,"span",17),a(1,"OK"),t())}function Pe(r,s){r&1&&(i(0,"span",45),a(1,"-"),t())}function Ne(r,s){if(r&1&&(i(0,"tr")(1,"td"),a(2),t(),i(3,"td")(4,"span",45),a(5),t(),i(6,"span",46),a(7),t()(),i(8,"td"),a(9),t(),i(10,"td"),a(11),t(),i(12,"td"),p(13,ke,2,0,"span",47)(14,Pe,2,0,"span",48),t()()),r&2){let e=s.$implicit,n=m();o(2),u(e.infoestudiantesifas_id),o(3),u(n.codigoEstado(e.estado_asistencia)),o(2),u(e.estado_asistencia),o(2),u(e.metodo),o(2),u(e.fecha_registro),o(2),d("ngIf",e.gps_valido),o(),d("ngIf",!e.gps_valido)}}function Fe(r,s){r&1&&(i(0,"tr")(1,"td",49),a(2,"Sin registros a\xFAn."),t()())}function Oe(r,s){r&1&&(i(0,"div",50),a(1," Registro virtual activo: usa P/A/F. Las licencias (L) solo las registra secretar\xEDa. "),t())}function qe(r,s){r&1&&(i(0,"div",51),a(1," Registro virtual deshabilitado en este modo. Si corresponde, usa QR. "),t())}function Ve(r,s){r&1&&(i(0,"th"),a(1,"Marcar"),t())}function Qe(r,s){r&1&&(i(0,"span",17),a(1,"P"),t())}function We(r,s){r&1&&(i(0,"span",18),a(1,"A"),t())}function Be(r,s){r&1&&(i(0,"span",19),a(1,"F"),t())}function Ge(r,s){r&1&&(i(0,"span",20),a(1,"L"),t())}function ze(r,s){r&1&&(i(0,"span",45),a(1,"SIN REGISTRO"),t())}function Ue(r,s){r&1&&(i(0,"span",46),a(1,"LICENCIA"),t())}function je(r,s){if(r&1){let e=T();i(0,"td")(1,"div",55)(2,"button",56),g("click",function(){v(e);let c=m().$implicit,l=m();return b(l.marcar(c,"P"))}),a(3,"P"),t(),i(4,"button",57),g("click",function(){v(e);let c=m().$implicit,l=m();return b(l.marcar(c,"A"))}),a(5,"A"),t(),i(6,"button",58),g("click",function(){v(e);let c=m().$implicit,l=m();return b(l.marcar(c,"F"))}),a(7,"F"),t()(),p(8,Ue,2,0,"span",59),t()}if(r&2){let e=m().$implicit,n=m();o(2),d("disabled",!n.puedeMarcarEstudiante(e)||n.marcandoInfoId===e.infoestudiantesifas_id),o(2),d("disabled",!n.puedeMarcarEstudiante(e)||n.marcandoInfoId===e.infoestudiantesifas_id),o(2),d("disabled",!n.puedeMarcarEstudiante(e)||n.marcandoInfoId===e.infoestudiantesifas_id),o(2),d("ngIf",e.tiene_permiso)}}function He(r,s){if(r&1&&(i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),p(6,Qe,2,0,"span",47)(7,We,2,0,"span",52)(8,Be,2,0,"span",53)(9,Ge,2,0,"span",54)(10,ze,2,0,"span",48),t(),p(11,je,9,4,"td",24),i(12,"td"),a(13),t(),i(14,"td"),a(15),t()()),r&2){let e=s.$implicit,n=m();o(2),u(e.nombre_completo),o(2),u(e.infoestudiantesifas_id),o(2),d("ngIf",n.estadoVisible(e)==="PRESENTE"),o(),d("ngIf",n.estadoVisible(e)==="ATRASO"),o(),d("ngIf",n.estadoVisible(e)==="FALTA"),o(),d("ngIf",n.estadoVisible(e)==="PERMISO"),o(),d("ngIf",n.estadoVisible(e)==="SIN REGISTRO"),o(),d("ngIf",(n.sesion==null?null:n.sesion.estado)==="ABIERTA"&&n.permiteRegistroVirtual()),o(2),u(e.metodo||"-"),o(2),u(e.fecha_registro||"-")}}function Je(r,s){if(r&1&&(i(0,"tr")(1,"td",60),a(2,"Sin estudiantes o no se pudo cargar."),t()()),r&2){let e=m();o(),te("colspan",(e.sesion==null?null:e.sesion.estado)==="ABIERTA"&&e.permiteRegistroVirtual()?6:5)}}var k=class k{constructor(s,e){this.route=s;this.api=e;this.sesion=null;this.materia=null;this.registros=[];this.estudiantes=[];this.isLoading=!1;this.errorMsg=null;this.qrDataUrl=null;this.qrToken=null;this.qrExpiresAt=null;this.marcandoInfoId=null;this.timer=null;this.countdownTimer=null;this.restanteTexto="-";this.qrStatusTexto="NO INICIADO";this.idSesion=Number(this.route.snapshot.paramMap.get("id"))}ngOnInit(){this.cargar()}ngOnDestroy(){this.detenerQrLocal()}cargar(){this.isLoading=!0,this.errorMsg=null,this.api.getSesion(this.idSesion).subscribe({next:s=>{this.sesion=s?.sesion||null,this.materia=s?.materia||null,this.isLoading=!1,this.cargarRegistros(),this.cargarEstudiantes(),this.actualizarEstadoQrUI(),this.sesion?.estado==="ABIERTA"&&this.permiteQr()&&this.qrIniciado()&&!this.qrDetenido()&&this.iniciarQr()},error:()=>{this.errorMsg="No se pudo cargar la sesi\xF3n.",this.isLoading=!1}})}parseDateTime(s){if(!s)return null;let e=s.toString().trim();if(!e)return null;let n=e.includes("T")?e:e.replace(" ","T"),c=new Date(n);return Number.isNaN(c.getTime())?null:c}formatMMSS(s){let e=Math.max(0,Math.floor(s)),n=Math.floor(e/60).toString().padStart(2,"0"),c=Math.floor(e%60).toString().padStart(2,"0");return`${n}:${c}`}normModo(s){let e=(s??"").toString().trim();return!e||e.toLowerCase()==="null"||e.toLowerCase()==="undefined"?"NORMAL":e.toUpperCase()}modoAsistencia(){return this.normModo(this.materia?.materia_modo_asistencia)}permiteQr(){return this.modoAsistencia().includes("QR")}permiteRegistroVirtual(){let s=this.modoAsistencia();return s.includes("REGISTRO VIRTUAL")&&s!=="POR QR (ESTRICTO)"}qrIniciado(){return!!this.sesion?.qr_iniciado_at}qrDetenido(){return!!this.sesion?.qr_detenido_at}actualizarEstadoQrUI(){if(!this.sesion||!this.permiteQr()){this.qrStatusTexto="-",this.restanteTexto="-";return}if(this.sesion.estado!=="ABIERTA"){this.qrStatusTexto="CERRADA",this.restanteTexto="-";return}if(!this.qrIniciado()){this.qrStatusTexto="NO INICIADO",this.restanteTexto="-";return}if(this.qrDetenido()){this.qrStatusTexto="DETENIDO",this.restanteTexto="-";return}this.qrStatusTexto="EN CURSO",this.actualizarCountdown()}iniciarCountdown(){this.countdownTimer||(this.actualizarCountdown(),this.countdownTimer=setInterval(()=>this.actualizarCountdown(),1e3))}actualizarCountdown(){if(!this.sesion){this.restanteTexto="-";return}if(this.sesion.estado!=="ABIERTA"||!this.qrIniciado()||this.qrDetenido()){this.restanteTexto="-";return}let s=this.parseDateTime(this.sesion.hora_ingreso);if(!s){this.restanteTexto="-";return}let e=Number(this.sesion.minutos_falta??30),n=new Date(s.getTime()+e*60*1e3),c=Math.floor((n.getTime()-Date.now())/1e3);if(c<=0){this.restanteTexto="00:00",this.detenerQrLocal(),this.qrStatusTexto="VENCIDO";return}this.restanteTexto=this.formatMMSS(c)}codigoEstado(s){let e=this.normModo(s);return e==="PRESENTE"?"P":e==="ATRASO"?"A":e==="FALTA"?"F":e==="PERMISO"?"L":"-"}cargarRegistros(){this.api.listRegistros(this.idSesion).subscribe({next:s=>{this.registros=s?.registros||[]},error:()=>{this.registros=[]}})}cargarEstudiantes(){this.api.listEstudiantesSesion(this.idSesion).subscribe({next:s=>{this.estudiantes=s?.estudiantes||[]},error:()=>{this.estudiantes=[]}})}refrescarQr(){return F(this,null,function*(){this.errorMsg=null,this.api.generarQr(this.idSesion,5).subscribe({next:s=>F(this,null,function*(){let e=s?.qr?.token,n=s?.qr?.expires_at;e&&(s?.sesion&&(this.sesion=s.sesion,this.actualizarEstadoQrUI()),this.qrToken=e,this.qrExpiresAt=n,this.qrDataUrl=yield ue.toDataURL(e,{margin:1,width:240}))}),error:s=>{this.errorMsg=s?.error?.message||"No se pudo generar el QR.",this.detenerQrLocal()}})})}iniciarQr(){if(this.sesion&&this.sesion.estado==="ABIERTA"&&this.permiteQr()){if(this.qrDetenido()){this.errorMsg="El QR fue detenido y no se puede reiniciar.";return}this.timer||(this.refrescarQr(),this.timer=setInterval(()=>this.refrescarQr(),5e3),this.iniciarCountdown(),this.actualizarEstadoQrUI())}}detenerQrLocal(){this.timer&&(clearInterval(this.timer),this.timer=null),this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null)}detenerQr(){if(this.sesion&&this.sesion.estado==="ABIERTA"){if(!this.qrIniciado()){this.errorMsg="El QR a\xFAn no fue iniciado.";return}this.qrDetenido()||(this.errorMsg=null,this.api.detenerQr(this.idSesion).subscribe({next:s=>{s?.sesion&&(this.sesion=s.sesion),this.detenerQrLocal(),this.actualizarEstadoQrUI(),this.cargar()},error:s=>{this.errorMsg=s?.error?.message||"No se pudo detener el QR."}}))}}cerrarSesion(){this.errorMsg=null,this.api.cerrarSesion(this.idSesion).subscribe({next:()=>{this.detenerQrLocal(),this.cargar()},error:s=>{this.errorMsg=s?.error?.message||"No se pudo cerrar la sesi\xF3n."}})}contar(s){return this.registros.filter(e=>e.estado_asistencia===s).length}estadoVisible(s){return s.estado_asistencia?s.estado_asistencia:s.tiene_permiso?"PERMISO":"SIN REGISTRO"}puedeMarcarEstudiante(s){return!(!this.sesion||this.sesion.estado!=="ABIERTA"||!this.permiteRegistroVirtual()||s.tiene_permiso)}marcar(s,e){if(!this.sesion||!this.puedeMarcarEstudiante(s))return;let n=Number(s.infoestudiantesifas_id);!n||Number.isNaN(n)||(this.marcandoInfoId=n,this.api.marcar(this.idSesion,{infoestudiantesifas_id:n,estado_asistencia:e}).subscribe({next:c=>{let l=c?.registro?.estado_asistencia;s.estado_asistencia=l||s.estado_asistencia,s.metodo=c?.registro?.metodo||"MANUAL",s.fecha_registro=c?.registro?.fecha_registro||s.fecha_registro,this.marcandoInfoId=null,this.cargarRegistros()},error:c=>{this.errorMsg=c?.error?.message||"No se pudo marcar.",this.marcandoInfoId=null}}))}};k.\u0275fac=function(e){return new(e||k)(x(le),x(y))},k.\u0275cmp=E({type:k,selectors:[["app-asistencia-sesion-detalle"]],standalone:!1,decls:76,vars:20,consts:[[1,"container","mt-4"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h4","fw-bold","titulosGlobales","mb-1"],["class","text-muted",4,"ngIf"],["class","small text-muted",4,"ngIf"],[1,"d-flex","gap-2"],[1,"btn","btn-outline-secondary",3,"routerLink"],[1,"btn","btn-danger",3,"click","disabled"],["class","alert alert-warning mt-3",4,"ngIf"],[1,"row","mt-3","g-3"],["class","col-12 col-lg-4",4,"ngIf"],[1,"col-12",3,"ngClass"],[1,"card"],[1,"card-body"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"mt-2","d-flex","gap-2","flex-wrap"],[1,"badge","text-bg-success"],[1,"badge","text-bg-warning"],[1,"badge","text-bg-danger"],[1,"badge","text-bg-info"],[1,"table-responsive","mt-2"],[1,"table","table-sm","table-striped","align-middle"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"card","mt-3"],["class","alert alert-info mt-3",4,"ngIf"],["class","alert alert-secondary mt-3",4,"ngIf"],[1,"text-muted"],[1,"small","text-muted"],[1,"alert","alert-warning","mt-3"],[1,"col-12","col-lg-4"],[1,"h6"],["class","text-center",4,"ngIf"],[1,"alert","alert-info","mt-3","mb-0"],[1,"text-center"],["alt","QR","class","img-fluid","style","max-width: 240px",3,"src",4,"ngIf"],[1,"mt-2","small","text-muted"],[1,"mt-1","small"],[1,"fw-semibold"],[1,"mt-2","d-flex","justify-content-center","gap-2"],[1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],[1,"btn","btn-sm","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-sm","btn-primary",3,"click","disabled"],["alt","QR",1,"img-fluid",2,"max-width","240px",3,"src"],[1,"badge","text-bg-secondary"],[1,"small","text-muted","ms-2"],["class","badge text-bg-success",4,"ngIf"],["class","badge text-bg-secondary",4,"ngIf"],["colspan","5",1,"text-center","text-muted"],[1,"alert","alert-info","mt-3"],[1,"alert","alert-secondary","mt-3"],["class","badge text-bg-warning",4,"ngIf"],["class","badge text-bg-danger",4,"ngIf"],["class","badge text-bg-info",4,"ngIf"],["role","group","aria-label","Marcar asistencia",1,"btn-group","btn-group-sm"],[1,"btn","btn-outline-success",3,"click","disabled"],[1,"btn","btn-outline-warning",3,"click","disabled"],[1,"btn","btn-outline-danger",3,"click","disabled"],["class","small text-muted ms-2",4,"ngIf"],[1,"text-center","text-muted"]],template:function(e,n){e&1&&(i(0,"div",0)(1,"div",1)(2,"div")(3,"h1",2),a(4),t(),p(5,Ie,2,3,"div",3)(6,Te,2,3,"div",4),t(),i(7,"div",5)(8,"a",6),a(9,"Volver"),t(),i(10,"button",7),g("click",function(){return n.cerrarSesion()}),a(11,"Cerrar"),t()()(),p(12,Me,2,1,"div",8),i(13,"div",9),p(14,Le,9,3,"div",10),i(15,"div",11)(16,"div",12)(17,"div",13)(18,"div",1)(19,"h2",14),a(20,"Registros"),t(),i(21,"button",15),g("click",function(){return n.cargarRegistros()}),a(22,"Actualizar"),t()(),i(23,"div",16)(24,"span",17),a(25),t(),i(26,"span",18),a(27),t(),i(28,"span",19),a(29),t(),i(30,"span",20),a(31),t()(),i(32,"div",21)(33,"table",22)(34,"thead")(35,"tr")(36,"th"),a(37,"Estudiante"),t(),i(38,"th"),a(39,"Estado"),t(),i(40,"th"),a(41,"M\xE9todo"),t(),i(42,"th"),a(43,"Fecha"),t(),i(44,"th"),a(45,"GPS"),t()()(),i(46,"tbody"),p(47,Ne,15,7,"tr",23)(48,Fe,3,0,"tr",24),t()()()()(),i(49,"div",25)(50,"div",13)(51,"div",1)(52,"h2",14),a(53,"Lista de estudiantes"),t(),i(54,"button",15),g("click",function(){return n.cargarEstudiantes()}),a(55,"Actualizar"),t()(),p(56,Oe,2,0,"div",26)(57,qe,2,0,"div",27),i(58,"div",21)(59,"table",22)(60,"thead")(61,"tr")(62,"th"),a(63,"Estudiante"),t(),i(64,"th"),a(65,"ID (info)"),t(),i(66,"th"),a(67,"Estado"),t(),p(68,Ve,2,0,"th",24),i(69,"th"),a(70,"M\xE9todo"),t(),i(71,"th"),a(72,"Fecha"),t()()(),i(73,"tbody"),p(74,He,16,10,"tr",23)(75,Je,3,1,"tr",24),t()()()()()()()()),e&2&&(o(4),S("Sesi\xF3n #",n.idSesion),o(),d("ngIf",n.sesion),o(),d("ngIf",n.materia),o(2),d("routerLink",se(19,Ce)),o(2),d("disabled",(n.sesion==null?null:n.sesion.estado)!=="ABIERTA"),o(2),d("ngIf",n.errorMsg),o(2),d("ngIf",n.permiteQr()),o(),d("ngClass",n.permiteQr()?"col-lg-8":"col-lg-12"),o(10),S("P (PRESENTE): ",n.contar("PRESENTE")),o(2),S("A (ATRASO): ",n.contar("ATRASO")),o(2),S("F (FALTA): ",n.contar("FALTA")),o(2),S("L (LICENCIA): ",n.contar("PERMISO")),o(16),d("ngForOf",n.registros),o(),d("ngIf",n.registros.length===0),o(8),d("ngIf",(n.sesion==null?null:n.sesion.estado)==="ABIERTA"&&n.permiteRegistroVirtual()),o(),d("ngIf",(n.sesion==null?null:n.sesion.estado)==="ABIERTA"&&!n.permiteRegistroVirtual()),o(11),d("ngIf",(n.sesion==null?null:n.sesion.estado)==="ABIERTA"&&n.permiteRegistroVirtual()),o(6),d("ngForOf",n.estudiantes),o(),d("ngIf",n.estudiantes.length===0))},dependencies:[oe,M,A,W],encapsulation:2});var j=k;function Ke(r,s){if(r&1&&(i(0,"span"),a(1),t()),r&2){let e=m(2);o(),S("Estado: ",e.lastEstado)}}function Ze(r,s){if(r&1&&(i(0,"div",14),a(1),p(2,Ke,2,1,"span",15),t()),r&2){let e=m();o(),S("",e.msg," "),o(),d("ngIf",e.lastEstado)}}var P=class P{constructor(s){this.api=s;this.token="";this.isLoading=!1;this.gps={lat:null,lng:null,precision:null};this.msg=null;this.lastEstado=null}obtenerGps(){return this.msg=null,new Promise(s=>{if(!navigator.geolocation){this.msg="Este navegador no soporta GPS.",s();return}navigator.geolocation.getCurrentPosition(e=>{this.gps.lat=e.coords.latitude,this.gps.lng=e.coords.longitude,this.gps.precision=e.coords.accuracy,s()},()=>{this.msg="No se pudo obtener el GPS. Revise permisos del navegador.",s()},{enableHighAccuracy:!0,timeout:8e3})})}registrar(){return F(this,null,function*(){if(this.msg=null,this.lastEstado=null,!this.token||this.token.trim().length<5){this.msg="Pegue el token del QR.";return}this.isLoading=!0,yield this.obtenerGps(),this.api.scan({token:this.token.trim(),gps_lat:this.gps.lat??void 0,gps_lng:this.gps.lng??void 0,gps_precision_m:this.gps.precision??void 0}).subscribe({next:s=>{this.lastEstado=s?.registro?.estado_asistencia||null,this.msg="Asistencia registrada.",this.isLoading=!1},error:s=>{this.msg=s?.error?.message||"No se pudo registrar la asistencia.",this.isLoading=!1}})})}};P.\u0275fac=function(e){return new(e||P)(x(y))},P.\u0275cmp=E({type:P,selectors:[["app-asistencia-scan"]],standalone:!1,decls:20,vars:7,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"form-label"],["placeholder","Pegue aqu\xED el token",1,"form-control",3,"ngModelChange","ngModel"],[1,"mt-3","d-flex","gap-2"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],[1,"mt-3","small","text-muted"],["class","alert alert-info mt-3 mb-0",4,"ngIf"],[1,"alert","alert-info","mt-3","mb-0"],[4,"ngIf"]],template:function(e,n){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),a(4,"Registrar asistencia"),t(),i(5,"p",4),a(6,"Pegue el token del QR y confirme"),t()()(),i(7,"div",5)(8,"div",6)(9,"label",7),a(10,"Token (QR)"),t(),i(11,"input",8),h("ngModelChange",function(l){return _(n.token,l)||(n.token=l),l}),t(),i(12,"div",9)(13,"button",10),g("click",function(){return n.obtenerGps()}),a(14,"Obtener GPS"),t(),i(15,"button",11),g("click",function(){return n.registrar()}),a(16,"Registrar"),t()(),i(17,"div",12),a(18),t(),p(19,Ze,3,2,"div",13),t()()()),e&2&&(o(11),f("ngModel",n.token),o(2),d("disabled",n.isLoading),o(2),d("disabled",n.isLoading),o(3),O(" GPS: ",n.gps.lat||"-",", ",n.gps.lng||"-"," (\xB1 ",n.gps.precision||"-"," m) "),o(),d("ngIf",n.msg))},dependencies:[A,w,D,R],encapsulation:2});var H=P;function Xe(r,s){if(r&1&&(i(0,"option",11),a(1),t()),r&2){let e=s.$implicit;d("ngValue",e.id),o(),u(e.Anio)}}function Ye(r,s){r&1&&(i(0,"div",33),a(1," No se pudo cargar la lista de a\xF1os. "),t())}function $e(r,s){if(r&1){let e=T();i(0,"button",36),g("click",function(){let c=v(e).$implicit,l=m(2);return b(l.seleccionarEstudiante(c))}),i(1,"div",37)(2,"span"),a(3),t(),i(4,"span",38),a(5),t()()()}if(r&2){let e=s.$implicit;o(3),u(e.nombre_completo),o(2),S("CI: ",e.ci)}}function et(r,s){if(r&1&&(i(0,"div",34),p(1,$e,6,2,"button",35),t()),r&2){let e=m();o(),d("ngForOf",e.resultados)}}function tt(r,s){if(r&1&&(i(0,"div",39),a(1," Seleccionado: "),i(2,"strong"),a(3),t(),a(4),t()),r&2){let e=m();o(3),u(e.estudianteSeleccionado.nombre_completo),o(),S(" (CI: ",e.estudianteSeleccionado.ci,") ")}}function it(r,s){if(r&1&&(i(0,"div",40),a(1),t()),r&2){let e=m();o(),u(e.msg)}}function nt(r,s){r&1&&(i(0,"div",41),a(1,"Cargando..."),t())}function st(r,s){if(r&1){let e=T();i(0,"tr")(1,"td"),a(2),t(),i(3,"td"),a(4),t(),i(5,"td"),a(6),t(),i(7,"td"),a(8),t(),i(9,"td"),a(10),t(),i(11,"td",44)(12,"button",47),g("click",function(){let c=v(e).$implicit,l=m(2);return b(l.aplicar(c.id))}),a(13,"Aplicar"),t(),i(14,"button",48),g("click",function(){let c=v(e).$implicit,l=m(2);return b(l.borrar(c.id))}),a(15,"Borrar"),t()()()}if(r&2){let e=s.$implicit,n=m(2);o(2),u(e.id),o(2),u(e.estudiante_ci||"-"),o(2),S(" ",(e.estudiante_ap_paterno||"")+" "+(e.estudiante_ap_materno||"")+" "+(e.estudiante_nombre||"")," "),o(2),ne("",e.fecha_inicio," \u2192 ",e.fecha_fin),o(2),u(e.motivo||"-"),o(2),d("disabled",n.isLoading),o(2),d("disabled",n.isLoading)}}function at(r,s){r&1&&(i(0,"tr")(1,"td",49),a(2,"Sin licencias."),t()())}function ot(r,s){if(r&1&&(i(0,"div",42)(1,"table",43)(2,"thead")(3,"tr")(4,"th"),a(5,"ID"),t(),i(6,"th"),a(7,"CI"),t(),i(8,"th"),a(9,"Estudiante"),t(),i(10,"th"),a(11,"Rango"),t(),i(12,"th"),a(13,"Motivo"),t(),i(14,"th",44),a(15,"Acci\xF3n"),t()()(),i(16,"tbody"),p(17,st,16,8,"tr",45)(18,at,3,0,"tr",46),t()()()),r&2){let e=m();o(17),d("ngForOf",e.licencias),o(),d("ngIf",e.licencias.length===0)}}var N=class N{constructor(s){this.api=s;this.isLoading=!1;this.msg=null;this.licencias=[];this.anios=[];this.buscando=!1;this.busqueda="";this.resultados=[];this.estudianteSeleccionado=null;this.form={anios_id:null,infoestudiantesifas_id:null,fecha_inicio:new Date().toISOString().slice(0,10),fecha_fin:new Date().toISOString().slice(0,10),motivo:"",registrado_por:""}}ngOnInit(){this.cargarAnios()}cargarAnios(){this.api.getAnios().subscribe({next:s=>{this.anios=Array.isArray(s)?s:s?.data||s?.anios||[];let n=this.anios.find(c=>{let l=String(c?.Predeterminado||"").trim().toUpperCase();return l==="SI"||l==="S\xCD"||l==="1"||l==="TRUE"||l.includes("PREDETER")})||this.anios[0];n?.id&&(this.form.anios_id=Number(n.id)),this.cargar()},error:()=>{this.anios=[],this.cargar()}})}cargar(){this.isLoading=!0,this.api.listLicencias({anios_id:this.form.anios_id??void 0}).subscribe({next:s=>{this.licencias=s?.licencias||[],this.isLoading=!1},error:()=>{this.licencias=[],this.isLoading=!1}})}crear(){if(this.msg=null,!this.form.anios_id){this.msg="Seleccione gesti\xF3n/a\xF1o.";return}if(!this.form.infoestudiantesifas_id){this.msg="Seleccione un estudiante.";return}this.isLoading=!0,this.api.crearLicencia({anios_id:this.form.anios_id,infoestudiantesifas_id:this.form.infoestudiantesifas_id,fecha_inicio:this.form.fecha_inicio,fecha_fin:this.form.fecha_fin,motivo:this.form.motivo||null,registrado_por:this.form.registrado_por||null}).subscribe({next:()=>{this.msg="Licencia creada.",this.isLoading=!1,this.resultados=[],this.cargar()},error:s=>{this.msg=s?.error?.message||"No se pudo crear la licencia.",this.isLoading=!1}})}buscar(){let s=(this.busqueda||"").trim();this.resultados=[],this.estudianteSeleccionado=null,this.form.infoestudiantesifas_id=null,!(s.length<2)&&(this.buscando=!0,this.api.buscarEstudiantesLicencias(s).subscribe({next:e=>{this.resultados=e?.estudiantes||[],this.buscando=!1},error:()=>{this.resultados=[],this.buscando=!1}}))}seleccionarEstudiante(s){this.estudianteSeleccionado=s,this.form.infoestudiantesifas_id=Number(s?.infoestudiantesifas_id),this.resultados=[]}onCambioAnio(){this.cargar()}borrar(s){this.msg=null,this.isLoading=!0,this.api.borrarLicencia(s).subscribe({next:()=>{this.isLoading=!1,this.cargar()},error:()=>{this.msg="No se pudo borrar la licencia.",this.isLoading=!1}})}aplicar(s){this.msg=null,this.isLoading=!0,this.api.aplicarLicencia(s).subscribe({next:e=>{let n=e?.stats?.registros_insertados??0,c=e?.stats?.registros_actualizados??0;this.msg=`Licencia aplicada a asistencias. Insertados: ${n}, actualizados: ${c}.`,this.isLoading=!1,this.cargar()},error:e=>{this.msg=e?.error?.message||"No se pudo aplicar la licencia.",this.isLoading=!1}})}};N.\u0275fac=function(e){return new(e||N)(x(y))},N.\u0275cmp=E({type:N,selectors:[["app-asistencia-permisos"]],standalone:!1,decls:56,vars:18,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"row","g-2"],[1,"col-12","col-md-3"],[1,"form-label"],[1,"form-select",3,"ngModelChange","change","ngModel","disabled"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["class","text-muted mt-1","style","font-size: 0.9em;",4,"ngIf"],[1,"col-12","col-md-5"],[1,"input-group"],["placeholder","Ej: 1234567 o PEREZ JUAN",1,"form-control",3,"ngModelChange","keyup.enter","ngModel"],[1,"btn","btn-outline-secondary",3,"click","disabled"],["class","list-group mt-2",4,"ngIf"],["class","text-secondary mt-2",4,"ngIf"],[1,"col-6","col-md-2"],["type","date",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-6"],[1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-4"],[1,"col-12","col-md-2","d-flex","align-items-end"],[1,"btn","btn-primary","w-100",3,"click","disabled"],["class","alert alert-info mt-3 mb-0",4,"ngIf"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["class","text-center my-3",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"text-muted","mt-1",2,"font-size","0.9em"],[1,"list-group","mt-2"],["type","button","class","list-group-item list-group-item-action",3,"click",4,"ngFor","ngForOf"],["type","button",1,"list-group-item","list-group-item-action",3,"click"],[1,"d-flex","justify-content-between"],[1,"text-muted"],[1,"text-secondary","mt-2"],[1,"alert","alert-info","mt-3","mb-0"],[1,"text-center","my-3"],[1,"table-responsive"],[1,"table","table-sm","table-striped","align-middle","mt-2"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"btn","btn-sm","btn-outline-primary","me-2",3,"click","disabled"],[1,"btn","btn-sm","btn-outline-danger",3,"click","disabled"],["colspan","6",1,"text-center","text-muted"]],template:function(e,n){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),a(4,"Licencias de asistencia"),t(),i(5,"p",4),a(6,"Secretar\xEDa registra licencias (PERMISO en vez de FALTA)"),t()()(),i(7,"div",5)(8,"div",6)(9,"div",7)(10,"div",8)(11,"label",9),a(12,"Gesti\xF3n / A\xF1o"),t(),i(13,"select",10),h("ngModelChange",function(l){return _(n.form.anios_id,l)||(n.form.anios_id=l),l}),g("change",function(){return n.onCambioAnio()}),i(14,"option",11),a(15,"Seleccione..."),t(),p(16,Xe,2,2,"option",12),t(),p(17,Ye,2,0,"div",13),t(),i(18,"div",14)(19,"label",9),a(20,"Buscar estudiante (CI / apellidos / nombres)"),t(),i(21,"div",15)(22,"input",16),h("ngModelChange",function(l){return _(n.busqueda,l)||(n.busqueda=l),l}),g("keyup.enter",function(){return n.buscar()}),t(),i(23,"button",17),g("click",function(){return n.buscar()}),a(24,"Buscar"),t()(),p(25,et,2,1,"div",18)(26,tt,5,2,"div",19),t(),i(27,"div",20)(28,"label",9),a(29,"Inicio"),t(),i(30,"input",21),h("ngModelChange",function(l){return _(n.form.fecha_inicio,l)||(n.form.fecha_inicio=l),l}),t()(),i(31,"div",20)(32,"label",9),a(33,"Fin"),t(),i(34,"input",21),h("ngModelChange",function(l){return _(n.form.fecha_fin,l)||(n.form.fecha_fin=l),l}),t()(),i(35,"div",22)(36,"label",9),a(37,"Motivo"),t(),i(38,"input",23),h("ngModelChange",function(l){return _(n.form.motivo,l)||(n.form.motivo=l),l}),t()(),i(39,"div",24)(40,"label",9),a(41,"Registrado por"),t(),i(42,"input",23),h("ngModelChange",function(l){return _(n.form.registrado_por,l)||(n.form.registrado_por=l),l}),t()(),i(43,"div",25)(44,"button",26),g("click",function(){return n.crear()}),a(45,"Crear"),t()()(),p(46,it,2,1,"div",27),t()(),i(47,"div",5)(48,"div",6)(49,"div",28)(50,"h2",29),a(51,"Licencias recientes"),t(),i(52,"button",30),g("click",function(){return n.cargar()}),a(53,"Actualizar"),t()(),p(54,nt,2,0,"div",31)(55,ot,19,2,"div",32),t()()()),e&2&&(o(13),f("ngModel",n.form.anios_id),d("disabled",n.anios.length===0),o(),d("ngValue",null),o(2),d("ngForOf",n.anios),o(),d("ngIf",n.anios.length===0),o(5),f("ngModel",n.busqueda),o(),d("disabled",n.buscando),o(2),d("ngIf",n.resultados.length>0),o(),d("ngIf",n.estudianteSeleccionado),o(4),f("ngModel",n.form.fecha_inicio),o(4),f("ngModel",n.form.fecha_fin),o(4),f("ngModel",n.form.motivo),o(4),f("ngModel",n.form.registrado_por),o(2),d("disabled",n.isLoading),o(2),d("ngIf",n.msg),o(6),d("disabled",n.isLoading),o(2),d("ngIf",n.isLoading),o(),d("ngIf",!n.isLoading))},dependencies:[M,A,G,z,w,B,D,R],encapsulation:2});var J=N;var rt=[{path:"",redirectTo:"scan",pathMatch:"full"},{path:"scan",component:H},{path:"sesiones",component:U},{path:"sesion/:id",component:j},{path:"permisos",component:J}],C=class C{};C.\u0275fac=function(e){return new(e||C)},C.\u0275mod=Q({type:C}),C.\u0275inj=V({imports:[Z.forChild(rt),Z]});var K=C;var I=class I{};I.\u0275fac=function(e){return new(e||I)},I.\u0275mod=Q({type:I}),I.\u0275inj=V({imports:[re,me,K]});var ge=I;export{ge as SistemaasistenciasestudiantesModule};
