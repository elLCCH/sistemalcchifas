import{a as I}from"./chunk-KFXCIGMC.js";import{Da as g,Ea as c,Fa as s,Qa as b,Qb as y,Sa as f,Zb as S,ab as _,ea as l,eb as u,fb as h,fc as E,gb as M,la as v,lc as B,na as x,sa as C}from"./chunk-LW4OU2FI.js";import"./chunk-ATDPNAVO.js";function $(p,n){if(p&1&&(c(0,"div",7)(1,"div",8)(2,"div",9),u(3),s()(),c(4,"div",10),u(5,"Subiendo\u2026"),s()()),p&2){let t=f();l(2),_("width",t.progress,"%"),l(),M("",t.progress,"%")}}function k(p,n){if(p&1&&(c(0,"div",11),u(1),s()),p&2){let t=f();l(),h(t.message)}}function w(p,n){if(p&1&&(c(0,"div",12),u(1),s()),p&2){let t=f();l(),h(t.error)}}var d=class d{constructor(n,t){this.route=n;this.http=t;this.ruta="";this.token=null;this.uploading=!1;this.progress=0;this.message=null;this.error=null;this.ruta=this.resolveBackendBaseUrl(),this.token=this.route.snapshot.paramMap.get("token")}formatBytes(n){if(!Number.isFinite(n)||n<=0)return"0 B";let t=["B","KB","MB","GB"],e=Math.min(Math.floor(Math.log(n)/Math.log(1024)),t.length-1);return`${(n/Math.pow(1024,e)).toFixed(e===0?0:1)} ${t[e]}`}buildUploadErrorMessage(n,t){let e=n?.status,o=(n?.error?.error??n?.error?.message??"").toString().trim(),i=t?.name?`Archivo: ${t.name}`:"",a=typeof t?.size=="number"?`Tama\xF1o: ${this.formatBytes(t.size)}`:"",m=t?.type?`Tipo: ${t.type}`:"",r=[i,a,m].filter(Boolean).join(" | ");return e===0?"No se pudo conectar con el servidor (red/HTTPS/CORS o redirecci\xF3n). Verifica que el enlace sea https y que /api est\xE9 accesible desde el celular."+(r?`
${r}`:""):e===413?(o||"La foto supera el l\xEDmite permitido.")+(r?`
${r}`:""):e===400?(o||"No se recibi\xF3 el archivo. Esto suele pasar cuando el hosting corta la subida por l\xEDmite de post_max_size/upload_max_filesize.")+(r?`
${r}`:""):e===404?o||"Sesi\xF3n no encontrada. Genera un nuevo QR.":e===409?o||"Sesi\xF3n no disponible. Vuelve a intentar desde la PC.":e===410?o||"Sesi\xF3n expirada. Genera un nuevo QR.":e===422?(o||"El archivo debe ser una imagen v\xE1lida (jpg, png, webp, gif, heic).")+(r?`
${r}`:""):typeof e=="number"&&e>=500?"Error interno del servidor al guardar la imagen (HTTP 500). En hosting normalmente es permisos de escritura o falta de espacio."+(o?`
Detalle: ${o}`:"")+(r?`
${r}`:""):o?o+(r?`
${r}`:""):`No se pudo subir la foto (HTTP ${e??"desconocido"}).`+(r?`
${r}`:"")}resolveBackendBaseUrl(){let n=window.location.origin.replace(/\/+$/,"")+"/",t=(I.ruta??"").trim();if(!t)return n;try{let e=new URL(t,n),o=(e.hostname||"").toLowerCase(),i=(window.location.hostname||"").toLowerCase();if((o==="localhost"||o==="127.0.0.1"||o==="::1")&&i&&i!==o){let m=new URL(e.toString());return m.hostname=i,m.toString()}return e.toString()}catch{return n}}onFileSelected(n){let t=n.target,e=t.files?.item(0);if(t.value="",!e||!this.token)return;let o=40*1024*1024;if(e.size>o){this.error=`La foto pesa ${this.formatBytes(e.size)} y excede 40MB.`;return}this.uploading=!0,this.progress=0,this.message=null,this.error=null;let i=new FormData;i.append("file",e),this.http.post(this.ruta+"api/capture-sessions/"+this.token+"/upload",i,{reportProgress:!0,observe:"events"}).subscribe({next:a=>{if(a?.type===1&&a.total){this.progress=Math.round(a.loaded/a.total*100);return}a?.type===4&&(this.uploading=!1,this.message="Foto enviada. Ya puedes cerrar esta pantalla.")},error:a=>{this.uploading=!1,this.progress=0,this.error=this.buildUploadErrorMessage(a,e)}})}};d.\u0275fac=function(t){return new(t||d)(v(B),v(E))},d.\u0275cmp=x({type:d,selectors:[["app-captura-foto"]],decls:10,vars:3,consts:[[1,"page"],[1,"muted"],[1,"box"],["type","file","accept","image/*","capture","environment",3,"change"],["class","mt",4,"ngIf"],["class","ok mt",4,"ngIf"],["class","err mt",4,"ngIf"],[1,"mt"],[1,"progress"],[1,"progress-bar"],[1,"muted","mt2"],[1,"ok","mt"],[1,"err","mt"]],template:function(t,e){t&1&&(c(0,"div",0)(1,"h3"),u(2,"Captura de foto"),s(),c(3,"p",1),u(4," Toca el bot\xF3n para abrir la c\xE1mara del celular y enviar la foto. "),s(),c(5,"div",2)(6,"input",3),b("change",function(i){return e.onFileSelected(i)}),s(),C(7,$,6,3,"div",4)(8,k,2,1,"div",5)(9,w,2,1,"div",6),s()()),t&2&&(l(7),g("ngIf",e.uploading),l(),g("ngIf",e.message),l(),g("ngIf",e.error))},dependencies:[S,y],styles:[".page[_ngcontent-%COMP%]{max-width:520px;margin:24px auto;padding:0 16px}.muted[_ngcontent-%COMP%]{color:#666}.box[_ngcontent-%COMP%]{border:1px solid #e5e5e5;border-radius:12px;padding:16px}.mt[_ngcontent-%COMP%]{margin-top:12px}.mt2[_ngcontent-%COMP%]{margin-top:8px}.progress[_ngcontent-%COMP%]{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden}.progress-bar[_ngcontent-%COMP%]{height:10px;background:#0d6efd;color:transparent}.ok[_ngcontent-%COMP%]{color:#0a7f2e}.err[_ngcontent-%COMP%]{color:#b00020}"]});var P=d;export{P as CapturaFotoComponent};
