import{e as P}from"./chunk-2UZ5XJOB.js";import{a as B}from"./chunk-5RMZ5E5A.js";import{Ca as l,Dc as M,Fb as b,Jb as d,Ka as v,Kb as h,Lb as y,Lc as S,Pa as x,Ua as C,Vc as E,gb as g,hb as c,ib as s,tb as _,vb as f}from"./chunk-4IB5NCLX.js";import"./chunk-GG76335P.js";function $(p,o){if(p&1&&(c(0,"div",7)(1,"div",8)(2,"div",9),d(3),s()(),c(4,"div",10),d(5,"Subiendo\u2026"),s()()),p&2){let t=f();l(2),b("width",t.progress,"%"),l(),y("",t.progress,"%")}}function k(p,o){if(p&1&&(c(0,"div",11),d(1),s()),p&2){let t=f();l(),h(t.message)}}function w(p,o){if(p&1&&(c(0,"div",12),d(1),s()),p&2){let t=f();l(),h(t.error)}}var u=class u{constructor(o,t){this.route=o;this.http=t;this.ruta="";this.token=null;this.uploading=!1;this.progress=0;this.message=null;this.error=null;this.ruta=this.resolveBackendBaseUrl(),this.token=this.route.snapshot.paramMap.get("token")}formatBytes(o){if(!Number.isFinite(o)||o<=0)return"0 B";let t=["B","KB","MB","GB"],e=Math.min(Math.floor(Math.log(o)/Math.log(1024)),t.length-1);return`${(o/Math.pow(1024,e)).toFixed(e===0?0:1)} ${t[e]}`}buildUploadErrorMessage(o,t){let e=o?.status,n=(o?.error?.error??o?.error?.message??"").toString().trim(),i=t?.name?`Archivo: ${t.name}`:"",a=typeof t?.size=="number"?`Tama\xF1o: ${this.formatBytes(t.size)}`:"",m=t?.type?`Tipo: ${t.type}`:"",r=[i,a,m].filter(Boolean).join(" | ");return e===0?"No se pudo conectar con el servidor (red/HTTPS/CORS o redirecci\xF3n). Verifica que el enlace sea https y que /api est\xE9 accesible desde el celular."+(r?`
${r}`:""):e===413?(n||"La foto supera el l\xEDmite permitido.")+(r?`
${r}`:""):e===400?(n||"No se recibi\xF3 el archivo. Esto suele pasar cuando el hosting corta la subida por l\xEDmite de post_max_size/upload_max_filesize.")+(r?`
${r}`:""):e===404?n||"Sesi\xF3n no encontrada. Genera un nuevo QR.":e===409?n||"Sesi\xF3n no disponible. Vuelve a intentar desde la PC.":e===410?n||"Sesi\xF3n expirada. Genera un nuevo QR.":e===422?(!n||/campos con errores|given data was invalid/i.test(n)?"El servidor rechaz\xF3 el archivo (422). En hosting esto suele ser por l\xEDmites de PHP (upload_max_filesize/post_max_size), y la c\xE1mara principal genera fotos m\xE1s pesadas. Sube esos l\xEDmites o reduce el tama\xF1o/formato de la foto.":n)+(r?`
${r}`:""):typeof e=="number"&&e>=500?"Error interno del servidor al guardar la imagen (HTTP 500). En hosting normalmente es permisos de escritura o falta de espacio."+(n?`
Detalle: ${n}`:"")+(r?`
${r}`:""):n?n+(r?`
${r}`:""):`No se pudo subir la foto (HTTP ${e??"desconocido"}).`+(r?`
${r}`:"")}resolveBackendBaseUrl(){let o=window.location.origin.replace(/\/+$/,"")+"/",t=(B.ruta??"").trim();if(!t)return o;try{let e=new URL(t,o),n=(e.hostname||"").toLowerCase(),i=(window.location.hostname||"").toLowerCase();if((n==="localhost"||n==="127.0.0.1"||n==="::1")&&i&&i!==n){let m=new URL(e.toString());return m.hostname=i,m.toString()}return e.toString()}catch{return o}}onFileSelected(o){let t=o.target,e=t.files?.item(0);if(t.value="",!e||!this.token)return;let n=30*1024*1024;if(e.size>n){this.error=`La foto pesa ${this.formatBytes(e.size)} y excede 30MB.`;return}this.uploading=!0,this.progress=0,this.message=null,this.error=null;let i=new FormData;i.append("file",e),this.http.post(this.ruta+"api/capture-sessions/"+this.token+"/upload",i,{reportProgress:!0,observe:"events"}).subscribe({next:a=>{if(a?.type===1&&a.total){this.progress=Math.round(a.loaded/a.total*100);return}a?.type===4&&(this.uploading=!1,this.message="Foto enviada. Ya puedes cerrar esta pantalla.")},error:a=>{this.uploading=!1,this.progress=0,this.error=this.buildUploadErrorMessage(a,e)}})}};u.\u0275fac=function(t){return new(t||u)(v(P),v(E))},u.\u0275cmp=x({type:u,selectors:[["app-captura-foto"]],decls:10,vars:3,consts:[[1,"page"],[1,"muted"],[1,"box"],["type","file","accept","image/*","capture","environment",3,"change"],["class","mt",4,"ngIf"],["class","ok mt",4,"ngIf"],["class","err mt",4,"ngIf"],[1,"mt"],[1,"progress"],[1,"progress-bar"],[1,"muted","mt2"],[1,"ok","mt"],[1,"err","mt"]],template:function(t,e){t&1&&(c(0,"div",0)(1,"h3"),d(2,"Captura de foto"),s(),c(3,"p",1),d(4," Toca el bot\xF3n para abrir la c\xE1mara del celular y enviar la foto. "),s(),c(5,"div",2)(6,"input",3),_("change",function(i){return e.onFileSelected(i)}),s(),C(7,$,6,3,"div",4)(8,k,2,1,"div",5)(9,w,2,1,"div",6),s()()),t&2&&(l(7),g("ngIf",e.uploading),l(),g("ngIf",e.message),l(),g("ngIf",e.error))},dependencies:[S,M],styles:[".page[_ngcontent-%COMP%]{max-width:520px;margin:24px auto;padding:0 16px}.muted[_ngcontent-%COMP%]{color:#666}.box[_ngcontent-%COMP%]{border:1px solid #e5e5e5;border-radius:12px;padding:16px}.mt[_ngcontent-%COMP%]{margin-top:12px}.mt2[_ngcontent-%COMP%]{margin-top:8px}.progress[_ngcontent-%COMP%]{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden}.progress-bar[_ngcontent-%COMP%]{height:10px;background:#0d6efd;color:transparent}.ok[_ngcontent-%COMP%]{color:#0a7f2e}.err[_ngcontent-%COMP%]{color:#b00020}"]});var I=u;export{I as CapturaFotoComponent};
