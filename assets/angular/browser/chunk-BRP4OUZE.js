import{a as k}from"./chunk-KFXCIGMC.js";import{Da as g,Ea as c,Fa as s,Qa as b,Qb as y,Sa as f,Zb as S,ab as _,ea as l,eb as u,fb as h,fc as B,gb as M,la as v,lc as I,na as x,sa as C}from"./chunk-LW4OU2FI.js";import"./chunk-ATDPNAVO.js";function E(p,n){if(p&1&&(c(0,"div",7)(1,"div",8)(2,"div",9),u(3),s()(),c(4,"div",10),u(5,"Subiendo\u2026"),s()()),p&2){let e=f();l(2),_("width",e.progress,"%"),l(),M("",e.progress,"%")}}function P(p,n){if(p&1&&(c(0,"div",11),u(1),s()),p&2){let e=f();l(),h(e.message)}}function F(p,n){if(p&1&&(c(0,"div",12),u(1),s()),p&2){let e=f();l(),h(e.error)}}var d=class d{constructor(n,e){this.route=n;this.http=e;this.ruta="";this.token=null;this.uploading=!1;this.progress=0;this.message=null;this.error=null;this.ruta=this.resolveBackendBaseUrl(),this.token=this.route.snapshot.paramMap.get("token")}formatBytes(n){if(!Number.isFinite(n)||n<=0)return"0 B";let e=["B","KB","MB","GB"],t=Math.min(Math.floor(Math.log(n)/Math.log(1024)),e.length-1);return`${(n/Math.pow(1024,t)).toFixed(t===0?0:1)} ${e[t]}`}buildUploadErrorMessage(n,e){let t=n?.status,o=(n?.error?.error??n?.error?.message??"").toString().trim(),i=e?.name?`Archivo: ${e.name}`:"",a=typeof e?.size=="number"?`Tama\xF1o: ${this.formatBytes(e.size)}`:"",m=e?.type?`Tipo: ${e.type}`:"",r=[i,a,m].filter(Boolean).join(" | ");return t===0?"No se pudo conectar con el servidor (red/HTTPS/CORS o redirecci\xF3n). Verifica que el enlace sea https y que /api est\xE9 accesible desde el celular."+(r?`
${r}`:""):t===413?(o||"La foto supera el l\xEDmite permitido.")+(r?`
${r}`:""):t===400?(o||"No se recibi\xF3 el archivo. Esto suele pasar cuando el hosting corta la subida por l\xEDmite de post_max_size/upload_max_filesize.")+(r?`
${r}`:""):t===404?o||"Sesi\xF3n no encontrada. Genera un nuevo QR.":t===409?o||"Sesi\xF3n no disponible. Vuelve a intentar desde la PC.":t===410?o||"Sesi\xF3n expirada. Genera un nuevo QR.":t===422?(o||"El archivo debe ser una imagen v\xE1lida (jpg, png, webp, gif, heic).")+(r?`
${r}`:""):o?o+(r?`
${r}`:""):`No se pudo subir la foto (HTTP ${t??"desconocido"}).`+(r?`
${r}`:"")}resolveBackendBaseUrl(){let n=window.location.origin.replace(/\/+$/,"")+"/",e=(k.ruta??"").trim();if(!e)return n;try{let t=new URL(e,n),o=(t.hostname||"").toLowerCase(),i=(window.location.hostname||"").toLowerCase();if((o==="localhost"||o==="127.0.0.1"||o==="::1")&&i&&i!==o){let m=new URL(t.toString());return m.hostname=i,m.toString()}return t.toString()}catch{return n}}onFileSelected(n){let e=n.target,t=e.files?.item(0);if(e.value="",!t||!this.token)return;let o=40*1024*1024;if(t.size>o){this.error=`La foto pesa ${this.formatBytes(t.size)} y excede 40MB.`;return}this.uploading=!0,this.progress=0,this.message=null,this.error=null;let i=new FormData;i.append("file",t),this.http.post(this.ruta+"api/capture-sessions/"+this.token+"/upload",i,{reportProgress:!0,observe:"events"}).subscribe({next:a=>{if(a?.type===1&&a.total){this.progress=Math.round(a.loaded/a.total*100);return}a?.type===4&&(this.uploading=!1,this.message="Foto enviada. Ya puedes cerrar esta pantalla.")},error:a=>{this.uploading=!1,this.progress=0,this.error=this.buildUploadErrorMessage(a,t)}})}};d.\u0275fac=function(e){return new(e||d)(v(I),v(B))},d.\u0275cmp=x({type:d,selectors:[["app-captura-foto"]],decls:10,vars:3,consts:[[1,"page"],[1,"muted"],[1,"box"],["type","file","accept","image/*","capture","environment",3,"change"],["class","mt",4,"ngIf"],["class","ok mt",4,"ngIf"],["class","err mt",4,"ngIf"],[1,"mt"],[1,"progress"],[1,"progress-bar"],[1,"muted","mt2"],[1,"ok","mt"],[1,"err","mt"]],template:function(e,t){e&1&&(c(0,"div",0)(1,"h3"),u(2,"Captura de foto"),s(),c(3,"p",1),u(4," Toca el bot\xF3n para abrir la c\xE1mara del celular y enviar la foto. "),s(),c(5,"div",2)(6,"input",3),b("change",function(i){return t.onFileSelected(i)}),s(),C(7,E,6,3,"div",4)(8,P,2,1,"div",5)(9,F,2,1,"div",6),s()()),e&2&&(l(7),g("ngIf",t.uploading),l(),g("ngIf",t.message),l(),g("ngIf",t.error))},dependencies:[S,y],styles:[".page[_ngcontent-%COMP%]{max-width:520px;margin:24px auto;padding:0 16px}.muted[_ngcontent-%COMP%]{color:#666}.box[_ngcontent-%COMP%]{border:1px solid #e5e5e5;border-radius:12px;padding:16px}.mt[_ngcontent-%COMP%]{margin-top:12px}.mt2[_ngcontent-%COMP%]{margin-top:8px}.progress[_ngcontent-%COMP%]{height:10px;background:#f1f1f1;border-radius:999px;overflow:hidden}.progress-bar[_ngcontent-%COMP%]{height:10px;background:#0d6efd;color:transparent}.ok[_ngcontent-%COMP%]{color:#0a7f2e}.err[_ngcontent-%COMP%]{color:#b00020}"]});var w=d;export{w as CapturaFotoComponent};
