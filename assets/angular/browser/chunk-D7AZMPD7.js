import{a as De}from"./chunk-ST24VIJ6.js";import{a as $e}from"./chunk-P3TSJKXI.js";import{a as Le}from"./chunk-IJH25Q43.js";import{b as Oe}from"./chunk-XRWX5X3S.js";import"./chunk-NS5OA4EG.js";import{a as Ae}from"./chunk-AMGFTWP2.js";import{a as Fe}from"./chunk-A66FWWRH.js";import{b as oe}from"./chunk-JWFA3Q55.js";import{b as Ne}from"./chunk-3WNOAE5J.js";import{g as Re}from"./chunk-5BWXFJAB.js";import{b as Ee,c as Z,f as J,g as Ie,j as ee,k as Te,l as Pe,o as we,p as Me,q as te,r as ie,s as ne,t as Ve,u as ke}from"./chunk-ZNK2DKDR.js";import"./chunk-5RMZ5E5A.js";import{$b as ye,Bb as xe,Db as j,Ea as u,Fa as r,Ga as a,Ha as x,L as z,La as de,Ma as ue,Oa as v,Q as g,R as f,Ra as _,Rb as q,Ta as d,Tb as Q,Ub as X,Xa as fe,Ya as he,Za as be,_ as ge,ab as $,ac as Se,bb as ve,cb as M,da as D,ea as H,fa as s,fb as c,gb as b,hb as S,ib as Y,ma as P,mb as B,nb as K,oa as R,ob as G,pa as W,ta as h,wa as V,yb as Ce,yc as me}from"./chunk-ESRSF5MW.js";import{a as pe,m as _e}from"./chunk-GG76335P.js";function ze(o,t){if(o&1){let e=v();r(0,"div",35)(1,"button",36),_("click",function(){g(e);let n=d();return f(n.infoPrev())}),c(2,"Prev"),a(),r(3,"button",36),_("click",function(){g(e);let n=d();return f(n.infoNext())}),c(4,"Next"),a()()}if(o&2){let e=d();s(),u("disabled",!e.infoTienePrev()||e.isLoadingInfo),s(2),u("disabled",!e.infoTieneNext()||e.isLoadingInfo)}}function He(o,t){if(o&1){let e=v();r(0,"label",37)(1,"input",20),_("ngModelChange",function(n){g(e);let l=d();return f(l.onEvalEnabledChange(0,n))}),a(),r(2,"span",21),c(3,"1"),a()()}if(o&2){let e=d();s(),u("ngModel",e.evalEnabled[0])}}function We(o,t){if(o&1){let e=v();r(0,"label",37)(1,"input",20),_("ngModelChange",function(n){g(e);let l=d();return f(l.onEvalEnabledChange(1,n))}),a(),r(2,"span",21),c(3,"2"),a()()}if(o&2){let e=d();s(),u("ngModel",e.evalEnabled[1])}}function Ye(o,t){if(o&1){let e=v();r(0,"label",37)(1,"input",20),_("ngModelChange",function(n){g(e);let l=d();return f(l.onEvalEnabledChange(2,n))}),a(),r(2,"span",21),c(3,"3"),a()()}if(o&2){let e=d();s(),u("ngModel",e.evalEnabled[2])}}function qe(o,t){if(o&1){let e=v();r(0,"label",37)(1,"input",20),_("ngModelChange",function(n){g(e);let l=d();return f(l.onEvalEnabledChange(3,n))}),a(),r(2,"span",21),c(3,"4"),a()()}if(o&2){let e=d();s(),u("ngModel",e.evalEnabled[3])}}function Qe(o,t){if(o&1&&(r(0,"span"),c(1),a()),o&2){let e=d(2);s(),Y("\xB7 P\xE1gina ",e.infoMeta.current_page," / ",e.infoMeta.last_page)}}function Xe(o,t){if(o&1&&(r(0,"span"),c(1),a()),o&2){let e=d().$implicit;s(),S("\xB7 ",e.NombreInstitucion)}}function Ze(o,t){if(o&1){let e=v();r(0,"button",46),_("click",function(){let n=g(e).$implicit,l=d(2);return f(l.seleccionarInfo(n))}),r(1,"div",47),c(2),a(),r(3,"div",48),c(4),h(5,Xe,2,1,"span",43),a()()}if(o&2){let e=t.$implicit,i=d(2);M("active",(i.selectedInfo==null?null:i.selectedInfo.id)===e.id),s(2),b(i.infoLabel(e)),s(2),S(" ID Inscripci\xF3n: ",e.id," "),s(),u("ngIf",i.esSuperAdmin&&e.NombreInstitucion)}}function Je(o,t){if(o&1&&(r(0,"div",38)(1,"div",39)(2,"div",40)(3,"div",41)(4,"div",42),c(5),h(6,Qe,2,2,"span",43),a(),r(7,"div",44),h(8,Ze,6,5,"button",45),a()()()()()),o&2){let e=d();s(5),S(" Resultados: ",(e.infoMeta==null?null:e.infoMeta.total)??e.infoItems.length," "),s(),u("ngIf",e.infoMeta),s(2),u("ngForOf",e.infoItems)("ngForTrackBy",e.trackByRowIndex)}}function et(o,t){o&1&&(r(0,"div",49)(1,"div",50),c(2," Primero busca una "),r(3,"strong"),c(4,"inscripci\xF3n"),a(),c(5," y selecci\xF3nala para cargar sus materias. "),a(),r(6,"div",51),c(7," Columnas calculadas: "),r(8,"strong"),c(9,"Prom Teo"),a(),c(10,", "),r(11,"strong"),c(12,"Prom Prac"),a(),c(13," y "),r(14,"strong"),c(15,"Prom"),a(),c(16," (solo lectura). "),a()())}function tt(o,t){o&1&&(r(0,"span"),c(1,"Cargando calificaciones\u2026"),a())}function it(o,t){o&1&&(r(0,"span"),c(1,"Guardando cambios\u2026"),a())}function nt(o,t){if(o&1&&(r(0,"div",52)(1,"div",51),h(2,tt,2,0,"span",43)(3,it,2,0,"span",43),a()()),o&2){let e=d();s(2),u("ngIf",e.isLoadingCalificaciones),s(),u("ngIf",e.isSaving)}}function ot(o,t){if(o&1&&(r(0,"div",53)(1,"div",51),c(2),a()()),o&2){let e=d();s(2),b(e.saveError)}}function rt(o,t){if(o&1&&(r(0,"span"),c(1),a()),o&2){let e=d(2);s(),S("/ ",e.califMeta.last_page)}}function at(o,t){if(o&1){let e=v();r(0,"div",56)(1,"button",36),_("click",function(){g(e);let n=d(2);return f(n.califPrev())}),c(2,"Prev"),a(),r(3,"button",36),_("click",function(){g(e);let n=d(2);return f(n.califNext())}),c(4,"Next"),a()()}if(o&2){let e=d(2);s(),u("disabled",!e.califTienePrev()||e.isLoadingCalificaciones),s(2),u("disabled",!e.califTieneNext()||e.isLoadingCalificaciones)}}function lt(o,t){if(o&1){let e=v();r(0,"div",2)(1,"div",54),c(2," Inscripci\xF3n seleccionada: "),r(3,"strong"),c(4),a(),c(5," \xB7 P\xE1gina materias: "),r(6,"strong"),c(7),a(),h(8,rt,2,1,"span",43),a(),r(9,"div",5)(10,"div",51),c(11,"Cambios pendientes: "),r(12,"strong"),c(13),a()(),h(14,at,5,2,"div",55),r(15,"button",12),_("click",function(){g(e);let n=d();return f(n.cargarCalificaciones(n.califPage))}),c(16," Recargar "),a()()()}if(o&2){let e=d();s(4),b(e.selectedInfo.id),s(3),b((e.califMeta==null?null:e.califMeta.current_page)??e.califPage),s(),u("ngIf",e.califMeta),s(5),b(e.dirtyIds.size),s(),u("ngIf",e.califMeta),s(),u("disabled",e.isLoadingCalificaciones)}}function st(o,t){if(o&1&&(r(0,"span",4),c(1),a()),o&2){let e=t.ngIf;s(),S("(",e,")")}}function ct(o,t){if(o&1&&(r(0,"th",62),c(1),h(2,st,2,1,"span",63),a()),o&2){let e=t.$implicit,i=d(2);ve("width",e.widthPx,"px"),u("ngClass",i.headerThClass(e.key)),s(),S(" ",e.label," "),s(),u("ngIf",i.maxForColumn(e))}}function dt(o,t){if(o&1&&(r(0,"tr",68)(1,"td",59)(2,"div",47),c(3),a()()()),o&2){let e=d().$implicit,i=d(2);s(),V("colspan",i.tableColspan()),s(2),b(i.groupKey(e))}}function ut(o,t){if(o&1){let e=v();de(0),r(1,"input",71),_("ngModelChange",function(n){g(e);let l=d().$implicit,m=d().index,p=d(2);return f(p.onCellValueInput(m,l.key,n))})("focus",function(){g(e);let n=d().index,l=d().index,m=d(2);return f(m.onCellFocus(l,n))})("keydown",function(n){g(e);let l=d().index,m=d().index,p=d(2);return f(p.onKeyDown(n,m,l))})("paste",function(n){g(e);let l=d().index,m=d().index,p=d(2);return f(p.onPaste(n,m,l))}),a(),ue()}if(o&2){let e=d(),i=e.$implicit,n=e.index,l=d(),m=l.$implicit,p=l.index,y=d(2);s(),M("readonly-cell",i.readonly),u("readOnly",!!i.readonly||!y.isColumnEditable(i.key))("ngModel",m[i.key]),V("data-cell",p+"-"+n)("min",0)("max",y.maxForColumn(i))}}function mt(o,t){if(o&1){let e=v();r(0,"input",72),_("focus",function(){g(e);let n=d().index,l=d().index,m=d(2);return f(m.onCellFocus(l,n))})("keydown",function(n){g(e);let l=d().index,m=d().index,p=d(2);return f(p.onKeyDown(n,m,l))})("paste",function(n){g(e);let l=d().index,m=d().index,p=d(2);return f(p.onPaste(n,m,l))}),a()}if(o&2){let e=d(),i=e.$implicit,n=e.index,l=d(),m=l.$implicit,p=l.index,y=d(2);u("readOnly",!0)("value",y.sumForColumn(m,i.key)??""),V("data-cell",p+"-"+n)}}function pt(o,t){if(o&1&&(r(0,"td",69),h(1,ut,2,7,"ng-container",70)(2,mt,1,3,"ng-template",null,0,j),a()),o&2){let e=t.$implicit,i=t.index,n=$(3),l=d().$implicit,m=d(2);u("ngClass",m.cellTdClass(l,i,e.key)),s(),u("ngIf",e.kind!=="sum")("ngIfElse",n)}}function _t(o,t){if(o&1){let e=v();de(0),h(1,dt,4,2,"tr",64),r(2,"tr")(3,"td",59)(4,"div",65)(5,"div")(6,"div",47),c(7),a(),r(8,"div",66),c(9),a()(),r(10,"button",24),_("click",function(){let n=g(e).$implicit,l=d(2);return f(l.openPhoto(n))}),c(11,"Foto"),a()()(),h(12,pt,4,3,"td",67),a(),ue()}if(o&2){let e=t.$implicit,i=t.index,n=d(2);s(),u("ngIf",n.isGroupStart(i)),s(),M("table-active",i===n.activeRowIndex),s(5),b(e.estudiante),s(2),b(e.materia),s(3),u("ngForOf",n.columns)("ngForTrackBy",n.trackByColIndex)}}function gt(o,t){if(o&1&&(r(0,"div",57)(1,"table",58)(2,"thead")(3,"tr")(4,"th",59),c(5,"Estudiante"),a(),h(6,ct,3,5,"th",60),a()(),r(7,"tbody"),h(8,_t,13,7,"ng-container",61),a()()()),o&2){let e=d();s(6),u("ngForOf",e.columns)("ngForTrackBy",e.trackByColIndex),s(2),u("ngForOf",e.rows)("ngForTrackBy",e.trackByRowIndex)}}function ft(o,t){if(o&1){let e=v();r(0,"div",73)(1,"div",74)(2,"div",75)(3,"div",76)(4,"h5",77),c(5),a(),r(6,"button",78),_("click",function(){g(e);let n=d();return f(n.closePhoto())}),a()(),r(7,"div",79),x(8,"img",80),r(9,"div",81),c(10),a()()()()()}if(o&2){let e=d();s(5),S("Foto - ",e.photoRow==null?null:e.photoRow.estudiante),s(3),u("src",e.photoUrlFor(e.photoRow),D),s(2),b(e.photoRow==null?null:e.photoRow.materia)}}function ht(o,t){if(o&1){let e=v();r(0,"div",82),_("click",function(){g(e);let n=d();return f(n.closePhoto())}),a()}}var N=class N{constructor(t,e,i,n){this.hostEl=t;this._calif=e;this._info=i;this._auth=n;this.esSuperAdmin=!1;this.PASSING_SCORE=61;this.maxTeorico=30;this.maxPractico=70;this.avgEvalCount=4;this.evalEnabled=[!0,!0,!0,!0];this.showSumColumns=!1;this.filterInfo="";this.infoItems=[];this.infoMeta=null;this.infoPage=1;this.infoPerPage=10;this.isLoadingInfo=!1;this.selectedInfo=null;this.isLoadingCalificaciones=!1;this.califMeta=null;this.califPage=1;this.califPerPage=200;this.isSaving=!1;this.saveError=null;this.originalById=new Map;this.dirtyIds=new Set;this.HISTORY_LIMIT=80;this.undoStack=[];this.redoStack=[];this.isRestoring=!1;this.viewMode="intercalado";this.rows=[];this.activeRowIndex=0;this.activeColIndex=0;this.photoModalOpen=!1;this.photoRow=null;this.trackByRowIndex=(t,e)=>e.id;this.trackByColIndex=(t,e)=>e.key}get visibleEvalCount(){return this.avgEvalCount}get columns(){return this.buildColumns(this.viewMode,this.visibleEvalCount)}tableColspan(){return 1+this.columns.length}groupKey(t){let e=(t.Anio??"SIN A\xD1O").toString().trim()||"SIN A\xD1O",i=(t.LvlCurso??"SIN CURSO").toString().trim()||"SIN CURSO";return`${e} | ${i}`}isGroupStart(t){if(t<=0)return!0;let e=this.rows[t-1],i=this.rows[t];return!e||!i?!0:this.groupKey(e)!==this.groupKey(i)}buildColumns(t,e){let i=[],l=e;if(t==="intercalado")for(let m=1;m<=l;m++)i.push({key:`Teorico${m}`,label:`Teo${m}`,type:"number",kind:"input",widthPx:95}),i.push({key:`Practico${m}`,label:`Prac${m}`,type:"number",kind:"input",widthPx:95}),this.showSumColumns&&i.push({key:`Sum${m}`,label:`Sum${m}`,type:"number",kind:"sum",readonly:!0,widthPx:90});else{for(let m=1;m<=l;m++)i.push({key:`Teorico${m}`,label:`Teo${m}`,type:"number",kind:"input",widthPx:95});for(let m=1;m<=l;m++)i.push({key:`Practico${m}`,label:`Prac${m}`,type:"number",kind:"input",widthPx:95}),this.showSumColumns&&i.push({key:`Sum${m}`,label:`Sum${m}`,type:"number",kind:"sum",readonly:!0,widthPx:90})}return[...i,{key:"PromTeorico",label:"Prom Teo",type:"number",kind:"input",readonly:!0,widthPx:110},{key:"PromPractico",label:"Prom Prac",type:"number",kind:"input",readonly:!0,widthPx:110},{key:"Promedio",label:"Prom",type:"number",kind:"input",readonly:!0,widthPx:90},{key:"PruebaRecuperacion",label:"Recup",type:"number",kind:"input",widthPx:95}]}ngOnInit(){this._auth.revisarSiEsSuperAdmin().subscribe(t=>{this.esSuperAdmin=t})}buscarInfo(t=1){if(this.isLoadingInfo)return;let e=(this.filterInfo??"").trim();if(!e||e.length<2){this.infoItems=[],this.infoMeta=null,this.infoPage=1;return}this.isLoadingInfo=!0,this._info.Obtenerinfoestudiantesifas({page:t,per_page:this.infoPerPage,search:e,sort_by:"FechInsc",sort_dir:"desc"}).subscribe({next:i=>{let n=Array.isArray(i?.data)?i.data:[];this.infoItems=n.map(l=>({id:Number(l?.id),FechInsc:l?.FechInsc??null,Curso_Solicitado:l?.Curso_Solicitado??null,Paralelo_Solicitado:l?.Paralelo_Solicitado??null,Categoria:l?.Categoria??null,Turno:l?.Turno??null,Anio:l?.Anio??null,Ap_Paterno:l?.Ap_Paterno??null,Ap_Materno:l?.Ap_Materno??null,Nombre:l?.Nombre??null,NombreInstitucion:l?.NombreInstitucion??null})).filter(l=>Number.isFinite(l.id)),this.infoMeta=i?.meta??null,this.infoPage=this.infoMeta?.current_page??t},error:i=>{console.error("Error al buscar inscripciones:",i),this.infoItems=[],this.infoMeta=null},complete:()=>{this.isLoadingInfo=!1}})}infoTienePrev(){return(this.infoMeta?.current_page??1)>1}infoTieneNext(){let t=this.infoMeta?.current_page??1,e=this.infoMeta?.last_page??1;return t<e}infoPrev(){this.infoTienePrev()&&this.buscarInfo((this.infoMeta?.current_page??1)-1)}infoNext(){this.infoTieneNext()&&this.buscarInfo((this.infoMeta?.current_page??1)+1)}infoLabel(t){let e=(t.Ap_Paterno??"").toString().trim(),i=(t.Ap_Materno??"").toString().trim(),n=(t.Nombre??"").toString().trim(),l=`${e} ${i} ${n}`.replace(/\s+/g," ").trim()||`Inscripci\xF3n #${t.id}`,m=(t.Anio??"").toString().trim(),p=(t.Curso_Solicitado??"").toString().trim(),y=(t.Paralelo_Solicitado??"").toString().trim(),E=[l];return m&&E.push(`A\xF1o: ${m}`),p&&E.push(`Curso: ${p}${y?" - "+y:""}`),E.join(" \xB7 ")}seleccionarInfo(t){this.selectedInfo=t,this.resetGridForNewInfo(),this.cargarCalificaciones(1)}limpiarInfo(){this.selectedInfo=null,this.resetGridForNewInfo()}resetGridForNewInfo(){this.rows=[],this.originalById.clear(),this.dirtyIds.clear(),this.undoStack=[],this.redoStack=[],this.saveError=null,this.califMeta=null,this.califPage=1}califTienePrev(){return(this.califMeta?.current_page??1)>1}califTieneNext(){let t=this.califMeta?.current_page??1,e=this.califMeta?.last_page??1;return t<e}califPrev(){this.califTienePrev()&&this.cargarCalificaciones((this.califMeta?.current_page??1)-1)}califNext(){this.califTieneNext()&&this.cargarCalificaciones((this.califMeta?.current_page??1)+1)}cargarCalificaciones(t=1){if(!this.selectedInfo||this.isLoadingCalificaciones)return;this.isLoadingCalificaciones=!0,this.saveError=null;let e=this.selectedInfo.id;this._calif.ObtenerCalificacionesPorInfoPaginado(e,{page:t,per_page:this.califPerPage}).subscribe({next:i=>{let n=Array.isArray(i?.data)?i.data:[];this.califMeta=i?.meta??null,this.califPage=this.califMeta?.current_page??t;let l=Number(n?.[0]?.CantidadEvaluaciones);Number.isFinite(l)&&(this.avgEvalCount=this.clampInt(l,1,4));let m=this.infoLabel(this.selectedInfo);this.rows=n.map(p=>{let y=(p?.NombreMateria??"").toString().trim(),E=(p?.SiglaMateria??"").toString().trim(),C=(p?.MateriaParalelo??"").toString().trim(),T=[E,y].filter(Boolean).join(" ")+(C?` (${C})`:"");return{id:Number(p?.id),infoestudiantesifas_id:Number(p?.infoestudiantesifas_id??e),materias_id:Number(p?.materias_id),estudiante:m,materia:T||`Materia #${p?.materias_id}`,fotoUrl:null,Anio:p?.Anio??null,LvlCurso:p?.LvlCurso??null,Teorico1:p?.Teorico1??null,Teorico2:p?.Teorico2??null,Teorico3:p?.Teorico3??null,Teorico4:p?.Teorico4??null,Practico1:p?.Practico1??null,Practico2:p?.Practico2??null,Practico3:p?.Practico3??null,Practico4:p?.Practico4??null,PromTeorico:p?.PromTeorico??null,PromPractico:p?.PromPractico??null,Promedio:p?.Promedio??null,PruebaRecuperacion:p?.PruebaRecuperacion??null}}).filter(p=>Number.isFinite(p.id)&&Number.isFinite(p.materias_id));for(let p of this.rows){for(let y of["Teorico1","Teorico2","Teorico3","Teorico4","Practico1","Practico2","Practico3","Practico4","PruebaRecuperacion"])this.sanitizeCellValue(p,y);this.recalcInPlace(p)}this.captureBaseline()},error:i=>{console.error("Error al cargar calificaciones:",i),this.rows=[],this.califMeta=null,this.saveError="No se pudieron cargar las calificaciones."},complete:()=>{this.isLoadingCalificaciones=!1}})}captureBaseline(){this.originalById.clear(),this.dirtyIds.clear();for(let t of this.rows)this.originalById.set(t.id,{Teorico1:t.Teorico1,Teorico2:t.Teorico2,Teorico3:t.Teorico3,Teorico4:t.Teorico4,Practico1:t.Practico1,Practico2:t.Practico2,Practico3:t.Practico3,Practico4:t.Practico4,PruebaRecuperacion:t.PruebaRecuperacion})}recomputeDirtyForRow(t){let e=this.originalById.get(t.id);if(!e)return;["Teorico1","Teorico2","Teorico3","Teorico4","Practico1","Practico2","Practico3","Practico4","PruebaRecuperacion"].some(l=>t[l]!==e[l])?this.dirtyIds.add(t.id):this.dirtyIds.delete(t.id)}guardarCambios(){if(!this.selectedInfo||this.isSaving||(this.saveError=null,Array.from(this.dirtyIds.values()).length===0))return;let e=this.rows.filter(i=>this.dirtyIds.has(i.id)).map(i=>({id:i.id,Teorico1:i.Teorico1,Teorico2:i.Teorico2,Teorico3:i.Teorico3,Teorico4:i.Teorico4,Practico1:i.Practico1,Practico2:i.Practico2,Practico3:i.Practico3,Practico4:i.Practico4,PruebaRecuperacion:i.PruebaRecuperacion}));this.isSaving=!0,this._calif.GuardarCalificacionesBulk({infoestudiantesifas_id:this.selectedInfo.id,avg_eval_count:this.avgEvalCount,items:e}).subscribe({next:()=>{for(let i of this.rows)this.dirtyIds.has(i.id)&&this.originalById.set(i.id,{Teorico1:i.Teorico1,Teorico2:i.Teorico2,Teorico3:i.Teorico3,Teorico4:i.Teorico4,Practico1:i.Practico1,Practico2:i.Practico2,Practico3:i.Practico3,Practico4:i.Practico4,PruebaRecuperacion:i.PruebaRecuperacion});this.dirtyIds.clear()},error:i=>{console.error("Error al guardar cambios:",i),this.saveError="No se pudieron guardar los cambios."},complete:()=>{this.isSaving=!1}})}onGlobalKeyDown(t){let e=t.target;if(!e||!this.hostEl.nativeElement.contains(e)||!(t.ctrlKey||t.metaKey))return;let n=t.key.toLowerCase();if(n==="z"&&!t.shiftKey){this.canUndo()&&(t.preventDefault(),this.undo());return}(n==="y"||n==="z"&&t.shiftKey)&&this.canRedo()&&(t.preventDefault(),this.redo())}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}undo(){let t=this.undoStack.pop();t&&(this.redoStack.push(this.snapshotState()),this.restoreState(t))}redo(){let t=this.redoStack.pop();t&&(this.undoStack.push(this.snapshotState()),this.restoreState(t))}beginUserChange(){this.isRestoring||(this.undoStack.push(this.snapshotState()),this.undoStack.length>this.HISTORY_LIMIT&&this.undoStack.shift(),this.redoStack=[])}copyAllToClipboard(){return _e(this,null,function*(){let t=this.buildTsvExport();if(navigator.clipboard?.writeText){yield navigator.clipboard.writeText(t);return}let e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)})}onShowSumColumnsChange(t){this.beginUserChange(),this.showSumColumns=!!t}onMaxTeoricoInput(t){this.beginUserChange(),this.maxTeorico=t,this.onLimitsChange()}onMaxPracticoInput(t){this.beginUserChange(),this.maxPractico=t,this.onLimitsChange()}onLimitsChange(){this.maxTeorico=this.clampInt(this.maxTeorico,1,100),this.maxPractico=this.clampInt(this.maxPractico,1,100);for(let t of this.rows){for(let e of["Teorico1","Teorico2","Teorico3","Teorico4","Practico1","Practico2","Practico3","Practico4","PruebaRecuperacion"])this.sanitizeCellValue(t,e);this.recalcInPlace(t)}}onAvgEvalCountInput(t){this.beginUserChange(),this.avgEvalCount=t,this.onAvgEvalCountChange()}onAvgEvalCountChange(){this.avgEvalCount=this.clampInt(this.avgEvalCount,1,4);for(let t of this.rows)this.recalcInPlace(t)}setAllEvaluations(t){this.beginUserChange(),this.evalEnabled=[t,t,t,t]}onEvalEnabledChange(t,e){t<0||t>3||(this.beginUserChange(),this.evalEnabled[t]=!!e)}setViewMode(t){this.viewMode!==t&&(this.beginUserChange(),this.viewMode=t)}onCellFocus(t,e){this.activeRowIndex=t,this.activeColIndex=e}maxForKey(t){return this.isTeoricoKey(t)?this.maxTeorico:this.isPracticoKey(t)?this.maxPractico:t==="PruebaRecuperacion"?100:null}maxForColumn(t){if(t.kind!=="input")return null;let e=t.key;return this.isReadonlyKey(e)?null:this.maxForKey(e)}isColumnEditable(t){return this.isSumKey(t)?!1:this.isCellEditable(t)}isSumColumn(t){return this.isSumKey(t)}sumForColumn(t,e){let i=this.evalIndexFromColumnKey(e);return i===null?null:this.evalSum(t,i)}openPhoto(t){this.photoRow=t,this.photoModalOpen=!0}closePhoto(){this.photoModalOpen=!1,this.photoRow=null}photoUrlFor(t){return t?.fotoUrl??"assets/images/client6.png"}isCellEditable(t){if(this.isReadonlyKey(t))return!1;let e=this.evalIndexFromKey(t);return e!==null?!!this.evalEnabled[e-1]:!0}evalSum(t,e){let i=t[`Teorico${e}`],n=t[`Practico${e}`];return typeof i=="number"&&typeof n=="number"?i+n:null}isSumKey(t){return typeof t=="string"&&t.startsWith("Sum")}evalIndexFromColumnKey(t){if(this.isSumKey(t)){let e=Number(t.replace("Sum",""));return e>=1&&e<=4?e:null}return this.evalIndexFromKey(t)}cellTdClass(t,e,i){return{"eval-end":this.isEvaluationSeparator(i),"section-start":this.isSectionStart(i),"cell-danger":this.isDangerCell(t,i)}}headerThClass(t){return{"eval-end":this.isEvaluationSeparator(t),"section-start":this.isSectionStart(t)}}onCellValueInput(t,e,i){if(!this.isCellEditable(e)||this.isReadonlyKey(e))return;this.beginUserChange();let n=this.rows[t];n[e]=this.parseNullableInt(String(i??"").trim()),this.sanitizeCellValue(n,e),this.recalcInPlace(n),this.recomputeDirtyForRow(this.rows[t])}onPaste(t,e,i){let n=t.clipboardData?.getData("text/plain");n&&(t.preventDefault(),this.beginUserChange(),this.applyPaste(n,e,i))}onKeyDown(t,e,i){if(t.key!=="ArrowUp"&&t.key!=="ArrowDown"&&t.key!=="ArrowLeft"&&t.key!=="ArrowRight")return;t.preventDefault();let n=this.keyToDelta(t.key),l=this.clamp(e+n.dr,0,this.rows.length-1),m=this.clamp(i+n.dc,0,this.columns.length-1);this.focusCell(l,m)}focusCell(t,e){this.activeRowIndex=t,this.activeColIndex=e,queueMicrotask(()=>{let i=document.querySelector(`[data-cell="${t}-${e}"]`);i?.focus(),i?.select()})}pasteHere(t){this.applyPaste(t,this.activeRowIndex,this.activeColIndex)}applyPaste(t,e,i){let n=t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`),l=this.trimEmptyTrailingLines(n);for(let m=0;m<l.length;m++){let p=e+m;if(p>=this.rows.length)break;let y=l[m].split("	");for(let E=0;E<y.length;E++){let C=i+E;if(C>=this.columns.length)break;let T=this.columns[C];if(T.readonly||T.kind==="sum"||this.isSumKey(T.key))continue;let I=y[E].trim(),w=T.key;if(!this.isCellEditable(w))continue;let O=this.parseNullableInt(I);this.rows[p][w]=O,this.sanitizeCellValue(this.rows[p],w)}this.recalcInPlace(this.rows[p]),this.recomputeDirtyForRow(this.rows[p])}}recalcInPlace(t){let e=this.findZeroCascadeIndex(t),i=t,n=!!i.__cascadeActive,l=i.__cascadeLockFrom??null;if(e!==null){n||(i.__cascadeBackup={1:{teo:t.Teorico1,prac:t.Practico1},2:{teo:t.Teorico2,prac:t.Practico2},3:{teo:t.Teorico3,prac:t.Practico3},4:{teo:t.Teorico4,prac:t.Practico4}}),i.__cascadeActive=!0,i.__cascadeLockFrom=e;for(let C=e;C<=4;C++)t[`Teorico${C}`]=0,t[`Practico${C}`]=0}else if(n){let C=i.__cascadeBackup,T=l??1;if(C)for(let I=T+1;I<=4;I++){let w=C[I];if(!w)continue;let O=t[`Teorico${I}`],U=t[`Practico${I}`];typeof O=="number"&&typeof U=="number"&&O===0&&U===0&&(t[`Teorico${I}`]=w.teo,t[`Practico${I}`]=w.prac)}i.__cascadeActive=!1,i.__cascadeLockFrom=null,i.__cascadeBackup=null}let m=e!==null,p=this.getAvgEvalIndices(),y=p.map(C=>t[`Teorico${C}`]),E=p.map(C=>t[`Practico${C}`]);if(t.PromTeorico=m?0:this.avg(y),t.PromPractico=m?0:this.avg(E),t.PromTeorico===null&&t.PromPractico===null)t.Promedio=null;else{let C=(t.PromTeorico??0)+(t.PromPractico??0);t.Promedio=Math.max(0,Math.min(100,Math.round(C)))}}avg(t){let e=t.filter(n=>typeof n=="number"&&Number.isFinite(n));if(e.length===0)return null;let i=e.reduce((n,l)=>n+l,0);return Math.round(i/e.length)}parseNullableInt(t){if(!t)return null;let e=t.replace(",","."),i=Number(e);return Number.isFinite(i)?Math.trunc(i):null}sanitizeCellValue(t,e){if(this.isReadonlyKey(e))return;let i=t[e];if(i==null||!Number.isFinite(i)){t[e]=null;return}let n=Math.trunc(i),l=this.maxForKey(e);l!==null&&(n=Math.min(n,l)),n=Math.max(n,0),t[e]=n}clampInt(t,e,i){let n=Number(t);return Number.isFinite(n)?Math.trunc(this.clamp(n,e,i)):e}getAvgEvalIndices(){let t=[];for(let e=1;e<=this.avgEvalCount;e++)t.push(e);return t}findZeroCascadeIndex(t){for(let e=1;e<=4;e=e+1){let i=t[`Teorico${e}`],n=t[`Practico${e}`];if(typeof i=="number"&&typeof n=="number"&&i===0&&n===0)return e}return null}buildTsvExport(){let t=[{key:"Teorico1",label:"Teo1"},{key:"Practico1",label:"Prac1"},{key:"Teorico2",label:"Teo2"},{key:"Practico2",label:"Prac2"},{key:"Teorico3",label:"Teo3"},{key:"Practico3",label:"Prac3"},{key:"Teorico4",label:"Teo4"},{key:"Practico4",label:"Prac4"},{key:"PromTeorico",label:"Prom Teo"},{key:"PromPractico",label:"Prom Prac"},{key:"Promedio",label:"Prom"},{key:"PruebaRecuperacion",label:"Recup"}],e=["Estudiante","Materia",...t.map(n=>n.label)].join("	"),i=this.rows.map(n=>{let l=t.map(m=>{let p=n[m.key];return p==null?"":String(p)});return[n.estudiante,n.materia,...l].join("	")});return[e,...i].join(`
`)}snapshotState(){return{maxTeorico:this.maxTeorico,maxPractico:this.maxPractico,avgEvalCount:this.avgEvalCount,viewMode:this.viewMode,evalEnabled:[...this.evalEnabled],showSumColumns:this.showSumColumns,rows:this.rows.map(t=>({id:t.id,Teorico1:t.Teorico1,Teorico2:t.Teorico2,Teorico3:t.Teorico3,Teorico4:t.Teorico4,Practico1:t.Practico1,Practico2:t.Practico2,Practico3:t.Practico3,Practico4:t.Practico4,PruebaRecuperacion:t.PruebaRecuperacion}))}}restoreState(t){this.isRestoring=!0;try{this.maxTeorico=t.maxTeorico,this.maxPractico=t.maxPractico,this.avgEvalCount=t.avgEvalCount,this.viewMode=t.viewMode,this.evalEnabled=[...t.evalEnabled],this.showSumColumns=!!t.showSumColumns;let e=new Map(t.rows.map(i=>[i.id,i]));for(let i of this.rows){let n=e.get(i.id);n&&(i.Teorico1=n.Teorico1,i.Teorico2=n.Teorico2,i.Teorico3=n.Teorico3,i.Teorico4=n.Teorico4,i.Practico1=n.Practico1,i.Practico2=n.Practico2,i.Practico3=n.Practico3,i.Practico4=n.Practico4,i.PruebaRecuperacion=n.PruebaRecuperacion,i.__cascadeActive=!1,i.__cascadeLockFrom=null,i.__cascadeBackup=null,this.recalcInPlace(i),this.recomputeDirtyForRow(i))}}finally{this.isRestoring=!1}}isTeoricoKey(t){return t==="Teorico1"||t==="Teorico2"||t==="Teorico3"||t==="Teorico4"}isPracticoKey(t){return t==="Practico1"||t==="Practico2"||t==="Practico3"||t==="Practico4"}isReadonlyKey(t){return t==="PromTeorico"||t==="PromPractico"||t==="Promedio"}isEvaluationSeparator(t){if(this.viewMode==="intercalado"){let e=i=>this.showSumColumns?`Sum${i}`:`Practico${i}`;return this.visibleEvalCount>=1&&t===e(1)||this.visibleEvalCount>=2&&t===e(2)||this.visibleEvalCount>=3&&t===e(3)||this.visibleEvalCount>=4&&t===e(4)}return t===`Teorico${this.visibleEvalCount}`||t===`Practico${this.visibleEvalCount}`||this.showSumColumns&&t===`Sum${this.visibleEvalCount}`}isSectionStart(t){return t==="PromTeorico"}isDangerCell(t,e){let i=this.evalIndexFromColumnKey(e);if(i!==null){let n=t[`Teorico${i}`],l=t[`Practico${i}`];return typeof n=="number"&&typeof l=="number"?n+l<this.PASSING_SCORE:!1}return e==="PromTeorico"?t.PromTeorico===null?!1:t.PromTeorico*100<this.PASSING_SCORE*this.maxTeorico:e==="PromPractico"?t.PromPractico===null?!1:t.PromPractico*100<this.PASSING_SCORE*this.maxPractico:e==="Promedio"?t.Promedio!==null&&t.Promedio<this.PASSING_SCORE:e==="PruebaRecuperacion"?t.PruebaRecuperacion!==null&&t.PruebaRecuperacion<this.PASSING_SCORE:!1}evalIndexFromKey(t){switch(t){case"Teorico1":case"Practico1":return 1;case"Teorico2":case"Practico2":return 2;case"Teorico3":case"Practico3":return 3;case"Teorico4":case"Practico4":return 4;default:return null}}trimEmptyTrailingLines(t){let e=[...t];for(;e.length>0&&e[e.length-1].trim()==="";)e.pop();return e}keyToDelta(t){switch(t){case"ArrowUp":return{dr:-1,dc:0};case"ArrowDown":return{dr:1,dc:0};case"ArrowLeft":return{dr:0,dc:-1};case"ArrowRight":return{dr:0,dc:1};default:return{dr:0,dc:0}}}clamp(t,e,i){return Math.max(e,Math.min(i,t))}makeRow(t,e,i,n,l,m,p,y,E,C,T,I,w,O,U){return{id:t,infoestudiantesifas_id:e,materias_id:i,estudiante:n,materia:l,fotoUrl:m,Teorico1:p,Teorico2:y,Teorico3:E,Teorico4:C,Practico1:T,Practico2:I,Practico3:w,Practico4:O,PromTeorico:null,PromPractico:null,Promedio:null,PruebaRecuperacion:U}}};N.\u0275fac=function(e){return new(e||N)(P(ge),P($e),P(De),P(oe))},N.\u0275cmp=R({type:N,selectors:[["app-calificacionessolo"]],hostBindings:function(e,i){e&1&&_("keydown",function(l){return i.onGlobalKeyDown(l)},H)},standalone:!1,decls:73,vars:34,consts:[["sumCell",""],[1,"container-fluid","py-2"],[1,"d-flex","align-items-center","justify-content-between","flex-wrap","gap-2","mb-2"],[1,"mb-0"],[1,"text-body-secondary"],[1,"d-flex","align-items-center","gap-2"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"input-group","input-group-sm",2,"width","380px"],[1,"input-group-text"],["placeholder","Apellido o nombre (min 2 letras)",1,"form-control",3,"ngModelChange","keydown.enter","ngModel"],["type","button",1,"btn","btn-outline-primary",3,"click","disabled"],["class","btn-group btn-group-sm","role","group","aria-label","Paginaci\xF3n inscripci\xF3n",4,"ngIf"],["type","button",1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["role","group","aria-label","Modo de visualizaci\xF3n",1,"btn-group","btn-group-sm"],["type","button",1,"btn",3,"click"],[1,"d-flex","align-items-center","gap-1","small"],["type","number","min","1","max","100",1,"form-control","form-control-sm",2,"width","78px",3,"ngModelChange","ngModel"],[1,"form-select","form-select-sm",2,"width","110px",3,"ngModelChange","ngModel"],[3,"ngValue"],[1,"form-check","small","mb-0"],["type","checkbox",1,"form-check-input",3,"ngModelChange","ngModel"],[1,"form-check-label"],[1,"d-flex","align-items-center","gap-2","small"],["class","form-check form-check-inline mb-0",4,"ngIf"],["type","button",1,"btn","btn-outline-secondary","btn-sm",3,"click"],["type","button",1,"btn","btn-outline-primary","btn-sm",3,"click"],["type","button",1,"btn","btn-primary","btn-sm",3,"click","disabled"],["class","row g-2 mb-2",4,"ngIf"],["class","alert alert-info py-2 mb-2",4,"ngIf"],["class","alert alert-warning py-2 mb-2",4,"ngIf"],["class","alert alert-danger py-2 mb-2",4,"ngIf"],["class","d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2",4,"ngIf"],["class","table-responsive cali-grid-wrap",4,"ngIf"],["class","modal fade show d-block","tabindex","-1","role","dialog","aria-modal","true",4,"ngIf"],["class","modal-backdrop fade show",3,"click",4,"ngIf"],["role","group","aria-label","Paginaci\xF3n inscripci\xF3n",1,"btn-group","btn-group-sm"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"form-check","form-check-inline","mb-0"],[1,"row","g-2","mb-2"],[1,"col-12"],[1,"card"],[1,"card-body","py-2"],[1,"small","text-body-secondary","mb-2"],[4,"ngIf"],[1,"list-group","list-group-flush"],["type","button","class","list-group-item list-group-item-action py-2",3,"active","click",4,"ngFor","ngForOf","ngForTrackBy"],["type","button",1,"list-group-item","list-group-item-action","py-2",3,"click"],[1,"fw-semibold"],[1,"small","opacity-75"],[1,"alert","alert-info","py-2","mb-2"],[1,"small","mb-1"],[1,"small"],[1,"alert","alert-warning","py-2","mb-2"],[1,"alert","alert-danger","py-2","mb-2"],[1,"small","text-body-secondary"],["class","btn-group btn-group-sm","role","group","aria-label","Paginaci\xF3n calificaciones",4,"ngIf"],["role","group","aria-label","Paginaci\xF3n calificaciones",1,"btn-group","btn-group-sm"],[1,"table-responsive","cali-grid-wrap"],[1,"table","table-sm","table-bordered","align-middle","cali-grid"],[1,"sticky-col","col-meta"],["class","text-center",3,"width","ngClass",4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"text-center",3,"ngClass"],["class","text-body-secondary",4,"ngIf"],["class","table-secondary",4,"ngIf"],[1,"d-flex","align-items-start","justify-content-between","gap-2"],[1,"text-body-secondary","small"],["class","p-1",3,"ngClass",4,"ngFor","ngForOf","ngForTrackBy"],[1,"table-secondary"],[1,"p-1",3,"ngClass"],[4,"ngIf","ngIfElse"],["type","number","inputmode","numeric",1,"form-control","form-control-sm","text-center",3,"ngModelChange","focus","keydown","paste","readOnly","ngModel"],["type","number","inputmode","numeric",1,"form-control","form-control-sm","text-center","readonly-cell",3,"focus","keydown","paste","readOnly","value"],["tabindex","-1","role","dialog","aria-modal","true",1,"modal","fade","show","d-block"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Cerrar",1,"btn-close",3,"click"],[1,"modal-body","text-center"],["alt","Foto del estudiante",1,"img-fluid","rounded",3,"src"],[1,"text-body-secondary","small","mt-2"],[1,"modal-backdrop","fade","show",3,"click"]],template:function(e,i){e&1&&(r(0,"div",1)(1,"div",2)(2,"div")(3,"h5",3),c(4,"Editor de calificaciones (BD) tipo Excel"),a(),r(5,"small",4),c(6," Edita directo en celdas. Puedes copiar desde Excel y pegar (Ctrl+V) dentro de una celda; soporta pegar bloques (tab + saltos de l\xEDnea). "),a()(),r(7,"div",5)(8,"div",6)(9,"div",7)(10,"span",8),c(11,"Buscar inscripci\xF3n"),a(),r(12,"input",9),_("ngModelChange",function(l){return i.filterInfo=l})("keydown.enter",function(){return i.buscarInfo(1)}),a(),r(13,"button",10),_("click",function(){return i.buscarInfo(1)}),c(14," Buscar "),a()(),h(15,ze,5,2,"div",11),r(16,"button",12),_("click",function(){return i.limpiarInfo()}),c(17," Limpiar "),a()(),r(18,"div",13)(19,"button",14),_("click",function(){return i.setViewMode("intercalado")}),c(20," Intercalado (Eval1..4) "),a(),r(21,"button",14),_("click",function(){return i.setViewMode("agrupado")}),c(22," Agrupado (Teo/Prac) "),a()(),r(23,"div",6)(24,"div",15)(25,"span",4),c(26,"L\xEDmite Teo"),a(),r(27,"input",16),_("ngModelChange",function(l){return i.onMaxTeoricoInput(l)}),a()(),r(28,"div",15)(29,"span",4),c(30,"L\xEDmite Prac"),a(),r(31,"input",16),_("ngModelChange",function(l){return i.onMaxPracticoInput(l)}),a()(),r(32,"div",6)(33,"div",15)(34,"span",4),c(35,"Promedio usa"),a(),r(36,"select",17),_("ngModelChange",function(l){return i.onAvgEvalCountInput(l)}),r(37,"option",18),c(38,"1 eval"),a(),r(39,"option",18),c(40,"2 eval"),a(),r(41,"option",18),c(42,"3 eval"),a(),r(43,"option",18),c(44,"4 eval"),a()()()()(),r(45,"div",6)(46,"label",19)(47,"input",20),_("ngModelChange",function(l){return i.onShowSumColumnsChange(l)}),a(),r(48,"span",21),c(49,"Mostrar sumas"),a()(),r(50,"div",22)(51,"span",4),c(52,"Evaluaciones"),a(),h(53,He,4,1,"label",23)(54,We,4,1,"label",23)(55,Ye,4,1,"label",23)(56,qe,4,1,"label",23),a(),r(57,"button",24),_("click",function(){return i.setAllEvaluations(!0)}),c(58," Todas "),a()(),r(59,"button",12),_("click",function(){return i.focusCell(0,0)}),c(60," Ir a primera celda "),a(),r(61,"button",25),_("click",function(){return i.copyAllToClipboard()}),c(62," Copiar todo "),a(),r(63,"button",26),_("click",function(){return i.guardarCambios()}),c(64," Guardar cambios "),a()()(),h(65,Je,9,4,"div",27)(66,et,17,0,"div",28)(67,nt,4,2,"div",29)(68,ot,3,1,"div",30)(69,lt,17,6,"div",31)(70,gt,9,4,"div",32)(71,ft,11,3,"div",33)(72,ht,1,0,"div",34),a()),e&2&&(s(12),u("ngModel",i.filterInfo),s(),u("disabled",i.isLoadingInfo),s(2),u("ngIf",i.infoMeta),s(),u("disabled",!i.selectedInfo),s(3),M("btn-primary",i.viewMode==="intercalado")("btn-outline-primary",i.viewMode!=="intercalado"),s(2),M("btn-primary",i.viewMode==="agrupado")("btn-outline-primary",i.viewMode!=="agrupado"),s(6),u("ngModel",i.maxTeorico),s(4),u("ngModel",i.maxPractico),s(5),u("ngModel",i.avgEvalCount),s(),u("ngValue",1),s(2),u("ngValue",2),s(2),u("ngValue",3),s(2),u("ngValue",4),s(4),u("ngModel",i.showSumColumns),s(6),u("ngIf",i.visibleEvalCount>=1),s(),u("ngIf",i.visibleEvalCount>=2),s(),u("ngIf",i.visibleEvalCount>=3),s(),u("ngIf",i.visibleEvalCount>=4),s(3),u("disabled",i.rows.length===0),s(4),u("disabled",!i.selectedInfo||i.dirtyIds.size===0||i.isSaving),s(2),u("ngIf",i.infoItems.length>0),s(),u("ngIf",!i.selectedInfo),s(),u("ngIf",i.selectedInfo&&(i.isLoadingCalificaciones||i.isSaving)),s(),u("ngIf",i.saveError),s(),u("ngIf",i.selectedInfo),s(),u("ngIf",i.selectedInfo),s(),u("ngIf",i.photoModalOpen),s(),u("ngIf",i.photoModalOpen))},dependencies:[q,Q,X,ie,ne,Z,Pe,Ee,te,J,ke,Ve,ee],styles:['@charset "UTF-8";[_nghost-%COMP%]{display:block}.cali-grid-wrap[_ngcontent-%COMP%]{max-height:calc(100vh - 220px)}.cali-grid[_ngcontent-%COMP%]{border-collapse:separate;border-spacing:0}.cali-grid[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;z-index:3;background:var(--bs-body-bg)}.col-meta[_ngcontent-%COMP%]{min-width:240px;background:inherit}.sticky-col[_ngcontent-%COMP%]{position:sticky;left:0;z-index:2;background:var(--bs-body-bg)}.cali-grid[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th.col-meta[_ngcontent-%COMP%]{background:var(--bs-body-bg)}.cali-grid[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr.table-active[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .cali-grid[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr.table-active[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:var(--bs-table-active-bg)}.cali-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .cali-grid[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap}.readonly-cell[_ngcontent-%COMP%]{background:#0000000a}.cali-grid[_ngcontent-%COMP%]   td.eval-end[_ngcontent-%COMP%], .cali-grid[_ngcontent-%COMP%]   th.eval-end[_ngcontent-%COMP%]{border-right-width:3px;border-right-style:solid;border-right-color:color-mix(in srgb,var(--bs-body-color) 55%,var(--bs-border-color))}.cali-grid[_ngcontent-%COMP%]   td.section-start[_ngcontent-%COMP%], .cali-grid[_ngcontent-%COMP%]   th.section-start[_ngcontent-%COMP%]{border-left-width:3px;border-left-style:solid;border-left-color:color-mix(in srgb,var(--bs-body-color) 55%,var(--bs-border-color))}.cali-grid[_ngcontent-%COMP%]   td.cell-danger[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{color:var(--bs-danger);font-weight:600}.cali-grid[_ngcontent-%COMP%]   td.cell-danger[_ngcontent-%COMP%]   input.form-control.readonly-cell[_ngcontent-%COMP%]{color:var(--bs-danger)}.cali-grid[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%], .cali-grid[_ngcontent-%COMP%]   select.form-select[_ngcontent-%COMP%]{border-radius:0}']});var re=N;var bt=["modalgestioncontroles"];function vt(o,t){if(o&1&&(r(0,"option",25),c(1),a()),o&2){let e=t.$implicit;u("value",e),s(),b(e)}}function Ct(o,t){o&1&&(r(0,"div",29),c(1," Cargando controles... "),a())}function xt(o,t){if(o&1&&(r(0,"div",49),c(1),a()),o&2){let e=d().$implicit,i=d(3).$implicit,n=d(3);s(),Y(" ",n.labelEdadesCategoria(i),": ",e.Edades||"-"," ")}}function yt(o,t){if(o&1&&(r(0,"span",49),c(1),a()),o&2){let e=d().$implicit,i=d(6);s(),S("Instituci\xF3n: ",i.getNombreInstitucion(e)||(e.instituciones_id??"GLOBAL"))}}function St(o,t){o&1&&(r(0,"span",49),c(1,"|"),a())}function Et(o,t){if(o&1){let e=v();r(0,"div",44)(1,"div",45)(2,"div",46),c(3),a(),h(4,xt,2,2,"div",47)(5,yt,2,1,"span",47)(6,St,2,0,"span",47),r(7,"div",48)(8,"span",49),c(9,"Estado:"),a(),r(10,"button",50),_("click",function(n){let l=g(e).$implicit,m=d(6);return f(m.toggleEstadoFila(l,n))}),c(11),a(),r(12,"span",49),c(13,"|"),a(),r(14,"span",49),c(15,"Visibilidad:"),a(),r(16,"button",51),_("click",function(n){let l=g(e).$implicit,m=d(6);return f(m.toggleVisibilidadFila(l,n))}),c(17),a()()(),r(18,"div",52)(19,"button",53),_("click",function(){let n=g(e).$implicit,l=d(6);return f(l.Seleccionarcontroles(n.id))}),c(20,"Editar"),a(),r(21,"button",54),_("click",function(){let n=g(e).$implicit,l=d(6);return f(l.Eliminarcontroles(n.id))}),c(22,"Eliminar"),a()()()}if(o&2){let e=t.$implicit,i=d(3).$implicit,n=d(3);s(3),b(e.ParaI),s(),u("ngIf",n.showEdadesCategoria(i)),s(),u("ngIf",n.esSuperlcchs),s(),u("ngIf",n.esSuperlcchs),s(4),u("ngClass",e.Estado==="ACTIVO"?"btn-outline-success":"btn-outline-secondary")("disabled",n.isTogglingEstado(e.id)),s(),S(" ",e.Estado," "),s(5),u("ngClass",e.Visibilidad==="VISIBLE"?"btn-outline-primary":"btn-outline-secondary")("disabled",n.isTogglingVisibilidad(e.id)),s(),S(" ",e.Visibilidad," ")}}function It(o,t){if(o&1&&(r(0,"div",42),h(1,Et,23,10,"div",43),a()),o&2){let e=d().ngIf;s(),u("ngForOf",e)}}function Tt(o,t){o&1&&(r(0,"div",55),c(1,"Sin datos"),a())}function Pt(o,t){if(o&1){let e=v();r(0,"div",34)(1,"div",35)(2,"div",36)(3,"h4",37),c(4),a()(),r(5,"div",38),c(6),a(),r(7,"button",39),_("click",function(){g(e);let n=d().$implicit,l=d(3);return f(l.abrirNuevoPorCategoria(n))}),c(8," Nuevo "),a()(),r(9,"div",40),h(10,It,2,1,"div",41)(11,Tt,2,0,"ng-template",null,1,j),a()()}if(o&2){let e=t.ngIf,i=$(12),n=d().$implicit;s(4),S("",n," "),s(2),S(" ",e.length," item(s) "),s(4),u("ngIf",e.length>0)("ngIfElse",i)}}function wt(o,t){if(o&1&&(r(0,"div",32),h(1,Pt,13,4,"div",33),a()),o&2){let e=t.$implicit,i=d(3);s(),u("ngIf",i.getControlesPorCategoria(e))}}function Mt(o,t){if(o&1&&(r(0,"div",30),h(1,wt,2,1,"div",31),a()),o&2){let e=d(2);s(),u("ngForOf",e.categoriasParaMostrar)}}function Vt(o,t){if(o&1&&(r(0,"div",26),h(1,Ct,2,0,"div",27)(2,Mt,2,1,"div",28),a()),o&2){let e=d();s(),u("ngIf",e.isLoadingcontroles),s(),u("ngIf",!e.isLoadingcontroles)}}function kt(o,t){o&1&&(r(0,"th",67),c(1,"NombreInstitucion"),a())}function At(o,t){if(o&1&&(r(0,"tr")(1,"td",59)(2,"div",68)(3,"span",69),c(4,"Cargando..."),a()()()()),o&2){let e=d(2);s(),V("colspan",e.esSuperlcchs?9:8)}}function Ot(o,t){if(o&1&&(r(0,"tr")(1,"td",59),c(2,"No hay datos disponibles"),a()()),o&2){let e=d(2);s(),V("colspan",e.esSuperlcchs?9:8)}}function Rt(o,t){if(o&1&&(r(0,"td"),c(1),a()),o&2){let e=d().$implicit,i=d(2);s(),b(i.getNombreInstitucion(e))}}function Nt(o,t){if(o&1&&x(0,"img",76),o&2){let e=d(3);u("src",e._tools.rutabtniconsanimaciones+"pencil.svg",D)}}function Ft(o,t){if(o&1&&x(0,"ng-lottie",77),o&2){let e=d(3);u("options",e._tools.optionsEditar)}}function Lt(o,t){if(o&1&&x(0,"img",76),o&2){let e=d(3);u("src",e._tools.rutabtniconsanimaciones+"delete.svg",D)}}function Dt(o,t){if(o&1&&x(0,"ng-lottie",77),o&2){let e=d(3);u("options",e._tools.optionsEliminar)}}function $t(o,t){if(o&1){let e=v();r(0,"tr",70),_("contextmenu",function(n){let l=g(e).$implicit,m=d(2);return f(m.abrirMenucontroles(n,l))}),r(1,"td",59),c(2),a(),r(3,"td"),c(4),a(),h(5,Rt,2,1,"td",62),r(6,"td"),c(7),a(),r(8,"td"),c(9),a(),r(10,"td"),c(11),a(),r(12,"td")(13,"button",50),_("click",function(n){let l=g(e).$implicit,m=d(2);return f(m.toggleEstadoFila(l,n))}),c(14),a()(),r(15,"td")(16,"button",51),_("click",function(n){let l=g(e).$implicit,m=d(2);return f(m.toggleVisibilidadFila(l,n))}),c(17),a()(),r(18,"td",71)(19,"button",72),_("click",function(){let n=g(e).$implicit,l=d(2);return f(l.Seleccionarcontroles(n.id))})("mouseenter",function(){let n=g(e).$implicit,l=d(2);return f(l._tools.hoverBotonMap["edicioncontroles-"+n.id]=!0)})("mouseleave",function(){let n=g(e).$implicit,l=d(2);return f(l._tools.hoverBotonMap["edicioncontroles-"+n.id]=!1)}),h(20,Nt,1,1,"img",73)(21,Ft,1,1,"ng-lottie",74),a(),r(22,"button",75),_("click",function(){let n=g(e).$implicit,l=d(2);return f(l.Eliminarcontroles(n.id))})("mouseenter",function(){let n=g(e).$implicit,l=d(2);return f(l._tools.hoverBotonMap["eliminacioncontroles-"+n.id]=!0)})("mouseleave",function(){let n=g(e).$implicit,l=d(2);return f(l._tools.hoverBotonMap["eliminacioncontroles-"+n.id]=!1)}),h(23,Lt,1,1,"img",73)(24,Dt,1,1,"ng-lottie",74),a()()()}if(o&2){let e=t.index,i=t.$implicit,n=d(2);s(2),b((n.paginacontroles-1)*n.pageSizecontroles+(e+1)),s(2),b(i.instituciones_id??"GLOBAL"),s(),u("ngIf",n.esSuperlcchs),s(2),b(i.Categoria),s(2),b(i.ParaI),s(2),b(i.Edades),s(2),u("ngClass",i.Estado==="ACTIVO"?"btn-outline-success":"btn-outline-secondary")("disabled",n.isTogglingEstado(i.id)),s(),S(" ",i.Estado," "),s(2),u("ngClass",i.Visibilidad==="VISIBLE"?"btn-outline-primary":"btn-outline-secondary")("disabled",n.isTogglingVisibilidad(i.id)),s(),S(" ",i.Visibilidad," "),s(3),u("ngIf",!n._tools.hoverBotonMap["edicioncontroles-"+i.id]),s(),u("ngIf",n._tools.hoverBotonMap["edicioncontroles-"+i.id]),s(2),u("ngIf",!n._tools.hoverBotonMap["eliminacioncontroles-"+i.id]),s(),u("ngIf",n._tools.hoverBotonMap["eliminacioncontroles-"+i.id])}}function Bt(o,t){if(o&1&&(r(0,"option",25),c(1),a()),o&2){let e=t.$implicit;u("value",e),s(),S("",e," por p\xE1gina")}}function Kt(o,t){if(o&1){let e=v();r(0,"div",26)(1,"div",56)(2,"table",57)(3,"thead",58)(4,"tr")(5,"th",59),c(6,"#"),a(),r(7,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("instituciones_id",n))}),c(8,"Instituci\xF3n"),a(),h(9,kt,2,0,"th",61),r(10,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("Categoria",n))}),c(11,"Categoria"),a(),r(12,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("ParaI",n))}),c(13,"ParaI"),a(),r(14,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("Edades",n))}),c(15,"Edades"),a(),r(16,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("Estado",n))}),c(17,"Estado"),a(),r(18,"th",60),_("click",function(n){g(e);let l=d();return f(l.sortBycontroles("Visibilidad",n))}),c(19,"Visibilidad"),a(),r(20,"th",59),c(21,"ACCIONES"),a()()(),r(22,"tbody"),h(23,At,5,1,"tr",62)(24,Ot,3,1,"tr",62)(25,$t,25,16,"tr",63),Ce(26,"slice"),a()()(),r(27,"div",64)(28,"ngb-pagination",65),G("pageChange",function(n){g(e);let l=d();return K(l.paginacontroles,n)||(l.paginacontroles=n),f(n)}),a(),r(29,"select",66),G("ngModelChange",function(n){g(e);let l=d();return K(l.pageSizecontroles,n)||(l.pageSizecontroles=n),f(n)}),_("change",function(){g(e);let n=d();return f(n.onPageSizeChangecontroles())}),h(30,Bt,2,2,"option",23),a()()()}if(o&2){let e=d();s(9),u("ngIf",e.esSuperlcchs),s(14),u("ngIf",e.isLoadingcontroles),s(),u("ngIf",!e.isLoadingcontroles&&(!e.controles||e.controles.length===0)),s(),u("ngForOf",xe(26,13,e.controlesFiltrados,(e.paginacontroles-1)*e.pageSizecontroles,e.paginacontroles*e.pageSizecontroles)),s(3),B("page",e.paginacontroles),u("collectionSize",e.controlesFiltrados.length)("pageSize",e.pageSizecontroles)("maxSize",5)("rotate",!0)("ellipses",!1)("boundaryLinks",!0),s(),B("ngModel",e.pageSizecontroles),s(),u("ngForOf",e.pageSizeOptionscontroles)}}function Gt(o,t){if(o&1&&(r(0,"option",97),c(1),a()),o&2){let e=t.$implicit;u("ngValue",e.id),s(),b(e.Nombre)}}function jt(o,t){if(o&1&&(r(0,"div",84)(1,"select",96)(2,"option",97),c(3,"GLOBAL"),a(),h(4,Gt,2,2,"option",98),a(),r(5,"label"),c(6,"Instituci\xF3n"),a()()),o&2){let e=d(2);s(2),u("ngValue",""),s(2),u("ngForOf",e.institucionesInfo)}}function Ut(o,t){if(o&1&&(r(0,"option",25),c(1),a()),o&2){let e=t.$implicit;u("value",e),s(),b(e)}}function zt(o,t){if(o&1&&(r(0,"div",84),x(1,"input",99),r(2,"label"),c(3),a()()),o&2){let e=d(2);s(3),b(e.labelNivelCurso)}}function Ht(o,t){if(o&1&&(r(0,"div",84),x(1,"input",100),r(2,"label"),c(3),a()()),o&2){let e=d(2);s(3),b(e.labelEdades)}}function Wt(o,t){if(o&1&&(r(0,"option",25),c(1),a()),o&2){let e=t.$implicit;u("value",e),s(),b(e)}}function Yt(o,t){if(o&1&&(r(0,"option",25),c(1),a()),o&2){let e=t.$implicit;u("value",e),s(),b(e)}}function qt(o,t){if(o&1){let e=v();r(0,"button",103),_("click",function(){g(e);let n=d(3);return f(n.AutoCompletarLastcontroles())}),r(1,"span",104),x(2,"ng-lottie",105),a(),r(3,"span"),c(4,"AUTO COMPLETAR "),a(),x(5,"span",10),a()}if(o&2){let e=d(3);s(2),u("options",e._tools.optionsautocompletar)}}function Qt(o,t){if(o&1&&(r(0,"div",101),h(1,qt,6,1,"button",102),a()),o&2){let e=d(2);s(),u("ngIf",!e.AnimacionCargabtnModalcontroles)}}function Xt(o,t){if(o&1){let e=v();r(0,"button",106),_("click",function(){g(e);let n=d().$implicit,l=d();return n.dismiss(),f(l.resetcontroles())}),r(1,"span",104),x(2,"ng-lottie",105),a(),r(3,"span"),c(4,"CANCELAR"),a(),x(5,"span",10),a()}if(o&2){let e=d(2);s(2),u("options",e._tools.optionscancelar)}}function Zt(o,t){if(o&1){let e=v();r(0,"button",107),_("click",function(){g(e);let n=d(2);return f(n.AgregarModificarcontroles())}),x(1,"span",108),a()}o&2&&u("disabled",!0)}function Jt(o,t){if(o&1){let e=v();r(0,"button",109),_("click",function(){g(e);let n=d(2);return f(n.AgregarModificarcontroles())}),r(1,"span",104),x(2,"ng-lottie",105),a(),r(3,"span"),c(4),a(),x(5,"span",10),a()}if(o&2){let e,i,n=d(2);s(2),u("options",(e=n.newcontroles.get("id"))!=null&&e.value?n._tools.optionsEditar:n._tools.optionsAdicionar),s(2),b((i=n.newcontroles.get("id"))!=null&&i.value?"MODIFICAR":"REGISTRAR")}}function ei(o,t){if(o&1){let e=v();r(0,"div",78)(1,"h4",79),c(2),a(),r(3,"button",80),_("click",function(){let n=g(e).$implicit,l=d();return n.dismiss(),f(l.resetcontroles())}),a()(),r(4,"div",81)(5,"form",82),h(6,jt,7,2,"div",83),r(7,"div",84)(8,"select",85)(9,"option",22),c(10,"SELECCIONE"),a(),h(11,Ut,2,2,"option",23),a(),r(12,"label"),c(13,"Categoria"),a()(),r(14,"div",84),x(15,"input",86),r(16,"label"),c(17),a()(),h(18,zt,4,1,"div",83)(19,Ht,4,1,"div",83),r(20,"div",84)(21,"select",87),h(22,Wt,2,2,"option",23),a(),r(23,"label"),c(24,"Estado"),a()(),r(25,"div",84)(26,"select",88),h(27,Yt,2,2,"option",23),a(),r(28,"label"),c(29,"Visibilidad"),a()()()(),r(30,"div",89),h(31,Qt,2,1,"div",90),r(32,"div",91),h(33,Xt,6,1,"button",92),a(),r(34,"div",93),h(35,Zt,2,1,"button",94)(36,Jt,6,2,"button",95),a()()}if(o&2){let e,i=d();s(2),S("",(e=i.newcontroles.get("id"))!=null&&e.value?"Modificar":"Registrar"," control"),s(3),u("formGroup",i.newcontroles),s(),u("ngIf",i.esSuperlcchs),s(5),u("ngForOf",i.categoriasOptionsForm),s(6),b(i.labelParaI),s(),u("ngIf",i.showNivelCurso),s(),u("ngIf",i.showEdades),s(3),u("ngForOf",i.estadoOptions),s(5),u("ngForOf",i.visibilidadOptions),s(4),u("ngIf",!i.newcontroles.get("id").value),s(2),u("ngIf",!i.AnimacionCargabtnModalcontroles),s(2),u("ngIf",i.AnimacionCargabtnModalcontroles),s(),u("ngIf",!i.AnimacionCargabtnModalcontroles)}}var F=class F{constructor(t,e,i,n){this._cont=t;this._tools=e;this._auth=i;this._inst=n;this.esSuperlcchs=!1;this.esAdministrativo=!1;this.institucionesIdSesion=null;this.institucionesInfo=[];this.institucionesById=new Map;this.estadoOptions=["ACTIVO","INACTIVO"];this.visibilidadOptions=["VISIBLE","OCULTO"];this.categoriasGlobales=["CARGOS SUPERADMINISTRATIVOS","PERMISO","ESTADO","VISIBILIDAD","SEXO","CARACTER\xCDSTICAS DE INSTITUCI\xD3N","EDICI\xD3N DE INSCRIPCIONES","EDICI\xD3N DE CALIFICACIONES","PREDETERMINADO","TIPOS SUPERADMINISTRATIVOS","TIPOS PLANTEL ADMINISTRATIVOS","TIPOS DOCENTES","ESTADO DE HABILITACI\xD3N","TIPOS MATERIAS","MODOS MATERIAS","RELACI\xD3N DOCENTE ESTUDIANTES","PROGRAMA","MODALIDAD","TIPO DE ESTUDIANTE"];this.categoriasPorInstitucion=["CARGOS ADMINISTRATIVOS","CARGOS DOCENTES","NIVEL DE CARRERA","ESPECIALIDAD","ESPECIALIDAD SECUNDARIA","LVLCURSO","NIVEL EN COLEGIO","GRADO DE COLEGIO","TIPO COLEGIO","TIPO REGISTRO DE MATERIA","ESTADO PAGO","EXPEDIDO","TURNO","VERIFICACI\xD3N INSCRIPCIONES"];this.togglingEstadoIds=new Set;this.togglingVisibilidadIds=new Set;this.viewMode="interactive";this.categoriaFiltro="";this.menuStatecontroles$=this._tools.state$;this.controles=[];this.paginacontroles=1;this.isLoadingcontroles=!0;this.AnimacionCargabtnModalcontroles=!1;this.filtertxtcontroles="";this.collectionSizecontroles=0;this.pageSizecontroles=10;this.pageSizeOptionscontroles=[5,10,20,50];this.sortColumnscontroles=[]}get categoriasOptions(){return this.esSuperlcchs?[...this.categoriasGlobales,...this.categoriasPorInstitucion]:[...this.categoriasPorInstitucion]}get categoriasOptionsForm(){return this.categoriasOptions}ngOnInit(){this.newcontroles=this._cont.createFormGroupcontroles(),this.newcontrolesAnteriorAccion=this._cont.createFormGroupcontroles(),this.setupCategoriaWatcher(),this.cargarSesionYPermisos()}cargarSesionYPermisos(){this._auth.pedirPerfil().subscribe({next:t=>{let e=(t?.tipo??"").toString().toLowerCase();this.esSuperlcchs=e==="superlcchs",this.esAdministrativo=e==="planteladministrativos";let i=Number(t?.usuario?.instituciones_id??0);this.institucionesIdSesion=Number.isFinite(i)&&i>0?i:null,this.applyCategoriaRules(),this.esSuperlcchs&&this._inst.Obtenerinstituciones().subscribe({next:n=>{this.institucionesInfo=n?.data||[],this.institucionesById=new Map((this.institucionesInfo||[]).map(l=>[String(l?.id??""),l]))},error:()=>{this.institucionesInfo=[],this.institucionesById=new Map}}),this.Cargarcontroles()},error:()=>{this.esSuperlcchs=!1,this.esAdministrativo=!1,this.institucionesIdSesion=null,this.applyCategoriaRules(),this.Cargarcontroles()}})}upperTrim(t){return(t??"").toString().trim().toUpperCase()}isCategoriaGlobal(t){return this.categoriasGlobales.includes(t)}puedeEditarFila(t){if(this.esSuperlcchs)return!0;let e=Number(this.institucionesIdSesion??0),i=Number(t?.instituciones_id??0);return e>0&&i===e}getNombreInstitucion(t){let e=(t?.NombreInstitucion??t?.nombre_institucion??t?.institucion_nombre??"").toString().trim();if(e)return e;let i=String(t?.instituciones_id??""),n=this.institucionesById.get(i);return(n?.Nombre??n?.nombre??"").toString().trim()}get categoriaActual(){return this.upperTrim(this.newcontroles?.get("Categoria")?.value)}get categoriaFiltroActual(){return this.upperTrim(this.categoriaFiltro)}get categoriasParaMostrar(){let t=this.categoriaFiltroActual;return t?this.categoriasOptions.filter(e=>this.upperTrim(e)===t):this.categoriasOptions}get showEdades(){return this.categoriaActual==="LVLCURSO"||this.categoriaActual==="TURNO"}categoriaUsaNivelCurso(t){let e=this.upperTrim(t);return e==="TIPOS DOCENTES"||e==="MODOS MATERIAS"||e==="RELACI\xD3N DOCENTE ESTUDIANTES"}get showNivelCurso(){let t=this.categoriaActual,e=(this.newcontroles?.get("NivelCurso")?.value??"").toString().trim();return this.categoriaUsaNivelCurso(t)||e.length>0}get labelNivelCurso(){switch(this.categoriaActual){case"TIPOS DOCENTES":case"MODOS MATERIAS":case"RELACI\xD3N DOCENTE ESTUDIANTES":return"Detalle";default:return"NivelCurso"}}get labelEdades(){return this.categoriaActual==="TURNO"?"Horas":"Edades"}get labelParaI(){switch(this.categoriaActual){case"LVLCURSO":return"Nivel/Curso";case"TURNO":return"Turno";case"EXPEDIDO":return"Sigla";default:return"Valor"}}applyCategoriaRules(){let t=this.categoriaActual;t&&this.newcontroles.get("Categoria")?.value!==t&&this.newcontroles.get("Categoria")?.setValue(t,{emitEvent:!1});let e=this.upperTrim(this.newcontroles.get("Estado")?.value);this.estadoOptions.includes(e)||this.newcontroles.get("Estado")?.setValue("ACTIVO",{emitEvent:!1});let i=this.upperTrim(this.newcontroles.get("Visibilidad")?.value);this.visibilidadOptions.includes(i)||this.newcontroles.get("Visibilidad")?.setValue("VISIBLE",{emitEvent:!1});let n=this.newcontroles.get("instituciones_id");n&&(this.esSuperlcchs?t&&this.isCategoriaGlobal(t)?(n.setValue("",{emitEvent:!1}),n.disable({emitEvent:!1})):n.enable({emitEvent:!1}):(this.institucionesIdSesion&&n.setValue(this.institucionesIdSesion,{emitEvent:!1}),n.disable({emitEvent:!1}))),this.showEdades||this.newcontroles.get("Edades")?.setValue("",{emitEvent:!1}),this.showNivelCurso||this.newcontroles.get("NivelCurso")?.setValue("",{emitEvent:!1})}buildPayloadFromForm(){let t=this.newcontroles.getRawValue(),e=pe({},t);return delete e.created_at,delete e.updated_at,this.showEdades||(e.Edades=""),this.showNivelCurso||(e.NivelCurso=""),e}setViewMode(t){this.viewMode=t,this.paginacontroles=1}onCategoriaFiltroChange(){this.paginacontroles=1}get controlesFiltrados(){let t=this.categoriaFiltroActual,e=this.upperTrim(this.filtertxtcontroles);return(this.controles||[]).filter(i=>{if(t&&this.upperTrim(i?.Categoria)!==t)return!1;if(!e)return!0;let n=[i?.instituciones_id,i?.Categoria,i?.ParaI,i?.Edades,i?.Estado,i?.Visibilidad].map(l=>(l??"").toString()).join(" ");return this.upperTrim(n).includes(e)})}getControlesPorCategoria(t){let e=this.upperTrim(t);return this.controlesFiltrados.filter(i=>this.upperTrim(i?.Categoria)===e)}labelEdadesCategoria(t){return this.upperTrim(t)==="TURNO"?"Horas":"Edades"}showEdadesCategoria(t){let e=this.upperTrim(t);return e==="LVLCURSO"||e==="TURNO"}abrirNuevoPorCategoria(t){this.resetcontroles();let e=this.upperTrim(t);e&&(this.newcontroles.get("Categoria")?.setValue(e),this.applyCategoriaRules()),this.modalGestioncontrolesRef=this._tools.openModal(this.modalgestioncontroles,"xl")}isTogglingEstado(t){return this.togglingEstadoIds.has(Number(t))}isTogglingVisibilidad(t){return this.togglingVisibilidadIds.has(Number(t))}toggleEstadoFila(t,e){if(e?.stopPropagation(),!this.puedeEditarFila(t)){this._tools.MostrarMensaje("warning","No autorizado");return}let i=Number(t?.id);if(!Number.isFinite(i)||i<=0||this.togglingEstadoIds.has(i))return;let n=this.upperTrim(t?.Estado),l=n==="ACTIVO"?"INACTIVO":"ACTIVO";this.togglingEstadoIds.add(i),t.Estado=l,this._cont.Modificarcontroles({id:i,Estado:l},i).subscribe({next:m=>{t.Estado=this.upperTrim(m?.data?.Estado??l)},error:m=>{console.error("Error toggling Estado",m),t.Estado=n},complete:()=>{this.togglingEstadoIds.delete(i)}})}toggleVisibilidadFila(t,e){if(e?.stopPropagation(),!this.puedeEditarFila(t)){this._tools.MostrarMensaje("warning","No autorizado");return}let i=Number(t?.id);if(!Number.isFinite(i)||i<=0||this.togglingVisibilidadIds.has(i))return;let n=this.upperTrim(t?.Visibilidad),l=n==="VISIBLE"?"OCULTO":"VISIBLE";this.togglingVisibilidadIds.add(i),t.Visibilidad=l,this._cont.Modificarcontroles({id:i,Visibilidad:l},i).subscribe({next:m=>{t.Visibilidad=this.upperTrim(m?.data?.Visibilidad??l)},error:m=>{console.error("Error toggling Visibilidad",m),t.Visibilidad=n},complete:()=>{this.togglingVisibilidadIds.delete(i)}})}setupCategoriaWatcher(){this.categoriaSub&&(this.categoriaSub.unsubscribe(),this.categoriaSub=void 0),this.categoriaSub=this.newcontroles.get("Categoria")?.valueChanges.subscribe(()=>{this.applyCategoriaRules()}),this.applyCategoriaRules()}closeMenu(){this._tools.close()}abrirMenucontroles(t,e){t.preventDefault(),t.stopPropagation();let i=[{label:"\u270F Editar",action:()=>this.Seleccionarcontroles(e.id)},{label:"\u{1F5D1}\uFE0F Eliminar",action:()=>this.Eliminarcontroles(e.id)}];this._tools.open(t.clientX,t.clientY,i)}Cargarcontroles(){this.isLoadingcontroles=!0,this._cont.Obtenercontroles().subscribe({next:t=>{let e=t.data||[];if(!this.esSuperlcchs&&this.institucionesIdSesion){let i=Number(this.institucionesIdSesion);this.controles=e.filter(n=>Number(n?.instituciones_id??0)===i)}else this.esSuperlcchs?this.controles=e:this.controles=[];this.collectionSizecontroles=this.controles.length,this.isLoadingcontroles=!1},error:t=>{console.error("Error al cargar controles",t),this.controles=[],this.collectionSizecontroles=0,this.isLoadingcontroles=!1}})}AgregarModificarcontroles(){if(this.newcontroles.invalid){this.ValidacionTodoElementocontroles(),this._tools.MostrarMensajeFrmIncompleto(),this.AnimacionCargabtnModalcontroles=!1;return}this.AnimarCargaTablacontroles(),this.AnimacionCargabtnModalcontroles=!0,this._tools.MostrarMensajeLoading(),this.newcontrolesAnteriorAccion.patchValue(this.newcontroles.getRawValue());let t=this.newcontroles.controls.id.value,e=this.buildPayloadFromForm();t?this._cont.Modificarcontroles(e,e.id).subscribe(i=>{this.Cargarcontroles(),this.resetcontroles(),this.AnimacionCargabtnModalcontroles=!1,this._tools.MostrarMensajeSuccess()},i=>{console.log("ERROR AL MODIFICAR controles",i),this.AnimacionCargabtnModalcontroles=!1,this._tools.MostrarMensajeError()}):this._cont.Agregarcontroles(e).subscribe(i=>{this.Cargarcontroles(),this.resetcontroles(),this.AnimacionCargabtnModalcontroles=!1,this._tools.MostrarMensajeSuccess()},i=>{console.log("ERROR AL A\xD1ADIR controles",i),this.AnimacionCargabtnModalcontroles=!1,this._tools.MostrarMensajeError()})}Seleccionarcontroles(t){if(this._tools.MostrarMensajeLoading(),!t)return;let e=this.controles.find(i=>i.id===t);if(e){if(!this.puedeEditarFila(e)){this._tools.MostrarMensaje("warning","No autorizado");return}this._cont.Seleccionarcontroles(t).subscribe(i=>{Object.keys(this.newcontroles.controls).forEach(n=>{this.newcontroles.controls[n].setValue(i.data[n])}),this.newcontrolesAnteriorAccion.patchValue(this.newcontroles.getRawValue()),this.applyCategoriaRules(),this.modalGestioncontrolesRef=this._tools.openModal(this.modalgestioncontroles,"xl"),this._tools.MostrarMensajeSuccess()},i=>{console.log("ERROR AL SELECCIONAR controles",i),this._tools.MostrarMensajeError()})}}Eliminarcontroles(t){let e=this.controles.find(i=>i.id===t);if(e&&!this.puedeEditarFila(e)){this._tools.MostrarMensaje("warning","No autorizado");return}this._tools.mostrarMensajeConfirm("\xBFSEGURO QUE DESEA ELIMINAR?","SE ELIMINARA EL DATO Y NO SE PODR\xC1 RECUPERAR EL DATO","warning","SI, ESTOY SEGURO","NO").then(i=>{i&&(this._tools.MostrarMensajeLoading(),this._cont.Eliminarcontroles(t).subscribe(n=>{this.Cargarcontroles(),this._tools.MostrarMensajeSuccess()},n=>{console.log("ERROR AL ELIMINAR controles",n),this._tools.MostrarMensajeError()}))})}resetcontroles(){this.newcontroles=this._cont.createFormGroupcontroles(),this.setupCategoriaWatcher(),this._tools.closeModal(this.modalGestioncontrolesRef)}AutoCompletarLastcontroles(){this.newcontroles.patchValue(this.newcontrolesAnteriorAccion.getRawValue()),this.newcontroles.patchValue({id:0})}AnimarCargaTablacontroles(){this.controles=[],this.isLoadingcontroles=!0}ValidacioncontrolesxElemento(t){return this._tools.obtenerValidationClass(this.newcontroles,t)}ValidacionTodoElementocontroles(){Object.values(this.newcontroles.controls).forEach(t=>{t.markAsTouched(),t.markAsDirty()})}onPageSizeChangecontroles(){this.paginacontroles=1}sortBycontroles(t,e){this.sortColumnscontroles=this._tools.handleSort(t,e,this.sortColumnscontroles),this.controles=this._tools.applyMultiSort(this.controles,this.sortColumnscontroles)}isSortedcontroles(t){return this._tools.isSorted(this.sortColumnscontroles,t)}getSortDircontroles(t){return this._tools.getSortDirection(this.sortColumnscontroles,t)}};F.\u0275fac=function(e){return new(e||F)(P(Fe),P(Ne),P(oe),P(Ae))},F.\u0275cmp=R({type:F,selectors:[["app-controles"]],viewQuery:function(e,i){if(e&1&&fe(bt,7),e&2){let n;he(n=be())&&(i.modalgestioncontroles=n.first)}},hostBindings:function(e,i){e&1&&_("click",function(){return i.closeMenu()},H)},standalone:!1,decls:41,vars:11,consts:[["modalgestioncontroles",""],["emptyCat",""],[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-4","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"button","col-sm-3","d-flex","justify-content-start"],[1,"btn","mouse-dir","primary","d-flex","align-items-center",2,"gap","8px",3,"click"],["width","30px","height","30px",3,"options"],[1,"dir-part"],[1,"col-sm-3","ms-auto","d-flex","justify-content-end"],[1,"input-group"],[1,"input-group-text"],[1,"form-floating"],["type","text","placeholder","Buscar","title","Filtrar/Buscar",1,"form-control",3,"input","ngModelChange","ngModel"],[1,"row","mt-3","align-items-end",2,"row-gap","10px"],[1,"col-sm-4"],["role","group","aria-label","Modo",1,"btn-group"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"col-sm-5"],[1,"form-select",3,"ngModelChange","change","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","mt-4",4,"ngIf"],[3,"value"],[1,"mt-4"],["class","alert alert-secondary","style","margin-bottom: 0;",4,"ngIf"],["class","row","style","row-gap: 14px;",4,"ngIf"],[1,"alert","alert-secondary",2,"margin-bottom","0"],[1,"row",2,"row-gap","14px"],["class","col-12",4,"ngFor","ngForOf"],[1,"col-12"],["class","card",4,"ngIf"],[1,"card"],[1,"card-header","d-flex","align-items-center","justify-content-between","col-sm-12",2,"gap","10px"],[1,"col-sm-8"],[1,"fw-bold","text-center","text-danger"],[1,"small","text-secondary","col-sm-2"],[1,"btn","btn-outline-primary","btn-sm",3,"click"],[1,"card-body",2,"padding","0"],["class","list-group list-group-flush",4,"ngIf","ngIfElse"],[1,"list-group","list-group-flush"],["class","list-group-item d-flex align-items-center justify-content-between flex-row","style","gap: 12px;",4,"ngFor","ngForOf"],[1,"list-group-item","d-flex","align-items-center","justify-content-between","flex-row",2,"gap","12px"],[1,"d-flex","align-items-center","flex-wrap","justify-content-between",2,"gap","12px","min-width","0","width","100%"],[1,"fw-semibold","text-truncate",2,"max-width","180px"],["class","small text-secondary",4,"ngIf"],[1,"d-flex","align-items-center","ms-auto",2,"gap","8px"],[1,"small","text-secondary"],["type","button","title","Cambiar Estado",1,"btn","btn-sm",3,"click","ngClass","disabled"],["type","button","title","Cambiar Visibilidad",1,"btn","btn-sm",3,"click","ngClass","disabled"],[1,"d-flex",2,"gap","8px","flex-shrink","0"],["title","Editar",1,"btn","btn-outline-warning","btn-sm",3,"click"],["title","Eliminar",1,"btn","btn-outline-danger","btn-sm",3,"click"],[1,"p-3","text-center","text-secondary"],[1,"table-responsive"],[1,"table","table-striped","table-hover","table-sm","align-middle"],[1,""],[1,"text-center"],[2,"user-select","none",3,"click"],["style","user-select:none;",4,"ngIf"],[4,"ngIf"],["style","cursor: pointer;",3,"contextmenu",4,"ngFor","ngForOf"],[1,"d-flex","justify-content-center","mt-3"],["previousLabel","Anterior","nextLabel","Siguiente",3,"pageChange","page","collectionSize","pageSize","maxSize","rotate","ellipses","boundaryLinks"],[1,"form-select",2,"width","auto",3,"ngModelChange","change","ngModel"],[2,"user-select","none"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[2,"cursor","pointer",3,"contextmenu"],[1,"text-center","d-flex","justify-content-center","align-items-center",2,"gap","5px"],["title","Modificar informaci\xF3n",1,"btn","btn-outline-warning","btn-sm","d-flex","justify-content-center","align-items-center","p-0",2,"width","40px","height","40px","overflow","hidden",3,"click","mouseenter","mouseleave"],["width","20",3,"src",4,"ngIf"],["width","30px","height","35px",3,"options",4,"ngIf"],["title","Eliminar informaci\xF3n",1,"btn","btn-outline-danger","btn-sm","d-flex","justify-content-center","align-items-center","p-0",2,"width","40px","height","40px","overflow","hidden",3,"click","mouseenter","mouseleave"],["width","20",3,"src"],["width","30px","height","35px",3,"options"],[1,"modal-header"],[1,"modal-title"],["type","button","title","cerrar",1,"btn-close",3,"click"],[1,"modal-body"],["novalidate","",3,"formGroup"],["class","form-floating mb-3 col-sm-12",4,"ngIf"],[1,"form-floating","mb-3","col-sm-12"],["formControlName","Categoria",1,"form-select"],["type","text","placeholder","","formControlName","ParaI",1,"form-control",2,"text-transform","uppercase"],["formControlName","Estado",1,"form-select"],["formControlName","Visibilidad",1,"form-select"],[1,"modal-footer"],["class","button d-flex justify-content-start",4,"ngIf"],[1,"button","me-2"],["title","Cancelar y cerrar","class","btn mouse-dir secondary d-flex align-items-center","style"," gap: 8px;",3,"click",4,"ngIf"],[1,"button"],["class","btn mouse-dir success","title","Procesando informaci\xF3n",3,"disabled","click",4,"ngIf"],["class","btn mouse-dir primary d-flex align-items-center","style"," gap: 8px;","title","Accionar",3,"click",4,"ngIf"],["formControlName","instituciones_id",1,"form-select"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["type","text","placeholder","","formControlName","NivelCurso",1,"form-control",2,"text-transform","uppercase"],["type","text","placeholder","","formControlName","Edades",1,"form-control",2,"text-transform","uppercase"],[1,"button","d-flex","justify-content-start"],["title","Se Autocompletar\xE1 la ultima informaci\xF3n","class","btn mouse-dir secondary d-flex align-items-center","style"," gap: 8px;",3,"click",4,"ngIf"],["title","Se Autocompletar\xE1 la ultima informaci\xF3n",1,"btn","mouse-dir","secondary","d-flex","align-items-center",2,"gap","8px",3,"click"],[2,"display","flex","align-items","center","justify-content","center","width","30px","height","30px"],["width","50px","height","50px",3,"options"],["title","Cancelar y cerrar",1,"btn","mouse-dir","secondary","d-flex","align-items-center",2,"gap","8px",3,"click"],["title","Procesando informaci\xF3n",1,"btn","mouse-dir","success",3,"click","disabled"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm"],["title","Accionar",1,"btn","mouse-dir","primary","d-flex","align-items-center",2,"gap","8px",3,"click"]],template:function(e,i){if(e&1){let n=v();r(0,"div",2)(1,"div",3)(2,"div",4)(3,"h1",5),c(4,"Gesti\xF3n de controles"),a(),r(5,"p",6),c(6,"Administra los controles (selects/autocompletados) del sistema"),a()()()(),r(7,"div",3)(8,"div",7)(9,"button",8),_("click",function(){g(n);let m=$(40);return f(i.modalGestioncontrolesRef=i._tools.openModal(m,"xl"))}),x(10,"ng-lottie",9),r(11,"span"),c(12,"A\xF1adir control"),a(),x(13,"span",10),a()(),r(14,"div",11)(15,"div",12)(16,"span",13),x(17,"ng-lottie",9),a(),r(18,"div",14)(19,"input",15),_("input",function(){return g(n),f(i.paginacontroles=1)}),G("ngModelChange",function(m){return g(n),K(i.filtertxtcontroles,m)||(i.filtertxtcontroles=m),f(m)}),a(),r(20,"label"),c(21,"Buscar"),a()()()()(),r(22,"div",16)(23,"div",17)(24,"div",18)(25,"button",19),_("click",function(){return g(n),f(i.setViewMode("interactive"))}),c(26,"Modo interactivo"),a(),r(27,"button",19),_("click",function(){return g(n),f(i.setViewMode("table"))}),c(28,"Modo tabla"),a()()(),r(29,"div",20)(30,"div",14)(31,"select",21),G("ngModelChange",function(m){return g(n),K(i.categoriaFiltro,m)||(i.categoriaFiltro=m),f(m)}),_("change",function(){return g(n),f(i.onCategoriaFiltroChange())}),r(32,"option",22),c(33,"TODAS"),a(),h(34,vt,2,2,"option",23),a(),r(35,"label"),c(36,"Filtrar por categor\xEDa"),a()()()(),h(37,Vt,3,2,"div",24)(38,Kt,31,17,"div",24)(39,ei,37,13,"ng-template",null,0,j)}e&2&&(s(10),u("options",i._tools.optionsAdicionar),s(7),u("options",i._tools.optionslupa),s(2),B("ngModel",i.filtertxtcontroles),s(6),M("active",i.viewMode==="interactive"),s(2),M("active",i.viewMode==="table"),s(4),B("ngModel",i.categoriaFiltro),s(3),u("ngForOf",i.categoriasOptions),s(3),u("ngIf",i.viewMode==="interactive"),s(),u("ngIf",i.viewMode==="table"))},dependencies:[q,Q,X,Te,ie,ne,Z,te,J,Ie,ee,we,Me,Re,Oe,ye],encapsulation:2});var le=F;var L=class L{};L.\u0275fac=function(e){return new(e||L)},L.\u0275cmp=R({type:L,selectors:[["app-gestioninicios"]],standalone:!1,decls:2,vars:0,template:function(e,i){e&1&&(r(0,"p"),c(1,"gestioninicios works!"),a())},encapsulation:2});var se=L;var ti=[{path:"calificacionessolo",component:re},{path:"controles",component:le},{path:"gestioninicios",component:se}],k=class k{};k.\u0275fac=function(e){return new(e||k)},k.\u0275mod=W({type:k}),k.\u0275inj=z({imports:[me.forChild(ti),me]});var ce=k;var A=class A{};A.\u0275fac=function(e){return new(e||A)},A.\u0275mod=W({type:A}),A.\u0275inj=z({imports:[Se,Le,ce]});var Ke=A;export{Ke as AdministrativosModule};
