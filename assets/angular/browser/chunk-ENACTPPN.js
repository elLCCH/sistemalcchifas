import{b as P}from"./chunk-K42WWFMO.js";import{a as R}from"./chunk-KFXCIGMC.js";import{Da as c,Ea as l,Fa as o,Na as k,P as C,Q as I,Qa as T,Sa as m,Tb as S,_b as b,ab as E,ea as a,eb as p,fb as f,gb as x,hc as w,la as _,na as y,qc as B,sa as v}from"./chunk-T7ZSEIVN.js";import"./chunk-ATDPNAVO.js";function $(r,t){r&1&&(l(0,"div",4),p(1," No hay celular vinculado. Vuelve a la PC y escanea el QR de vinculaci\xF3n. "),o())}function A(r,t){r&1&&(l(0,"div",11),p(1," Esperando solicitud de captura desde la PC... "),o())}function L(r,t){if(r&1&&(l(0,"div",6),p(1),o()),r&2){let e=m(3);a(),x("Expira: ",e.captureExpiresAt)}}function N(r,t){if(r&1&&(l(0,"div",15)(1,"div",19)(2,"div",20),p(3),o()()()),r&2){let e=m(3);a(2),E("width",e.progress,"%"),a(),x("",e.progress,"%")}}function D(r,t){if(r&1&&(l(0,"div",21),p(1),o()),r&2){let e=m(3);a(),f(e.message)}}function F(r,t){if(r&1&&(l(0,"div",22),p(1),o()),r&2){let e=m(3);a(),f(e.error)}}function H(r,t){if(r&1){let e=k();l(0,"div",12)(1,"div",13)(2,"div",7),p(3,"Solicitud recibida"),o(),v(4,L,2,1,"div",14),l(5,"div",15)(6,"input",16),T("change",function(n){C(e);let u=m(2);return I(u.onFileSelected(n))}),o()(),v(7,N,4,3,"div",17)(8,D,2,1,"div",18)(9,F,2,1,"div",10),o()()}if(r&2){let e=m(2);a(4),c("ngIf",e.captureExpiresAt),a(2),c("disabled",e.uploading),a(),c("ngIf",e.uploading),a(),c("ngIf",e.message),a(),c("ngIf",e.error)}}function z(r,t){if(r&1&&(l(0,"div",22),p(1),o()),r&2){let e=m(2);a(),f(e.error)}}function O(r,t){if(r&1&&(l(0,"div")(1,"div",5)(2,"div",6),p(3,"Estado"),o(),l(4,"div",7),p(5),o()(),v(6,A,2,0,"div",8)(7,H,10,5,"div",9)(8,z,2,1,"div",10),o()),r&2){let e=m();a(5),f(e.pairingStatus||"..."),a(),c("ngIf",!e.captureToken),a(),c("ngIf",e.captureToken),a(),c("ngIf",e.error&&!e.captureToken)}}var g=class g{constructor(t,e){this.route=t;this.http=e;this.ruta="";this.pairingToken=null;this.pairingStatus=null;this.captureToken=null;this.captureExpiresAt=null;this.pollingId=null;this.revokeSent=!1;this.uploading=!1;this.progress=0;this.message=null;this.error=null;this.ruta=this.resolveBackendBaseUrl();let i=this.route.snapshot.paramMap.get("token"),n=localStorage.getItem("lcch_capture_pairing_token");this.pairingToken=i||n,this.pairingToken&&localStorage.setItem("lcch_capture_pairing_token",this.pairingToken)}formatBytes(t){if(!Number.isFinite(t)||t<=0)return"0 B";let e=["B","KB","MB","GB"],i=Math.min(Math.floor(Math.log(t)/Math.log(1024)),e.length-1);return`${(t/Math.pow(1024,i)).toFixed(i===0?0:1)} ${e[i]}`}buildUploadErrorMessage(t,e){let i=t?.status,n=(t?.error?.error??t?.error?.message??"").toString().trim(),u=e?.name?`Archivo: ${e.name}`:"",d=typeof e?.size=="number"?`Tama\xF1o: ${this.formatBytes(e.size)}`:"",h=e?.type?`Tipo: ${e.type}`:"",s=[u,d,h].filter(Boolean).join(" | ");return i===0?"No se pudo conectar con el servidor (red/HTTPS/CORS o redirecci\xF3n). Verifica que el enlace sea https y que /api est\xE9 accesible desde el celular."+(s?`
${s}`:""):i===413?(n||"La foto supera el l\xEDmite permitido.")+(s?`
${s}`:""):i===400?(n||"No se recibi\xF3 el archivo. Esto suele pasar cuando el hosting corta la subida por l\xEDmite de post_max_size/upload_max_filesize.")+(s?`
${s}`:""):i===404?n||"Sesi\xF3n no encontrada. Genera un nuevo QR.":i===409?n||"Sesi\xF3n no disponible. Vuelve a intentar desde la PC.":i===410?n||"Sesi\xF3n expirada. Genera un nuevo QR.":i===422?(!n||/campos con errores|given data was invalid/i.test(n)?"El servidor rechaz\xF3 el archivo (422). En hosting esto suele ser por l\xEDmites de PHP (upload_max_filesize/post_max_size), y la c\xE1mara principal genera fotos m\xE1s pesadas. Sube esos l\xEDmites o reduce el tama\xF1o/formato de la foto.":n)+(s?`
${s}`:""):typeof i=="number"&&i>=500?"Error interno del servidor al guardar la imagen (HTTP 500). En hosting normalmente es permisos de escritura o falta de espacio."+(n?`
Detalle: ${n}`:"")+(s?`
${s}`:""):n?n+(s?`
${s}`:""):`No se pudo subir la foto (HTTP ${i??"desconocido"}).`+(s?`
${s}`:"")}resolveBackendBaseUrl(){let t=window.location.origin.replace(/\/+$/,"")+"/",e=(R.ruta??"").trim();if(!e)return t;try{let i=new URL(e,t),n=(i.hostname||"").toLowerCase(),u=(window.location.hostname||"").toLowerCase();if((n==="localhost"||n==="127.0.0.1"||n==="::1")&&u&&u!==n){let h=new URL(i.toString());return h.hostname=u,h.toString()}return i.toString()}catch{return t}}ngOnInit(){this.pairingToken&&this.http.post(this.ruta+"api/capture-pairings/"+this.pairingToken+"/link",{device_label:"CELULAR"}).subscribe({next:t=>{this.pairingStatus=t?.data?.status??"LINKED",this.startPolling()},error:t=>{let e=t?.status;(e===404||e===409||e===410)&&localStorage.removeItem("lcch_capture_pairing_token"),this.error=t?.error?.error??"No se pudo vincular. Vuelve a generar el QR desde la PC."}})}ngOnDestroy(){this.pollingId&&(clearInterval(this.pollingId),this.pollingId=null),this.sendRevokeBestEffort("ngOnDestroy")}sendRevokeBestEffort(t){if(this.revokeSent||!this.pairingToken)return;let e=this.ruta+"api/capture-pairings/"+this.pairingToken+"/revoke",i=JSON.stringify({reason:t});try{if(typeof navigator<"u"&&"sendBeacon"in navigator){let n=new Blob([i],{type:"application/json"});navigator.sendBeacon(e,n)}else fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:i,keepalive:!0}).catch(()=>{})}catch{}this.revokeSent=!0,localStorage.removeItem("lcch_capture_pairing_token")}startPolling(){this.pairingToken&&(this.pollingId&&clearInterval(this.pollingId),this.pollingId=setInterval(()=>{!this.pairingToken||this.uploading||this.http.get(this.ruta+"api/capture-pairings/"+this.pairingToken+"/pending-capture",{headers:{[P]:"1"}}).subscribe({next:t=>{if(this.pairingStatus=t?.data?.status??this.pairingStatus,this.pairingStatus==="REVOKED"||this.pairingStatus==="EXPIRED"){localStorage.removeItem("lcch_capture_pairing_token"),this.pairingToken=null,this.captureToken=null,this.captureExpiresAt=null;return}let e=t?.data?.capture_token??null,i=t?.data?.expires_at??null;this.captureToken=e,this.captureExpiresAt=i},error:()=>{}})},2e3))}onFileSelected(t){let e=t.target,i=e.files?.item(0);if(e.value="",!i||!this.captureToken)return;let n=30*1024*1024;if(i.size>n){this.error=`La foto pesa ${this.formatBytes(i.size)} y excede 30MB.`;return}this.uploading=!0,this.progress=0,this.message=null,this.error=null;let u=new FormData;u.append("file",i),this.http.post(this.ruta+"api/capture-sessions/"+this.captureToken+"/upload",u,{reportProgress:!0,observe:"events"}).subscribe({next:d=>{if(d?.type===1&&d.total){this.progress=Math.round(d.loaded/d.total*100);return}d?.type===4&&(this.uploading=!1,this.message="Foto enviada. Puedes esperar la siguiente solicitud.",this.captureToken=null,this.captureExpiresAt=null)},error:d=>{this.uploading=!1,this.progress=0,this.error=this.buildUploadErrorMessage(d,i)}})}};g.\u0275fac=function(e){return new(e||g)(_(B),_(w))},g.\u0275cmp=y({type:g,selectors:[["app-captura-celular"]],decls:5,vars:2,consts:[[1,"container","py-4",2,"max-width","520px"],[1,"mb-2"],["class","alert alert-warning",4,"ngIf"],[4,"ngIf"],[1,"alert","alert-warning"],[1,"mb-3"],[1,"small","text-muted"],[1,"fw-semibold"],["class","alert alert-info",4,"ngIf"],["class","card",4,"ngIf"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"alert","alert-info"],[1,"card"],[1,"card-body"],["class","small text-muted",4,"ngIf"],[1,"mt-3"],["type","file","accept","image/*","capture","environment",1,"form-control",3,"change","disabled"],["class","mt-3",4,"ngIf"],["class","alert alert-success mt-3",4,"ngIf"],[1,"progress"],["role","progressbar",1,"progress-bar"],[1,"alert","alert-success","mt-3"],[1,"alert","alert-danger","mt-3"]],template:function(e,i){e&1&&(l(0,"div",0)(1,"h2",1),p(2,"Captura desde celular"),o(),v(3,$,2,0,"div",2)(4,O,9,4,"div",3),o()),e&2&&(a(3),c("ngIf",!i.pairingToken),a(),c("ngIf",i.pairingToken))},dependencies:[b,S],encapsulation:2});var M=g;export{M as CapturaCelularComponent};
