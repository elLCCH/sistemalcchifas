import{a as ve}from"./chunk-44R4R5AU.js";import{b as fe}from"./chunk-2XFHIHYO.js";import"./chunk-OXONTOT5.js";import{e as me,h as U,k as Y}from"./chunk-2UZ5XJOB.js";import"./chunk-3IGMLI3N.js";import{b as ce,c as D,f as R,k,m as G,r as pe,s as ue,t as ge}from"./chunk-F4JB6MJU.js";import{a as b}from"./chunk-5RMZ5E5A.js";import{Ca as o,Cc as T,Dc as y,Jb as s,Ka as x,Kb as c,Lb as S,Lc as le,Mb as ae,Nb as B,Pa as E,Qa as q,Qb as f,Rb as _,Rc as X,Sb as h,Ua as p,Vc as de,Wb as oe,Xb as re,Z as te,_ as V,ba as ie,ga as M,gb as d,ha as w,hb as t,ib as e,jb as se,qb as Q,tb as u,vb as g,za as ne}from"./chunk-4IB5NCLX.js";import{f as Se,m as W}from"./chunk-GG76335P.js";var A=class A{constructor(n){this.http=n;this.apiUrl=b.apiUrl}getAulasDisponibles(){return this.http.get(`${this.apiUrl}/${b.apiRoutes.lchaula.aulas}`)}listSesiones(n){let i=new X;return n&&(i=i.set("fecha",n)),this.http.get(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}`,{params:i})}crearSesion(n){return this.http.post(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}`,n)}getSesion(n){return this.http.get(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}/${n}`)}cerrarSesion(n){return this.http.post(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}/${n}/cerrar`,{})}listRegistros(n){return this.http.get(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}/${n}/registros`)}listEstudiantesSesion(n){return this.http.get(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}/${n}/estudiantes`)}generarQr(n,i=5){return this.http.post(`${this.apiUrl}/${b.apiRoutes.asistencias.sesiones}/${n}/qr`,{ttl_seconds:i})}scan(n){return this.http.post(`${this.apiUrl}/${b.apiRoutes.asistencias.scan}`,n)}listPermisos(n){let i=new X;return n?.instituciones_id&&(i=i.set("instituciones_id",n.instituciones_id)),n?.infoestudiantesifas_id&&(i=i.set("infoestudiantesifas_id",n.infoestudiantesifas_id)),this.http.get(`${this.apiUrl}/${b.apiRoutes.asistencias.permisos}`,{params:i})}crearPermiso(n){return this.http.post(`${this.apiUrl}/${b.apiRoutes.asistencias.permisos}`,n)}borrarPermiso(n){return this.http.delete(`${this.apiUrl}/${b.apiRoutes.asistencias.permisos}/${n}`)}};A.\u0275fac=function(i){return new(i||A)(ie(de))},A.\u0275prov=te({token:A,factory:A.\u0275fac,providedIn:"root"});var v=A;var Ee=r=>["/asistenciasestudiantes/sesion",r];function ye(r,n){if(r&1&&(t(0,"option",12),s(1),e()),r&2){let i=n.$implicit;d("ngValue",i.id),o(),c(i.nombre||i.Nombre||"Aula #"+i.id)}}function Ae(r,n){if(r&1&&(t(0,"div",30),s(1),e()),r&2){let i=g();o(),c(i.errorMsg)}}function Ce(r,n){r&1&&(t(0,"div",31),s(1,"Cargando..."),e())}function Ie(r,n){if(r&1&&(t(0,"tr")(1,"td"),s(2),e(),t(3,"td"),s(4),e(),t(5,"td"),s(6),e(),t(7,"td"),s(8),e(),t(9,"td"),s(10),e(),t(11,"td",34)(12,"a",37),s(13,"Abrir"),e()()()),r&2){let i=n.$implicit;o(2),c(i.id),o(2),c(i.aulas_virtuales_id),o(2),c(i.fecha),o(2),c(i.hora_ingreso),o(2),c(i.estado),o(2),d("routerLink",re(6,Ee,i.id))}}function Me(r,n){r&1&&(t(0,"tr")(1,"td",38),s(2,"Sin sesiones para la fecha."),e()())}function we(r,n){if(r&1&&(t(0,"div",32)(1,"table",33)(2,"thead")(3,"tr")(4,"th"),s(5,"ID"),e(),t(6,"th"),s(7,"Aula"),e(),t(8,"th"),s(9,"Fecha"),e(),t(10,"th"),s(11,"Hora ingreso"),e(),t(12,"th"),s(13,"Estado"),e(),t(14,"th",34),s(15,"Acci\xF3n"),e()()(),t(16,"tbody"),p(17,Ie,14,8,"tr",35)(18,Me,3,0,"tr",36),e()()()),r&2){let i=g();o(17),d("ngForOf",i.sesiones),o(),d("ngIf",i.sesiones.length===0)}}var L=class L{constructor(n){this.api=n;this.isLoading=!1;this.errorMsg=null;this.fecha=new Date().toISOString().slice(0,10);this.aulas=[];this.sesiones=[];this.form={instituciones_id:null,aulas_virtuales_id:null,tiempo_espera_minutos:10,gps_requerido:!0,radio_metros:150}}ngOnInit(){this.cargarAulas(),this.cargarSesiones()}cargarAulas(){this.api.getAulasDisponibles().subscribe({next:n=>{if(this.aulas=n?.aulas||n?.data||[],this.aulas.length===1){let i=this.aulas[0];this.form.aulas_virtuales_id=i?.id??null,this.form.instituciones_id=i?.instituciones_id??this.form.instituciones_id}},error:()=>{this.aulas=[]}})}cargarSesiones(){this.isLoading=!0,this.errorMsg=null,this.api.listSesiones(this.fecha).subscribe({next:n=>{this.sesiones=n?.sesiones||[],this.isLoading=!1},error:()=>{this.errorMsg="No se pudieron cargar las sesiones.",this.isLoading=!1}})}onChangeAula(){let n=this.aulas.find(i=>i?.id===this.form.aulas_virtuales_id);n?.instituciones_id&&(this.form.instituciones_id=n.instituciones_id)}crearSesion(){if(this.errorMsg=null,!this.form.instituciones_id||!this.form.aulas_virtuales_id){this.errorMsg="Seleccione instituci\xF3n y aula.";return}this.isLoading=!0,this.api.crearSesion({instituciones_id:this.form.instituciones_id,aulas_virtuales_id:this.form.aulas_virtuales_id,fecha:this.fecha,tiempo_espera_minutos:this.form.tiempo_espera_minutos,gps_requerido:this.form.gps_requerido,radio_metros:this.form.radio_metros}).subscribe({next:()=>{this.cargarSesiones()},error:n=>{this.errorMsg=n?.error?.message||"No se pudo crear la sesi\xF3n.",this.isLoading=!1}})}};L.\u0275fac=function(i){return new(i||L)(x(v))},L.\u0275cmp=E({type:L,selectors:[["app-asistencia-sesiones"]],standalone:!1,decls:51,vars:13,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"row","g-2","align-items-end"],[1,"col-12","col-md-3"],[1,"form-label"],["type","date",1,"form-control",3,"ngModelChange","change","ngModel"],[1,"form-select",3,"ngModelChange","change","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"col-12","col-md-2"],["type","number","placeholder","ID",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-6","col-md-2"],["type","number",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-4","mt-2"],[1,"form-check"],["type","checkbox","id","gpsReq",1,"form-check-input",3,"ngModelChange","ngModel"],["for","gpsReq",1,"form-check-label"],[1,"col-12","col-md-8","mt-2","d-flex","justify-content-end"],[1,"btn","btn-primary",3,"click","disabled"],["class","alert alert-warning mt-3",4,"ngIf"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["class","text-center my-3",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"alert","alert-warning","mt-3"],[1,"text-center","my-3"],[1,"table-responsive"],[1,"table","table-sm","table-striped","align-middle","mt-2"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"btn","btn-sm","btn-outline-primary",3,"routerLink"],["colspan","6",1,"text-center","text-muted"]],template:function(i,a){i&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),s(4,"Sesiones de asistencia"),e(),t(5,"p",4),s(6,"Crear y gestionar la asistencia del d\xEDa"),e()()(),t(7,"div",5)(8,"div",6)(9,"div",7)(10,"div",8)(11,"label",9),s(12,"Fecha"),e(),t(13,"input",10),h("ngModelChange",function(l){return _(a.fecha,l)||(a.fecha=l),l}),u("change",function(){return a.cargarSesiones()}),e()(),t(14,"div",8)(15,"label",9),s(16,"Aula"),e(),t(17,"select",11),h("ngModelChange",function(l){return _(a.form.aulas_virtuales_id,l)||(a.form.aulas_virtuales_id=l),l}),u("change",function(){return a.onChangeAula()}),t(18,"option",12),s(19,"Seleccione"),e(),p(20,ye,2,2,"option",13),e()(),t(21,"div",14)(22,"label",9),s(23,"Instituci\xF3n"),e(),t(24,"input",15),h("ngModelChange",function(l){return _(a.form.instituciones_id,l)||(a.form.instituciones_id=l),l}),e()(),t(25,"div",16)(26,"label",9),s(27,"PRESENTE (min)"),e(),t(28,"input",17),h("ngModelChange",function(l){return _(a.form.tiempo_espera_minutos,l)||(a.form.tiempo_espera_minutos=l),l}),e()(),t(29,"div",16)(30,"label",9),s(31,"Radio (m)"),e(),t(32,"input",17),h("ngModelChange",function(l){return _(a.form.radio_metros,l)||(a.form.radio_metros=l),l}),e()(),t(33,"div",18)(34,"div",19)(35,"input",20),h("ngModelChange",function(l){return _(a.form.gps_requerido,l)||(a.form.gps_requerido=l),l}),e(),t(36,"label",21),s(37,"GPS requerido"),e()()(),t(38,"div",22)(39,"button",23),u("click",function(){return a.crearSesion()}),s(40,"Crear sesi\xF3n"),e()()(),p(41,Ae,2,1,"div",24),e()(),t(42,"div",5)(43,"div",6)(44,"div",25)(45,"h2",26),s(46,"Sesiones"),e(),t(47,"button",27),u("click",function(){return a.cargarSesiones()}),s(48," Actualizar "),e()(),p(49,Ce,2,0,"div",28)(50,we,19,2,"div",29),e()()()),i&2&&(o(13),f("ngModel",a.fecha),o(4),f("ngModel",a.form.aulas_virtuales_id),o(),d("ngValue",null),o(2),d("ngForOf",a.aulas),o(4),f("ngModel",a.form.instituciones_id),o(4),f("ngModel",a.form.tiempo_espera_minutos),o(4),f("ngModel",a.form.radio_metros),o(3),f("ngModel",a.form.gps_requerido),o(4),d("disabled",a.isLoading),o(2),d("ngIf",a.errorMsg),o(6),d("disabled",a.isLoading),o(2),d("ngIf",a.isLoading),o(),d("ngIf",!a.isLoading))},dependencies:[T,y,ue,ge,D,G,ce,pe,R,k,U],encapsulation:2});var $=L;var he=Se(ve());var Te=()=>["/asistenciasestudiantes/sesiones"];function De(r,n){if(r&1&&(t(0,"div",28),s(1),e()),r&2){let i=g();o(),B("Aula: ",i.sesion.aulas_virtuales_id," \xB7 Fecha: ",i.sesion.fecha," \xB7 Estado: ",i.sesion.estado)}}function Re(r,n){if(r&1&&(t(0,"div",29),s(1),e()),r&2){let i=g();o(),c(i.errorMsg)}}function ke(r,n){r&1&&(t(0,"div",28),s(1,"Sesi\xF3n cerrada: no se genera QR."),e())}function Pe(r,n){if(r&1&&se(0,"img",37),r&2){let i=g(2);d("src",i.qrDataUrl,ne)}}function Le(r,n){if(r&1){let i=Q();t(0,"div",30),p(1,Pe,1,1,"img",31),t(2,"div",32),s(3),e(),t(4,"div",33)(5,"button",34),u("click",function(){M(i);let m=g();return w(m.iniciarQr())}),s(6,"Iniciar"),e(),t(7,"button",35),u("click",function(){M(i);let m=g();return w(m.detenerQr())}),s(8,"Detener"),e(),t(9,"button",36),u("click",function(){M(i);let m=g();return w(m.refrescarQr())}),s(10,"Actualizar"),e()()()}if(r&2){let i=g();o(),d("ngIf",i.qrDataUrl),o(2),S("Expira: ",i.qrExpiresAt||"-")}}function Oe(r,n){r&1&&(t(0,"span",19),s(1,"OK"),e())}function Ne(r,n){r&1&&(t(0,"span",40),s(1,"-"),e())}function Fe(r,n){if(r&1&&(t(0,"tr")(1,"td"),s(2),e(),t(3,"td"),s(4),e(),t(5,"td"),s(6),e(),t(7,"td"),s(8),e(),t(9,"td"),p(10,Oe,2,0,"span",38)(11,Ne,2,0,"span",39),e()()),r&2){let i=n.$implicit;o(2),c(i.infoestudiantesifas_id),o(2),c(i.estado_asistencia),o(2),c(i.metodo),o(2),c(i.fecha_registro),o(2),d("ngIf",i.gps_valido),o(),d("ngIf",!i.gps_valido)}}function We(r,n){r&1&&(t(0,"tr")(1,"td",41),s(2,"Sin registros a\xFAn."),e()())}function Ve(r,n){r&1&&(t(0,"span",19),s(1,"PRESENTE"),e())}function qe(r,n){r&1&&(t(0,"span",20),s(1,"ATRASO"),e())}function Qe(r,n){r&1&&(t(0,"span",21),s(1,"FALTA"),e())}function Be(r,n){r&1&&(t(0,"span",22),s(1,"PERMISO"),e())}function Ue(r,n){r&1&&(t(0,"span",40),s(1,"SIN REGISTRO"),e())}function Ge(r,n){if(r&1&&(t(0,"tr")(1,"td"),s(2),e(),t(3,"td"),s(4),e(),t(5,"td"),p(6,Ve,2,0,"span",38)(7,qe,2,0,"span",42)(8,Qe,2,0,"span",43)(9,Be,2,0,"span",44)(10,Ue,2,0,"span",39),e(),t(11,"td"),s(12),e(),t(13,"td"),s(14),e()()),r&2){let i=n.$implicit,a=g();o(2),c(i.nombre_completo),o(2),c(i.infoestudiantesifas_id),o(2),d("ngIf",a.estadoVisible(i)==="PRESENTE"),o(),d("ngIf",a.estadoVisible(i)==="ATRASO"),o(),d("ngIf",a.estadoVisible(i)==="FALTA"),o(),d("ngIf",a.estadoVisible(i)==="PERMISO"),o(),d("ngIf",a.estadoVisible(i)==="SIN REGISTRO"),o(2),c(i.metodo||"-"),o(2),c(i.fecha_registro||"-")}}function je(r,n){r&1&&(t(0,"tr")(1,"td",41),s(2,"Sin estudiantes o no se pudo cargar."),e()())}var O=class O{constructor(n,i){this.route=n;this.api=i;this.sesion=null;this.registros=[];this.estudiantes=[];this.isLoading=!1;this.errorMsg=null;this.qrDataUrl=null;this.qrToken=null;this.qrExpiresAt=null;this.timer=null;this.idSesion=Number(this.route.snapshot.paramMap.get("id"))}ngOnInit(){this.cargar()}ngOnDestroy(){this.detenerQr()}cargar(){this.isLoading=!0,this.errorMsg=null,this.api.getSesion(this.idSesion).subscribe({next:n=>{this.sesion=n?.sesion||null,this.isLoading=!1,this.cargarRegistros(),this.cargarEstudiantes(),this.sesion?.estado==="ABIERTA"&&this.iniciarQr()},error:()=>{this.errorMsg="No se pudo cargar la sesi\xF3n.",this.isLoading=!1}})}cargarRegistros(){this.api.listRegistros(this.idSesion).subscribe({next:n=>{this.registros=n?.registros||[]},error:()=>{this.registros=[]}})}cargarEstudiantes(){this.api.listEstudiantesSesion(this.idSesion).subscribe({next:n=>{this.estudiantes=n?.estudiantes||[]},error:()=>{this.estudiantes=[]}})}refrescarQr(){return W(this,null,function*(){this.errorMsg=null,this.api.generarQr(this.idSesion,5).subscribe({next:n=>W(this,null,function*(){let i=n?.qr?.token,a=n?.qr?.expires_at;i&&(this.qrToken=i,this.qrExpiresAt=a,this.qrDataUrl=yield he.toDataURL(i,{margin:1,width:240}))}),error:n=>{this.errorMsg=n?.error?.message||"No se pudo generar el QR.",this.detenerQr()}})})}iniciarQr(){this.timer||(this.refrescarQr(),this.timer=setInterval(()=>this.refrescarQr(),5e3))}detenerQr(){this.timer&&(clearInterval(this.timer),this.timer=null)}cerrarSesion(){this.errorMsg=null,this.api.cerrarSesion(this.idSesion).subscribe({next:()=>{this.detenerQr(),this.cargar()},error:n=>{this.errorMsg=n?.error?.message||"No se pudo cerrar la sesi\xF3n."}})}contar(n){return this.registros.filter(i=>i.estado_asistencia===n).length}estadoVisible(n){return n.estado_asistencia?n.estado_asistencia:n.tiene_permiso?"PERMISO":"SIN REGISTRO"}};O.\u0275fac=function(i){return new(i||O)(x(me),x(v))},O.\u0275cmp=E({type:O,selectors:[["app-asistencia-sesion-detalle"]],standalone:!1,decls:80,vars:17,consts:[[1,"container","mt-4"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h4","fw-bold","titulosGlobales","mb-1"],["class","text-muted",4,"ngIf"],[1,"d-flex","gap-2"],[1,"btn","btn-outline-secondary",3,"routerLink"],[1,"btn","btn-danger",3,"click","disabled"],["class","alert alert-warning mt-3",4,"ngIf"],[1,"row","mt-3","g-3"],[1,"col-12","col-lg-4"],[1,"card"],[1,"card-body"],[1,"h6"],["class","text-center",4,"ngIf"],[1,"alert","alert-info","mt-3","mb-0"],[1,"col-12","col-lg-8"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"mt-2","d-flex","gap-2","flex-wrap"],[1,"badge","text-bg-success"],[1,"badge","text-bg-warning"],[1,"badge","text-bg-danger"],[1,"badge","text-bg-info"],[1,"table-responsive","mt-2"],[1,"table","table-sm","table-striped","align-middle"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"card","mt-3"],[1,"text-muted"],[1,"alert","alert-warning","mt-3"],[1,"text-center"],["alt","QR","class","img-fluid","style","max-width: 240px",3,"src",4,"ngIf"],[1,"mt-2","small","text-muted"],[1,"mt-2","d-flex","justify-content-center","gap-2"],[1,"btn","btn-sm","btn-outline-primary",3,"click"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[1,"btn","btn-sm","btn-primary",3,"click"],["alt","QR",1,"img-fluid",2,"max-width","240px",3,"src"],["class","badge text-bg-success",4,"ngIf"],["class","badge text-bg-secondary",4,"ngIf"],[1,"badge","text-bg-secondary"],["colspan","5",1,"text-center","text-muted"],["class","badge text-bg-warning",4,"ngIf"],["class","badge text-bg-danger",4,"ngIf"],["class","badge text-bg-info",4,"ngIf"]],template:function(i,a){i&1&&(t(0,"div",0)(1,"div",1)(2,"div")(3,"h1",2),s(4),e(),p(5,De,2,3,"div",3),e(),t(6,"div",4)(7,"a",5),s(8,"Volver"),e(),t(9,"button",6),u("click",function(){return a.cerrarSesion()}),s(10,"Cerrar"),e()()(),p(11,Re,2,1,"div",7),t(12,"div",8)(13,"div",9)(14,"div",10)(15,"div",11)(16,"h2",12),s(17,"QR rotativo"),e(),p(18,ke,2,0,"div",3)(19,Le,11,2,"div",13),t(20,"div",14),s(21),e()()()(),t(22,"div",15)(23,"div",10)(24,"div",11)(25,"div",1)(26,"h2",16),s(27,"Registros"),e(),t(28,"button",17),u("click",function(){return a.cargarRegistros()}),s(29,"Actualizar"),e()(),t(30,"div",18)(31,"span",19),s(32),e(),t(33,"span",20),s(34),e(),t(35,"span",21),s(36),e(),t(37,"span",22),s(38),e()(),t(39,"div",23)(40,"table",24)(41,"thead")(42,"tr")(43,"th"),s(44,"Estudiante"),e(),t(45,"th"),s(46,"Estado"),e(),t(47,"th"),s(48,"M\xE9todo"),e(),t(49,"th"),s(50,"Fecha"),e(),t(51,"th"),s(52,"GPS"),e()()(),t(53,"tbody"),p(54,Fe,12,6,"tr",25)(55,We,3,0,"tr",26),e()()()()(),t(56,"div",27)(57,"div",11)(58,"div",1)(59,"h2",16),s(60,"Lista de estudiantes"),e(),t(61,"button",17),u("click",function(){return a.cargarEstudiantes()}),s(62,"Actualizar"),e()(),t(63,"div",23)(64,"table",24)(65,"thead")(66,"tr")(67,"th"),s(68,"Estudiante"),e(),t(69,"th"),s(70,"ID (info)"),e(),t(71,"th"),s(72,"Estado"),e(),t(73,"th"),s(74,"M\xE9todo"),e(),t(75,"th"),s(76,"Fecha"),e()()(),t(77,"tbody"),p(78,Ge,15,9,"tr",25)(79,je,3,0,"tr",26),e()()()()()()()()),i&2&&(o(4),S("Sesi\xF3n #",a.idSesion),o(),d("ngIf",a.sesion),o(2),d("routerLink",oe(16,Te)),o(2),d("disabled",(a.sesion==null?null:a.sesion.estado)!=="ABIERTA"),o(2),d("ngIf",a.errorMsg),o(7),d("ngIf",(a.sesion==null?null:a.sesion.estado)!=="ABIERTA"),o(),d("ngIf",(a.sesion==null?null:a.sesion.estado)==="ABIERTA"),o(2),S(" Reglas: PRESENTE dentro de ",(a.sesion==null?null:a.sesion.tiempo_espera_minutos)||10," min; luego ATRASO; a los 30 min ya no registra. "),o(11),S("PRESENTE: ",a.contar("PRESENTE")),o(2),S("ATRASO: ",a.contar("ATRASO")),o(2),S("FALTA: ",a.contar("FALTA")),o(2),S("PERMISO: ",a.contar("PERMISO")),o(16),d("ngForOf",a.registros),o(),d("ngIf",a.registros.length===0),o(23),d("ngForOf",a.estudiantes),o(),d("ngIf",a.estudiantes.length===0))},dependencies:[T,y,U],encapsulation:2});var z=O;function $e(r,n){if(r&1&&(t(0,"span"),s(1),e()),r&2){let i=g(2);o(),S("Estado: ",i.lastEstado)}}function ze(r,n){if(r&1&&(t(0,"div",14),s(1),p(2,$e,2,1,"span",15),e()),r&2){let i=g();o(),S("",i.msg," "),o(),d("ngIf",i.lastEstado)}}var N=class N{constructor(n){this.api=n;this.token="";this.isLoading=!1;this.gps={lat:null,lng:null,precision:null};this.msg=null;this.lastEstado=null}obtenerGps(){return this.msg=null,new Promise(n=>{if(!navigator.geolocation){this.msg="Este navegador no soporta GPS.",n();return}navigator.geolocation.getCurrentPosition(i=>{this.gps.lat=i.coords.latitude,this.gps.lng=i.coords.longitude,this.gps.precision=i.coords.accuracy,n()},()=>{this.msg="No se pudo obtener el GPS. Revise permisos del navegador.",n()},{enableHighAccuracy:!0,timeout:8e3})})}registrar(){return W(this,null,function*(){if(this.msg=null,this.lastEstado=null,!this.token||this.token.trim().length<5){this.msg="Pegue el token del QR.";return}this.isLoading=!0,yield this.obtenerGps(),this.api.scan({token:this.token.trim(),gps_lat:this.gps.lat??void 0,gps_lng:this.gps.lng??void 0,gps_precision_m:this.gps.precision??void 0}).subscribe({next:n=>{this.lastEstado=n?.registro?.estado_asistencia||null,this.msg="Asistencia registrada.",this.isLoading=!1},error:n=>{this.msg=n?.error?.message||"No se pudo registrar la asistencia.",this.isLoading=!1}})})}};N.\u0275fac=function(i){return new(i||N)(x(v))},N.\u0275cmp=E({type:N,selectors:[["app-asistencia-scan"]],standalone:!1,decls:20,vars:7,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"form-label"],["placeholder","Pegue aqu\xED el token",1,"form-control",3,"ngModelChange","ngModel"],[1,"mt-3","d-flex","gap-2"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],[1,"mt-3","small","text-muted"],["class","alert alert-info mt-3 mb-0",4,"ngIf"],[1,"alert","alert-info","mt-3","mb-0"],[4,"ngIf"]],template:function(i,a){i&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),s(4,"Registrar asistencia"),e(),t(5,"p",4),s(6,"Pegue el token del QR y confirme"),e()()(),t(7,"div",5)(8,"div",6)(9,"label",7),s(10,"Token (QR)"),e(),t(11,"input",8),h("ngModelChange",function(l){return _(a.token,l)||(a.token=l),l}),e(),t(12,"div",9)(13,"button",10),u("click",function(){return a.obtenerGps()}),s(14,"Obtener GPS"),e(),t(15,"button",11),u("click",function(){return a.registrar()}),s(16,"Registrar"),e()(),t(17,"div",12),s(18),e(),p(19,ze,3,2,"div",13),e()()()),i&2&&(o(11),f("ngModel",a.token),o(2),d("disabled",a.isLoading),o(2),d("disabled",a.isLoading),o(3),B(" GPS: ",a.gps.lat||"-",", ",a.gps.lng||"-"," (\xB1 ",a.gps.precision||"-"," m) "),o(),d("ngIf",a.msg))},dependencies:[y,D,R,k],encapsulation:2});var H=N;function He(r,n){if(r&1&&(t(0,"div",27),s(1),e()),r&2){let i=g();o(),c(i.msg)}}function Ke(r,n){r&1&&(t(0,"div",28),s(1,"Cargando..."),e())}function Je(r,n){if(r&1){let i=Q();t(0,"tr")(1,"td"),s(2),e(),t(3,"td"),s(4),e(),t(5,"td"),s(6),e(),t(7,"td"),s(8),e(),t(9,"td"),s(10),e(),t(11,"td",31)(12,"button",34),u("click",function(){let m=M(i).$implicit,l=g(2);return w(l.borrar(m.id))}),s(13,"Borrar"),e()()()}if(r&2){let i=n.$implicit;o(2),c(i.id),o(2),c(i.instituciones_id),o(2),c(i.infoestudiantesifas_id),o(2),ae("",i.fecha_inicio," \u2192 ",i.fecha_fin),o(2),c(i.aulas_virtuales_id||"-")}}function Xe(r,n){r&1&&(t(0,"tr")(1,"td",35),s(2,"Sin permisos."),e()())}function Ye(r,n){if(r&1&&(t(0,"div",29)(1,"table",30)(2,"thead")(3,"tr")(4,"th"),s(5,"ID"),e(),t(6,"th"),s(7,"Instituci\xF3n"),e(),t(8,"th"),s(9,"Estudiante"),e(),t(10,"th"),s(11,"Rango"),e(),t(12,"th"),s(13,"Aula"),e(),t(14,"th",31),s(15,"Acci\xF3n"),e()()(),t(16,"tbody"),p(17,Je,14,6,"tr",32)(18,Xe,3,0,"tr",33),e()()()),r&2){let i=g();o(17),d("ngForOf",i.permisos),o(),d("ngIf",i.permisos.length===0)}}var F=class F{constructor(n){this.api=n;this.isLoading=!1;this.msg=null;this.permisos=[];this.form={instituciones_id:null,infoestudiantesifas_id:null,fecha_inicio:new Date().toISOString().slice(0,10),fecha_fin:new Date().toISOString().slice(0,10),aulas_virtuales_id:null,motivo:"",registrado_por:""}}ngOnInit(){this.cargar()}cargar(){this.isLoading=!0,this.api.listPermisos().subscribe({next:n=>{this.permisos=n?.permisos||[],this.isLoading=!1},error:()=>{this.permisos=[],this.isLoading=!1}})}crear(){if(this.msg=null,!this.form.instituciones_id||!this.form.infoestudiantesifas_id){this.msg="Falta instituci\xF3n y/o estudiante inscrito.";return}this.isLoading=!0,this.api.crearPermiso({instituciones_id:this.form.instituciones_id,infoestudiantesifas_id:this.form.infoestudiantesifas_id,fecha_inicio:this.form.fecha_inicio,fecha_fin:this.form.fecha_fin,aulas_virtuales_id:this.form.aulas_virtuales_id??null,motivo:this.form.motivo||null,registrado_por:this.form.registrado_por||null}).subscribe({next:()=>{this.msg="Permiso creado.",this.isLoading=!1,this.cargar()},error:n=>{this.msg=n?.error?.message||"No se pudo crear el permiso.",this.isLoading=!1}})}borrar(n){this.msg=null,this.isLoading=!0,this.api.borrarPermiso(n).subscribe({next:()=>{this.isLoading=!1,this.cargar()},error:()=>{this.msg="No se pudo borrar el permiso.",this.isLoading=!1}})}};F.\u0275fac=function(i){return new(i||F)(x(v))},F.\u0275cmp=E({type:F,selectors:[["app-asistencia-permisos"]],standalone:!1,decls:51,vars:12,consts:[[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-6","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"card","mt-3"],[1,"card-body"],[1,"row","g-2"],[1,"col-12","col-md-2"],[1,"form-label"],["type","number","placeholder","ID",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-3"],["type","number","placeholder","infoestudiantesifas_id",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-6","col-md-2"],["type","date",1,"form-control",3,"ngModelChange","ngModel"],["type","number","placeholder","aulas_virtuales_id",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-6"],[1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-4"],[1,"col-12","col-md-2","d-flex","align-items-end"],[1,"btn","btn-primary","w-100",3,"click","disabled"],["class","alert alert-info mt-3 mb-0",4,"ngIf"],[1,"d-flex","justify-content-between","align-items-center"],[1,"h6","m-0"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["class","text-center my-3",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"alert","alert-info","mt-3","mb-0"],[1,"text-center","my-3"],[1,"table-responsive"],[1,"table","table-sm","table-striped","align-middle","mt-2"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"btn","btn-sm","btn-outline-danger",3,"click"],["colspan","6",1,"text-center","text-muted"]],template:function(i,a){i&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),s(4,"Permisos de asistencia"),e(),t(5,"p",4),s(6,"Secretar\xEDa registra permisos (PERMISO en vez de FALTA)"),e()()(),t(7,"div",5)(8,"div",6)(9,"div",7)(10,"div",8)(11,"label",9),s(12,"Instituci\xF3n"),e(),t(13,"input",10),h("ngModelChange",function(l){return _(a.form.instituciones_id,l)||(a.form.instituciones_id=l),l}),e()(),t(14,"div",11)(15,"label",9),s(16,"Estudiante inscrito"),e(),t(17,"input",12),h("ngModelChange",function(l){return _(a.form.infoestudiantesifas_id,l)||(a.form.infoestudiantesifas_id=l),l}),e()(),t(18,"div",13)(19,"label",9),s(20,"Inicio"),e(),t(21,"input",14),h("ngModelChange",function(l){return _(a.form.fecha_inicio,l)||(a.form.fecha_inicio=l),l}),e()(),t(22,"div",13)(23,"label",9),s(24,"Fin"),e(),t(25,"input",14),h("ngModelChange",function(l){return _(a.form.fecha_fin,l)||(a.form.fecha_fin=l),l}),e()(),t(26,"div",11)(27,"label",9),s(28,"Aula (opcional)"),e(),t(29,"input",15),h("ngModelChange",function(l){return _(a.form.aulas_virtuales_id,l)||(a.form.aulas_virtuales_id=l),l}),e()(),t(30,"div",16)(31,"label",9),s(32,"Motivo"),e(),t(33,"input",17),h("ngModelChange",function(l){return _(a.form.motivo,l)||(a.form.motivo=l),l}),e()(),t(34,"div",18)(35,"label",9),s(36,"Registrado por"),e(),t(37,"input",17),h("ngModelChange",function(l){return _(a.form.registrado_por,l)||(a.form.registrado_por=l),l}),e()(),t(38,"div",19)(39,"button",20),u("click",function(){return a.crear()}),s(40,"Crear"),e()()(),p(41,He,2,1,"div",21),e()(),t(42,"div",5)(43,"div",6)(44,"div",22)(45,"h2",23),s(46,"Permisos recientes"),e(),t(47,"button",24),u("click",function(){return a.cargar()}),s(48,"Actualizar"),e()(),p(49,Ke,2,0,"div",25)(50,Ye,19,2,"div",26),e()()()),i&2&&(o(13),f("ngModel",a.form.instituciones_id),o(4),f("ngModel",a.form.infoestudiantesifas_id),o(4),f("ngModel",a.form.fecha_inicio),o(4),f("ngModel",a.form.fecha_fin),o(4),f("ngModel",a.form.aulas_virtuales_id),o(4),f("ngModel",a.form.motivo),o(4),f("ngModel",a.form.registrado_por),o(2),d("disabled",a.isLoading),o(2),d("ngIf",a.msg),o(6),d("disabled",a.isLoading),o(2),d("ngIf",a.isLoading),o(),d("ngIf",!a.isLoading))},dependencies:[T,y,D,G,R,k],encapsulation:2});var K=F;var Ze=[{path:"",redirectTo:"scan",pathMatch:"full"},{path:"scan",component:H},{path:"sesiones",component:$},{path:"sesion/:id",component:z},{path:"permisos",component:K}],C=class C{};C.\u0275fac=function(i){return new(i||C)},C.\u0275mod=q({type:C}),C.\u0275inj=V({imports:[Y.forChild(Ze),Y]});var J=C;var I=class I{};I.\u0275fac=function(i){return new(i||I)},I.\u0275mod=q({type:I}),I.\u0275inj=V({imports:[le,fe,J]});var be=I;export{be as SistemaasistenciasestudiantesModule};
