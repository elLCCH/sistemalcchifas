import{a as Pe}from"./chunk-27RMNQXJ.js";import{a as Ee}from"./chunk-OOC77CZV.js";import"./chunk-54WVOQJ7.js";import"./chunk-M3KGNDQ5.js";import{a as ye,b as Y,d as Z,h as J,j as Q,n as ee,o as te,p as ie,q as Ce,r as ne}from"./chunk-NILQYPGY.js";import{a as xe}from"./chunk-OQPWVW4O.js";import{Bb as he,Ha as p,Ia as o,Ja as a,Ka as H,O as ue,Oa as pe,P as z,Pa as fe,R as de,Ra as w,Rb as q,Sb as X,U as C,Ua as b,V as E,Wa as d,Zb as be,a as T,ca as me,db as _e,dc as ve,eb as ge,fb as S,g as B,ia as l,ib as c,jb as P,kb as M,lb as U,mb as G,nc as ce,ob as R,pa as D,pb as O,qb as A,ra as j,sa as W,wa as y,za as k}from"./chunk-TNNFIFGQ.js";function Ie(s,t){if(s&1&&(o(0,"span"),c(1),a()),s&2){let e=d(2);l(),M(" | Paralelo: ",e.materia.MateriaParalelo)}}function ke(s,t){if(s&1&&(o(0,"span"),c(1),a()),s&2){let e=d(2);l(),M("",e.materia.SiglaMateria," - ")}}function Re(s,t){if(s&1&&(o(0,"div"),c(1),a()),s&2){let e=d(2);l(),M("A\xF1o: ",e.materia.Anio)}}function Oe(s,t){if(s&1&&(o(0,"div"),c(1),a()),s&2){let e=d(2);l(),M("Docentes: ",e.docentesLabel())}}function Ae(s,t){if(s&1&&(o(0,"div",31)(1,"div")(2,"strong"),c(3),a(),y(4,Ie,2,1,"span",32),a(),o(5,"div"),y(6,ke,2,1,"span",32),c(7),a(),y(8,Re,2,1,"div",32)(9,Oe,2,1,"div",32),a()),s&2){let e=d();l(3),P(e.materia.LvlCurso||"Curso"),l(),p("ngIf",e.materia.MateriaParalelo),l(2),p("ngIf",e.materia.SiglaMateria),l(),M("",e.materia.NombreMateria||"Materia"," "),l(),p("ngIf",e.materia.Anio),l(),p("ngIf",e.docentes==null?null:e.docentes.length)}}function Ne(s,t){if(s&1&&(o(0,"div",33),c(1),a()),s&2){let e=d();l(),P(e.loadError)}}function Ve(s,t){if(s&1&&(o(0,"div",33),c(1),a()),s&2){let e=d();l(),P(e.saveError)}}function Ke(s,t){if(s&1&&(o(0,"div",34),c(1),a()),s&2){let e=d();l(),P(e.saveOk)}}function $e(s,t){if(s&1){let e=w();o(0,"div",35)(1,"div",36),c(2),a(),o(3,"div",37)(4,"button",38),b("click",function(){C(e);let n=d();return E(n.prev())}),c(5,"Anterior"),a(),o(6,"button",38),b("click",function(){C(e);let n=d();return E(n.next())}),c(7,"Siguiente"),a()()()}if(s&2){let e=d();l(2),G("Mostrando ",e.meta.from||0,"-",e.meta.to||0," de ",e.meta.total),l(2),p("disabled",!e.tienePrev()||e.isLoading),l(2),p("disabled",!e.tieneNext()||e.isLoading)}}function Fe(s,t){if(s&1&&(o(0,"th"),c(1),a()),s&2){let e=t.$implicit;S("sep-after",e.sepAfter),l(),P(e.label)}}function Le(s,t){if(s&1){let e=w();pe(0),o(1,"input",49),b("ngModelChange",function(n){C(e);let r=d(),u=r.$implicit,m=r.index,f=d().index,g=d(2);return E(g.onCellChange(f,m,u.key,n))})("focus",function(){C(e);let n=d().index,r=d().index,u=d(2);return E(u.onFocusCell(r,n))})("paste",function(n){C(e);let r=d().index,u=d().index,m=d(2);return E(m.onPaste(n,u,r))}),a(),fe()}if(s&2){let e=d(),i=e.$implicit,n=e.index,r=d(),u=r.$implicit,m=r.index,f=d(2);l(),p("readOnly",i.readonly||!f.canEdit(i.key))("ngModel",u[i.key]),k("data-row",m)("data-col",n)}}function De(s,t){if(s&1){let e=w();o(0,"input",50),b("focus",function(){C(e);let n=d().index,r=d().index,u=d(2);return E(u.onFocusCell(r,n))}),a()}if(s&2){let e=d(),i=e.$implicit,n=e.index,r=d(),u=r.$implicit,m=r.index,f=d(2);p("readOnly",!0)("ngModel",f.sumValueForKey(u,i.key)),k("data-row",m)("data-col",n)}}function Be(s,t){if(s&1&&(o(0,"td"),y(1,Le,2,4,"ng-container",48)(2,De,1,4,"ng-template",null,0,he),a()),s&2){let e=t.$implicit,i=_e(3),n=d().$implicit,r=d(2);S("sep-after",e.sepAfter)("cell-danger",r.isCellDanger(n,e.key)),l(),p("ngIf",!r.isSumColumn(e.key))("ngIfElse",i)}}function ze(s,t){if(s&1&&(o(0,"tr")(1,"td",42)(2,"div",46),c(3),a()(),o(4,"td",43),c(5),a(),y(6,Be,4,6,"td",47),a()),s&2){let e=t.$implicit,i=t.index,n=d(2);S("table-danger",n.isDanger(e))("active-row",i===n.activeRow),l(3),P(n.nombreCompleto(e)),l(2),P(e.CI||""),l(),p("ngForOf",n.columns)}}function je(s,t){if(s&1&&(o(0,"div",39)(1,"table",40)(2,"thead",41)(3,"tr")(4,"th",42),c(5,"Estudiante"),a(),o(6,"th",43),c(7,"CI"),a(),y(8,Fe,2,3,"th",44),a()(),o(9,"tbody"),y(10,ze,7,7,"tr",45),a()()()),s&2){let e=d();l(8),p("ngForOf",e.columns),l(2),p("ngForOf",e.rows)}}function We(s,t){s&1&&(o(0,"div",51),c(1," No hay calificaciones asignadas a esta materia. "),a())}var $=class ${constructor(t,e){this.hostEl=t;this._calif=e;this.materiaId=4;this.PASSING_SCORE=61;this.materia=null;this.docentes=[];this.rows=[];this.columns=[];this.isLoading=!1;this.loadError=null;this.saveError=null;this.saveOk=null;this.isSaving=!1;this.meta=null;this.page=1;this.perPage=200;this.maxTeorico=30;this.maxPractico=70;this.avgEvalCount=4;this.viewMode="intercalado";this.editableEvaluations=!0;this.showSumColumns=!1;this.evalEnabled=[!0,!0,!0,!0];this.originalById=new Map;this.dirtyIds=new Set;this.activeRow=0;this.activeCol=0;this.undoStack=[];this.redoStack=[];this.MAX_HISTORY=50;this.isBatchEdit=!1}ngOnInit(){this.rebuildColumns(),this.cargarCalificaciones(1)}cargarCalificaciones(t=1){this.isLoading||(this.isLoading=!0,this.loadError=null,this.saveError=null,this.saveOk=null,this._calif.ObtenerCalificacionesPorMateriaPaginado(this.materiaId,{page:t,per_page:this.perPage}).subscribe({next:e=>{let i=Array.isArray(e?.data)?e.data:[];this.rows=i.map(r=>T({},r)),this.materia=e?.materia??null,this.docentes=Array.isArray(e?.docentes)?e.docentes:[],this.meta=e?.meta??null,this.page=this.meta?.current_page??t;let n=this.materia?.CantidadEvaluaciones??null;(n===1||n===2||n===3||n===4)&&(this.avgEvalCount=n),this.rebuildColumns(),this.captureBaseline(),this.dirtyIds.clear(),this.activeRow=0,this.activeCol=0},error:e=>{console.error("Error al cargar calificaciones por materia:",e),this.rows=[],this.meta=null,this.loadError="No se pudieron cargar las calificaciones de la materia."},complete:()=>{this.isLoading=!1}}))}recargarTabla(){this.cargarCalificaciones(this.page||1)}tienePrev(){return!!this.meta&&(this.meta.current_page??1)>1}tieneNext(){return!!this.meta&&(this.meta.current_page??1)<(this.meta.last_page??1)}prev(){this.tienePrev()&&this.cargarCalificaciones((this.meta.current_page??1)-1)}next(){this.tieneNext()&&this.cargarCalificaciones((this.meta.current_page??1)+1)}captureBaseline(){this.originalById.clear();for(let t of this.rows)this.originalById.set(t.id,T({},t))}snapshotRows(){let t={};for(let e of this.rows)t[e.id]={Teorico1:e.Teorico1??null,Teorico2:e.Teorico2??null,Teorico3:e.Teorico3??null,Teorico4:e.Teorico4??null,Practico1:e.Practico1??null,Practico2:e.Practico2??null,Practico3:e.Practico3??null,Practico4:e.Practico4??null,PromTeorico:e.PromTeorico??null,PromPractico:e.PromPractico??null,Promedio:e.Promedio??null,PruebaRecuperacion:e.PruebaRecuperacion??null};return t}restoreSnapshot(t){this.isBatchEdit=!0;try{this.dirtyIds.clear();for(let e of this.rows){let i=t[e.id];i&&(e.Teorico1=i.Teorico1??null,e.Teorico2=i.Teorico2??null,e.Teorico3=i.Teorico3??null,e.Teorico4=i.Teorico4??null,e.Practico1=i.Practico1??null,e.Practico2=i.Practico2??null,e.Practico3=i.Practico3??null,e.Practico4=i.Practico4??null,e.PruebaRecuperacion=i.PruebaRecuperacion??null,e.__cascadeActive=!1,e.__cascadeLockFrom=null,e.__cascadeBackup=null,this.recalcPromedios(e),this.recomputeDirtyForRow(e))}}finally{this.isBatchEdit=!1}}beginUserChange(){this.isBatchEdit||(this.undoStack.push(this.snapshotRows()),this.undoStack.length>this.MAX_HISTORY&&this.undoStack.shift(),this.redoStack=[])}undo(){if(this.undoStack.length===0)return;let t=this.snapshotRows(),e=this.undoStack.pop();this.redoStack.push(t),this.restoreSnapshot(e)}redo(){if(this.redoStack.length===0)return;let t=this.snapshotRows(),e=this.redoStack.pop();this.undoStack.push(t),this.restoreSnapshot(e)}recomputeDirtyForRow(t){let e=this.originalById.get(t.id);if(!e)return;["Teorico1","Practico1","Teorico2","Practico2","Teorico3","Practico3","Teorico4","Practico4","PruebaRecuperacion"].some(r=>(t[r]??null)!==(e[r]??null))?this.dirtyIds.add(t.id):this.dirtyIds.delete(t.id)}rebuildColumns(){let t=[],e=[1,2,3,4].slice(0,this.avgEvalCount),i=n=>{t.push({key:`Teorico${n}`,label:`Teo${n}`,widthClass:"w-80"}),t.push({key:`Practico${n}`,label:`Prac${n}`,widthClass:"w-80",sepAfter:!this.showSumColumns}),this.showSumColumns&&t.push({key:`Sum${n}`,label:`Sum${n}`,widthClass:"w-80",readonly:!0,sepAfter:!0})};if(this.viewMode==="intercalado")for(let n of e)i(n);else{for(let n of e)t.push({key:`Teorico${n}`,label:`Teo${n}`,widthClass:"w-80"});t[t.length-1].sepAfter=!0;for(let n of e)t.push({key:`Practico${n}`,label:`Prac${n}`,widthClass:"w-80"}),this.showSumColumns?t.push({key:`Sum${n}`,label:`Sum${n}`,widthClass:"w-80",readonly:!0,sepAfter:!0}):t[t.length-1].sepAfter=!0}t.push({key:"PromTeorico",label:"Prom Teo",readonly:!0,widthClass:"w-90"}),t.push({key:"PromPractico",label:"Prom Prac",readonly:!0,widthClass:"w-90"}),t.push({key:"Promedio",label:"Prom",readonly:!0,widthClass:"w-80",sepAfter:!0}),t.push({key:"PruebaRecuperacion",label:"Recup",widthClass:"w-80"}),this.columns=t}onShowSumColumnsChange(t){this.showSumColumns=!!t,this.rebuildColumns()}onEvalEnabledChange(t,e){t<0||t>3||(this.evalEnabled[t]=!!e)}setAllEvaluations(t){this.evalEnabled=[t,t,t,t]}nombreCompleto(t){let e=(t.Ap_Paterno??"").trim(),i=(t.Ap_Materno??"").trim(),n=(t.Nombres??"").trim();return[e,i,n].filter(Boolean).join(" ").trim()||"(Sin nombre)"}docentesLabel(){return this.docentes?.length?this.docentes.map(t=>`${(t.Apellidos??"").trim()} ${(t.Nombres??"").trim()}`.trim()).filter(Boolean).join(", "):""}isDanger(t){let e=t.Promedio;return typeof e=="number"&&e<=60}isSumKey(t){return typeof t=="string"&&t.startsWith("Sum")}isSumColumn(t){return this.isSumKey(t)}evalIndexFromKey(t){switch(t){case"Teorico1":case"Practico1":return 1;case"Teorico2":case"Practico2":return 2;case"Teorico3":case"Practico3":return 3;case"Teorico4":case"Practico4":return 4;default:return null}}evalIndexFromColumnKey(t){if(this.isSumKey(t)){let e=Number(t.replace("Sum",""));return e>=1&&e<=4?e:null}return this.evalIndexFromKey(t)}sumValue(t,e){let i=t[`Teorico${e}`],n=t[`Practico${e}`];return typeof i=="number"&&typeof n=="number"?i+n:null}sumValueForKey(t,e){let i=this.evalIndexFromColumnKey(e);return i===null?null:this.sumValue(t,i)}isCellDanger(t,e){let i=this.evalIndexFromColumnKey(e);if(i!==null){let n=this.sumValue(t,i);return typeof n=="number"&&n<this.PASSING_SCORE}return e==="PromTeorico"?t.PromTeorico===null||t.PromTeorico===void 0?!1:t.PromTeorico*100<this.PASSING_SCORE*this.maxTeorico:e==="PromPractico"?t.PromPractico===null||t.PromPractico===void 0?!1:t.PromPractico*100<this.PASSING_SCORE*this.maxPractico:e==="Promedio"?t.Promedio!==null&&t.Promedio!==void 0&&t.Promedio<this.PASSING_SCORE:e==="PruebaRecuperacion"?t.PruebaRecuperacion!==null&&t.PruebaRecuperacion!==void 0&&t.PruebaRecuperacion<this.PASSING_SCORE:!1}clampNum(t,e,i){return Number.isNaN(t)||t<e?e:t>i?i:t}parseNullableInt(t){if(t==null)return null;let e=String(t).trim();if(e==="")return null;let i=parseInt(e,10);return Number.isFinite(i)?i:null}isTeoricoKey(t){return t==="Teorico1"||t==="Teorico2"||t==="Teorico3"||t==="Teorico4"}isPracticoKey(t){return t==="Practico1"||t==="Practico2"||t==="Practico3"||t==="Practico4"}recalcPromedios(t){let e=this.findZeroCascadeIndex(t),i=t,n=!!i.__cascadeActive,r=i.__cascadeLockFrom??null;if(e!==null){n||(i.__cascadeBackup={1:{teo:t.Teorico1??null,prac:t.Practico1??null},2:{teo:t.Teorico2??null,prac:t.Practico2??null},3:{teo:t.Teorico3??null,prac:t.Practico3??null},4:{teo:t.Teorico4??null,prac:t.Practico4??null}}),i.__cascadeActive=!0,i.__cascadeLockFrom=e;for(let _=e;_<=4;_++)t[`Teorico${_}`]=0,t[`Practico${_}`]=0}else if(n){let _=i.__cascadeBackup,v=r??1;if(_)for(let h=v+1;h<=4;h++){let x=_[h];if(!x)continue;let I=t[`Teorico${h}`],L=t[`Practico${h}`];typeof I=="number"&&typeof L=="number"&&I===0&&L===0&&(t[`Teorico${h}`]=x.teo,t[`Practico${h}`]=x.prac)}i.__cascadeActive=!1,i.__cascadeLockFrom=null,i.__cascadeBackup=null}if(e!==null){t.PromTeorico=0,t.PromPractico=0,t.Promedio=0;return}let u=[1,2,3,4].slice(0,this.avgEvalCount),m=_=>{let v=_.filter(x=>typeof x=="number");if(v.length===0)return null;let h=v.reduce((x,I)=>x+I,0);return Math.round(h/v.length)},f=u.map(_=>t[`Teorico${_}`]),g=u.map(_=>t[`Practico${_}`]);if(t.PromTeorico=m(f),t.PromPractico=m(g),t.PromTeorico===null&&t.PromPractico===null)t.Promedio=null;else{let _=(t.PromTeorico??0)+(t.PromPractico??0);t.Promedio=this.clampNum(Math.round(_),0,100)}}findZeroCascadeIndex(t){let e=t,i=!!e.__cascadeActive,n=e.__cascadeLockFrom??null;if(i&&n){for(let r=1;r<=n;r=r+1){let u=t[`Teorico${r}`],m=t[`Practico${r}`];if(typeof u=="number"&&typeof m=="number"&&u===0&&m===0)return r}return null}for(let r=1;r<=4;r=r+1){let u=t[`Teorico${r}`],m=t[`Practico${r}`];if(typeof u=="number"&&typeof m=="number"&&u===0&&m===0)return r}return null}canEdit(t){if(!this.editableEvaluations||this.isSumKey(t)||t==="PromTeorico"||t==="PromPractico"||t==="Promedio")return!1;let e=this.evalIndexFromColumnKey(t);return e!==null?!!this.evalEnabled[e-1]:!0}onFocusCell(t,e){this.activeRow=t,this.activeCol=e}onCellChange(t,e,i,n){let r=this.rows[t];if(!r||!this.canEdit(i)||this.isSumKey(i))return;this.beginUserChange();let u=this.parseNullableInt(n);if(u===null)r[i]=null;else{let m=u;this.isTeoricoKey(i)?m=this.clampNum(m,0,this.maxTeorico):this.isPracticoKey(i)?m=this.clampNum(m,0,this.maxPractico):m=this.clampNum(m,0,100),r[i]=m}this.recalcPromedios(r),this.recomputeDirtyForRow(r),this.activeRow=t,this.activeCol=e}onPaste(t,e,i){if(!t.clipboardData)return;let n=t.clipboardData.getData("text");if(!n)return;let r=n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(u=>u.length>0).map(u=>u.split("	"));if(r.length!==0){t.preventDefault(),this.beginUserChange(),this.isBatchEdit=!0;try{for(let u=0;u<r.length&&this.rows[e+u];u++)for(let f=0;f<r[u].length;f++){let g=this.columns[i+f];if(!g)break;let _=g.key;this.canEdit(_)&&this.onCellChange(e+u,i+f,_,r[u][f])}}finally{this.isBatchEdit=!1}}}focusCell(t,e){let i=this.hostEl.nativeElement.querySelector(`input[data-row="${t}"][data-col="${e}"]`);i?.focus(),i?.select()}onKeydown(t){if(t.ctrlKey||t.metaKey){let _=t.key.toLowerCase();if(_==="z"&&!t.shiftKey){t.preventDefault(),this.undo();return}if(_==="y"||_==="z"&&t.shiftKey){t.preventDefault(),this.redo();return}}let e=t.key;if(e!=="ArrowUp"&&e!=="ArrowDown"&&e!=="ArrowLeft"&&e!=="ArrowRight")return;let i=document.activeElement;if(!i||i.tagName!=="INPUT")return;let n=i.dataset.row,r=i.dataset.col;if(n===void 0||r===void 0)return;let u=parseInt(n,10),m=parseInt(r,10);if(!Number.isFinite(u)||!Number.isFinite(m))return;t.preventDefault();let f=u,g=m;e==="ArrowUp"&&(f=Math.max(0,u-1)),e==="ArrowDown"&&(f=Math.min(this.rows.length-1,u+1)),e==="ArrowLeft"&&(g=Math.max(0,m-1)),e==="ArrowRight"&&(g=Math.min(this.columns.length-1,m+1)),this.activeRow=f,this.activeCol=g,setTimeout(()=>this.focusCell(f,g))}copiarTodo(){return B(this,null,function*(){let t=this.buildTsvExport();try{yield navigator.clipboard.writeText(t),this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1500)}catch{let i=document.createElement("textarea");i.value=t,i.style.position="fixed",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1500)}})}buildTsvExport(){let t=[{key:"Teorico1",label:"Teo1"},{key:"Practico1",label:"Prac1"},{key:"Teorico2",label:"Teo2"},{key:"Practico2",label:"Prac2"},{key:"Teorico3",label:"Teo3"},{key:"Practico3",label:"Prac3"},{key:"Teorico4",label:"Teo4"},{key:"Practico4",label:"Prac4"},{key:"PromTeorico",label:"Prom Teo"},{key:"PromPractico",label:"Prom Prac"},{key:"Promedio",label:"Prom"},{key:"PruebaRecuperacion",label:"Recup"}],e=["Ap_Paterno","Ap_Materno","Nombres","CI",...t.map(n=>n.label)].join("	"),i=this.rows.map(n=>{let r=[n.Ap_Paterno??"",n.Ap_Materno??"",n.Nombres??"",n.CI??""],u=t.map(m=>n[m.key]??"");return[...r,...u].join("	")});return[e,...i].join(`
`)}guardarCambios(){if(this.isSaving)return;if(this.saveError=null,this.saveOk=null,Array.from(this.dirtyIds.values()).length===0){this.saveOk="No hay cambios para guardar.",setTimeout(()=>this.saveOk=null,1500);return}let e=this.rows.filter(i=>this.dirtyIds.has(i.id)).map(i=>({id:i.id,Teorico1:i.Teorico1??null,Teorico2:i.Teorico2??null,Teorico3:i.Teorico3??null,Teorico4:i.Teorico4??null,Practico1:i.Practico1??null,Practico2:i.Practico2??null,Practico3:i.Practico3??null,Practico4:i.Practico4??null,PruebaRecuperacion:i.PruebaRecuperacion??null}));this.isSaving=!0,this._calif.GuardarCalificacionesBulkMateria({materias_id:this.materiaId,avg_eval_count:this.avgEvalCount,items:e}).subscribe({next:i=>{let n=i?.data?.updated??null;this.saveOk=typeof n=="number"?`Guardado: ${n} filas.`:"Guardado.",this.captureBaseline(),this.dirtyIds.clear(),setTimeout(()=>this.saveOk=null,2e3)},error:i=>{console.error("Error al guardar cambios:",i),this.saveError="No se pudieron guardar los cambios."},complete:()=>{this.isSaving=!1}})}onAvgEvalCountChange(t){let e=parseInt(String(t),10);if(e===1||e===2||e===3||e===4){this.avgEvalCount=e;for(let i of this.rows)this.recalcPromedios(i);this.rebuildColumns()}}};$.\u0275fac=function(e){return new(e||$)(D(me),D(Pe))},$.\u0275cmp=j({type:$,selectors:[["app-calificaciones"]],hostBindings:function(e,i){e&1&&b("keydown",function(r){return i.onKeydown(r)})},standalone:!1,decls:76,vars:24,consts:[["sumCell",""],[1,"container-fluid","py-3"],[1,"d-flex","align-items-start","justify-content-between","gap-3","flex-wrap"],[1,"mb-1"],["class","text-muted small",4,"ngIf"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"input-group","input-group-sm",2,"width","170px"],[1,"input-group-text"],[1,"form-select",3,"ngModelChange","ngModel"],["value","intercalado"],["value","agrupado"],[1,"form-check","form-check-inline","small","mb-0"],["type","checkbox",1,"form-check-input",3,"ngModelChange","ngModel"],[1,"form-check-label"],[1,"d-flex","align-items-center","gap-2","small"],[1,"text-body-secondary"],[1,"form-check","form-check-inline","mb-0"],["role","group","aria-label","Habilitar evaluaciones",1,"btn-group","btn-group-sm"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"input-group","input-group-sm",2,"width","160px"],[3,"ngValue"],[1,"input-group","input-group-sm",2,"width","140px"],["type","number","min","0","max","100",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-sm","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-sm","btn-primary",3,"click","disabled"],[1,"mt-2"],["class","alert alert-danger py-2",4,"ngIf"],["class","alert alert-success py-2",4,"ngIf"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],["class","table-responsive mt-2 grid-wrap",4,"ngIf"],["class","text-muted small mt-2",4,"ngIf"],[1,"text-muted","small"],[4,"ngIf"],[1,"alert","alert-danger","py-2"],[1,"alert","alert-success","py-2"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"small","text-muted"],[1,"btn-group","btn-group-sm"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"table-responsive","mt-2","grid-wrap"],[1,"table","table-sm","table-bordered","align-middle","mb-0","grid-table"],[1,"table-light"],[1,"sticky-col","name-col"],[1,"sticky-col","name-col-2"],[3,"sep-after",4,"ngFor","ngForOf"],[3,"table-danger","active-row",4,"ngFor","ngForOf"],[1,"fw-semibold"],[3,"sep-after","cell-danger",4,"ngFor","ngForOf"],[4,"ngIf","ngIfElse"],["inputmode","numeric",1,"form-control","form-control-sm","cell",3,"ngModelChange","focus","paste","readOnly","ngModel"],["inputmode","numeric",1,"form-control","form-control-sm","cell",3,"focus","readOnly","ngModel"],[1,"text-muted","small","mt-2"]],template:function(e,i){e&1&&(o(0,"div",1)(1,"div",2)(2,"div")(3,"h5",3),c(4,"Calificaciones por materia"),a(),y(5,Ae,10,6,"div",4),a(),o(6,"div",5)(7,"div",6)(8,"span",7),c(9,"Modo"),a(),o(10,"select",8),A("ngModelChange",function(r){return O(i.viewMode,r)||(i.viewMode=r),r}),b("ngModelChange",function(){return i.rebuildColumns()}),o(11,"option",9),c(12,"Intercalado"),a(),o(13,"option",10),c(14,"Agrupado"),a()()(),o(15,"label",11)(16,"input",12),b("ngModelChange",function(r){return i.onShowSumColumnsChange(r)}),a(),o(17,"span",13),c(18,"Mostrar sumas"),a()(),o(19,"div",14)(20,"span",15),c(21,"Evaluaciones"),a(),o(22,"label",16)(23,"input",12),b("ngModelChange",function(r){return i.onEvalEnabledChange(0,r)}),a(),o(24,"span",13),c(25,"1"),a()(),o(26,"label",16)(27,"input",12),b("ngModelChange",function(r){return i.onEvalEnabledChange(1,r)}),a(),o(28,"span",13),c(29,"2"),a()(),o(30,"label",16)(31,"input",12),b("ngModelChange",function(r){return i.onEvalEnabledChange(2,r)}),a(),o(32,"span",13),c(33,"3"),a()(),o(34,"label",16)(35,"input",12),b("ngModelChange",function(r){return i.onEvalEnabledChange(3,r)}),a(),o(36,"span",13),c(37,"4"),a()()(),o(38,"div",17)(39,"button",18),b("click",function(){return i.setAllEvaluations(!0)}),c(40,"Todas"),a(),o(41,"button",18),b("click",function(){return i.setAllEvaluations(!1)}),c(42,"Ninguna"),a()(),o(43,"div",19)(44,"span",7),c(45,"Prom"),a(),o(46,"select",8),b("ngModelChange",function(r){return i.onAvgEvalCountChange(r)}),o(47,"option",20),c(48,"1 eval"),a(),o(49,"option",20),c(50,"2 eval"),a(),o(51,"option",20),c(52,"3 eval"),a(),o(53,"option",20),c(54,"4 eval"),a()()(),o(55,"div",21)(56,"span",7),c(57,"Teo \u2264"),a(),o(58,"input",22),A("ngModelChange",function(r){return O(i.maxTeorico,r)||(i.maxTeorico=r),r}),a()(),o(59,"div",21)(60,"span",7),c(61,"Prac \u2264"),a(),o(62,"input",22),A("ngModelChange",function(r){return O(i.maxPractico,r)||(i.maxPractico=r),r}),a()(),o(63,"button",23),b("click",function(){return i.recargarTabla()}),c(64,"Recargar"),a(),o(65,"button",23),b("click",function(){return i.copiarTodo()}),c(66,"Copiar todo"),a(),o(67,"button",24),b("click",function(){return i.guardarCambios()}),c(68),a()()(),o(69,"div",25),y(70,Ne,2,1,"div",26)(71,Ve,2,1,"div",26)(72,Ke,2,1,"div",27),a(),y(73,$e,8,5,"div",28)(74,je,11,2,"div",29)(75,We,2,0,"div",30),a()),e&2&&(l(5),p("ngIf",i.materia),l(5),R("ngModel",i.viewMode),l(6),p("ngModel",i.showSumColumns),l(7),p("ngModel",i.evalEnabled[0]),l(4),p("ngModel",i.evalEnabled[1]),l(4),p("ngModel",i.evalEnabled[2]),l(4),p("ngModel",i.evalEnabled[3]),l(11),p("ngModel",i.avgEvalCount),l(),p("ngValue",1),l(2),p("ngValue",2),l(2),p("ngValue",3),l(2),p("ngValue",4),l(5),R("ngModel",i.maxTeorico),l(4),R("ngModel",i.maxPractico),l(),p("disabled",i.isLoading||i.isSaving),l(2),p("disabled",i.isLoading||i.rows.length===0),l(2),p("disabled",i.isLoading||i.isSaving||i.dirtyIds.size===0),l(),M(" Guardar cambios (",i.dirtyIds.size,") "),l(2),p("ngIf",i.loadError),l(),p("ngIf",i.saveError),l(),p("ngIf",i.saveOk),l(),p("ngIf",i.meta),l(),p("ngIf",i.rows.length),l(),p("ngIf",!i.isLoading&&!i.rows.length))},dependencies:[q,X,te,ie,Y,Q,ye,ee,Z,ne,Ce,J],styles:[".grid-wrap[_ngcontent-%COMP%]{max-height:calc(100vh - 220px)}.grid-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .grid-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{white-space:nowrap}.sticky-col[_ngcontent-%COMP%]{position:sticky;left:0;z-index:2;background:var(--bs-body-bg)}.name-col[_ngcontent-%COMP%]{min-width:260px}.name-col-2[_ngcontent-%COMP%]{left:260px;min-width:120px;z-index:2;background:var(--bs-body-bg)}.table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th.sticky-col[_ngcontent-%COMP%]{z-index:3;background:var(--bs-table-bg)}.cell[_ngcontent-%COMP%]{min-width:76px;padding:.15rem .35rem}td.sep-after[_ngcontent-%COMP%], th.sep-after[_ngcontent-%COMP%]{border-right-width:3px}td.cell-danger[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{color:var(--bs-danger);font-weight:600}tr.active-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{outline:1px solid rgba(13,110,253,.35);outline-offset:-1px}"]});var re=$;var N=class N{constructor(t){this.http=t;this.ruta=xe.ruta}ObtenerRegistroPorMateriaPaginado(t,e,i){let n=new URLSearchParams;n.set("eval",String(e)),i?.page&&n.set("page",String(i.page)),i?.per_page&&n.set("per_page",String(i.per_page));let r=n.toString(),u=this.ruta+"api/registrocalificaciones/materia/"+t+(r?`?${r}`:"");return this.http.get(u)}CrearRubro(t){return this.http.post(this.ruta+"api/registrocalificaciones/rubros",t)}ActualizarRubro(t,e){return this.http.put(this.ruta+"api/registrocalificaciones/rubros/"+t,e)}EliminarRubro(t){return this.http.delete(this.ruta+"api/registrocalificaciones/rubros/"+t)}GuardarNotasBulk(t){return this.http.post(this.ruta+"api/registrocalificaciones/bulk-save",t)}ActualizarEvaluacionModo(t){return this.http.put(this.ruta+"api/registrocalificaciones/evaluacion",t)}};N.\u0275fac=function(e){return new(e||N)(de(ve))},N.\u0275prov=ue({token:N,factory:N.\u0275fac,providedIn:"root"});var oe=N;function Ue(s,t){s&1&&(o(0,"span",42),c(1,"Cargando"),a())}function Ge(s,t){if(s&1&&(o(0,"span",43),c(1),a()),s&2){let e=d();l(),M("",e.dirty.size," cambios")}}function qe(s,t){if(s&1&&(o(0,"span"),c(1),a()),s&2){let e=d(2);l(),M(" | Paralelo: ",e.materia.MateriaParalelo)}}function Xe(s,t){if(s&1&&(o(0,"span"),c(1),a()),s&2){let e=d(2);l(),M(" | A\xF1o: ",e.materia.Anio)}}function Ye(s,t){if(s&1&&(o(0,"span"),c(1),a()),s&2){let e=d(2);l(),M("",e.materia.SiglaMateria," - ")}}function Ze(s,t){if(s&1&&(o(0,"div",44)(1,"div")(2,"strong"),c(3),a(),y(4,qe,2,1,"span",45)(5,Xe,2,1,"span",45),a(),o(6,"div"),y(7,Ye,2,1,"span",45),c(8),a()()),s&2){let e=d();l(3),P(e.materia.LvlCurso||"Curso"),l(),p("ngIf",e.materia.MateriaParalelo),l(),p("ngIf",e.materia.Anio),l(2),p("ngIf",e.materia.SiglaMateria),l(),M("",e.materia.NombreMateria||"Materia"," ")}}function Je(s,t){if(s&1&&(o(0,"div",49),c(1),a()),s&2){let e=d(2);l(),P(e.loadError)}}function Qe(s,t){if(s&1&&(o(0,"div",49),c(1),a()),s&2){let e=d(2);l(),P(e.saveError)}}function et(s,t){if(s&1&&(o(0,"div",50),c(1),a()),s&2){let e=d(2);l(),P(e.saveOk)}}function tt(s,t){if(s&1&&(o(0,"div",46),y(1,Je,2,1,"div",47)(2,Qe,2,1,"div",47)(3,et,2,1,"div",48),a()),s&2){let e=d();l(),p("ngIf",e.loadError),l(),p("ngIf",e.saveError),l(),p("ngIf",e.saveOk)}}function it(s,t){if(s&1){let e=w();o(0,"div",51)(1,"div",52),c(2),a(),o(3,"div",53)(4,"button",14),b("click",function(){C(e);let n=d();return E(n.prev())}),c(5,"Anterior"),a(),o(6,"button",14),b("click",function(){C(e);let n=d();return E(n.next())}),c(7,"Siguiente"),a()()()}if(s&2){let e=d();l(2),G("Mostrando ",e.meta.from||0,"-",e.meta.to||0," de ",e.meta.total),l(2),p("disabled",!e.tienePrev()||e.isLoading),l(2),p("disabled",!e.tieneNext()||e.isLoading)}}function nt(s,t){if(s&1&&(o(0,"th",69),c(1,"Te\xF3ricas"),a()),s&2){let e=d(2);k("colspan",e.rubrosTeo.length)}}function rt(s,t){if(s&1&&(o(0,"th",69),c(1,"Pr\xE1cticas"),a()),s&2){let e=d(2);k("colspan",e.rubrosPra.length)}}function at(s,t){if(s&1){let e=w();o(0,"th",69)(1,"div",70)(2,"div",71),c(3),a(),o(4,"div",72)(5,"button",39),b("click",function(){let n=C(e).$implicit,r=d(2);return E(r.editarRubro(n))}),c(6,"E"),a(),o(7,"button",73),b("click",function(){let n=C(e).$implicit,r=d(2);return E(r.eliminarRubro(n))}),c(8,"X"),a()()()()}if(s&2){let e=t.$implicit;l(3),U("",e.nombre," (",e.max_puntos,")")}}function ot(s,t){if(s&1){let e=w();o(0,"th",69)(1,"div",70)(2,"div",71),c(3),a(),o(4,"div",72)(5,"button",39),b("click",function(){let n=C(e).$implicit,r=d(2);return E(r.editarRubro(n))}),c(6,"E"),a(),o(7,"button",73),b("click",function(){let n=C(e).$implicit,r=d(2);return E(r.eliminarRubro(n))}),c(8,"X"),a()()()()}if(s&2){let e=t.$implicit;l(3),U("",e.nombre," (",e.max_puntos,")")}}function lt(s,t){if(s&1){let e=w();o(0,"td")(1,"input",82),b("ngModelChange",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.setNota(u.infoestudiantesifas_id,r.id,n))})("id",function(){let n=C(e).$implicit,r=d().$implicit,u=d(2);return E(u.cellId(r.infoestudiantesifas_id,n.id))})("paste",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onPaste(n,u.infoestudiantesifas_id,r.id))})("keydown",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onKeydown(n,u.infoestudiantesifas_id,r.id))})("mousedown",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onCellMouseDown(n,u.infoestudiantesifas_id,r.id))}),a()()}if(s&2){let e=t.$implicit,i=d().$implicit,n=d(2);S("cell-selected",n.isCellSelected(i.infoestudiantesifas_id,e.id)),l(),p("ngModel",n.getNota(i.infoestudiantesifas_id,e.id))("data-row",i.infoestudiantesifas_id)("data-col",e.id),k("max",e.max_puntos)}}function st(s,t){if(s&1){let e=w();o(0,"td")(1,"input",82),b("ngModelChange",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.setNota(u.infoestudiantesifas_id,r.id,n))})("id",function(){let n=C(e).$implicit,r=d().$implicit,u=d(2);return E(u.cellId(r.infoestudiantesifas_id,n.id))})("paste",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onPaste(n,u.infoestudiantesifas_id,r.id))})("keydown",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onKeydown(n,u.infoestudiantesifas_id,r.id))})("mousedown",function(n){let r=C(e).$implicit,u=d().$implicit,m=d(2);return E(m.onCellMouseDown(n,u.infoestudiantesifas_id,r.id))}),a()()}if(s&2){let e=t.$implicit,i=d().$implicit,n=d(2);S("cell-selected",n.isCellSelected(i.infoestudiantesifas_id,e.id)),l(),p("ngModel",n.getNota(i.infoestudiantesifas_id,e.id))("data-row",i.infoestudiantesifas_id)("data-col",e.id),k("max",e.max_puntos)}}function ct(s,t){if(s&1&&(o(0,"tr")(1,"td",74)(2,"div",75),c(3),a()(),o(4,"td",76),c(5),a(),y(6,lt,2,6,"td",77),H(7,"td",78),o(8,"td",79),c(9),a(),y(10,st,2,6,"td",77),H(11,"td",78),o(12,"td",80),c(13),a(),o(14,"td",81),c(15),a()()),s&2){let e=t.$implicit,i=d(2);l(3),P(i.nombreCompleto(e)),l(2),P(e.CI||""),l(),p("ngForOf",i.rubrosTeo),l(3),P(i.getTeo(e)??""),l(),p("ngForOf",i.rubrosPra),l(3),P(i.getPra(e)??""),l(2),P(i.getSum(e)??"")}}function ut(s,t){if(s&1){let e=w();o(0,"div",54)(1,"table",55)(2,"thead",56)(3,"tr")(4,"th",57),c(5,"Estudiante"),a(),o(6,"th",58),c(7,"CI"),a(),y(8,nt,2,1,"th",59),o(9,"th",60)(10,"button",61),b("click",function(){C(e);let n=d();return E(n.abrirModalRubro("TEO"))}),c(11,"+"),a()(),o(12,"th",62),c(13),a(),y(14,rt,2,1,"th",59),o(15,"th",60)(16,"button",63),b("click",function(){C(e);let n=d();return E(n.abrirModalRubro("PRA"))}),c(17,"+"),a()(),o(18,"th",64),c(19),a(),o(20,"th",65),c(21),a()(),o(22,"tr"),y(23,at,9,2,"th",66),o(24,"th",60)(25,"span",67),c(26,"\xA0"),a()(),y(27,ot,9,2,"th",66),o(28,"th",60)(29,"span",67),c(30,"\xA0"),a()()()(),o(31,"tbody"),y(32,ct,16,7,"tr",68),a()()()}if(s&2){let e=d();l(8),p("ngIf",e.rubrosTeo.length),l(2),p("disabled",e.isLoading||e.isSaving),l(3),M("Teo ",e.evalNum),l(),p("ngIf",e.rubrosPra.length),l(2),p("disabled",e.isLoading||e.isSaving),l(3),M("Prac ",e.evalNum),l(2),M("Sum ",e.evalNum),l(2),p("ngForOf",e.rubrosTeo),l(4),p("ngForOf",e.rubrosPra),l(5),p("ngForOf",e.rows)}}function dt(s,t){s&1&&(o(0,"div",37),c(1,"No hay estudiantes asignados a esta materia."),a())}function mt(s,t){s&1&&H(0,"div",83)}var F=class F{constructor(t){this.api=t;this.materiaId=4;this.evalNum=1;this.isLoading=!1;this.isSaving=!1;this.loadError=null;this.saveError=null;this.saveOk=null;this.materia=null;this.evaluacion=null;this.modoEval=3;this.rubros=[];this.rows=[];this.meta=null;this.page=1;this.perPage=30;this.notas=new Map;this.dirty=new Set;this.modalVisible=!1;this.modalTipo="TEO";this.modalModo="create";this.modalRubroId=null;this.nuevoNombre="";this.nuevoMax=10;this.nuevoOrden=1;this.anchor=null;this.cursor=null;this.undoStack=[];this.redoStack=[];this.isRestoring=!1;this.isBatching=!1}ngOnInit(){this.cargar(1)}get rubrosTeo(){return this.rubros.filter(t=>t.tipo==="TEO")}get rubrosPra(){return this.rubros.filter(t=>t.tipo==="PRA")}key(t,e){return`${t}__${e}`}nombreCompleto(t){let e=(t.Ap_Paterno??"").trim(),i=(t.Ap_Materno??"").trim(),n=(t.Nombres??"").trim();return[e,i,n].filter(Boolean).join(" ").trim()||"(Sin nombre)"}setEval(t){this.evalNum!==t&&(this.evalNum=t,this.cargar(1))}onModoChange(t){let e=Number(t);(e===1||e===2||e===3)&&this.api.ActualizarEvaluacionModo({materias_id:this.materiaId,numero_eval:this.evalNum,modo_eval:e}).subscribe({next:i=>{let n=Number(i?.evaluacion?.modo_eval??e);this.modoEval=n===1||n===2||n===3?n:e,this.saveOk="Modo actualizado.",setTimeout(()=>this.saveOk=null,1200),this.recargar()},error:i=>{console.error("Error actualizando modo:",i),this.saveError="No se pudo actualizar el modo.",this.recargar()}})}tienePrev(){return!!this.meta&&(this.meta.current_page??1)>1}tieneNext(){return!!this.meta&&(this.meta.current_page??1)<(this.meta.last_page??1)}prev(){this.tienePrev()&&this.cargar((this.meta.current_page??1)-1)}next(){this.tieneNext()&&this.cargar((this.meta.current_page??1)+1)}recargar(){this.cargar(this.page||1)}abrirModalRubro(t){this.modalModo="create",this.modalRubroId=null,this.modalTipo=t,this.nuevoNombre="",this.nuevoMax=10;let e=t==="TEO"?this.rubrosTeo:this.rubrosPra;this.nuevoOrden=(e.reduce((i,n)=>Math.max(i,n.orden??1),0)||0)+1,this.modalVisible=!0,setTimeout(()=>{let i=document.querySelector(".modal input.form-control");i?.focus(),i?.select()},0)}cerrarModal(){this.modalVisible=!1}onModalBackdrop(t){t.target?.classList?.contains("modal")&&this.cerrarModal()}confirmarModal(){this.modalModo==="create"?this.crearRubroDesdeModal():this.actualizarRubroDesdeModal()}editarRubro(t){this.modalModo="edit",this.modalRubroId=t.id,this.modalTipo=t.tipo,this.nuevoNombre=t.nombre,this.nuevoMax=t.max_puntos,this.nuevoOrden=t.orden,this.modalVisible=!0,setTimeout(()=>{let e=document.querySelector(".modal input.form-control");e?.focus(),e?.select()},0)}eliminarRubro(t){window.confirm(`\xBFEliminar el rubro "${t.nombre}"?`)&&this.api.EliminarRubro(t.id).subscribe({next:()=>{this.saveOk="Rubro eliminado.",setTimeout(()=>this.saveOk=null,1500),this.recargar()},error:i=>{console.error("Error eliminando rubro:",i),this.saveError="No se pudo eliminar el rubro."}})}cargar(t=1){this.isLoading||(this.isLoading=!0,this.loadError=null,this.saveError=null,this.saveOk=null,this.api.ObtenerRegistroPorMateriaPaginado(this.materiaId,this.evalNum,{page:t,per_page:this.perPage}).subscribe({next:e=>{this.materia=e?.materia??null,this.evaluacion=e?.evaluacion??null;let i=Number(this.evaluacion?.modo_eval??this.evaluacion?.modoEval??3);this.modoEval=i===1||i===2||i===3?i:3,this.rubros=Array.isArray(e?.rubros)?e.rubros:[],this.rows=Array.isArray(e?.data)?e.data:[],this.meta=e?.meta??null,this.page=this.meta?.current_page??t,this.notas.clear(),this.dirty.clear();let n=Array.isArray(e?.notas)?e.notas:[];for(let r of n)this.notas.set(this.key(r.infoestudiantesifas_id,r.rubro_id),r.nota??null)},error:e=>{console.error("Error al cargar registrocalificaciones:",e),this.rows=[],this.rubros=[],this.meta=null,this.loadError="No se pudo cargar el registro de calificaciones."},complete:()=>{this.isLoading=!1}}))}getNota(t,e){return this.notas.get(this.key(t,e))??null}setNota(t,e,i,n){!this.isRestoring&&!this.isBatching&&!n?.skipUndo&&this.pushUndoSnapshot();let r=this.key(t,e),u=String(i??"").trim(),m=null;if(u!==""){let _=Number(u);Number.isFinite(_)?m=Math.round(_):m=null}let f=this.rubros.find(_=>_.id===e);m!==null&&f&&(m<0&&(m=0),m>f.max_puntos&&(m=f.max_puntos)),(this.notas.get(r)??null)!==m&&(this.notas.set(r,m),this.dirty.add(r))}onCellMouseDown(t,e,i){if(t.shiftKey&&this.anchor){this.cursor={infoId:e,rubroId:i};return}this.anchor={infoId:e,rubroId:i},this.cursor={infoId:e,rubroId:i}}isCellSelected(t,e){if(!this.anchor||!this.cursor)return!1;let i=this.rowIndexOf(this.anchor.infoId),n=this.rubroIndexOf(this.anchor.rubroId),r=this.rowIndexOf(this.cursor.infoId),u=this.rubroIndexOf(this.cursor.rubroId);if(i<0||n<0||r<0||u<0)return!1;let m=Math.min(i,r),f=Math.max(i,r),g=Math.min(n,u),_=Math.max(n,u),v=this.rowIndexOf(t),h=this.rubroIndexOf(e);return v>=m&&v<=f&&h>=g&&h<=_}buildSelectionTSV(){if(!this.anchor||!this.cursor)return null;let t=this.rowIndexOf(this.anchor.infoId),e=this.rubroIndexOf(this.anchor.rubroId),i=this.rowIndexOf(this.cursor.infoId),n=this.rubroIndexOf(this.cursor.rubroId);if(t<0||e<0||i<0||n<0)return null;let r=Math.min(t,i),u=Math.max(t,i),m=Math.min(e,n),f=Math.max(e,n),g=[];for(let _=r;_<=u;_++){let v=this.rows[_];if(!v)continue;let h=[];for(let x=m;x<=f;x++){let I=this.rubros[x];if(!I)continue;let L=this.getNota(v.infoestudiantesifas_id,I.id);h.push(L===null?"":String(Math.trunc(L)))}g.push(h.join("	"))}return g.join(`
`)}copyText(t){return B(this,null,function*(){try{yield navigator.clipboard.writeText(t);return}catch{let e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus(),e.select();try{document.execCommand("copy")}finally{document.body.removeChild(e)}}})}pushUndoSnapshot(){let t={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?T({},this.anchor):null,cursor:this.cursor?T({},this.cursor):null};this.undoStack.push(t),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack.length=0}restoreSnapshot(t){this.isRestoring=!0;try{this.notas.clear();for(let[e,i]of t.notas)this.notas.set(e,i);this.dirty=new Set(t.dirty),this.anchor=t.anchor,this.cursor=t.cursor}finally{this.isRestoring=!1}}undo(){let t=this.undoStack.pop();if(!t)return;let e={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?T({},this.anchor):null,cursor:this.cursor?T({},this.cursor):null};this.redoStack.push(e),this.restoreSnapshot(t)}redo(){let t=this.redoStack.pop();if(!t)return;let e={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?T({},this.anchor):null,cursor:this.cursor?T({},this.cursor):null};this.undoStack.push(e),this.restoreSnapshot(t)}crearRubroDesdeModal(){let t=this.nuevoNombre.trim();if(!t)return;let e=Math.max(1,Math.trunc(Number(this.nuevoMax)||1)),i=Math.max(1,Math.trunc(Number(this.nuevoOrden)||1));this.modoEval===1?e=100:this.modoEval===2&&(e=this.modalTipo==="TEO"?30:70),this.api.CrearRubro({materias_id:this.materiaId,numero_eval:this.evalNum,tipo:this.modalTipo,nombre:t,max_puntos:e,orden:i}).subscribe({next:()=>{this.saveOk="Rubro creado.",setTimeout(()=>this.saveOk=null,1500),this.cerrarModal(),this.recargar()},error:n=>{console.error("Error creando rubro:",n),this.saveError="No se pudo crear el rubro."}})}actualizarRubroDesdeModal(){let t=this.modalRubroId;if(!t)return;let e=this.nuevoNombre.trim();if(!e)return;let i=Math.max(1,Math.trunc(Number(this.nuevoMax)||1)),n=Math.max(1,Math.trunc(Number(this.nuevoOrden)||1));this.modoEval===1?i=100:this.modoEval===2&&(i=this.modalTipo==="TEO"?30:70),this.api.ActualizarRubro(t,{tipo:this.modalTipo,nombre:e,max_puntos:i,orden:n}).subscribe({next:()=>{this.saveOk="Rubro actualizado.",setTimeout(()=>this.saveOk=null,1500),this.cerrarModal(),this.recargar()},error:r=>{console.error("Error actualizando rubro:",r),this.saveError="No se pudo actualizar el rubro."}})}getTeo(t){let e=this.getVirtualEval(t.infoestudiantesifas_id)?.teo;if(e!==null)return e;let i=`Teorico${this.evalNum}`,n=t[i];return typeof n=="number"?Math.trunc(n):n??null}getPra(t){let e=this.getVirtualEval(t.infoestudiantesifas_id)?.pra;if(e!==null)return e;let i=`Practico${this.evalNum}`,n=t[i];return typeof n=="number"?Math.trunc(n):n??null}getSum(t){let e=this.getTeo(t),i=this.getPra(t);if(e===null&&i===null)return null;let n=(e??0)+(i??0);return Math.trunc(n)}getVirtualEval(t){if(!this.rubros?.length)return null;let e=Math.trunc(Number(this.evaluacion?.limite_teorico??30)),i=Math.trunc(Number(this.evaluacion?.limite_practico??70)),n=[],r=[],u=null;for(let _ of this.rubros){let v=this.getNota(t,_.id);if(v==null)continue;let h=Math.round(Number(v));if(!Number.isFinite(h))continue;let x=Math.trunc(Number(_.max_puntos??0));h<0&&(h=0),x>0&&h>x&&(h=x);let I=_.es_asistencia===1||_.es_asistencia===!0;_.tipo==="TEO"?I?u=h:n.push(h):r.push(h)}let m=this.modoEval,f=null,g=null;if(m===1){let _=null;if(n.length>0){let v=n.reduce((h,x)=>h+x,0)/n.length;_=Math.round(v/100*20)}if((_!==null||u!==null)&&(f=Math.round((_??0)+(u??0)),f<0&&(f=0),f>e&&(f=e)),r.length>0){let v=r.reduce((h,x)=>h+x,0)/r.length;g=Math.round(v/100*i),g<0&&(g=0),g>i&&(g=i)}}else if(m===2){let _=null;if(n.length>0){let v=n.reduce((h,x)=>h+x,0)/n.length;_=Math.round(v/30*20)}if((_!==null||u!==null)&&(f=Math.round((_??0)+(u??0)),f<0&&(f=0),f>e&&(f=e)),r.length>0){let v=r.reduce((h,x)=>h+x,0)/r.length;g=Math.round(v/70*i),g<0&&(g=0),g>i&&(g=i)}}else{let _=n.reduce((h,x)=>h+x,0)+(u??0),v=r.reduce((h,x)=>h+x,0);(n.length>0||u!==null)&&(f=Math.round(_),f<0&&(f=0),f>e&&(f=e)),r.length>0&&(g=Math.round(v),g<0&&(g=0),g>i&&(g=i))}return{teo:f,pra:g}}cellId(t,e){return`rc_${t}_${e}`}focusCell(t,e){let i=document.getElementById(this.cellId(t,e));i&&(i.focus(),i.select())}rubroIndexOf(t){return this.rubros.findIndex(e=>e.id===t)}rowIndexOf(t){return this.rows.findIndex(e=>e.infoestudiantesifas_id===t)}onKeydown(t,e,i){let n=t.key.toLowerCase();if(t.ctrlKey&&!t.shiftKey&&n==="z"){t.preventDefault(),this.undo();return}if(t.ctrlKey&&n==="y"||t.ctrlKey&&t.shiftKey&&n==="z"){t.preventDefault(),this.redo();return}if(t.ctrlKey&&n==="c"){let h=this.buildSelectionTSV();h!==null&&(t.preventDefault(),this.copyText(h));return}let r=t.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter","Tab"].includes(r))return;let u=this.rowIndexOf(e),m=this.rubroIndexOf(i);if(u<0||m<0)return;let f=u,g=m;r==="ArrowLeft"&&(g-=1),r==="ArrowRight"&&(g+=1),r==="ArrowUp"&&(f-=1),r==="ArrowDown"&&(f+=1),r==="Enter"&&(f+=t.shiftKey?-1:1),r==="Tab"&&(g+=t.shiftKey?-1:1),f<0&&(f=0),f>=this.rows.length&&(f=this.rows.length-1),g<0&&(g=0),g>=this.rubros.length&&(g=this.rubros.length-1),t.preventDefault();let _=this.rows[f]?.infoestudiantesifas_id,v=this.rubros[g]?.id;_&&v&&(t.shiftKey?(this.anchor||(this.anchor={infoId:e,rubroId:i}),this.cursor={infoId:_,rubroId:v}):(this.anchor={infoId:_,rubroId:v},this.cursor={infoId:_,rubroId:v}),this.focusCell(_,v))}onPaste(t,e,i){let n=t.clipboardData?.getData("text/plain");if(!n)return;this.isRestoring||this.pushUndoSnapshot();let r=this.rowIndexOf(e),u=this.rubroIndexOf(i);if(r<0||u<0)return;let m=n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(f=>f.length>0);if(m.length){t.preventDefault(),this.isBatching=!0;for(let f=0;f<m.length;f++){let g=m[f].split("	"),_=this.rows[r+f];if(!_)break;for(let v=0;v<g.length;v++){let h=this.rubros[u+v];if(!h)break;let x=g[v].trim();if(x===""){this.setNota(_.infoestudiantesifas_id,h.id,null,{skipUndo:!0});continue}this.setNota(_.infoestudiantesifas_id,h.id,x,{skipUndo:!0})}}this.isBatching=!1}}guardarCambios(){if(this.isSaving)return;if(this.dirty.size===0){this.saveOk="No hay cambios para guardar.",setTimeout(()=>this.saveOk=null,1500);return}let t=[];for(let i of this.dirty.values()){let[n,r]=i.split("__"),u=Number(n),m=Number(r);!Number.isFinite(u)||!Number.isFinite(m)||t.push({infoestudiantesifas_id:u,rubro_id:m,nota:this.notas.get(i)??null})}this.isSaving=!0,this.saveError=null,this.saveOk=null;let e=this.materia?.CantidadEvaluaciones??4;this.api.GuardarNotasBulk({materias_id:this.materiaId,numero_eval:this.evalNum,avg_eval_count:e,items:t}).subscribe({next:()=>{this.saveOk="Guardado.",this.dirty.clear(),setTimeout(()=>this.saveOk=null,1500),this.recargar()},error:i=>{console.error("Error guardando notas:",i),this.saveError="No se pudieron guardar los cambios."},complete:()=>{this.isSaving=!1}})}};F.\u0275fac=function(e){return new(e||F)(D(oe))},F.\u0275cmp=j({type:F,selectors:[["app-registroscalificaciones"]],standalone:!1,decls:74,vars:35,consts:[[1,"container-fluid","py-3"],[1,"card","shadow-sm"],[1,"card-header","bg-body"],[1,"d-flex","align-items-start","justify-content-between","gap-3","flex-wrap"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"mb-0"],["class","badge text-bg-secondary",4,"ngIf"],["class","badge text-bg-warning",4,"ngIf"],["class","text-muted small mt-1",4,"ngIf"],[1,"d-flex","align-items-center","gap-2"],[1,"text-muted","small"],[1,"form-select","form-select-sm",2,"width","240px",3,"ngModelChange","ngModel","disabled"],[3,"ngValue"],["role","group","aria-label","Acciones",1,"btn-group","btn-group-sm"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],["class","mt-2",4,"ngIf"],["role","tablist",1,"nav","nav-pills","nav-fill","mt-3"],["role","presentation",1,"nav-item"],["type","button",1,"nav-link",3,"click"],[1,"card-body","pt-2"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],["class","table-responsive mt-2",4,"ngIf"],["class","text-muted small mt-2",4,"ngIf"],["tabindex","-1",1,"modal","fade",3,"click"],[1,"modal-dialog","modal-dialog-centered",3,"click"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"modal-body"],[1,"mb-2"],[1,"form-label","form-label-sm"],["placeholder","Ej: Prueba corta",1,"form-control","form-control-sm",3,"ngModelChange","keydown.enter","ngModel"],[1,"row","g-2"],[1,"col-6"],["type","number","min","1","step","1",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"text-muted","small","mt-2"],[1,"modal-footer"],["type","button",1,"btn","btn-sm","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-sm","btn-primary",3,"click","disabled"],["class","modal-backdrop fade show",4,"ngIf"],[1,"badge","text-bg-secondary"],[1,"badge","text-bg-warning"],[1,"text-muted","small","mt-1"],[4,"ngIf"],[1,"mt-2"],["class","alert alert-danger py-2 mb-2",4,"ngIf"],["class","alert alert-success py-2 mb-0",4,"ngIf"],[1,"alert","alert-danger","py-2","mb-2"],[1,"alert","alert-success","py-2","mb-0"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"small","text-muted"],[1,"btn-group","btn-group-sm"],[1,"table-responsive","mt-2"],[1,"table","table-sm","table-bordered","table-hover","table-striped","align-middle","mb-0","reg-grid"],[1,"table-light"],["rowspan","2",1,"sticky-col","col-meta"],["rowspan","2",1,"sticky-col","col-meta-2"],["class","text-center",4,"ngIf"],[1,"text-center","col-add"],["type","button","title","Agregar rubro te\xF3rico",1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],["rowspan","2",1,"text-center","col-teo"],["type","button","title","Agregar rubro pr\xE1ctico",1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],["rowspan","2",1,"text-center","col-pra"],["rowspan","2",1,"text-center","col-sum"],["class","text-center",4,"ngFor","ngForOf"],[1,"text-muted"],[4,"ngFor","ngForOf"],[1,"text-center"],[1,"rubro-head-wrap"],[1,"rubro-head"],[1,"rubro-actions"],["type","button",1,"btn","btn-sm","btn-outline-danger",3,"click"],[1,"sticky-col","col-meta"],[1,"fw-semibold"],[1,"sticky-col","col-meta-2"],[3,"cell-selected",4,"ngFor","ngForOf"],[1,"col-add"],[1,"col-teo","text-center"],[1,"col-pra","text-center"],[1,"col-sum","text-center"],["type","number","min","0","step","1","inputmode","numeric",1,"form-control","form-control-sm",3,"ngModelChange","id","paste","keydown","mousedown","ngModel","data-row","data-col"],[1,"modal-backdrop","fade","show"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"div",4)(6,"h5",5),c(7,"Registro de calificaciones"),a(),y(8,Ue,2,0,"span",6)(9,Ge,2,1,"span",7),a(),y(10,Ze,9,5,"div",8),a(),o(11,"div",4)(12,"div",9)(13,"span",10),c(14,"Modo:"),a(),o(15,"select",11),A("ngModelChange",function(r){return O(i.modoEval,r)||(i.modoEval=r),r}),b("ngModelChange",function(r){return i.onModoChange(r)}),o(16,"option",12),c(17,"Promediar sobre 100 \u2192 Teo20 + Asist10 / Prac70"),a(),o(18,"option",12),c(19,"Promediar sobre 30/70 (Asist10 fijo)"),a(),o(20,"option",12),c(21,"Sumatoria (Asist10 fijo)"),a()()(),o(22,"div",13)(23,"button",14),b("click",function(){return i.recargar()}),c(24,"Recargar"),a(),o(25,"button",15),b("click",function(){return i.guardarCambios()}),c(26," Guardar "),a()()()(),y(27,tt,4,3,"div",16),o(28,"ul",17)(29,"li",18)(30,"button",19),b("click",function(){return i.setEval(1)}),c(31,"Eval 1"),a()(),o(32,"li",18)(33,"button",19),b("click",function(){return i.setEval(2)}),c(34,"Eval 2"),a()(),o(35,"li",18)(36,"button",19),b("click",function(){return i.setEval(3)}),c(37,"Eval 3"),a()(),o(38,"li",18)(39,"button",19),b("click",function(){return i.setEval(4)}),c(40,"Eval 4"),a()()()(),o(41,"div",20),y(42,it,8,5,"div",21)(43,ut,33,10,"div",22)(44,dt,2,0,"div",23),a()(),o(45,"div",24),b("click",function(r){return i.onModalBackdrop(r)}),o(46,"div",25),b("click",function(r){return r.stopPropagation()}),o(47,"div",26)(48,"div",27)(49,"h5",28),c(50),a(),o(51,"button",29),b("click",function(){return i.cerrarModal()}),a()(),o(52,"div",30)(53,"div",31)(54,"label",32),c(55,"Nombre"),a(),o(56,"input",33),A("ngModelChange",function(r){return O(i.nuevoNombre,r)||(i.nuevoNombre=r),r}),b("keydown.enter",function(){return i.confirmarModal()}),a()(),o(57,"div",34)(58,"div",35)(59,"label",32),c(60,"Max puntos"),a(),o(61,"input",36),A("ngModelChange",function(r){return O(i.nuevoMax,r)||(i.nuevoMax=r),r}),a()(),o(62,"div",35)(63,"label",32),c(64,"Orden"),a(),o(65,"input",36),A("ngModelChange",function(r){return O(i.nuevoOrden,r)||(i.nuevoOrden=r),r}),a()()(),o(66,"div",37),c(67,"Notas: todo se guarda como n\xFAmero entero (redondeado)."),a()(),o(68,"div",38)(69,"button",39),b("click",function(){return i.cerrarModal()}),c(70,"Cancelar"),a(),o(71,"button",40),b("click",function(){return i.confirmarModal()}),c(72),a()()()()(),y(73,mt,1,0,"div",41),a()),e&2&&(l(8),p("ngIf",i.isLoading),l(),p("ngIf",!i.isLoading&&i.dirty.size>0),l(),p("ngIf",i.materia),l(5),R("ngModel",i.modoEval),p("disabled",i.isLoading||i.isSaving),l(),p("ngValue",1),l(2),p("ngValue",2),l(2),p("ngValue",3),l(3),p("disabled",i.isLoading||i.isSaving),l(2),p("disabled",i.isLoading||i.isSaving||i.dirty.size===0),l(2),p("ngIf",i.loadError||i.saveError||i.saveOk),l(3),S("active",i.evalNum===1),l(3),S("active",i.evalNum===2),l(3),S("active",i.evalNum===3),l(3),S("active",i.evalNum===4),l(3),p("ngIf",i.meta),l(),p("ngIf",i.rows.length),l(),p("ngIf",!i.isLoading&&!i.rows.length),l(),ge("display",i.modalVisible?"block":"none"),S("show",i.modalVisible),k("aria-hidden",!i.modalVisible),l(5),U("",i.modalModo==="create"?"Agregar":"Editar"," rubro ",i.modalTipo==="TEO"?"te\xF3rico":"pr\xE1ctico"),l(6),R("ngModel",i.nuevoNombre),l(5),R("ngModel",i.nuevoMax),l(4),R("ngModel",i.nuevoOrden),l(6),p("disabled",!i.nuevoNombre.trim()||i.isLoading||i.isSaving),l(),P(i.modalModo==="create"?"Agregar":"Guardar"),l(),p("ngIf",i.modalVisible))},dependencies:[q,X,te,ie,Y,Q,ee,Z,ne,J],styles:["[_nghost-%COMP%]{display:block}.reg-grid[_ngcontent-%COMP%]{border-collapse:separate;border-spacing:0}.reg-grid[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;z-index:3;background:var(--bs-tertiary-bg)}.sticky-col[_ngcontent-%COMP%]{position:sticky;left:0;z-index:2;background:var(--bs-body-bg)}.col-meta[_ngcontent-%COMP%]{min-width:260px}.col-meta-2[_ngcontent-%COMP%]{left:260px;min-width:120px;z-index:2}.col-teo[_ngcontent-%COMP%], .col-pra[_ngcontent-%COMP%], .col-sum[_ngcontent-%COMP%]{min-width:90px}.col-add[_ngcontent-%COMP%]{width:42px;min-width:42px;max-width:42px}.reg-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .reg-grid[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap}.rubro-head[_ngcontent-%COMP%]{writing-mode:vertical-lr;text-orientation:mixed;white-space:normal;line-height:1.1;font-weight:600;max-height:180px;overflow:hidden;margin:0 auto}.rubro-head-wrap[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:6px}.rubro-actions[_ngcontent-%COMP%]{display:flex;gap:4px}.reg-grid[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{padding:.15rem .35rem;text-align:center}.reg-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.cell-selected[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{outline:2px solid var(--bs-primary);outline-offset:-1px}"]});var le=F;var pt=[{path:"calificaciones",component:re},{path:"registrocalificaciones",component:le}],V=class V{};V.\u0275fac=function(e){return new(e||V)},V.\u0275mod=W({type:V}),V.\u0275inj=z({imports:[ce.forChild(pt),ce]});var se=V;var K=class K{};K.\u0275fac=function(e){return new(e||K)},K.\u0275mod=W({type:K}),K.\u0275inj=z({imports:[be,Ee,se]});var Me=K;export{Me as DocentesModule};
