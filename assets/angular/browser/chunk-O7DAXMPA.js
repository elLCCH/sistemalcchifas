import{a as B}from"./chunk-KFXCIGMC.js";import{Da as c,Ea as l,Fa as r,Na as k,P as x,Q as C,Qa as E,Qb as y,Sa as d,Zb as T,ab as S,ea as n,eb as p,fb as g,fc as b,gb as h,la as f,lc as w,na as I,sa as m}from"./chunk-LW4OU2FI.js";import"./chunk-ATDPNAVO.js";function L(i,t){i&1&&(l(0,"div",4),p(1," No hay celular vinculado. Vuelve a la PC y escanea el QR de vinculaci\xF3n. "),r())}function P(i,t){i&1&&(l(0,"div",11),p(1," Esperando solicitud de captura desde la PC... "),r())}function A(i,t){if(i&1&&(l(0,"div",6),p(1),r()),i&2){let e=d(3);n(),h("Expira: ",e.captureExpiresAt)}}function U(i,t){if(i&1&&(l(0,"div",15)(1,"div",19)(2,"div",20),p(3),r()()()),i&2){let e=d(3);n(2),S("width",e.progress,"%"),n(),h("",e.progress,"%")}}function H(i,t){if(i&1&&(l(0,"div",21),p(1),r()),i&2){let e=d(3);n(),g(e.message)}}function D(i,t){if(i&1&&(l(0,"div",22),p(1),r()),i&2){let e=d(3);n(),g(e.error)}}function N(i,t){if(i&1){let e=k();l(0,"div",12)(1,"div",13)(2,"div",7),p(3,"Solicitud recibida"),r(),m(4,A,2,1,"div",14),l(5,"div",15)(6,"input",16),E("change",function(s){x(e);let o=d(2);return C(o.onFileSelected(s))}),r()(),m(7,U,4,3,"div",17)(8,H,2,1,"div",18)(9,D,2,1,"div",10),r()()}if(i&2){let e=d(2);n(4),c("ngIf",e.captureExpiresAt),n(2),c("disabled",e.uploading),n(),c("ngIf",e.uploading),n(),c("ngIf",e.message),n(),c("ngIf",e.error)}}function F(i,t){if(i&1&&(l(0,"div",22),p(1),r()),i&2){let e=d(2);n(),g(e.error)}}function M(i,t){if(i&1&&(l(0,"div")(1,"div",5)(2,"div",6),p(3,"Estado"),r(),l(4,"div",7),p(5),r()(),m(6,P,2,0,"div",8)(7,N,10,5,"div",9)(8,F,2,1,"div",10),r()),i&2){let e=d();n(5),g(e.pairingStatus||"..."),n(),c("ngIf",!e.captureToken),n(),c("ngIf",e.captureToken),n(),c("ngIf",e.error&&!e.captureToken)}}var u=class u{constructor(t,e){this.route=t;this.http=e;this.ruta="";this.pairingToken=null;this.pairingStatus=null;this.captureToken=null;this.captureExpiresAt=null;this.pollingId=null;this.revokeSent=!1;this.onPageHideBound=()=>this.sendRevokeBestEffort("pagehide");this.onBeforeUnloadBound=()=>this.sendRevokeBestEffort("beforeunload");this.uploading=!1;this.progress=0;this.message=null;this.error=null;this.ruta=this.resolveBackendBaseUrl();let a=this.route.snapshot.paramMap.get("token"),s=localStorage.getItem("lcch_capture_pairing_token");this.pairingToken=a||s,this.pairingToken&&localStorage.setItem("lcch_capture_pairing_token",this.pairingToken)}resolveBackendBaseUrl(){let t=window.location.origin.replace(/\/+$/,"")+"/",e=(B.ruta??"").trim();if(!e)return t;try{let a=new URL(e,t),s=(a.hostname||"").toLowerCase(),o=(window.location.hostname||"").toLowerCase();if((s==="localhost"||s==="127.0.0.1"||s==="::1")&&o&&o!==s){let _=new URL(a.toString());return _.hostname=o,_.toString()}return a.toString()}catch{return t}}ngOnInit(){this.pairingToken&&(window.addEventListener("pagehide",this.onPageHideBound),window.addEventListener("beforeunload",this.onBeforeUnloadBound),this.http.post(this.ruta+"api/capture-pairings/"+this.pairingToken+"/link",{device_label:"CELULAR"}).subscribe({next:t=>{this.pairingStatus=t?.data?.status??"LINKED",this.startPolling()},error:t=>{let e=t?.status;(e===404||e===409||e===410)&&localStorage.removeItem("lcch_capture_pairing_token"),this.error=t?.error?.error??"No se pudo vincular. Vuelve a generar el QR desde la PC."}}))}ngOnDestroy(){this.pollingId&&(clearInterval(this.pollingId),this.pollingId=null),window.removeEventListener("pagehide",this.onPageHideBound),window.removeEventListener("beforeunload",this.onBeforeUnloadBound),this.sendRevokeBestEffort("ngOnDestroy")}sendRevokeBestEffort(t){if(this.revokeSent||!this.pairingToken)return;let e=this.ruta+"api/capture-pairings/"+this.pairingToken+"/revoke",a=JSON.stringify({reason:t});try{if(typeof navigator<"u"&&"sendBeacon"in navigator){let s=new Blob([a],{type:"application/json"});navigator.sendBeacon(e,s)}else fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:a,keepalive:!0}).catch(()=>{})}catch{}this.revokeSent=!0,localStorage.removeItem("lcch_capture_pairing_token")}startPolling(){this.pairingToken&&(this.pollingId&&clearInterval(this.pollingId),this.pollingId=setInterval(()=>{!this.pairingToken||this.uploading||this.http.get(this.ruta+"api/capture-pairings/"+this.pairingToken+"/pending-capture").subscribe({next:t=>{if(this.pairingStatus=t?.data?.status??this.pairingStatus,this.pairingStatus==="REVOKED"||this.pairingStatus==="EXPIRED"){localStorage.removeItem("lcch_capture_pairing_token"),this.pairingToken=null,this.captureToken=null,this.captureExpiresAt=null;return}let e=t?.data?.capture_token??null,a=t?.data?.expires_at??null;this.captureToken=e,this.captureExpiresAt=a},error:()=>{}})},2e3))}onFileSelected(t){let e=t.target,a=e.files?.item(0);if(e.value="",!a||!this.captureToken)return;this.uploading=!0,this.progress=0,this.message=null,this.error=null;let s=new FormData;s.append("file",a),this.http.post(this.ruta+"api/capture-sessions/"+this.captureToken+"/upload",s,{reportProgress:!0,observe:"events"}).subscribe({next:o=>{if(o?.type===1&&o.total){this.progress=Math.round(o.loaded/o.total*100);return}o?.type===4&&(this.uploading=!1,this.message="Foto enviada. Puedes esperar la siguiente solicitud.",this.captureToken=null,this.captureExpiresAt=null)},error:o=>{this.uploading=!1,this.progress=0;let v=o?.status;if(v===413){this.error="La foto supera el l\xEDmite permitido (m\xE1x 40MB). Si en el hosting est\xE1 m\xE1s bajo, aumenta upload_max_filesize y post_max_size a >= 40M.";return}if(v===0){this.error="No se pudo conectar con el servidor (red/HTTPS/CORS). Verifica que la URL sea https y que /api est\xE9 accesible.";return}this.error=o?.error?.error??"No se pudo subir la foto"}})}};u.\u0275fac=function(e){return new(e||u)(f(w),f(b))},u.\u0275cmp=I({type:u,selectors:[["app-captura-celular"]],decls:5,vars:2,consts:[[1,"container","py-4",2,"max-width","520px"],[1,"mb-2"],["class","alert alert-warning",4,"ngIf"],[4,"ngIf"],[1,"alert","alert-warning"],[1,"mb-3"],[1,"small","text-muted"],[1,"fw-semibold"],["class","alert alert-info",4,"ngIf"],["class","card",4,"ngIf"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"alert","alert-info"],[1,"card"],[1,"card-body"],["class","small text-muted",4,"ngIf"],[1,"mt-3"],["type","file","accept","image/*","capture","environment",1,"form-control",3,"change","disabled"],["class","mt-3",4,"ngIf"],["class","alert alert-success mt-3",4,"ngIf"],[1,"progress"],["role","progressbar",1,"progress-bar"],[1,"alert","alert-success","mt-3"],[1,"alert","alert-danger","mt-3"]],template:function(e,a){e&1&&(l(0,"div",0)(1,"h2",1),p(2,"Captura desde celular"),r(),m(3,L,2,0,"div",2)(4,M,9,4,"div",3),r()),e&2&&(n(3),c("ngIf",!a.pairingToken),n(),c("ngIf",a.pairingToken))},dependencies:[T,y],encapsulation:2});var R=u;export{R as CapturaCelularComponent};
