import{a as w}from"./chunk-KFXCIGMC.js";import{Da as s,Ea as o,Fa as a,Na as I,P as _,Q as x,Qa as k,Qb as T,Sa as d,Zb as y,ab as E,ea as n,eb as l,fb as g,fc as S,gb as f,la as v,lc as b,na as C,sa as m}from"./chunk-LW4OU2FI.js";import"./chunk-ATDPNAVO.js";function P(t,i){t&1&&(o(0,"div",4),l(1," No hay celular vinculado. Vuelve a la PC y escanea el QR de vinculaci\xF3n. "),a())}function R(t,i){t&1&&(o(0,"div",11),l(1," Esperando solicitud de captura desde la PC... "),a())}function A(t,i){if(t&1&&(o(0,"div",6),l(1),a()),t&2){let e=d(3);n(),f("Expira: ",e.captureExpiresAt)}}function L(t,i){if(t&1&&(o(0,"div",15)(1,"div",19)(2,"div",20),l(3),a()()()),t&2){let e=d(3);n(2),E("width",e.progress,"%"),n(),f("",e.progress,"%")}}function D(t,i){if(t&1&&(o(0,"div",21),l(1),a()),t&2){let e=d(3);n(),g(e.message)}}function N(t,i){if(t&1&&(o(0,"div",22),l(1),a()),t&2){let e=d(3);n(),g(e.error)}}function F(t,i){if(t&1){let e=I();o(0,"div",12)(1,"div",13)(2,"div",7),l(3,"Solicitud recibida"),a(),m(4,A,2,1,"div",14),o(5,"div",15)(6,"input",16),k("change",function(c){_(e);let p=d(2);return x(p.onFileSelected(c))}),a()(),m(7,L,4,3,"div",17)(8,D,2,1,"div",18)(9,N,2,1,"div",10),a()()}if(t&2){let e=d(2);n(4),s("ngIf",e.captureExpiresAt),n(2),s("disabled",e.uploading),n(),s("ngIf",e.uploading),n(),s("ngIf",e.message),n(),s("ngIf",e.error)}}function H(t,i){if(t&1&&(o(0,"div",22),l(1),a()),t&2){let e=d(2);n(),g(e.error)}}function M(t,i){if(t&1&&(o(0,"div")(1,"div",5)(2,"div",6),l(3,"Estado"),a(),o(4,"div",7),l(5),a()(),m(6,R,2,0,"div",8)(7,F,10,5,"div",9)(8,H,2,1,"div",10),a()),t&2){let e=d();n(5),g(e.pairingStatus||"..."),n(),s("ngIf",!e.captureToken),n(),s("ngIf",e.captureToken),n(),s("ngIf",e.error&&!e.captureToken)}}var u=class u{constructor(i,e){this.route=i;this.http=e;this.ruta=w.ruta;this.pairingToken=null;this.pairingStatus=null;this.captureToken=null;this.captureExpiresAt=null;this.pollingId=null;this.revokeSent=!1;this.onPageHideBound=()=>this.sendRevokeBestEffort("pagehide");this.onBeforeUnloadBound=()=>this.sendRevokeBestEffort("beforeunload");this.uploading=!1;this.progress=0;this.message=null;this.error=null;let r=this.route.snapshot.paramMap.get("token"),c=localStorage.getItem("lcch_capture_pairing_token");this.pairingToken=r||c,this.pairingToken&&localStorage.setItem("lcch_capture_pairing_token",this.pairingToken)}ngOnInit(){this.pairingToken&&(window.addEventListener("pagehide",this.onPageHideBound),window.addEventListener("beforeunload",this.onBeforeUnloadBound),this.http.post(this.ruta+"api/capture-pairings/"+this.pairingToken+"/link",{device_label:"CELULAR"}).subscribe({next:i=>{this.pairingStatus=i?.data?.status??"LINKED",this.startPolling()},error:i=>{let e=i?.status;(e===404||e===409||e===410)&&localStorage.removeItem("lcch_capture_pairing_token"),this.error=i?.error?.error??"No se pudo vincular. Vuelve a generar el QR desde la PC."}}))}ngOnDestroy(){this.pollingId&&(clearInterval(this.pollingId),this.pollingId=null),window.removeEventListener("pagehide",this.onPageHideBound),window.removeEventListener("beforeunload",this.onBeforeUnloadBound),this.sendRevokeBestEffort("ngOnDestroy")}sendRevokeBestEffort(i){if(this.revokeSent||!this.pairingToken)return;let e=this.ruta+"api/capture-pairings/"+this.pairingToken+"/revoke",r=JSON.stringify({reason:i});try{if(typeof navigator<"u"&&"sendBeacon"in navigator){let c=new Blob([r],{type:"application/json"});navigator.sendBeacon(e,c)}else fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:r,keepalive:!0}).catch(()=>{})}catch{}this.revokeSent=!0,localStorage.removeItem("lcch_capture_pairing_token")}startPolling(){this.pairingToken&&(this.pollingId&&clearInterval(this.pollingId),this.pollingId=setInterval(()=>{!this.pairingToken||this.uploading||this.http.get(this.ruta+"api/capture-pairings/"+this.pairingToken+"/pending-capture").subscribe({next:i=>{if(this.pairingStatus=i?.data?.status??this.pairingStatus,this.pairingStatus==="REVOKED"||this.pairingStatus==="EXPIRED"){localStorage.removeItem("lcch_capture_pairing_token"),this.pairingToken=null,this.captureToken=null,this.captureExpiresAt=null;return}let e=i?.data?.capture_token??null,r=i?.data?.expires_at??null;this.captureToken=e,this.captureExpiresAt=r},error:()=>{}})},2e3))}onFileSelected(i){let e=i.target,r=e.files?.item(0);if(e.value="",!r||!this.captureToken)return;this.uploading=!0,this.progress=0,this.message=null,this.error=null;let c=new FormData;c.append("file",r),this.http.post(this.ruta+"api/capture-sessions/"+this.captureToken+"/upload",c,{reportProgress:!0,observe:"events"}).subscribe({next:p=>{if(p?.type===1&&p.total){this.progress=Math.round(p.loaded/p.total*100);return}p?.type===4&&(this.uploading=!1,this.message="Foto enviada. Puedes esperar la siguiente solicitud.",this.captureToken=null,this.captureExpiresAt=null)},error:p=>{this.uploading=!1,this.progress=0;let h=p?.status;if(h===413){this.error="La foto supera el l\xEDmite permitido (m\xE1x 40MB). Si en el hosting est\xE1 m\xE1s bajo, aumenta upload_max_filesize y post_max_size a >= 40M.";return}if(h===0){this.error="No se pudo conectar con el servidor (red/HTTPS/CORS). Verifica que la URL sea https y que /api est\xE9 accesible.";return}this.error=p?.error?.error??"No se pudo subir la foto"}})}};u.\u0275fac=function(e){return new(e||u)(v(b),v(S))},u.\u0275cmp=C({type:u,selectors:[["app-captura-celular"]],decls:5,vars:2,consts:[[1,"container","py-4",2,"max-width","520px"],[1,"mb-2"],["class","alert alert-warning",4,"ngIf"],[4,"ngIf"],[1,"alert","alert-warning"],[1,"mb-3"],[1,"small","text-muted"],[1,"fw-semibold"],["class","alert alert-info",4,"ngIf"],["class","card",4,"ngIf"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"alert","alert-info"],[1,"card"],[1,"card-body"],["class","small text-muted",4,"ngIf"],[1,"mt-3"],["type","file","accept","image/*","capture","environment",1,"form-control",3,"change","disabled"],["class","mt-3",4,"ngIf"],["class","alert alert-success mt-3",4,"ngIf"],[1,"progress"],["role","progressbar",1,"progress-bar"],[1,"alert","alert-success","mt-3"],[1,"alert","alert-danger","mt-3"]],template:function(e,r){e&1&&(o(0,"div",0)(1,"h2",1),l(2,"Captura desde celular"),a(),m(3,P,2,0,"div",2)(4,M,9,4,"div",3),a()),e&2&&(n(3),s("ngIf",!r.pairingToken),n(),s("ngIf",r.pairingToken))},dependencies:[y,T],encapsulation:2});var B=u;export{B as CapturaCelularComponent};
