import{a as ot}from"./chunk-WANVCWDU.js";import{a as nt}from"./chunk-J5Y3SAOU.js";import{a as Se}from"./chunk-O24TPCPO.js";import{a as et}from"./chunk-76LOQ7RP.js";import{a as tt}from"./chunk-CLO6LTW7.js";import"./chunk-724O7RRN.js";import{a as it}from"./chunk-2GD4CMSK.js";import"./chunk-WJU65V47.js";import{a as qe}from"./chunk-DNUF2RNX.js";import{a as Je}from"./chunk-BPBF5BY4.js";import{b as Ye}from"./chunk-P3GASOP5.js";import{b as Xe}from"./chunk-LRDGIBFV.js";import"./chunk-44ZKMDH4.js";import"./chunk-NCIXDP2C.js";import{b as Ce}from"./chunk-KCTZUZJH.js";import{e as Q,g as je,k as Te}from"./chunk-PWQJWZZZ.js";import{b as Ze}from"./chunk-OX7OA6PN.js";import{g as Qe}from"./chunk-EGRYB44C.js";import"./chunk-5VY7FQQV.js";import{b as xe,c as Z,f as J,g as Ke,j as Pe,k as Y,l as $e,m as ve,o as Ue,p as Ge,q as We,r as ee,s as te,t as ie,u as He,v as ye}from"./chunk-ROSYCBC4.js";import{a as Be}from"./chunk-JISGPZ2J.js";import{Aa as fe,Bb as ue,Cb as me,Da as Re,Db as pe,Dc as Fe,Ea as l,F as le,Fc as q,Gb as De,Gc as X,Hb as Ve,Ib as F,Lb as d,Ma as N,Mb as S,Nb as w,Ob as H,Oc as Le,Pb as be,Ra as W,Sa as he,Tb as T,Ub as P,Vb as A,Wa as v,Yc as ze,Z as Oe,_ as _e,ab as V,ba as Ne,ga as f,ha as h,hc as B,ib as u,jb as r,k as se,kb as a,lb as I,o as j,pb as ce,qb as de,sb as M,ua as ke,vb as x,w as Ae,xb as m}from"./chunk-SPNCLBHB.js";import{a as O,b as G,m as D}from"./chunk-GG76335P.js";function pt(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m();l(),w(" ",e.materia.Anio)}}function gt(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2);l(),w("",e.materia.MateriaParalelo," ")}}function _t(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2);l(),S(e.materia.SiglaMateria)}}function ft(s,t){if(s&1&&(r(0,"span",32),d(1),a()),s&2){let e=m(2);l(),S(e.docentesLabelHeader())}}function ht(s,t){if(s&1&&(r(0,"p",29),d(1),v(2,gt,2,1,"span",5),d(3," - "),r(4,"span",30),d(5),a(),d(6," - "),v(7,_t,2,1,"span",5),d(8," - "),v(9,ft,2,1,"span",31),a()),s&2){let e=m();l(),w(" ",e.materia.LvlCurso||"Curso"," "),l(),u("ngIf",e.materia.MateriaParalelo),l(3),w(" ",e.materia.NombreMateria||"Materia"),l(2),u("ngIf",e.materia.SiglaMateria),l(2),u("ngIf",e.docentesLabelHeader())}}function bt(s,t){if(s&1){let e=M();r(0,"label",42)(1,"input",18),x("ngModelChange",function(n){f(e);let o=m(2);return h(o.onEvalEnabledChange(0,n))}),a(),r(2,"span",43),d(3,"1"),a()()}if(s&2){let e=m(2);l(),u("ngModel",e.evalEnabled[0])}}function xt(s,t){if(s&1){let e=M();r(0,"label",42)(1,"input",18),x("ngModelChange",function(n){f(e);let o=m(2);return h(o.onEvalEnabledChange(1,n))}),a(),r(2,"span",43),d(3,"2"),a()()}if(s&2){let e=m(2);l(),u("ngModel",e.evalEnabled[1])}}function vt(s,t){if(s&1){let e=M();r(0,"label",42)(1,"input",18),x("ngModelChange",function(n){f(e);let o=m(2);return h(o.onEvalEnabledChange(2,n))}),a(),r(2,"span",43),d(3,"3"),a()()}if(s&2){let e=m(2);l(),u("ngModel",e.evalEnabled[2])}}function yt(s,t){if(s&1){let e=M();r(0,"label",42)(1,"input",18),x("ngModelChange",function(n){f(e);let o=m(2);return h(o.onEvalEnabledChange(3,n))}),a(),r(2,"span",43),d(3,"4"),a()()}if(s&2){let e=m(2);l(),u("ngModel",e.evalEnabled[3])}}function Ct(s,t){if(s&1&&(r(0,"option",44),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e),l(),w("",e," eval")}}function St(s,t){if(s&1){let e=M();ce(0),r(1,"div",33)(2,"span",34),d(3,"Evaluaciones"),a(),v(4,bt,4,1,"label",35)(5,xt,4,1,"label",35)(6,vt,4,1,"label",35)(7,yt,4,1,"label",35),a(),r(8,"div",36)(9,"button",37),x("click",function(){f(e);let n=m();return h(n.setAllEvaluations(!0))}),d(10,"Todas"),a(),r(11,"button",37),x("click",function(){f(e);let n=m();return h(n.setAllEvaluations(!1))}),d(12,"Ninguna"),a()(),r(13,"div",38)(14,"span",13),d(15,"Prom"),a(),r(16,"select",14),x("ngModelChange",function(n){f(e);let o=m();return h(o.onAvgEvalCountChange(n))}),v(17,Ct,2,2,"option",39),a()(),r(18,"div",40)(19,"span",13),d(20,"Teo \u2264"),a(),r(21,"input",41),A("ngModelChange",function(n){f(e);let o=m();return P(o.maxTeorico,n)||(o.maxTeorico=n),h(n)}),a()(),r(22,"div",40)(23,"span",13),d(24,"Prac \u2264"),a(),r(25,"input",41),A("ngModelChange",function(n){f(e);let o=m();return P(o.maxPractico,n)||(o.maxPractico=n),h(n)}),a()(),de()}if(s&2){let e=m();l(4),u("ngIf",e.evalCountMax>=1),l(),u("ngIf",e.evalCountMax>=2),l(),u("ngIf",e.evalCountMax>=3),l(),u("ngIf",e.evalCountMax>=4),l(9),u("ngModel",e.avgEvalCount),l(),u("ngForOf",e.evalOptions()),l(4),T("ngModel",e.maxTeorico),u("readOnly",!0),l(4),T("ngModel",e.maxPractico),u("readOnly",!0)}}function Et(s,t){if(s&1&&(r(0,"option",44),d(1),a()),s&2){let e=t.$implicit,i=m(2);u("ngValue",e.id),l(),S(i.docenteOptionLabel(e))}}function Mt(s,t){if(s&1){let e=M();ce(0),r(1,"div",45)(2,"span",13),d(3,"Docente"),a(),r(4,"select",14),x("ngModelChange",function(n){f(e);let o=m();return h(o.onBoletinDocenteChange(n))}),r(5,"option",44),d(6,"TODOS"),a(),v(7,Et,2,2,"option",39),a()(),de()}if(s&2){let e=m();l(4),u("ngModel",e.boletinDocenteId),l(),u("ngValue",0),l(2),u("ngForOf",e.docentes)}}function wt(s,t){if(s&1&&(r(0,"option",44),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e),l(),S(e)}}function It(s,t){if(s&1){let e=M();ce(0),r(1,"div",46)(2,"span",13),d(3,"Especialidad"),a(),r(4,"select",47),A("ngModelChange",function(n){f(e);let o=m();return P(o.boletinEspecialidad,n)||(o.boletinEspecialidad=n),h(n)}),v(5,wt,2,2,"option",39),a()(),de()}if(s&2){let e=m();l(4),T("ngModel",e.boletinEspecialidad),u("disabled",e.boletinEspecialidadLocked),l(),u("ngForOf",e.boletinEspecialidadOptions)}}function Tt(s,t){if(s&1&&(r(0,"div",48),d(1),a()),s&2){let e=m();l(),S(e.loadError)}}function Pt(s,t){if(s&1&&(r(0,"div",48),d(1),a()),s&2){let e=m();l(),S(e.saveError)}}function At(s,t){if(s&1&&(r(0,"div",49),d(1),a()),s&2){let e=m();l(),S(e.saveOk)}}function Ot(s,t){if(s&1){let e=M();r(0,"div",50)(1,"div",51),d(2),a(),r(3,"div",52)(4,"button",53),x("click",function(){f(e);let n=m();return h(n.prev())}),d(5,"Anterior"),a(),r(6,"button",53),x("click",function(){f(e);let n=m();return h(n.next())}),d(7,"Siguiente"),a()()()}if(s&2){let e=m();l(2),be("Mostrando ",e.meta.from||0,"-",e.meta.to||0," de ",e.meta.total),l(2),u("disabled",!e.tienePrev()||e.isLoading),l(2),u("disabled",!e.tieneNext()||e.isLoading)}}function Nt(s,t){if(s&1&&(r(0,"th"),d(1),a()),s&2){let e=t.$implicit;F("sep-after",e.sepAfter),l(),S(e.label)}}function kt(s,t){if(s&1&&(r(0,"div"),d(1),a()),s&2){let e=m(2).$implicit;l(),w("Sec: ",e.InstrumentoMusicalSecundario)}}function Rt(s,t){if(s&1&&(r(0,"div",67),v(1,kt,2,1,"div",5),a()),s&2){let e=m().$implicit;l(),u("ngIf",e.InstrumentoMusicalSecundario)}}function Dt(s,t){if(s&1&&(r(0,"div",10),I(1,"img",68),a()),s&2){let e=m().$implicit,i=m(2);l(),u("src",i.fotoUrl(e.Foto),fe)}}function Vt(s,t){if(s&1){let e=M();ce(0),r(1,"input",71),x("ngModelChange",function(n){f(e);let o=m(),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onCellChange(g,p,c.key,n))})("focus",function(){f(e);let n=m(),o=n.$implicit,c=n.index,p=m().index,g=m(2);return h(g.onFocusGridInput(p,c,o.key))})("blur",function(){f(e);let n=m(),o=n.$implicit,c=n.index,p=m().index,g=m(2);return h(g.onBlurGridInput(p,c,o.key))})("click",function(n){f(e);let o=m(),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onClickGridInput(n,g,p,c.key))})("paste",function(n){f(e);let o=m().index,c=m().index,p=m(2);return h(p.onPaste(n,c,o))}),a(),de()}if(s&2){let e=m(),i=e.$implicit,n=e.index,o=m(),c=o.$implicit,p=o.index,g=m(2);l(),u("readOnly",i.readonly||!g.canEdit(i.key))("ngModel",c[i.key]),V("data-row",p)("data-col",n)}}function Ft(s,t){if(s&1){let e=M();r(0,"input",72),x("focus",function(){f(e);let n=m(),o=n.$implicit,c=n.index,p=m().index,g=m(2);return h(g.onFocusGridInput(p,c,o.key))})("blur",function(){f(e);let n=m(),o=n.$implicit,c=n.index,p=m().index,g=m(2);return h(g.onBlurGridInput(p,c,o.key))})("click",function(n){f(e);let o=m(),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onClickGridInput(n,g,p,c.key))}),a()}if(s&2){let e=m(),i=e.$implicit,n=e.index,o=m(),c=o.$implicit,p=o.index,g=m(2);u("readOnly",!0)("ngModel",g.sumValueForKey(c,i.key)),V("data-row",p)("data-col",n)}}function Lt(s,t){if(s&1){let e=M();r(0,"td",69),x("mousedown",function(n){let o=f(e),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onMouseDownGridCell(n,g,p,c.key))})("mouseover",function(n){let o=f(e),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onMouseOverGridCell(n,g,p,c.key))})("click",function(n){let o=f(e),c=o.$implicit,p=o.index,g=m().index,_=m(2);return h(_.onClickGridCell(n,g,p,c.key))}),v(1,Vt,2,4,"ng-container",70)(2,Ft,1,4,"ng-template",null,0,B),a()}if(s&2){let e=t.$implicit,i=t.index,n=De(3),o=m(),c=o.$implicit,p=o.index,g=m(2);F("sep-after",e.sepAfter)("cell-danger",g.isCellDanger(c,e.key))("cell-selected",g.isGridCellSelected(p,i,e.key))("cell-editing",g.isGridCellEditing(p,i,e.key)),l(),u("ngIf",!g.isSumColumn(e.key))("ngIfElse",n)}}function zt(s,t){if(s&1){let e=M();r(0,"tr")(1,"td",61),x("click",function(n){let o=f(e).index,c=m(2);return h(c.onClickMetaCell(n,o,"name"))}),r(2,"div",62),x("dblclick",function(){let n=f(e).$implicit,o=m(2);return h(o.toggleFoto(n))}),d(3),a(),v(4,Rt,2,1,"div",63)(5,Dt,2,1,"div",64),a(),r(6,"td",65),x("click",function(n){let o=f(e).index,c=m(2);return h(c.onClickMetaCell(n,o,"ci"))}),d(7),a(),v(8,Lt,4,10,"td",66),a()}if(s&2){let e=t.$implicit,i=t.index,n=m(2);F("table-danger",n.isDanger(e))("active-row",i===n.activeRow),l(),F("cell-selected",n.isMetaCellSelected(i,"name")),l(2),S(n.nombreCompleto(e)),l(),u("ngIf",e.InstrumentoMusical||e.InstrumentoMusicalSecundario),l(),u("ngIf",n.fotoAbierta(e)),l(),F("cell-selected",n.isMetaCellSelected(i,"ci")),l(),w(" ",e.CI||""," "),l(),u("ngForOf",n.columns)}}function jt(s,t){if(s&1&&(r(0,"div",54)(1,"table",55)(2,"thead",56)(3,"tr")(4,"th",57),d(5,"Estudiante"),a(),r(6,"th",58),d(7,"CI"),a(),v(8,Nt,2,3,"th",59),a()(),r(9,"tbody"),v(10,zt,9,13,"tr",60),a()()()),s&2){let e=m();l(8),u("ngForOf",e.columns),l(2),u("ngForOf",e.rows)}}function Bt(s,t){s&1&&(r(0,"div",73),d(1," No hay calificaciones asignadas a esta materia. "),a())}var ne=class ne{constructor(t,e,i,n,o,c){this.hostEl=t;this._calif=e;this._auth=i;this._reportes=n;this.route=o;this.router=c;this.materiaId=null;this.tipoSesion="";this.isAdminUser=!1;this.docentePerfilNombre=null;this.passingScore=61;this.minRevalida=40;this.materia=null;this.docentes=[];this.rows=[];this.columns=[];this.isLoading=!1;this.loadError=null;this.saveError=null;this.saveOk=null;this.isSaving=!1;this.meta=null;this.page=1;this.perPage=200;this.maxTeorico=30;this.maxPractico=70;this.avgEvalCount=4;this.viewMode="intercalado";this.editableEvaluations=!0;this.configLocked=!0;this.evalCountMax=4;this.showSumColumns=!1;this.evalEnabled=[!0,!0,!0,!0];this.openFotoInfoId=null;this.originalById=new Map;this.dirtyIds=new Set;this.activeRow=0;this.activeCol=0;this.selectedCell=null;this.editingCell=null;this.gridAnchor=null;this.gridSelection=null;this.isMouseSelecting=!1;this.suppressNextClick=!1;this.isGeneratingBoletin2026=!1;this.boletinEspecialidad="TODOS";this.boletinEspecialidadOptions=["TODOS"];this.boletinEspecialidadLocked=!1;this.boletinDocenteId=0;this.undoStack=[];this.redoStack=[];this.MAX_HISTORY=50;this.isBatchEdit=!1}ngOnInit(){this.rebuildColumns(),this._auth.pedirPerfil().subscribe({next:t=>{this.tipoSesion=(t?.tipo??"").toString(),this.isAdminUser=this.tipoSesion==="planteladministrativos"||this.tipoSesion==="usuarioslcchs"||this.tipoSesion==="superlcchs",this.configLocked=!this.isAdminUser;let e=this.tipoSesion==="planteldocentes";if(!this.isAdminUser&&!e){this.router.navigate(["/inicio"]);return}this.docentePerfilNombre=this.extractDocenteNombreFromPerfil(t),this.materia&&(this.applyConfigFromMateria(),this.rebuildColumns())},error:()=>{}}),this.route.queryParamMap.subscribe(t=>{let e=t.get("materiaId")??t.get("materias_id")??"",i=Number(e);if(!e||Number.isNaN(i)||i<=0){this.materiaId=null,this.rows=[],this.meta=null,this.materia=null,this.docentes=[],this.loadError='Falta seleccionar una materia. Vuelve a "Mis Materias" y abre calificaciones desde ah\xED.';return}let n=this.materiaId!==i;this.materiaId=i,n&&(this.boletinDocenteId=0,this.page=1,this.cargarCalificaciones(1))})}docentesLabelHeader(){if(!this.isAdminUser&&this.docentePerfilNombre?.label)return this.docentePerfilNombre.label;if(this.isAdminUser&&this.boletinPuedeFiltrarPorDocente&&this.boletinDocenteId>0){let t=this.docentes.find(i=>Number(i?.id)===Number(this.boletinDocenteId))??null;return(t?this.docenteOptionLabel(t):"")||this.docentesLabel()}return this.docentesLabel()}get boletinPuedeFiltrarPorDocente(){if(!this.isAdminUser)return!1;let t=this.getModoMateria();return t.includes("MODO INSTRUMENTOS DE ESPECIALIDAD")||t.includes("MODO INSTRUMENTO DE ESPECIALIDAD")||t.includes("MODO PRACTICA DE CONJUNTOS")||t.includes("MODO PRACTICA DE CONJUNTO")||t.includes("MODO INSTRUMENTO COMPLEMENTARIO")}docenteOptionLabel(t){let e=(t?.Apellidos??"").toString().trim(),i=(t?.Nombres??"").toString().trim();return[e,i].filter(Boolean).join(" ").trim()}onBoletinDocenteChange(t){let e=Number(t);this.boletinDocenteId=!Number.isNaN(e)&&e>0?e:0,this.cargarCalificaciones(1)}get showAdminControls(){return this.isAdminUser}normalizarTexto(t){return(t??"").toString().trim()}fotoUrl(t){let e=this.normalizarTexto(t);if(e===""||e.toLowerCase()==="null"||e.toLowerCase()==="undefined")return this._calif.ruta+"fijos/sinperfil.jpg";let i=e.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")||i.startsWith("data:")?e:this._calif.ruta+e}toggleFoto(t){let e=Number(t?.infoestudiantesifas_id);!e||Number.isNaN(e)||(this.openFotoInfoId=this.openFotoInfoId===e?null:e)}fotoAbierta(t){let e=Number(t?.infoestudiantesifas_id);return!!e&&this.openFotoInfoId===e}cargarCalificaciones(t=1){if(!this.materiaId){this.loadError="Materia inv\xE1lida.";return}if(this.isLoading)return;this.isLoading=!0,this.loadError=null,this.saveError=null,this.saveOk=null;let e=this.boletinPuedeFiltrarPorDocente&&this.boletinDocenteId>0?this.boletinDocenteId:void 0;this._calif.ObtenerCalificacionesPorMateriaPaginado(this.materiaId,{page:t,per_page:this.perPage,docente_id:e}).subscribe({next:n=>{let o=Array.isArray(n?.data)?n.data:[];this.rows=o.map(c=>O({},c)),this.materia=n?.materia??null,this.docentes=Array.isArray(n?.docentes)?n.docentes:[],this.meta=n?.meta??null,this.page=this.meta?.current_page??t,this.applyConfigFromMateria(),this.rebuildColumns(),this.rebuildBoletinEspecialidadOptions(),this.captureBaseline(),this.dirtyIds.clear(),this.activeRow=0,this.activeCol=0},error:n=>{console.error("Error al cargar calificaciones por materia:",n),this.rows=[],this.meta=null;let o=Number(n?.status);if(o===401||o===403){this.router.navigate(["/inicio"]);return}this.loadError=o===404?"Acceso no autorizado o materia no encontrada.":"No se pudieron cargar las calificaciones de la materia."},complete:()=>{this.isLoading=!1}})}applyConfigFromMateria(){let t=p=>{let _=(p??"").toString().match(/(\d+)/),b=Number(_?_[1]:p);return b===1||b===2||b===3||b===4?b:4},e=Number(this.materia?.LimiteMaxTeorico);!Number.isNaN(e)&&e>0&&(this.maxTeorico=Math.min(100,Math.max(0,e)));let i=Number(this.materia?.LimiteMaxPractico);!Number.isNaN(i)&&i>0&&(this.maxPractico=Math.min(100,Math.max(0,i)));let n=Number(this.materia?.NotaAprobacion);!Number.isNaN(n)&&n>0&&(this.passingScore=Math.min(100,Math.max(0,n)));let o=Number(this.materia?.NotaMinRevalida);!Number.isNaN(o)&&o>=0&&(this.minRevalida=Math.min(100,Math.max(0,o))),this.evalCountMax=t(this.materia?.CantidadEvaluaciones),this.avgEvalCount=this.evalCountMax;let c=this.parseEnabledEvaluations(this.materia?.EstadoHabilitacion,this.evalCountMax);this.evalEnabled=[c.has(1),c.has(2),c.has(3),c.has(4)];for(let p=this.evalCountMax;p<4;p++)this.evalEnabled[p]=!1;this.editableEvaluations=this.evalEnabled.some(Boolean)}evalOptions(){return[1,2,3,4].slice(0,this.evalCountMax)}parseEnabledEvaluations(t,e){let i=new Set,n=(t??"").toString().trim();if(!n)return i;let o=n.toUpperCase();if(o.includes("DESHABIL"))return i;if(o.includes("HABILIT")||o.includes("TODAS")||o.includes("TODO")){for(let c=1;c<=Math.max(1,Math.min(4,e));c++)i.add(c);return i}return(o.includes("PRIMERA")||/\b1\b/.test(o))&&i.add(1),(o.includes("SEGUNDA")||/\b2\b/.test(o))&&i.add(2),(o.includes("TERCERA")||/\b3\b/.test(o))&&i.add(3),(o.includes("CUARTA")||/\b4\b/.test(o))&&i.add(4),i}estadoEdicionLabel(){let t=(this.materia?.EstadoHabilitacion??"").toString().trim(),e=this.evalEnabled.map((i,n)=>i?n+1:null).filter(i=>typeof i=="number");return this.isAdminUser?e.length?`Edici\xF3n habilitada: ${e.join(", ")} (Admin)`:"Edici\xF3n deshabilitada":t?this.editableEvaluations?e.length?`Edici\xF3n habilitada: ${e.join(", ")} (${t})`:`Edici\xF3n deshabilitada (${t})`:`Edici\xF3n deshabilitada (${t})`:"Edici\xF3n deshabilitada"}recargarTabla(){this.cargarCalificaciones(this.page||1)}tienePrev(){return!!this.meta&&(this.meta.current_page??1)>1}tieneNext(){return!!this.meta&&(this.meta.current_page??1)<(this.meta.last_page??1)}prev(){this.tienePrev()&&this.cargarCalificaciones((this.meta.current_page??1)-1)}next(){this.tieneNext()&&this.cargarCalificaciones((this.meta.current_page??1)+1)}captureBaseline(){this.originalById.clear();for(let t of this.rows)this.originalById.set(t.id,O({},t))}snapshotRows(){let t={};for(let e of this.rows)t[e.id]={Teorico1:e.Teorico1??null,Teorico2:e.Teorico2??null,Teorico3:e.Teorico3??null,Teorico4:e.Teorico4??null,Practico1:e.Practico1??null,Practico2:e.Practico2??null,Practico3:e.Practico3??null,Practico4:e.Practico4??null,PromTeorico:e.PromTeorico??null,PromPractico:e.PromPractico??null,Promedio:e.Promedio??null,PruebaRecuperacion:e.PruebaRecuperacion??null};return t}restoreSnapshot(t){this.isBatchEdit=!0;try{this.dirtyIds.clear();for(let e of this.rows){let i=t[e.id];i&&(e.Teorico1=i.Teorico1??null,e.Teorico2=i.Teorico2??null,e.Teorico3=i.Teorico3??null,e.Teorico4=i.Teorico4??null,e.Practico1=i.Practico1??null,e.Practico2=i.Practico2??null,e.Practico3=i.Practico3??null,e.Practico4=i.Practico4??null,e.PruebaRecuperacion=i.PruebaRecuperacion??null,e.__cascadeActive=!1,e.__cascadeLockFrom=null,e.__cascadeBackup=null,this.recalcPromedios(e),this.recomputeDirtyForRow(e))}}finally{this.isBatchEdit=!1}}beginUserChange(){this.isBatchEdit||(this.undoStack.push(this.snapshotRows()),this.undoStack.length>this.MAX_HISTORY&&this.undoStack.shift(),this.redoStack=[])}undo(){if(this.undoStack.length===0)return;let t=this.snapshotRows(),e=this.undoStack.pop();this.redoStack.push(t),this.restoreSnapshot(e)}redo(){if(this.redoStack.length===0)return;let t=this.snapshotRows(),e=this.redoStack.pop();this.undoStack.push(t),this.restoreSnapshot(e)}recomputeDirtyForRow(t){let e=this.originalById.get(t.id);if(!e)return;["Teorico1","Practico1","Teorico2","Practico2","Teorico3","Practico3","Teorico4","Practico4","PruebaRecuperacion"].some(o=>(t[o]??null)!==(e[o]??null))?this.dirtyIds.add(t.id):this.dirtyIds.delete(t.id)}rebuildColumns(){let t=[],e=[1,2,3,4].slice(0,this.avgEvalCount),i=n=>{t.push({key:`Teorico${n}`,label:`Teo${n}`,widthClass:"w-80"}),t.push({key:`Practico${n}`,label:`Prac${n}`,widthClass:"w-80",sepAfter:!this.showSumColumns}),this.showSumColumns&&t.push({key:`Sum${n}`,label:`Sum${n}`,widthClass:"w-80",readonly:!0,sepAfter:!0})};if(this.viewMode==="intercalado")for(let n of e)i(n);else{for(let n of e)t.push({key:`Teorico${n}`,label:`Teo${n}`,widthClass:"w-80"});t[t.length-1].sepAfter=!0;for(let n of e)t.push({key:`Practico${n}`,label:`Prac${n}`,widthClass:"w-80"}),this.showSumColumns?t.push({key:`Sum${n}`,label:`Sum${n}`,widthClass:"w-80",readonly:!0,sepAfter:!0}):t[t.length-1].sepAfter=!0}t.push({key:"PromTeorico",label:"Prom Teo",readonly:!0,widthClass:"w-90"}),t.push({key:"PromPractico",label:"Prom Prac",readonly:!0,widthClass:"w-90"}),t.push({key:"Promedio",label:"Prom",readonly:!0,widthClass:"w-80",sepAfter:!0}),t.push({key:"PruebaRecuperacion",label:"Recup",widthClass:"w-80"}),this.columns=t}onShowSumColumnsChange(t){this.showSumColumns=!!t,this.rebuildColumns()}onEvalEnabledChange(t,e){if(this.configLocked||t<0||t>3||t+1>this.evalCountMax)return;this.evalEnabled[t]=!!e,this.editableEvaluations=this.evalEnabled.some(Boolean);let i=this.evalEnabled.map((n,o)=>n?o+1:0).reduce((n,o)=>Math.max(n,o),0);if(i>=1&&this.avgEvalCount<i){this.avgEvalCount=Math.min(this.evalCountMax,i);for(let n of this.rows)this.recalcPromedios(n);this.rebuildColumns()}}setAllEvaluations(t){if(!this.configLocked){this.evalEnabled=[!1,!1,!1,!1];for(let e=0;e<this.evalCountMax;e++)this.evalEnabled[e]=!!t;if(this.editableEvaluations=this.evalEnabled.some(Boolean),t){this.avgEvalCount=this.evalCountMax;for(let e of this.rows)this.recalcPromedios(e);this.rebuildColumns()}}}nombreCompleto(t){let e=(t.Ap_Paterno??"").trim(),i=(t.Ap_Materno??"").trim(),n=(t.Nombres??"").trim();return[e,i,n].filter(Boolean).join(" ").trim()||"(Sin nombre)"}docentesLabel(){return this.docentes?.length?this.docentes.map(t=>`${(t.Apellidos??"").trim()} ${(t.Nombres??"").trim()}`.trim()).filter(Boolean).join(", "):""}extractDocenteNombreFromPerfil(t){let e=t?.usuario??t??null;if(!e)return null;let i=(e?.Nombres??e?.Nombre??e?.nombres??e?.nombre??"").toString().trim(),n=(e?.Ap_Paterno??e?.ap_paterno??"").toString().trim(),o=(e?.Ap_Materno??e?.ap_materno??"").toString().trim(),c=(e?.Apellidos??e?.apellidos??"").toString().trim(),p=(e?.name??e?.Name??"").toString().trim(),_=([([n,o].filter(Boolean).join(" ").trim()||c).trim(),i].filter(Boolean).join(" ").trim()||p).trim();return _?{nombres:i,apPaterno:n,apMaterno:o,label:_}:null}normalizeUpper(t){return(t??"").toString().trim().toUpperCase()}normalizeModoKey(t){return(t??"").toString().trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}getModoMateria(){return this.normalizeModoKey(this.materia?.ModoMateria)}get boletinRequiereEspecialidad(){let t=this.getModoMateria();return t.includes("MODO INSTRUMENTOS DE ESPECIALIDAD")||t.includes("MODO INSTRUMENTO DE ESPECIALIDAD")||t.includes("MODO INSTRUMENTO COMPLEMENTARIO")}get boletinEsPracticaConjuntos(){let t=this.getModoMateria();return t.includes("MODO PRACTICA DE CONJUNTOS")||t.includes("MODO PRACTICA DE CONJUNTO")}get boletinEsMultiplesDocentes(){let t=this.getModoMateria();return t.includes("MULTIPLES DOCENTES")||t.includes("MULTIPLES DOCENTES X MATERIA")}getEspecialidadValueFromRow(t){return this.getModoMateria().includes("MODO INSTRUMENTO COMPLEMENTARIO")?(t.InstrumentoMusicalSecundario??"").toString().trim():(t.InstrumentoMusical??"").toString().trim()}formatTurnoForPdf(t){let e=(t??"").toString().trim();if(!e)return"";if(e.includes("-"))return e;let i=e.match(/^([A-Za-zÁÉÍÓÚÑ])\s+(.+)$/u);if(!i)return e;let n=(i[1]??"").trim(),o=(i[2]??"").trim();return!n||!o?e:`${n} - ${o}`}rebuildBoletinEspecialidadOptions(){if(!this.boletinRequiereEspecialidad){this.boletinEspecialidadOptions=["TODOS"],this.boletinEspecialidad="TODOS",this.boletinEspecialidadLocked=!1;return}let t=new Set;for(let n of this.rows){let o=this.getEspecialidadValueFromRow(n);o&&t.add(o)}let e=Array.from(t).sort((n,o)=>n.localeCompare(o));if(e.length===1){this.boletinEspecialidadOptions=[e[0]],this.boletinEspecialidad=e[0],this.boletinEspecialidadLocked=!0;return}let i=["TODOS",...e];this.boletinEspecialidadOptions=i,this.boletinEspecialidadLocked=!1,i.includes(this.boletinEspecialidad)||(this.boletinEspecialidad="TODOS")}buildCursoDataSesionForBoletin(){let t=this.normalizarTexto(this.materia?.NombreMateria)||"Materia",e=this.normalizarTexto(this.materia?.SiglaMateria),i=this.normalizarTexto(this.materia?.MateriaParalelo),n=[this.normalizarTexto(this.materia?.LvlCurso),i].filter(Boolean).join(" ").trim(),o=this.isAdminUser?null:this.docentePerfilNombre,c=this.docentes?.[0]??null,p=this.normalizarTexto(o?.nombres??c?.Nombres),g=this.normalizarTexto(o?.apPaterno??c?.Apellidos),_=this.normalizarTexto(o?.apMaterno);return{NombreCurso:t,Sigla:e,NivelCurso:n,Turno:this.formatTurnoForPdf(this.materia?.Turno),Malla:this.normalizarTexto(this.materia?.Malla),Nombre:p,Ap_Paterno:g,Ap_Materno:o?_:""}}mapRowsToReporteBoletin2026(t){return t.map(e=>{let i=(e.Nombres??"").toString().trim();return G(O({},e),{Nombre:i,Teorica1:e.Teorico1??null,Teorica2:e.Teorico2??null,Teorica3:e.Teorico3??null,Teorica4:e.Teorico4??null,Practica1:e.Practico1??null,Practica2:e.Practico2??null,Practica3:e.Practico3??null,Practica4:e.Practico4??null,PromEvT:e.PromTeorico??null,PromEvP:e.PromPractico??null,InstrumentoSecundario:e.InstrumentoMusicalSecundario??null})})}generarBoletin2026(){return D(this,null,function*(){if(!this.isGeneratingBoletin2026&&this.rows?.length)try{this.isGeneratingBoletin2026=!0;let t=this.getModoMateria(),e=this.boletinRequiereEspecialidad,i=e||this.boletinEsPracticaConjuntos||this.boletinEsMultiplesDocentes,n=this.rows,o="";if(e){let L=(this.boletinEspecialidad??"TODOS").toString().trim();L&&L!=="TODOS"?(n=this.rows.filter(dt=>this.getEspecialidadValueFromRow(dt)===L),o=`(${L})`):o="TODOS"}if(!n.length){this.saveError="No hay estudiantes para imprimir con la especialidad seleccionada.";return}let c=this.mapRowsToReporteBoletin2026(n),p=this.buildCursoDataSesionForBoletin(),g=this.normalizarTexto(this.materia?.Anio)||new Date().getFullYear().toString(),_=this.formatTurnoForPdf(this.materia?.Turno),b=this.docentes.find(L=>Number(L?.id)===Number(this.boletinDocenteId))??null,y=b?this.docenteOptionLabel(b):"",C=!this.isAdminUser&&this.docentePerfilNombre?.label?this.docentePerfilNombre.label:this.isAdminUser&&this.boletinPuedeFiltrarPorDocente&&this.boletinDocenteId>0?y||this.docentesLabel():this.docentesLabel(),E=!0,R=7,k=!1,z=e;yield this._reportes.GenerarBoletin2026DesdePerfil(c,p,o,C,g,_,E,i,R,k,z)}catch(t){console.error("Error al generar Bolet\xEDn 2026:",t),this.saveError="No se pudo generar el Bolet\xEDn 2026."}finally{this.isGeneratingBoletin2026=!1}})}isDanger(t){let e=t.Promedio;return typeof e=="number"&&e<this.passingScore}isSumKey(t){return typeof t=="string"&&t.startsWith("Sum")}isSumColumn(t){return this.isSumKey(t)}evalIndexFromKey(t){switch(t){case"Teorico1":case"Practico1":return 1;case"Teorico2":case"Practico2":return 2;case"Teorico3":case"Practico3":return 3;case"Teorico4":case"Practico4":return 4;default:return null}}evalIndexFromColumnKey(t){if(this.isSumKey(t)){let e=Number(t.replace("Sum",""));return e>=1&&e<=4?e:null}return this.evalIndexFromKey(t)}sumValue(t,e){let i=t[`Teorico${e}`],n=t[`Practico${e}`];return typeof i=="number"&&typeof n=="number"?i+n:null}sumValueForKey(t,e){let i=this.evalIndexFromColumnKey(e);return i===null?null:this.sumValue(t,i)}isCellDanger(t,e){let i=this.evalIndexFromColumnKey(e);if(i!==null){let n=this.sumValue(t,i);return typeof n=="number"&&n<this.passingScore}return e==="PromTeorico"?t.PromTeorico===null||t.PromTeorico===void 0?!1:t.PromTeorico*100<this.passingScore*this.maxTeorico:e==="PromPractico"?t.PromPractico===null||t.PromPractico===void 0?!1:t.PromPractico*100<this.passingScore*this.maxPractico:e==="Promedio"?t.Promedio!==null&&t.Promedio!==void 0&&t.Promedio<this.passingScore:e==="PruebaRecuperacion"?t.PruebaRecuperacion!==null&&t.PruebaRecuperacion!==void 0&&t.PruebaRecuperacion<this.passingScore:!1}clampNum(t,e,i){return Number.isNaN(t)||t<e?e:t>i?i:t}parseNullableInt(t){if(t==null)return null;let e=String(t).trim();if(e==="")return null;let i=parseInt(e,10);return Number.isFinite(i)?i:null}isTeoricoKey(t){return t==="Teorico1"||t==="Teorico2"||t==="Teorico3"||t==="Teorico4"}isPracticoKey(t){return t==="Practico1"||t==="Practico2"||t==="Practico3"||t==="Practico4"}recalcPromedios(t){let e=this.findZeroCascadeIndex(t),i=t,n=!!i.__cascadeActive,o=i.__cascadeLockFrom??null;if(e!==null){n||(i.__cascadeBackup={1:{teo:t.Teorico1??null,prac:t.Practico1??null},2:{teo:t.Teorico2??null,prac:t.Practico2??null},3:{teo:t.Teorico3??null,prac:t.Practico3??null},4:{teo:t.Teorico4??null,prac:t.Practico4??null}}),i.__cascadeActive=!0,i.__cascadeLockFrom=e;for(let b=e;b<=4;b++)t[`Teorico${b}`]=0,t[`Practico${b}`]=0}else if(n){let b=i.__cascadeBackup,y=o??1;if(b)for(let C=y+1;C<=4;C++){let E=b[C];if(!E)continue;let R=t[`Teorico${C}`],k=t[`Practico${C}`];typeof R=="number"&&typeof k=="number"&&R===0&&k===0&&(t[`Teorico${C}`]=E.teo,t[`Practico${C}`]=E.prac)}i.__cascadeActive=!1,i.__cascadeLockFrom=null,i.__cascadeBackup=null}if(e!==null){t.PromTeorico=0,t.PromPractico=0,t.Promedio=0;return}let c=[1,2,3,4].slice(0,this.avgEvalCount),p=b=>{let y=b.filter(E=>typeof E=="number");if(y.length===0)return null;let C=y.reduce((E,R)=>E+R,0);return Math.round(C/y.length)},g=c.map(b=>t[`Teorico${b}`]),_=c.map(b=>t[`Practico${b}`]);if(t.PromTeorico=p(g),t.PromPractico=p(_),t.PromTeorico===null&&t.PromPractico===null)t.Promedio=null;else{let b=(t.PromTeorico??0)+(t.PromPractico??0);t.Promedio=this.clampNum(Math.round(b),0,100)}}findZeroCascadeIndex(t){let e=t,i=!!e.__cascadeActive,n=e.__cascadeLockFrom??null;if(i&&n){for(let o=1;o<=n;o=o+1){let c=t[`Teorico${o}`],p=t[`Practico${o}`];if(typeof c=="number"&&typeof p=="number"&&c===0&&p===0)return o}return null}for(let o=1;o<=4;o=o+1){let c=t[`Teorico${o}`],p=t[`Practico${o}`];if(typeof c=="number"&&typeof p=="number"&&c===0&&p===0)return o}return null}canEdit(t){if(!this.editableEvaluations||this.isSumKey(t)||t==="PromTeorico"||t==="PromPractico"||t==="Promedio")return!1;let e=this.evalIndexFromColumnKey(t);return e!==null?!!this.evalEnabled[e-1]:!0}onFocusCell(t,e){this.activeRow=t,this.activeCol=e}onFocusGridInput(t,e,i){this.onFocusCell(t,e),this.selectedCell={kind:"grid",rowIndex:t,colIndex:e,key:i},this.editingCell={rowIndex:t,colIndex:e,key:i},this.gridAnchor={rowIndex:t,colIndex:e},this.gridSelection={r1:t,c1:e,r2:t,c2:e}}onBlurGridInput(t,e,i){this.editingCell&&this.editingCell.rowIndex===t&&this.editingCell.colIndex===e&&this.editingCell.key===i&&(this.editingCell=null)}onClickGridCell(t,e,i,n){if(this.suppressNextClick){this.suppressNextClick=!1;return}if(this.activeRow=e,this.activeCol=i,t.shiftKey&&this.gridAnchor){this.setGridSelection(this.gridAnchor.rowIndex,this.gridAnchor.colIndex,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n};return}this.gridAnchor={rowIndex:e,colIndex:i},this.setGridSelection(e,i,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n};let o=t.target;o&&o.tagName==="INPUT"||setTimeout(()=>this.focusCell(e,i))}onClickGridInput(t,e,i,n){if(this.suppressNextClick){this.suppressNextClick=!1;return}if(this.activeRow=e,this.activeCol=i,t.shiftKey&&this.gridAnchor){this.setGridSelection(this.gridAnchor.rowIndex,this.gridAnchor.colIndex,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n};return}this.gridAnchor={rowIndex:e,colIndex:i},this.setGridSelection(e,i,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n};let o=t.target;o&&o.tagName==="INPUT"&&setTimeout(()=>o.select())}onClickMetaCell(t,e,i){this.activeRow=e,this.activeCol=i==="name"?-2:-1,this.selectedCell={kind:"meta",rowIndex:e,meta:i},this.gridAnchor=null,this.gridSelection=null,t.currentTarget?.focus()}isGridCellSelected(t,e,i){return this.gridSelection?this.isInGridSelection(t,e):!!this.selectedCell&&this.selectedCell.kind==="grid"&&this.selectedCell.rowIndex===t&&this.selectedCell.colIndex===e&&this.selectedCell.key===i}onMouseDownGridCell(t,e,i,n){t.button===0&&(this.isMouseSelecting=!0,this.gridAnchor={rowIndex:e,colIndex:i},this.setGridSelection(e,i,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n})}onMouseOverGridCell(t,e,i,n){!this.isMouseSelecting||!this.gridAnchor||(this.setGridSelection(this.gridAnchor.rowIndex,this.gridAnchor.colIndex,e,i),this.selectedCell={kind:"grid",rowIndex:e,colIndex:i,key:n})}onDocumentMouseUp(t){this.isMouseSelecting&&(this.isMouseSelecting=!1,this.gridSelection&&(this.gridSelection.r1!==this.gridSelection.r2||this.gridSelection.c1!==this.gridSelection.c2)&&(this.suppressNextClick=!0))}setGridSelection(t,e,i,n){let o=Math.min(t,i),c=Math.max(t,i),p=Math.min(e,n),g=Math.max(e,n);this.gridSelection={r1:o,c1:p,r2:c,c2:g}}isInGridSelection(t,e){let i=this.gridSelection;return i?t>=i.r1&&t<=i.r2&&e>=i.c1&&e<=i.c2:!1}getSelectedGridRangeText(){let t=this.gridSelection;if(!t||t.r1===t.r2&&t.c1===t.c2)return null;let i=[];for(let n=t.r1;n<=t.r2;n++){let o=this.rows[n];if(!o){i.push("");continue}let c=[];for(let p=t.c1;p<=t.c2;p++){let g=this.columns[p];if(!g){c.push("");continue}let _=g.key;if(this.isSumColumn(_)){let b=this.sumValueForKey(o,_);c.push((b??"").toString())}else{let b=o[_];c.push((b??"").toString())}}i.push(c.join("	"))}return i.join(`
`)}isGridCellEditing(t,e,i){return!!this.editingCell&&this.editingCell.rowIndex===t&&this.editingCell.colIndex===e&&this.editingCell.key===i}isMetaCellSelected(t,e){return!!this.selectedCell&&this.selectedCell.kind==="meta"&&this.selectedCell.rowIndex===t&&this.selectedCell.meta===e}getSelectedCellText(){if(!this.selectedCell)return null;if(this.selectedCell.kind==="meta"){let n=this.rows[this.selectedCell.rowIndex];return n?this.selectedCell.meta==="ci"?(n.CI??"").toString():this.nombreCompleto(n):""}let t=this.rows[this.selectedCell.rowIndex];if(!t)return"";let e=this.selectedCell.key;return this.isSumColumn(e)?(this.sumValueForKey(t,e)??"").toString():(t[e]??"").toString()}copyTextToClipboard(t){return D(this,null,function*(){try{return yield navigator.clipboard.writeText(t),!0}catch{try{let e=document.createElement("textarea");return e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),!0}catch{return!1}}})}onCellChange(t,e,i,n){let o=this.rows[t];if(!o||!this.canEdit(i)||this.isSumKey(i))return;this.beginUserChange();let c=this.parseNullableInt(n);if(c===null)o[i]=null;else{let p=c;this.isTeoricoKey(i)?p=this.clampNum(p,0,this.maxTeorico):this.isPracticoKey(i)?p=this.clampNum(p,0,this.maxPractico):p=this.clampNum(p,0,100),o[i]=p}this.recalcPromedios(o),this.recomputeDirtyForRow(o),this.activeRow=t,this.activeCol=e}onPaste(t,e,i){if(!t.clipboardData)return;let n=t.clipboardData.getData("text");if(!n)return;let o=n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(c=>c.length>0).map(c=>c.split("	"));if(o.length!==0){t.preventDefault(),this.beginUserChange(),this.isBatchEdit=!0;try{for(let c=0;c<o.length&&this.rows[e+c];c++)for(let g=0;g<o[c].length;g++){let _=this.columns[i+g];if(!_)break;let b=_.key;this.canEdit(b)&&this.onCellChange(e+c,i+g,b,o[c][g])}}finally{this.isBatchEdit=!1}}}focusCell(t,e){let i=this.hostEl.nativeElement.querySelector(`input[data-row="${t}"][data-col="${e}"]`);i?.focus(),i?.select()}onKeydown(t){if((t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="c"){let y=document.activeElement,C=!!y&&(y.tagName==="INPUT"||y.tagName==="TEXTAREA"),E=window.getSelection()?.toString()??"",R=this.getSelectedGridRangeText();if(R&&E.length===0){t.preventDefault(),this.copyTextToClipboard(R).then(k=>{k&&(this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1200))});return}if(!C&&E.length===0){let k=this.getSelectedCellText();if(k!==null){t.preventDefault(),this.copyTextToClipboard(k).then(z=>{z&&(this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1200))});return}}}if(t.ctrlKey||t.metaKey){let b=t.key.toLowerCase();if(b==="z"&&!t.shiftKey){t.preventDefault(),this.undo();return}if(b==="y"||b==="z"&&t.shiftKey){t.preventDefault(),this.redo();return}}let e=t.key;if(e!=="ArrowUp"&&e!=="ArrowDown"&&e!=="ArrowLeft"&&e!=="ArrowRight")return;let i=document.activeElement;if(!i||i.tagName!=="INPUT")return;let n=i.dataset.row,o=i.dataset.col;if(n===void 0||o===void 0)return;let c=parseInt(n,10),p=parseInt(o,10);if(!Number.isFinite(c)||!Number.isFinite(p))return;t.preventDefault();let g=c,_=p;e==="ArrowUp"&&(g=Math.max(0,c-1)),e==="ArrowDown"&&(g=Math.min(this.rows.length-1,c+1)),e==="ArrowLeft"&&(_=Math.max(0,p-1)),e==="ArrowRight"&&(_=Math.min(this.columns.length-1,p+1)),this.activeRow=g,this.activeCol=_,setTimeout(()=>this.focusCell(g,_))}copiarTodo(){return D(this,null,function*(){let t=this.buildTsvExport();try{yield navigator.clipboard.writeText(t),this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1500)}catch{let i=document.createElement("textarea");i.value=t,i.style.position="fixed",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),this.saveOk="Copiado al portapapeles.",setTimeout(()=>this.saveOk=null,1500)}})}buildTsvExport(){let t=[{key:"Teorico1",label:"Teo1"},{key:"Practico1",label:"Prac1"},{key:"Teorico2",label:"Teo2"},{key:"Practico2",label:"Prac2"},{key:"Teorico3",label:"Teo3"},{key:"Practico3",label:"Prac3"},{key:"Teorico4",label:"Teo4"},{key:"Practico4",label:"Prac4"},{key:"PromTeorico",label:"Prom Teo"},{key:"PromPractico",label:"Prom Prac"},{key:"Promedio",label:"Prom"},{key:"PruebaRecuperacion",label:"Recup"}],e=["Ap_Paterno","Ap_Materno","Nombres","CI",...t.map(n=>n.label)].join("	"),i=this.rows.map(n=>{let o=[n.Ap_Paterno??"",n.Ap_Materno??"",n.Nombres??"",n.CI??""],c=t.map(p=>n[p.key]??"");return[...o,...c].join("	")});return[e,...i].join(`
`)}guardarCambios(){if(!this.materiaId){this.saveError="Materia inv\xE1lida.";return}if(this.isSaving)return;if(this.saveError=null,this.saveOk=null,Array.from(this.dirtyIds.values()).length===0){this.saveOk="No hay cambios para guardar.",setTimeout(()=>this.saveOk=null,1500);return}let e=this.rows.filter(i=>this.dirtyIds.has(i.id)).map(i=>({id:i.id,Teorico1:i.Teorico1??null,Teorico2:i.Teorico2??null,Teorico3:i.Teorico3??null,Teorico4:i.Teorico4??null,Practico1:i.Practico1??null,Practico2:i.Practico2??null,Practico3:i.Practico3??null,Practico4:i.Practico4??null,PruebaRecuperacion:i.PruebaRecuperacion??null}));this.isSaving=!0,this._calif.GuardarCalificacionesBulkMateria({materias_id:this.materiaId,avg_eval_count:this.avgEvalCount,enabled_evals:this.evalEnabled,items:e}).subscribe({next:i=>{let n=i?.data?.updated??null;this.saveOk=typeof n=="number"?`Guardado: ${n} filas.`:"Guardado.",this.captureBaseline(),this.dirtyIds.clear(),setTimeout(()=>this.saveOk=null,2e3)},error:i=>{console.error("Error al guardar cambios:",i),this.saveError="No se pudieron guardar los cambios."},complete:()=>{this.isSaving=!1}})}onAvgEvalCountChange(t){if(this.configLocked)return;let e=parseInt(String(t),10);if(e===1||e===2||e===3||e===4){this.avgEvalCount=Math.min(this.evalCountMax,Math.max(1,e));for(let i=this.avgEvalCount;i<4;i++)this.evalEnabled[i]=!1;this.editableEvaluations=this.evalEnabled.some(Boolean);for(let i of this.rows)this.recalcPromedios(i);this.rebuildColumns()}}};ne.\u0275fac=function(e){return new(e||ne)(N(ke),N(ot),N(Ce),N(Se),N(Q),N(je))},ne.\u0275cmp=W({type:ne,selectors:[["app-calificaciones"]],hostBindings:function(e,i){e&1&&x("mouseup",function(o){return i.onDocumentMouseUp(o)},Re)("keydown",function(o){return i.onKeydown(o)})},standalone:!1,decls:45,vars:19,consts:[["sumCell",""],[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-4","fw-bold","titulosGlobales"],[4,"ngIf"],["class","lead text-secondary subtitulosGlobales",4,"ngIf"],[1,"container-fluid","py-3"],[1,"d-flex","align-items-start","justify-content-between","gap-3","flex-wrap"],[1,"mb-1","text-danger","fw-bold"],[1,"mt-1"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"input-group","input-group-sm",2,"width","170px"],[1,"input-group-text"],[1,"form-select",3,"ngModelChange","ngModel"],["value","intercalado"],["value","agrupado"],[1,"form-check","form-check-inline","small","mb-0"],["type","checkbox",1,"form-check-input",3,"ngModelChange","ngModel"],[1,"form-check-label","text-black"],[1,"btn","btn-sm","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],[1,"btn","btn-sm","btn-primary",3,"click","disabled"],[1,"mt-2"],["class","alert alert-danger py-2",4,"ngIf"],["class","alert alert-success py-2",4,"ngIf"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],["class","table-responsive mt-2 grid-wrap",4,"ngIf"],["class","text-muted small mt-2",4,"ngIf"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"text-primary"],["class","text-black",4,"ngIf"],[1,"text-black"],[1,"d-flex","align-items-center","gap-2","small"],[1,"text-body-secondary"],["class","form-check form-check-inline mb-0",4,"ngIf"],["role","group","aria-label","Habilitar evaluaciones",1,"btn-group","btn-group-sm"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"input-group","input-group-sm",2,"width","160px"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"input-group","input-group-sm",2,"width","140px"],["type","number","min","0","max","100",1,"form-control",3,"ngModelChange","ngModel","readOnly"],[1,"form-check","form-check-inline","mb-0"],[1,"form-check-label"],[3,"ngValue"],[1,"input-group","input-group-sm",2,"width","260px"],[1,"input-group","input-group-sm",2,"width","240px"],[1,"form-select",3,"ngModelChange","ngModel","disabled"],[1,"alert","alert-danger","py-2"],[1,"alert","alert-success","py-2"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"small","text-muted"],[1,"btn-group","btn-group-sm"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"table-responsive","mt-2","grid-wrap"],[1,"table","table-sm","table-bordered","align-middle","mb-0","grid-table","table-hover"],[1,"table-light"],[1,"sticky-col","name-col","text-black","bg-light"],[1,"sticky-col","name-col-2","text-black","bg-light"],[3,"sep-after",4,"ngFor","ngForOf"],[3,"table-danger","active-row",4,"ngFor","ngForOf"],["tabindex","0",1,"sticky-col","name-col",3,"click"],["role","button",1,"student-name","fw-semibold",3,"dblclick"],["class","text-muted small",4,"ngIf"],["class","mt-1",4,"ngIf"],["tabindex","0",1,"sticky-col","name-col-2",3,"click"],["style","padding:0;",3,"sep-after","cell-danger","cell-selected","cell-editing","mousedown","mouseover","click",4,"ngFor","ngForOf"],[1,"text-muted","small"],["alt","Foto estudiante",1,"img-thumbnail",2,"max-width","140px",3,"src"],[2,"padding","0",3,"mousedown","mouseover","click"],[4,"ngIf","ngIfElse"],["inputmode","numeric",1,"form-control","form-control-sm","cell","text-center","border-0","rounded-0",2,"width","100%","height","100%","min-height","32px","box-shadow","none","background","transparent",3,"ngModelChange","focus","blur","click","paste","readOnly","ngModel"],["inputmode","numeric",1,"form-control","form-control-sm","cell","border-0","rounded-0",2,"width","100%","height","100%","min-height","32px","box-shadow","none","background","transparent",3,"focus","blur","click","readOnly","ngModel"],[1,"text-muted","small","mt-2"]],template:function(e,i){e&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"h1",4),d(4,"Gesti\xF3n de Calificaciones "),v(5,pt,2,1,"span",5),a(),v(6,ht,10,5,"p",6),a()()(),r(7,"div",7)(8,"div",8)(9,"div")(10,"h5",9)(11,"div",10)(12,"strong"),d(13),a()()()(),r(14,"div",11)(15,"div",12)(16,"span",13),d(17,"Modo"),a(),r(18,"select",14),A("ngModelChange",function(o){return P(i.viewMode,o)||(i.viewMode=o),o}),x("ngModelChange",function(){return i.rebuildColumns()}),r(19,"option",15),d(20,"Intercalado"),a(),r(21,"option",16),d(22,"Agrupado"),a()()(),r(23,"label",17)(24,"input",18),x("ngModelChange",function(o){return i.onShowSumColumnsChange(o)}),a(),r(25,"span",19),d(26,"Mostrar sumas"),a()(),v(27,St,26,10,"ng-container",5),r(28,"button",20),x("click",function(){return i.recargarTabla()}),d(29,"Recargar"),a(),r(30,"button",20),x("click",function(){return i.copiarTodo()}),d(31,"Copiar todo"),a(),v(32,Mt,8,3,"ng-container",5)(33,It,6,3,"ng-container",5),r(34,"button",21),x("click",function(){return i.generarBoletin2026()}),d(35," Bolet\xEDn 2026 "),a(),r(36,"button",22),x("click",function(){return i.guardarCambios()}),d(37),a()()(),r(38,"div",23),v(39,Tt,2,1,"div",24)(40,Pt,2,1,"div",24)(41,At,2,1,"div",25),a(),v(42,Ot,8,5,"div",26)(43,jt,11,2,"div",27)(44,Bt,2,0,"div",28),a()),e&2&&(l(5),u("ngIf",i.materia.Anio),l(),u("ngIf",i.materia),l(7),S(i.estadoEdicionLabel()),l(5),T("ngModel",i.viewMode),l(6),u("ngModel",i.showSumColumns),l(3),u("ngIf",i.showAdminControls),l(),u("disabled",i.isLoading||i.isSaving),l(2),u("disabled",i.isLoading||i.rows.length===0),l(2),u("ngIf",i.boletinPuedeFiltrarPorDocente),l(),u("ngIf",i.boletinRequiereEspecialidad),l(),u("disabled",i.isLoading||i.isSaving||i.rows.length===0||i.isGeneratingBoletin2026),l(2),u("disabled",i.isLoading||i.isSaving||i.dirtyIds.size===0||!i.editableEvaluations),l(),w(" Guardar cambios (",i.dirtyIds.size,") "),l(2),u("ngIf",i.loadError),l(),u("ngIf",i.saveError),l(),u("ngIf",i.saveOk),l(),u("ngIf",i.meta),l(),u("ngIf",i.rows.length),l(),u("ngIf",!i.isLoading&&!i.rows.length))},dependencies:[q,X,te,ie,Z,ve,xe,ee,J,ye,He,Y],styles:['@charset "UTF-8";.grid-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .grid-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{white-space:nowrap}.sticky-col[_ngcontent-%COMP%]{position:sticky;left:0;z-index:2;background:var(--bs-body-bg)}.name-col[_ngcontent-%COMP%]{min-width:260px}.name-col-2[_ngcontent-%COMP%]{left:260px;min-width:120px;z-index:2;background:var(--bs-body-bg)}.table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th.sticky-col[_ngcontent-%COMP%]{z-index:3;background:var(--bs-table-bg)}.cell[_ngcontent-%COMP%]{min-width:76px;padding:.15rem .35rem}.grid-table[_ngcontent-%COMP%]   td.cell-selected[_ngcontent-%COMP%]{outline:2px solid rgba(var(--bs-primary-rgb),.9);outline-offset:-2px}.grid-table[_ngcontent-%COMP%]   td.cell-editing[_ngcontent-%COMP%]{background:rgba(var(--bs-primary-rgb),.1);box-shadow:inset 0 0 0 1px rgba(var(--bs-primary-rgb),.35),0 0 0 3px rgba(var(--bs-primary-rgb),.12)}.grid-table[_ngcontent-%COMP%]   td.cell-selected.cell-editing[_ngcontent-%COMP%]{outline-color:rgba(var(--bs-primary-rgb),1)}.grid-table[_ngcontent-%COMP%]   td.name-col[_ngcontent-%COMP%], .grid-table[_ngcontent-%COMP%]   td.name-col-2[_ngcontent-%COMP%]{-webkit-user-select:text;user-select:text}td.sep-after[_ngcontent-%COMP%], th.sep-after[_ngcontent-%COMP%]{border-right-width:3px}td.cell-danger[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{color:var(--bs-danger);font-weight:600}tr.active-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{outline:1px solid rgba(13,110,253,.35);outline-offset:-1px}.student-name[_ngcontent-%COMP%]{cursor:pointer}.student-name[_ngcontent-%COMP%]:hover{text-decoration:underline}']});var Ee=ne;var K=class K{constructor(t){this.http=t;this.ruta=Be.ruta}ObtenerRegistroPorMateriaPaginado(t,e,i){let n=new URLSearchParams;n.set("eval",String(e)),i?.page&&n.set("page",String(i.page)),i?.per_page&&n.set("per_page",String(i.per_page));let o=n.toString(),c=this.ruta+"api/registrocalificaciones/materia/"+t+(o?`?${o}`:"");return this.http.get(c)}CrearRubro(t){return this.http.post(this.ruta+"api/registrocalificaciones/rubros",t)}ActualizarRubro(t,e){return this.http.put(this.ruta+"api/registrocalificaciones/rubros/"+t,e)}EliminarRubro(t){return this.http.delete(this.ruta+"api/registrocalificaciones/rubros/"+t)}GuardarNotasBulk(t){return this.http.post(this.ruta+"api/registrocalificaciones/bulk-save",t)}ActualizarEvaluacionModo(t){return this.http.put(this.ruta+"api/registrocalificaciones/evaluacion",t)}};K.\u0275fac=function(e){return new(e||K)(Ne(ze))},K.\u0275prov=Oe({token:K,factory:K.\u0275fac,providedIn:"root"});var Me=K;function $t(s,t){s&1&&(r(0,"span",41),d(1,"Cargando"),a())}function Ut(s,t){if(s&1&&(r(0,"span",42),d(1),a()),s&2){let e=m();l(),w("",e.dirty.size," cambios")}}function Gt(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2);l(),w(" | Paralelo: ",e.materia.MateriaParalelo)}}function Wt(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2);l(),w(" | A\xF1o: ",e.materia.Anio)}}function Ht(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2);l(),w("",e.materia.SiglaMateria," - ")}}function qt(s,t){if(s&1&&(r(0,"div",43)(1,"div")(2,"strong"),d(3),a(),v(4,Gt,2,1,"span",44)(5,Wt,2,1,"span",44),a(),r(6,"div"),v(7,Ht,2,1,"span",44),d(8),a()()),s&2){let e=m();l(3),S(e.materia.LvlCurso||"Curso"),l(),u("ngIf",e.materia.MateriaParalelo),l(),u("ngIf",e.materia.Anio),l(2),u("ngIf",e.materia.SiglaMateria),l(),w("",e.materia.NombreMateria||"Materia"," ")}}function Xt(s,t){if(s&1&&(r(0,"div",48),d(1),a()),s&2){let e=m(2);l(),S(e.loadError)}}function Qt(s,t){if(s&1&&(r(0,"div",48),d(1),a()),s&2){let e=m(2);l(),S(e.saveError)}}function Zt(s,t){if(s&1&&(r(0,"div",49),d(1),a()),s&2){let e=m(2);l(),S(e.saveOk)}}function Jt(s,t){if(s&1&&(r(0,"div",45),v(1,Xt,2,1,"div",46)(2,Qt,2,1,"div",46)(3,Zt,2,1,"div",47),a()),s&2){let e=m();l(),u("ngIf",e.loadError),l(),u("ngIf",e.saveError),l(),u("ngIf",e.saveOk)}}function Yt(s,t){if(s&1){let e=M();r(0,"li",50)(1,"button",51),x("click",function(){let n=f(e).$implicit,o=m();return h(o.setEval(n))}),d(2),a()()}if(s&2){let e=t.$implicit,i=m();l(),F("active",i.evalNum===e),l(),w("Eval ",e)}}function ei(s,t){if(s&1){let e=M();r(0,"div",52)(1,"div",53),d(2),a(),r(3,"div",54)(4,"button",14),x("click",function(){f(e);let n=m();return h(n.prev())}),d(5,"Anterior"),a(),r(6,"button",14),x("click",function(){f(e);let n=m();return h(n.next())}),d(7,"Siguiente"),a()()()}if(s&2){let e=m();l(2),be("Mostrando ",e.meta.from||0,"-",e.meta.to||0," de ",e.meta.total),l(2),u("disabled",!e.tienePrev()||e.isLoading),l(2),u("disabled",!e.tieneNext()||e.isLoading)}}function ti(s,t){if(s&1&&(r(0,"th",70),d(1,"Te\xF3ricas"),a()),s&2){let e=m(2);V("colspan",e.rubrosTeo.length)}}function ii(s,t){if(s&1&&(r(0,"th",70),d(1,"Pr\xE1cticas"),a()),s&2){let e=m(2);V("colspan",e.rubrosPra.length)}}function ni(s,t){if(s&1){let e=M();r(0,"th",70)(1,"div",71)(2,"div",72),d(3),a(),r(4,"div",73)(5,"button",38),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.editarRubro(n))}),d(6,"E"),a(),r(7,"button",74),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.eliminarRubro(n))}),d(8,"X"),a()()()()}if(s&2){let e=t.$implicit;l(3),H("",e.nombre," (",e.max_puntos,")")}}function oi(s,t){if(s&1){let e=M();r(0,"th",70)(1,"div",71)(2,"div",72),d(3),a(),r(4,"div",73)(5,"button",38),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.editarRubro(n))}),d(6,"E"),a(),r(7,"button",74),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.eliminarRubro(n))}),d(8,"X"),a()()()()}if(s&2){let e=t.$implicit;l(3),H("",e.nombre," (",e.max_puntos,")")}}function ai(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2).$implicit;l(),S(e.InstrumentoMusical)}}function ri(s,t){s&1&&(r(0,"span"),d(1," \xB7 "),a())}function si(s,t){if(s&1&&(r(0,"span"),d(1),a()),s&2){let e=m(2).$implicit;l(),S(e.InstrumentoMusicalSecundario)}}function li(s,t){if(s&1&&(r(0,"div",53),v(1,ai,2,1,"span",44)(2,ri,2,0,"span",44)(3,si,2,1,"span",44),a()),s&2){let e=m().$implicit,i=m(2);l(),u("ngIf",i.normalizarTexto(e.InstrumentoMusical)),l(),u("ngIf",i.normalizarTexto(e.InstrumentoMusical)&&i.normalizarTexto(e.InstrumentoMusicalSecundario)),l(),u("ngIf",i.normalizarTexto(e.InstrumentoMusicalSecundario))}}function ci(s,t){if(s&1&&(r(0,"div",45),I(1,"img",84),a()),s&2){let e=m().$implicit,i=m(2);l(),u("src",i.fotoUrl(e.Foto),fe)}}function di(s,t){if(s&1){let e=M();r(0,"td")(1,"input",85),x("ngModelChange",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.setNota(c.infoestudiantesifas_id,o.id,n))})("id",function(){let n=f(e).$implicit,o=m().$implicit,c=m(2);return h(c.cellId(o.infoestudiantesifas_id,n.id))})("paste",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onPaste(n,c.infoestudiantesifas_id,o.id))})("keydown",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onKeydown(n,c.infoestudiantesifas_id,o.id))})("mousedown",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onCellMouseDown(n,c.infoestudiantesifas_id,o.id))}),a()()}if(s&2){let e=t.$implicit,i=m().$implicit,n=m(2);F("cell-selected",n.isCellSelected(i.infoestudiantesifas_id,e.id)),l(),u("ngModel",n.getNota(i.infoestudiantesifas_id,e.id))("data-row",i.infoestudiantesifas_id)("data-col",e.id),V("max",e.max_puntos)}}function ui(s,t){if(s&1){let e=M();r(0,"td")(1,"input",85),x("ngModelChange",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.setNota(c.infoestudiantesifas_id,o.id,n))})("id",function(){let n=f(e).$implicit,o=m().$implicit,c=m(2);return h(c.cellId(o.infoestudiantesifas_id,n.id))})("paste",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onPaste(n,c.infoestudiantesifas_id,o.id))})("keydown",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onKeydown(n,c.infoestudiantesifas_id,o.id))})("mousedown",function(n){let o=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.onCellMouseDown(n,c.infoestudiantesifas_id,o.id))}),a()()}if(s&2){let e=t.$implicit,i=m().$implicit,n=m(2);F("cell-selected",n.isCellSelected(i.infoestudiantesifas_id,e.id)),l(),u("ngModel",n.getNota(i.infoestudiantesifas_id,e.id))("data-row",i.infoestudiantesifas_id)("data-col",e.id),V("max",e.max_puntos)}}function mi(s,t){if(s&1){let e=M();r(0,"tr")(1,"td",75)(2,"div",76),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.toggleFoto(n))}),d(3),a(),v(4,li,4,3,"div",77)(5,ci,2,1,"div",16),a(),r(6,"td",78),d(7),a(),v(8,di,2,6,"td",79),I(9,"td",80),r(10,"td",81),d(11),a(),v(12,ui,2,6,"td",79),I(13,"td",80),r(14,"td",82),d(15),a(),r(16,"td",83),d(17),a()()}if(s&2){let e=t.$implicit,i=m(2);l(3),S(i.nombreCompleto(e)),l(),u("ngIf",i.normalizarTexto(e.InstrumentoMusical)||i.normalizarTexto(e.InstrumentoMusicalSecundario)),l(),u("ngIf",i.fotoAbierta(e)),l(2),S(e.CI||""),l(),u("ngForOf",i.rubrosTeo),l(3),S(i.getTeo(e)??""),l(),u("ngForOf",i.rubrosPra),l(3),S(i.getPra(e)??""),l(2),S(i.getSum(e)??"")}}function pi(s,t){if(s&1){let e=M();r(0,"div",55)(1,"table",56)(2,"thead",57)(3,"tr")(4,"th",58),d(5,"Estudiante"),a(),r(6,"th",59),d(7,"CI"),a(),v(8,ti,2,1,"th",60),r(9,"th",61)(10,"button",62),x("click",function(){f(e);let n=m();return h(n.abrirModalRubro("TEO"))}),d(11,"+"),a()(),r(12,"th",63),d(13),a(),v(14,ii,2,1,"th",60),r(15,"th",61)(16,"button",64),x("click",function(){f(e);let n=m();return h(n.abrirModalRubro("PRA"))}),d(17,"+"),a()(),r(18,"th",65),d(19),a(),r(20,"th",66),d(21),a()(),r(22,"tr"),v(23,ni,9,2,"th",67),r(24,"th",61)(25,"span",68),d(26,"\xA0"),a()(),v(27,oi,9,2,"th",67),r(28,"th",61)(29,"span",68),d(30,"\xA0"),a()()()(),r(31,"tbody"),v(32,mi,18,9,"tr",69),a()()()}if(s&2){let e=m();l(8),u("ngIf",e.rubrosTeo.length),l(2),u("disabled",e.isLoading||e.isSaving),l(3),w("Teo ",e.evalNum),l(),u("ngIf",e.rubrosPra.length),l(2),u("disabled",e.isLoading||e.isSaving),l(3),w("Prac ",e.evalNum),l(2),w("Sum ",e.evalNum),l(2),u("ngForOf",e.rubrosTeo),l(4),u("ngForOf",e.rubrosPra),l(5),u("ngForOf",e.rows)}}function gi(s,t){s&1&&(r(0,"div",36),d(1,"No hay estudiantes asignados a esta materia."),a())}function _i(s,t){s&1&&I(0,"div",86)}var oe=class oe{constructor(t,e){this.api=t;this.route=e;this.materiaId=null;this.evalCountMax=4;this.openFotoInfoId=null;this.evalNum=1;this.isLoading=!1;this.isSaving=!1;this.loadError=null;this.saveError=null;this.saveOk=null;this.materia=null;this.evaluacion=null;this.modoEval=3;this.rubros=[];this.rows=[];this.meta=null;this.page=1;this.perPage=30;this.notas=new Map;this.dirty=new Set;this.modalVisible=!1;this.modalTipo="TEO";this.modalModo="create";this.modalRubroId=null;this.nuevoNombre="";this.nuevoMax=10;this.nuevoOrden=1;this.anchor=null;this.cursor=null;this.undoStack=[];this.redoStack=[];this.isRestoring=!1;this.isBatching=!1}ngOnInit(){this.route.queryParamMap.subscribe(t=>{let e=t.get("materiaId")??t.get("materias_id")??"",i=Number(e);if(!e||Number.isNaN(i)||i<=0){this.materiaId=null,this.rows=[],this.rubros=[],this.meta=null,this.materia=null,this.loadError='Falta seleccionar una materia. Vuelve a "Mis Materias" y abre el registro desde ah\xED.';return}let n=this.materiaId!==i;this.materiaId=i,n&&(this.evalNum=1,this.page=1,this.cargar(1))})}normalizarTexto(t){return(t??"").toString().trim()}fotoUrl(t){let e=this.normalizarTexto(t);if(e===""||e.toLowerCase()==="null"||e.toLowerCase()==="undefined")return this.api.ruta+"fijos/sinperfil.jpg";let i=e.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")||i.startsWith("data:")?e:this.api.ruta+e}toggleFoto(t){let e=Number(t?.infoestudiantesifas_id);!e||Number.isNaN(e)||(this.openFotoInfoId=this.openFotoInfoId===e?null:e)}fotoAbierta(t){let e=Number(t?.infoestudiantesifas_id);return!!e&&this.openFotoInfoId===e}parseEvalCount(t){let i=(t??"").toString().match(/(\d+)/),n=Number(i?i[1]:t);return n===1||n===2||n===3||n===4?n:4}evalTabs(){return[1,2,3,4].slice(0,this.evalCountMax)}get rubrosTeo(){return this.rubros.filter(t=>t.tipo==="TEO")}get rubrosPra(){return this.rubros.filter(t=>t.tipo==="PRA")}key(t,e){return`${t}__${e}`}nombreCompleto(t){let e=(t.Ap_Paterno??"").trim(),i=(t.Ap_Materno??"").trim(),n=(t.Nombres??"").trim();return[e,i,n].filter(Boolean).join(" ").trim()||"(Sin nombre)"}setEval(t){this.evalNum!==t&&(this.evalNum=t,this.cargar(1))}onModoChange(t){let e=Number(t);(e===1||e===2||e===3)&&this.materiaId&&this.api.ActualizarEvaluacionModo({materias_id:this.materiaId,numero_eval:this.evalNum,modo_eval:e}).subscribe({next:i=>{let n=Number(i?.evaluacion?.modo_eval??e);this.modoEval=n===1||n===2||n===3?n:e,this.saveOk="Modo actualizado.",setTimeout(()=>this.saveOk=null,1200),this.recargar()},error:i=>{console.error("Error actualizando modo:",i),this.saveError="No se pudo actualizar el modo.",this.recargar()}})}tienePrev(){return!!this.meta&&(this.meta.current_page??1)>1}tieneNext(){return!!this.meta&&(this.meta.current_page??1)<(this.meta.last_page??1)}prev(){this.tienePrev()&&this.cargar((this.meta.current_page??1)-1)}next(){this.tieneNext()&&this.cargar((this.meta.current_page??1)+1)}recargar(){this.cargar(this.page||1)}abrirModalRubro(t){this.modalModo="create",this.modalRubroId=null,this.modalTipo=t,this.nuevoNombre="",this.nuevoMax=10;let e=t==="TEO"?this.rubrosTeo:this.rubrosPra;this.nuevoOrden=(e.reduce((i,n)=>Math.max(i,n.orden??1),0)||0)+1,this.modalVisible=!0,setTimeout(()=>{let i=document.querySelector(".modal input.form-control");i?.focus(),i?.select()},0)}cerrarModal(){this.modalVisible=!1}onModalBackdrop(t){t.target?.classList?.contains("modal")&&this.cerrarModal()}confirmarModal(){this.modalModo==="create"?this.crearRubroDesdeModal():this.actualizarRubroDesdeModal()}editarRubro(t){this.modalModo="edit",this.modalRubroId=t.id,this.modalTipo=t.tipo,this.nuevoNombre=t.nombre,this.nuevoMax=t.max_puntos,this.nuevoOrden=t.orden,this.modalVisible=!0,setTimeout(()=>{let e=document.querySelector(".modal input.form-control");e?.focus(),e?.select()},0)}eliminarRubro(t){window.confirm(`\xBFEliminar el rubro "${t.nombre}"?`)&&this.api.EliminarRubro(t.id).subscribe({next:()=>{this.saveOk="Rubro eliminado.",setTimeout(()=>this.saveOk=null,1500),this.recargar()},error:i=>{console.error("Error eliminando rubro:",i),this.saveError="No se pudo eliminar el rubro."}})}cargar(t=1){if(!this.materiaId){this.loadError="Materia inv\xE1lida.";return}this.isLoading||(this.isLoading=!0,this.loadError=null,this.saveError=null,this.saveOk=null,this.api.ObtenerRegistroPorMateriaPaginado(this.materiaId,this.evalNum,{page:t,per_page:this.perPage}).subscribe({next:e=>{this.materia=e?.materia??null,this.evalCountMax=this.parseEvalCount(this.materia?.CantidadEvaluaciones),this.evalNum>this.evalCountMax&&(this.evalNum=1),this.evaluacion=e?.evaluacion??null;let i=Number(this.evaluacion?.modo_eval??this.evaluacion?.modoEval??3);this.modoEval=i===1||i===2||i===3?i:3,this.rubros=Array.isArray(e?.rubros)?e.rubros:[],this.rows=Array.isArray(e?.data)?e.data:[],this.meta=e?.meta??null,this.page=this.meta?.current_page??t,this.notas.clear(),this.dirty.clear();let n=Array.isArray(e?.notas)?e.notas:[];for(let o of n)this.notas.set(this.key(o.infoestudiantesifas_id,o.rubro_id),o.nota??null)},error:e=>{console.error("Error al cargar registrocalificaciones:",e),this.rows=[],this.rubros=[],this.meta=null,this.loadError="No se pudo cargar el registro de calificaciones."},complete:()=>{this.isLoading=!1}}))}getNota(t,e){return this.notas.get(this.key(t,e))??null}setNota(t,e,i,n){!this.isRestoring&&!this.isBatching&&!n?.skipUndo&&this.pushUndoSnapshot();let o=this.key(t,e),c=String(i??"").trim(),p=null;if(c!==""){let b=Number(c);Number.isFinite(b)?p=Math.round(b):p=null}let g=this.rubros.find(b=>b.id===e);p!==null&&g&&(p<0&&(p=0),p>g.max_puntos&&(p=g.max_puntos)),(this.notas.get(o)??null)!==p&&(this.notas.set(o,p),this.dirty.add(o))}onCellMouseDown(t,e,i){if(t.shiftKey&&this.anchor){this.cursor={infoId:e,rubroId:i};return}this.anchor={infoId:e,rubroId:i},this.cursor={infoId:e,rubroId:i}}isCellSelected(t,e){if(!this.anchor||!this.cursor)return!1;let i=this.rowIndexOf(this.anchor.infoId),n=this.rubroIndexOf(this.anchor.rubroId),o=this.rowIndexOf(this.cursor.infoId),c=this.rubroIndexOf(this.cursor.rubroId);if(i<0||n<0||o<0||c<0)return!1;let p=Math.min(i,o),g=Math.max(i,o),_=Math.min(n,c),b=Math.max(n,c),y=this.rowIndexOf(t),C=this.rubroIndexOf(e);return y>=p&&y<=g&&C>=_&&C<=b}buildSelectionTSV(){if(!this.anchor||!this.cursor)return null;let t=this.rowIndexOf(this.anchor.infoId),e=this.rubroIndexOf(this.anchor.rubroId),i=this.rowIndexOf(this.cursor.infoId),n=this.rubroIndexOf(this.cursor.rubroId);if(t<0||e<0||i<0||n<0)return null;let o=Math.min(t,i),c=Math.max(t,i),p=Math.min(e,n),g=Math.max(e,n),_=[];for(let b=o;b<=c;b++){let y=this.rows[b];if(!y)continue;let C=[];for(let E=p;E<=g;E++){let R=this.rubros[E];if(!R)continue;let k=this.getNota(y.infoestudiantesifas_id,R.id);C.push(k===null?"":String(Math.trunc(k)))}_.push(C.join("	"))}return _.join(`
`)}copyText(t){return D(this,null,function*(){try{yield navigator.clipboard.writeText(t);return}catch{let e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus(),e.select();try{document.execCommand("copy")}finally{document.body.removeChild(e)}}})}pushUndoSnapshot(){let t={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?O({},this.anchor):null,cursor:this.cursor?O({},this.cursor):null};this.undoStack.push(t),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack.length=0}restoreSnapshot(t){this.isRestoring=!0;try{this.notas.clear();for(let[e,i]of t.notas)this.notas.set(e,i);this.dirty=new Set(t.dirty),this.anchor=t.anchor,this.cursor=t.cursor}finally{this.isRestoring=!1}}undo(){let t=this.undoStack.pop();if(!t)return;let e={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?O({},this.anchor):null,cursor:this.cursor?O({},this.cursor):null};this.redoStack.push(e),this.restoreSnapshot(t)}redo(){let t=this.redoStack.pop();if(!t)return;let e={notas:Array.from(this.notas.entries()),dirty:Array.from(this.dirty.values()),anchor:this.anchor?O({},this.anchor):null,cursor:this.cursor?O({},this.cursor):null};this.undoStack.push(e),this.restoreSnapshot(t)}crearRubroDesdeModal(){let t=this.nuevoNombre.trim();if(!t)return;let e=Math.max(1,Math.trunc(Number(this.nuevoMax)||1)),i=Math.max(1,Math.trunc(Number(this.nuevoOrden)||1));this.modoEval===1?e=100:this.modoEval===2&&(e=this.modalTipo==="TEO"?30:70),this.materiaId&&this.api.CrearRubro({materias_id:this.materiaId,numero_eval:this.evalNum,tipo:this.modalTipo,nombre:t,max_puntos:e,orden:i}).subscribe({next:()=>{this.saveOk="Rubro creado.",setTimeout(()=>this.saveOk=null,1500),this.cerrarModal(),this.recargar()},error:n=>{console.error("Error creando rubro:",n),this.saveError="No se pudo crear el rubro."}})}actualizarRubroDesdeModal(){let t=this.modalRubroId;if(!t)return;let e=this.nuevoNombre.trim();if(!e)return;let i=Math.max(1,Math.trunc(Number(this.nuevoMax)||1)),n=Math.max(1,Math.trunc(Number(this.nuevoOrden)||1));this.modoEval===1?i=100:this.modoEval===2&&(i=this.modalTipo==="TEO"?30:70),this.api.ActualizarRubro(t,{tipo:this.modalTipo,nombre:e,max_puntos:i,orden:n}).subscribe({next:()=>{this.saveOk="Rubro actualizado.",setTimeout(()=>this.saveOk=null,1500),this.cerrarModal(),this.recargar()},error:o=>{console.error("Error actualizando rubro:",o),this.saveError="No se pudo actualizar el rubro."}})}getTeo(t){let e=this.getVirtualEval(t.infoestudiantesifas_id)?.teo;if(e!==null)return e;let i=`Teorico${this.evalNum}`,n=t[i];return typeof n=="number"?Math.trunc(n):n??null}getPra(t){let e=this.getVirtualEval(t.infoestudiantesifas_id)?.pra;if(e!==null)return e;let i=`Practico${this.evalNum}`,n=t[i];return typeof n=="number"?Math.trunc(n):n??null}getSum(t){let e=this.getTeo(t),i=this.getPra(t);if(e===null&&i===null)return null;let n=(e??0)+(i??0);return Math.trunc(n)}getVirtualEval(t){if(!this.rubros?.length)return null;let e=Math.trunc(Number(this.evaluacion?.limite_teorico??30)),i=Math.trunc(Number(this.evaluacion?.limite_practico??70)),n=[],o=[],c=null;for(let b of this.rubros){let y=this.getNota(t,b.id);if(y==null)continue;let C=Math.round(Number(y));if(!Number.isFinite(C))continue;let E=Math.trunc(Number(b.max_puntos??0));C<0&&(C=0),E>0&&C>E&&(C=E);let R=b.es_asistencia===1||b.es_asistencia===!0;b.tipo==="TEO"?R?c=C:n.push(C):o.push(C)}let p=this.modoEval,g=null,_=null;if(p===1){let b=null;if(n.length>0){let y=n.reduce((C,E)=>C+E,0)/n.length;b=Math.round(y/100*20)}if((b!==null||c!==null)&&(g=Math.round((b??0)+(c??0)),g<0&&(g=0),g>e&&(g=e)),o.length>0){let y=o.reduce((C,E)=>C+E,0)/o.length;_=Math.round(y/100*i),_<0&&(_=0),_>i&&(_=i)}}else if(p===2){let b=null;if(n.length>0){let y=n.reduce((C,E)=>C+E,0)/n.length;b=Math.round(y/30*20)}if((b!==null||c!==null)&&(g=Math.round((b??0)+(c??0)),g<0&&(g=0),g>e&&(g=e)),o.length>0){let y=o.reduce((C,E)=>C+E,0)/o.length;_=Math.round(y/70*i),_<0&&(_=0),_>i&&(_=i)}}else{let b=n.reduce((C,E)=>C+E,0)+(c??0),y=o.reduce((C,E)=>C+E,0);(n.length>0||c!==null)&&(g=Math.round(b),g<0&&(g=0),g>e&&(g=e)),o.length>0&&(_=Math.round(y),_<0&&(_=0),_>i&&(_=i))}return{teo:g,pra:_}}cellId(t,e){return`rc_${t}_${e}`}focusCell(t,e){let i=document.getElementById(this.cellId(t,e));i&&(i.focus(),i.select())}rubroIndexOf(t){return this.rubros.findIndex(e=>e.id===t)}rowIndexOf(t){return this.rows.findIndex(e=>e.infoestudiantesifas_id===t)}onKeydown(t,e,i){let n=t.key.toLowerCase();if(t.ctrlKey&&!t.shiftKey&&n==="z"){t.preventDefault(),this.undo();return}if(t.ctrlKey&&n==="y"||t.ctrlKey&&t.shiftKey&&n==="z"){t.preventDefault(),this.redo();return}if(t.ctrlKey&&n==="c"){let C=this.buildSelectionTSV();C!==null&&(t.preventDefault(),this.copyText(C));return}let o=t.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Enter","Tab"].includes(o))return;let c=this.rowIndexOf(e),p=this.rubroIndexOf(i);if(c<0||p<0)return;let g=c,_=p;o==="ArrowLeft"&&(_-=1),o==="ArrowRight"&&(_+=1),o==="ArrowUp"&&(g-=1),o==="ArrowDown"&&(g+=1),o==="Enter"&&(g+=t.shiftKey?-1:1),o==="Tab"&&(_+=t.shiftKey?-1:1),g<0&&(g=0),g>=this.rows.length&&(g=this.rows.length-1),_<0&&(_=0),_>=this.rubros.length&&(_=this.rubros.length-1),t.preventDefault();let b=this.rows[g]?.infoestudiantesifas_id,y=this.rubros[_]?.id;b&&y&&(t.shiftKey?(this.anchor||(this.anchor={infoId:e,rubroId:i}),this.cursor={infoId:b,rubroId:y}):(this.anchor={infoId:b,rubroId:y},this.cursor={infoId:b,rubroId:y}),this.focusCell(b,y))}onPaste(t,e,i){let n=t.clipboardData?.getData("text/plain");if(!n)return;this.isRestoring||this.pushUndoSnapshot();let o=this.rowIndexOf(e),c=this.rubroIndexOf(i);if(o<0||c<0)return;let p=n.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(g=>g.length>0);if(p.length){t.preventDefault(),this.isBatching=!0;for(let g=0;g<p.length;g++){let _=p[g].split("	"),b=this.rows[o+g];if(!b)break;for(let y=0;y<_.length;y++){let C=this.rubros[c+y];if(!C)break;let E=_[y].trim();if(E===""){this.setNota(b.infoestudiantesifas_id,C.id,null,{skipUndo:!0});continue}this.setNota(b.infoestudiantesifas_id,C.id,E,{skipUndo:!0})}}this.isBatching=!1}}guardarCambios(){if(this.isSaving)return;if(!this.materiaId){this.saveError="Materia inv\xE1lida.";return}if(this.dirty.size===0){this.saveOk="No hay cambios para guardar.",setTimeout(()=>this.saveOk=null,1500);return}let t=[];for(let i of this.dirty.values()){let[n,o]=i.split("__"),c=Number(n),p=Number(o);!Number.isFinite(c)||!Number.isFinite(p)||t.push({infoestudiantesifas_id:c,rubro_id:p,nota:this.notas.get(i)??null})}this.isSaving=!0,this.saveError=null,this.saveOk=null;let e=this.materia?.CantidadEvaluaciones??4;this.api.GuardarNotasBulk({materias_id:this.materiaId,numero_eval:this.evalNum,avg_eval_count:e,items:t}).subscribe({next:()=>{this.saveOk="Guardado.",this.dirty.clear(),setTimeout(()=>this.saveOk=null,1500),this.recargar()},error:i=>{console.error("Error guardando notas:",i),this.saveError="No se pudieron guardar los cambios."},complete:()=>{this.isSaving=!1}})}};oe.\u0275fac=function(e){return new(e||oe)(N(Me),N(Q))},oe.\u0275cmp=W({type:oe,selectors:[["app-registroscalificaciones"]],standalone:!1,decls:63,vars:28,consts:[[1,"container-fluid","py-3"],[1,"card","shadow-sm"],[1,"card-header","bg-body"],[1,"d-flex","align-items-start","justify-content-between","gap-3","flex-wrap"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"mb-0"],["class","badge text-bg-secondary",4,"ngIf"],["class","badge text-bg-warning",4,"ngIf"],["class","text-muted small mt-1",4,"ngIf"],[1,"d-flex","align-items-center","gap-2"],[1,"text-muted","small"],[1,"form-select","form-select-sm",2,"width","240px",3,"ngModelChange","ngModel","disabled"],[3,"ngValue"],["role","group","aria-label","Acciones",1,"btn-group","btn-group-sm"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"btn","btn-primary",3,"click","disabled"],["class","mt-2",4,"ngIf"],["role","tablist",1,"nav","nav-pills","nav-fill","mt-3"],["class","nav-item","role","presentation",4,"ngFor","ngForOf"],[1,"card-body","pt-2"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],["class","table-responsive mt-2",4,"ngIf"],["class","text-muted small mt-2",4,"ngIf"],["tabindex","-1",1,"modal","fade",3,"click"],[1,"modal-dialog","modal-dialog-centered",3,"click"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"modal-body"],[1,"mb-2"],[1,"form-label","form-label-sm"],["placeholder","Ej: Prueba corta",1,"form-control","form-control-sm",3,"ngModelChange","keydown.enter","ngModel"],[1,"row","g-2"],[1,"col-6"],["type","number","min","1","step","1",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"text-muted","small","mt-2"],[1,"modal-footer"],["type","button",1,"btn","btn-sm","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-sm","btn-primary",3,"click","disabled"],["class","modal-backdrop fade show",4,"ngIf"],[1,"badge","text-bg-secondary"],[1,"badge","text-bg-warning"],[1,"text-muted","small","mt-1"],[4,"ngIf"],[1,"mt-2"],["class","alert alert-danger py-2 mb-2",4,"ngIf"],["class","alert alert-success py-2 mb-0",4,"ngIf"],[1,"alert","alert-danger","py-2","mb-2"],[1,"alert","alert-success","py-2","mb-0"],["role","presentation",1,"nav-item"],["type","button",1,"nav-link",3,"click"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"small","text-muted"],[1,"btn-group","btn-group-sm"],[1,"table-responsive","mt-2"],[1,"table","table-sm","table-bordered","table-hover","table-striped","align-middle","mb-0","reg-grid"],[1,"table-light"],["rowspan","2",1,"sticky-col","col-meta"],["rowspan","2",1,"sticky-col","col-meta-2"],["class","text-center",4,"ngIf"],[1,"text-center","col-add"],["type","button","title","Agregar rubro te\xF3rico",1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],["rowspan","2",1,"text-center","col-teo"],["type","button","title","Agregar rubro pr\xE1ctico",1,"btn","btn-sm","btn-outline-primary",3,"click","disabled"],["rowspan","2",1,"text-center","col-pra"],["rowspan","2",1,"text-center","col-sum"],["class","text-center",4,"ngFor","ngForOf"],[1,"text-muted"],[4,"ngFor","ngForOf"],[1,"text-center"],[1,"rubro-head-wrap"],[1,"rubro-head"],[1,"rubro-actions"],["type","button",1,"btn","btn-sm","btn-outline-danger",3,"click"],[1,"sticky-col","col-meta"],[1,"fw-semibold","student-name",3,"click"],["class","small text-muted",4,"ngIf"],[1,"sticky-col","col-meta-2"],[3,"cell-selected",4,"ngFor","ngForOf"],[1,"col-add"],[1,"col-teo","text-center"],[1,"col-pra","text-center"],[1,"col-sum","text-center"],["alt","Foto",2,"max-width","140px","height","auto",3,"src"],["type","number","min","0","step","1","inputmode","numeric",1,"form-control","form-control-sm",3,"ngModelChange","id","paste","keydown","mousedown","ngModel","data-row","data-col"],[1,"modal-backdrop","fade","show"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"div",4)(6,"h5",5),d(7,"Registro de calificaciones"),a(),v(8,$t,2,0,"span",6)(9,Ut,2,1,"span",7),a(),v(10,qt,9,5,"div",8),a(),r(11,"div",4)(12,"div",9)(13,"span",10),d(14,"Modo:"),a(),r(15,"select",11),A("ngModelChange",function(o){return P(i.modoEval,o)||(i.modoEval=o),o}),x("ngModelChange",function(o){return i.onModoChange(o)}),r(16,"option",12),d(17,"Promediar sobre 100 \u2192 Teo20 + Asist10 / Prac70"),a(),r(18,"option",12),d(19,"Promediar sobre 30/70 (Asist10 fijo)"),a(),r(20,"option",12),d(21,"Sumatoria (Asist10 fijo)"),a()()(),r(22,"div",13)(23,"button",14),x("click",function(){return i.recargar()}),d(24,"Recargar"),a(),r(25,"button",15),x("click",function(){return i.guardarCambios()}),d(26," Guardar "),a()()()(),v(27,Jt,4,3,"div",16),r(28,"ul",17),v(29,Yt,3,3,"li",18),a()(),r(30,"div",19),v(31,ei,8,5,"div",20)(32,pi,33,10,"div",21)(33,gi,2,0,"div",22),a()(),r(34,"div",23),x("click",function(o){return i.onModalBackdrop(o)}),r(35,"div",24),x("click",function(o){return o.stopPropagation()}),r(36,"div",25)(37,"div",26)(38,"h5",27),d(39),a(),r(40,"button",28),x("click",function(){return i.cerrarModal()}),a()(),r(41,"div",29)(42,"div",30)(43,"label",31),d(44,"Nombre"),a(),r(45,"input",32),A("ngModelChange",function(o){return P(i.nuevoNombre,o)||(i.nuevoNombre=o),o}),x("keydown.enter",function(){return i.confirmarModal()}),a()(),r(46,"div",33)(47,"div",34)(48,"label",31),d(49,"Max puntos"),a(),r(50,"input",35),A("ngModelChange",function(o){return P(i.nuevoMax,o)||(i.nuevoMax=o),o}),a()(),r(51,"div",34)(52,"label",31),d(53,"Orden"),a(),r(54,"input",35),A("ngModelChange",function(o){return P(i.nuevoOrden,o)||(i.nuevoOrden=o),o}),a()()(),r(55,"div",36),d(56,"Notas: todo se guarda como n\xFAmero entero (redondeado)."),a()(),r(57,"div",37)(58,"button",38),x("click",function(){return i.cerrarModal()}),d(59,"Cancelar"),a(),r(60,"button",39),x("click",function(){return i.confirmarModal()}),d(61),a()()()()(),v(62,_i,1,0,"div",40),a()),e&2&&(l(8),u("ngIf",i.isLoading),l(),u("ngIf",!i.isLoading&&i.dirty.size>0),l(),u("ngIf",i.materia),l(5),T("ngModel",i.modoEval),u("disabled",i.isLoading||i.isSaving),l(),u("ngValue",1),l(2),u("ngValue",2),l(2),u("ngValue",3),l(3),u("disabled",i.isLoading||i.isSaving),l(2),u("disabled",i.isLoading||i.isSaving||i.dirty.size===0),l(2),u("ngIf",i.loadError||i.saveError||i.saveOk),l(2),u("ngForOf",i.evalTabs()),l(2),u("ngIf",i.meta),l(),u("ngIf",i.rows.length),l(),u("ngIf",!i.isLoading&&!i.rows.length),l(),Ve("display",i.modalVisible?"block":"none"),F("show",i.modalVisible),V("aria-hidden",!i.modalVisible),l(5),H("",i.modalModo==="create"?"Agregar":"Editar"," rubro ",i.modalTipo==="TEO"?"te\xF3rico":"pr\xE1ctico"),l(6),T("ngModel",i.nuevoNombre),l(5),T("ngModel",i.nuevoMax),l(4),T("ngModel",i.nuevoOrden),l(6),u("disabled",!i.nuevoNombre.trim()||i.isLoading||i.isSaving),l(),S(i.modalModo==="create"?"Agregar":"Guardar"),l(),u("ngIf",i.modalVisible))},dependencies:[q,X,te,ie,Z,ve,ee,J,ye,Y],styles:["[_nghost-%COMP%]{display:block}.student-name[_ngcontent-%COMP%]{cursor:pointer}.student-name[_ngcontent-%COMP%]:hover{text-decoration:underline}.reg-grid[_ngcontent-%COMP%]{border-collapse:separate;border-spacing:0}.reg-grid[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;z-index:3;background:var(--bs-tertiary-bg)}.sticky-col[_ngcontent-%COMP%]{position:sticky;left:0;z-index:2;background:var(--bs-body-bg)}.col-meta[_ngcontent-%COMP%]{min-width:260px}.col-meta-2[_ngcontent-%COMP%]{left:260px;min-width:120px;z-index:2}.col-teo[_ngcontent-%COMP%], .col-pra[_ngcontent-%COMP%], .col-sum[_ngcontent-%COMP%]{min-width:90px}.col-add[_ngcontent-%COMP%]{width:42px;min-width:42px;max-width:42px}.reg-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .reg-grid[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{white-space:nowrap}.rubro-head[_ngcontent-%COMP%]{writing-mode:vertical-lr;text-orientation:mixed;white-space:normal;line-height:1.1;font-weight:600;max-height:180px;overflow:hidden;margin:0 auto}.rubro-head-wrap[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:6px}.rubro-actions[_ngcontent-%COMP%]{display:flex;gap:4px}.reg-grid[_ngcontent-%COMP%]   input.form-control[_ngcontent-%COMP%]{padding:.15rem .35rem;text-align:center}.reg-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.cell-selected[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{outline:2px solid var(--bs-primary);outline-offset:-1px}"]});var we=oe;var fi=["modalEditarInscripcion"],hi=["modalReporte"],bi=["modalSeleccionPlantillaExcel"],xi=["modalActualizarExcel"];function vi(s,t){s&1&&(r(0,"span",63),d(1,"INACTIVO"),a())}function yi(s,t){if(s&1){let e=M();r(0,"button",60),x("click",function(){let n=f(e).$implicit,o=m(2);return h(o.seleccionarDocente(n))}),r(1,"span"),d(2),a(),r(3,"span",61)(4,"span",62),d(5),a(),v(6,vi,2,0,"span",17),a()()}if(s&2){let e=t.$implicit,i=m(2);u("disabled",i.docenteInactivo(e)),l(2),S(i.getNombreCompletoDocente(e)),l(3),S(i.getConteoAsignadosDocente(e)),l(),u("ngIf",i.docenteInactivo(e))}}function Ci(s,t){if(s&1&&(r(0,"div",58),v(1,yi,7,4,"button",59),a()),s&2){let e=m();l(),u("ngForOf",e.docentesFiltrados)}}function Si(s,t){if(s&1&&(r(0,"span",64),d(1),a()),s&2){let e=m();l(),w("Asignados: ",e.conteoAsignados)}}function Ei(s,t){if(s&1&&(r(0,"span",63),d(1),a()),s&2){let e=m();l(),w("Mostrando: ",e.collectionSize)}}function Mi(s,t){if(s&1){let e=M();r(0,"button",65),x("click",function(){f(e);let n=m();return h(n.refrescarPantalla())}),d(1,"Refrescar"),a()}}function wi(s,t){if(s&1){let e=M();r(0,"button",66),x("click",function(){f(e);let n=m();return h(n.limpiarDocente())}),d(1,"Limpiar"),a()}}function Ii(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.id),l(),S(e.Nombre)}}function Ti(s,t){if(s&1){let e=M();r(0,"div",21)(1,"div",12)(2,"select",22),A("ngModelChange",function(n){f(e);let o=m();return P(o.institucionesFiltroId,n)||(o.institucionesFiltroId=n),h(n)}),x("change",function(){f(e);let n=m();return h(n.onFiltroChange())}),r(3,"option",25),d(4,"(Todas)"),a(),v(5,Ii,2,2,"option",23),a(),r(6,"label"),d(7,"Instituci\xF3n"),a()()()}if(s&2){let e=m();l(2),T("ngModel",e.institucionesFiltroId),l(),u("ngValue",null),l(2),u("ngForOf",e.instituciones)}}function Pi(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.id),l(),S(e.Anio)}}function Ai(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.value),l(),S(e.label)}}function Oi(s,t){if(s&1){let e=M();r(0,"div",67)(1,"input",68),A("ngModelChange",function(n){f(e);let o=m();return P(o.includeSinDocente,n)||(o.includeSinDocente=n),h(n)}),x("change",function(){f(e);let n=m();return h(n.onFiltroChange())}),a(),r(2,"label",69),d(3,"Incluir est. sin docente asignado"),a()()}if(s&2){let e=m();l(),T("ngModel",e.includeSinDocente)}}function Ni(s,t){s&1&&(r(0,"span"),d(1,"COPIAR"),a())}function ki(s,t){s&1&&(r(0,"span"),I(1,"span",70),d(2," COPIANDO... "),a())}function Ri(s,t){s&1&&(r(0,"span"),d(1,"GENERAR EXCEL"),a())}function Di(s,t){s&1&&(r(0,"span"),I(1,"span",70),d(2," GENERANDO... "),a())}function Vi(s,t){s&1&&(r(0,"span"),d(1,"ACTUALIZAR DATOS ARCHIVO EXCEL"),a())}function Fi(s,t){s&1&&(r(0,"span"),I(1,"span",70),d(2," ACTUALIZANDO... "),a())}function Li(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e),l(),w("",e," por p\xE1gina")}}function zi(s,t){if(s&1){let e=M();r(0,"button",79),x("click",function(){let n=f(e).$implicit,o=m(2).$implicit;return h(o.close(n))}),r(1,"span"),d(2),a(),r(3,"small",80),d(4),a()()}if(s&2){let e=t.$implicit;l(2),S((e==null?null:e.ParaI)||"Plantilla"),l(2),S(e==null?null:e.Categoria)}}function ji(s,t){if(s&1&&(r(0,"div",77),v(1,zi,5,2,"button",78),a()),s&2){let e=m(2);l(),u("ngForOf",e.plantillasExcelDisponibles)}}function Bi(s,t){s&1&&(r(0,"div",80),d(1,"No hay plantillas disponibles."),a())}function Ki(s,t){if(s&1){let e=M();r(0,"div",71)(1,"h5",72),d(2,"Seleccionar plantilla Excel"),a(),r(3,"button",73),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("close"))}),a()(),r(4,"div",74),v(5,ji,2,1,"div",75)(6,Bi,2,0,"div",76),a()}if(s&2){let e=m();l(5),u("ngIf",e.plantillasExcelDisponibles&&e.plantillasExcelDisponibles.length),l(),u("ngIf",!e.plantillasExcelDisponibles||e.plantillasExcelDisponibles.length===0)}}function $i(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.label),l(),S(e.label)}}function Ui(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.label),l(),S(e.label)}}function Gi(s,t){if(s&1&&(r(0,"option",25),d(1),a()),s&2){let e=t.$implicit;u("ngValue",e.label),l(),S(e.label)}}function Wi(s,t){s&1&&(r(0,"th",81),d(1,"Acciones"),a())}function Hi(s,t){if(s&1&&(r(0,"tr")(1,"td",54)(2,"div",82)(3,"span",83),d(4,"Cargando..."),a()()()()),s&2){let e=m();l(),V("colspan",e.esDocente?11:12)}}function qi(s,t){if(s&1&&(r(0,"tr")(1,"td",84),d(2,"Selecciona un docente para ver sus estudiantes."),a()()),s&2){let e=m();l(),V("colspan",e.esDocente?11:12)}}function Xi(s,t){if(s&1&&(r(0,"tr")(1,"td",54),d(2,"No hay estudiantes con los filtros actuales."),a()()),s&2){let e=m();l(),V("colspan",e.esDocente?11:12)}}function Qi(s,t){if(s&1){let e=M();r(0,"button",90),x("click",function(){f(e);let n=m(2).$implicit,o=m();return h(o.quitarDocenteAsignado(n))}),d(1," Quitar doc "),a()}}function Zi(s,t){if(s&1){let e=M();r(0,"button",91),x("click",function(){f(e);let n=m(2).$implicit,o=m();return h(o.asignarADocenteSeleccionado(n))}),d(1," Asignar doc "),a()}}function Ji(s,t){if(s&1&&(r(0,"td",87),v(1,Qi,2,0,"button",88)(2,Zi,2,0,"button",89),a()),s&2){let e=m().$implicit,i=m();l(),u("ngIf",i.docenteSeleccionado&&i.getDocenteActualRow(e)&&i.getDocenteActualRow(e)!=0),l(),u("ngIf",i.docenteSeleccionado&&(!i.getDocenteActualRow(e)||i.getDocenteActualRow(e)==0))}}function Yi(s,t){if(s&1&&(r(0,"tr")(1,"td",54),d(2),a(),r(3,"td")(4,"span",85),d(5),a()(),r(6,"td"),d(7),a(),r(8,"td"),d(9),a(),r(10,"td"),d(11),a(),r(12,"td"),d(13),a(),r(14,"td"),d(15),a(),r(16,"td"),d(17),a(),r(18,"td"),d(19),a(),r(20,"td",54),d(21),a(),r(22,"td"),d(23),a(),v(24,Ji,3,2,"td",86),a()),s&2){let e=t.$implicit,i=t.index,n=m();l(2),S((n.pagina-1)*n.pageSize+(i+1)),l(2),u("ngClass",n.getDocenteActualRow(e)&&n.getDocenteActualRow(e)!=0?"bg-success":"bg-secondary"),l(),w(" ",n.getDocenteNombreById(n.getDocenteActualRow(e))," "),l(2),H("",e.Ap_Paterno," ",e.Ap_Materno),l(2),S(e.Nombre),l(2),S(e.Celular),l(2),S(e.NumCelP),l(2),S(e.NumCelM),l(2),S(n.cursoSolicitadoLabel(e)),l(2),S(n.getInstrumentoRow(e)),l(2),S(e.Anio),l(2),S(n.cursoAsignadoLabel(e)),l(),u("ngIf",!n.esDocente)}}function en(s,t){if(s&1){let e=M();r(0,"div",92)(1,"ngb-pagination",93),A("pageChange",function(n){f(e);let o=m();return P(o.pagina,n)||(o.pagina=n),h(n)}),x("pageChange",function(){f(e);let n=m();return h(n.cargarEstudiantes())}),a()()}if(s&2){let e=m();l(),T("page",e.pagina),u("collectionSize",e.collectionSize)("pageSize",e.pageSize)("maxSize",5)("rotate",!0)("ellipses",!1)("boundaryLinks",!0)}}function tn(s,t){if(s&1){let e=M();r(0,"button",60),x("click",function(){let n=f(e).$implicit,o=m(3);return h(o.seleccionarDocenteEdicion(n))}),r(1,"span"),d(2),a(),r(3,"span",85),d(4),a()()}if(s&2){let e=t.$implicit,i=m(3);u("disabled",i.docenteInactivo(e)),l(2),S(i.getNombreCompletoDocente(e)),l(),u("ngClass",i.docenteInactivo(e)?"bg-secondary":"bg-primary"),l(),S(i.docenteInactivo(e)?"INACTIVO":"OK")}}function nn(s,t){if(s&1&&(r(0,"div",113),v(1,tn,5,4,"button",59),a()),s&2){let e=m(2);l(),u("ngForOf",e.docentesFiltradosEdit)}}function on(s,t){s&1&&(r(0,"span"),d(1,"Guardar"),a())}function an(s,t){s&1&&(r(0,"span"),d(1,"Guardando..."),a())}function rn(s,t){if(s&1){let e=M();r(0,"div",71)(1,"h5",72),d(2,"Editar inscripci\xF3n (cambiar docente / datos clave)"),a(),r(3,"button",73),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("close"))}),a()(),r(4,"div",74)(5,"form",94)(6,"div",5)(7,"div",49)(8,"div",11)(9,"div",12)(10,"input",95),x("focus",function(){f(e);let n=m();return h(n.onDocenteEditFocus())})("blur",function(){f(e);let n=m();return h(n.onDocenteEditBlur())}),a(),r(11,"label"),d(12),a()(),v(13,nn,2,1,"div",96),a(),r(14,"div",97),d(15,"Si est\xE1 vac\xEDo, quedar\xE1 sin docente asignado."),a()(),r(16,"div",49)(17,"div",12),I(18,"input",98),r(19,"label"),d(20,"Fecha inscripci\xF3n"),a()()()(),r(21,"div",99)(22,"div",43)(23,"div",12),I(24,"input",100),r(25,"label"),d(26,"Curso solicitado"),a()()(),r(27,"div",43)(28,"div",12),I(29,"input",101),r(30,"label"),d(31,"Paralelo solicitado"),a()()(),r(32,"div",43)(33,"div",12),I(34,"input",102),r(35,"label"),d(36,"Turno"),a()()()(),r(37,"div",99)(38,"div",49)(39,"div",12),I(40,"input",103),r(41,"label"),d(42,"Instrumento musical"),a()()(),r(43,"div",49)(44,"div",12),I(45,"input",104),r(46,"label"),d(47,"Instrumento musical (sec.)"),a()()()(),r(48,"div",99)(49,"div",43)(50,"div",12),I(51,"input",105),r(52,"label"),d(53,"Categor\xEDa"),a()()(),r(54,"div",43)(55,"div",12),I(56,"input",106),r(57,"label"),d(58,"Verificaci\xF3n"),a()()(),r(59,"div",43)(60,"div",12),I(61,"input",107),r(62,"label"),d(63,"Matr\xEDcula"),a()()()(),r(64,"div",99)(65,"div",108)(66,"div",12),I(67,"textarea",109),r(68,"label"),d(69,"Observaci\xF3n"),a()()()()()(),r(70,"div",110)(71,"button",111),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("cancel"))}),d(72,"Cancelar"),a(),r(73,"button",112),x("click",function(){f(e);let n=m();return h(n.guardarInscripcion())}),v(74,on,2,0,"span",37)(75,an,2,0,"span",37),a()()}if(s&2){let e=m();l(5),u("formGroup",e.newinfoestudiantesifas),l(5),u("formControl",e.docEditInput),l(2),w("Docente (",e.tituloModo,")"),l(),u("ngIf",e.mostrarListaDocentesEdit&&e.docentesFiltradosEdit.length>0),l(60),u("disabled",e.isSaving),l(),u("ngIf",!e.isSaving),l(),u("ngIf",e.isSaving)}}function sn(s,t){if(s&1&&(r(0,"div",116)(1,"div")(2,"strong"),d(3,"Docente:"),a(),d(4),a(),r(5,"div")(6,"strong"),d(7,"Modo:"),a(),d(8),a(),r(9,"div")(10,"strong"),d(11,"Instituci\xF3n:"),a(),d(12),a(),r(13,"div")(14,"strong"),d(15,"A\xF1o:"),a(),d(16),a(),r(17,"div")(18,"strong"),d(19,"Especialidad:"),a(),d(20),a(),r(21,"div")(22,"strong"),d(23,"Curso solicitado:"),a(),d(24),a(),r(25,"div")(26,"strong"),d(27,"Curso asignado:"),a(),d(28),a(),r(29,"div")(30,"strong"),d(31,"Buscar:"),a(),d(32),a(),r(33,"div")(34,"strong"),d(35,"Orden:"),a(),d(36),a(),r(37,"div")(38,"strong"),d(39,"Filas en la tabla (p\xE1gina actual):"),a(),d(40),a(),r(41,"div")(42,"strong"),d(43,"Total filtrado:"),a(),d(44),a()()),s&2){let e=m(2);l(4),w(" ",e.reporteResumen.docente),l(4),w(" ",e.tituloModo),l(4),w(" ",e.reporteResumen.institucion),l(4),w(" ",e.reporteResumen.anio_id),l(4),w(" ",e.reporteResumen.especialidad),l(4),w(" ",e.reporteResumen.cursoSolicitado),l(4),w(" ",e.reporteResumen.cursoAsignado),l(4),w(" ",e.reporteResumen.buscar),l(4),w(" ",e.reporteResumen.orden),l(4),w(" ",e.reporteResumen.filas),l(4),w(" ",e.reporteResumen.totalFiltrado)}}function ln(s,t){s&1&&(r(0,"div",80),d(1,"No hay informaci\xF3n del reporte."),a())}function cn(s,t){if(s&1){let e=M();r(0,"div",71)(1,"h5",72),d(2,"Generar reporte (PDF) - tabla actual"),a(),r(3,"button",73),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("close"))}),a()(),r(4,"div",74),v(5,sn,45,11,"div",114)(6,ln,2,0,"div",76),a(),r(7,"div",110)(8,"button",111),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("cancel"))}),d(9,"Cancelar"),a(),r(10,"button",115),x("click",function(){f(e);let n=m();return h(n.generarReportePdfActual())}),d(11," Generar PDF "),a()()}if(s&2){let e=m();l(5),u("ngIf",e.reporteResumen),l(),u("ngIf",!e.reporteResumen),l(4),u("disabled",!e.estudiantes||e.estudiantes.length===0)}}function dn(s,t){if(s&1&&(r(0,"div",125),I(1,"i",126),d(2),a()),s&2){let e=m(2);l(2),w(" ",e.archivoExcelParaActualizar.name," ")}}function un(s,t){if(s&1){let e=M();r(0,"div",71)(1,"h4",72),d(2,"Actualizar datos archivo Excel"),a(),r(3,"button",117),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("cancel"))}),a()(),r(4,"div",74)(5,"p",118),d(6," Seleccione el archivo Excel que descarg\xF3 previamente. Se reemplazar\xE1n los datos de estudiantes y los metadatos (docente, materia, curso, gesti\xF3n, etc.) con la informaci\xF3n actual del sistema. "),a(),r(7,"div",119)(8,"label",120),d(9,"Archivo Excel (.xlsx / .xlsm)"),a(),r(10,"input",121),x("change",function(n){f(e);let o=m();return h(o.onArchivoExcelSeleccionado(n))}),a()(),v(11,dn,3,1,"div",122),a(),r(12,"div",110)(13,"button",123),x("click",function(){let n=f(e).$implicit;return h(n.dismiss("cancel"))}),d(14,"CANCELAR"),a(),r(15,"button",124),x("click",function(){f(e);let n=m();return h(n.ejecutarActualizarExcel())}),r(16,"span",35),I(17,"ng-lottie",36),a(),r(18,"span"),d(19),a(),I(20,"span",38),a()()}if(s&2){let e=m();l(11),u("ngIf",e.archivoExcelParaActualizar),l(2),u("disabled",e.actualizandoExcel),l(2),u("disabled",e.actualizandoExcel||!e.archivoExcelParaActualizar),l(2),u("options",e._tools.optionsarchive),l(2),S(e.actualizandoExcel?"ACTUALIZANDO...":"ACTUALIZAR Y DESCARGAR")}}var ae=class ae{constructor(t,e,i,n,o,c,p,g,_,b){this._infoest=t;this._planteldoc=e;this._anios=i;this._controles=n;this._inst=o;this._auth=c;this._tools=p;this._reportes=g;this._plantillasExcel=_;this.route=b;this.esDocente=!1;this.esPlantelAdministrativo=!1;this.docenteIdPerfil=null;this.perfilCargado=!1;this.modo="especialidad";this.docenteFieldKey="planteldocadmins_id";this.instrumentoFieldKey="InstrumentoMusical";this.tituloModo="Especialidad";this.esSuperAdmin=!1;this.instituciones=[];this.institucionesFiltroId=null;this.anios=[];this.selectedAnioId=null;this.especialidadOptions=[];this.especialidadSecundariaOptions=[];this.especialidadSeleccionada="";this.cursoOptions=[];this.cursoSolicitadoSeleccionado="";this.cursoAsignadoSeleccionado="";this.cursoMixtoSeleccionado="";this.sortBy="NombreEstudiante";this.sortDir="asc";this.includeSinDocente=!1;this.filterTxt="";this.plantelDocentes=[];this.docenteInput=new Pe("");this.docentesFiltrados=[];this.mostrarListaDocentes=!1;this.docenteSeleccionado=null;this.estudiantes=[];this.isLoading=!1;this.pagina=1;this.pageSize=100;this.pageSizeOptions=[10,20,50,100,200];this.collectionSize=0;this.conteoAsignados=0;this.docenteConteoMap={};this.isLoadingConteoDocentes=!1;this.isLoadingCursosOptions=!1;this.cursoSolicitadoOptionsDocente=[];this.cursoAsignadoOptionsDocente=[];this.cursoMixtoOptionsDocente=[];this.isSaving=!1;this.reporteResumen=null;this.plantillasExcelDisponibles=[];this.generandoExcel=!1;this.archivoExcelParaActualizar=null;this.actualizandoExcel=!1;this.docEditInput=new Pe("");this.docentesFiltradosEdit=[];this.mostrarListaDocentesEdit=!1;this.newinfoestudiantesifas=this._infoest.createFormGroupinfoestudiantesifas()}ngOnInit(){this.route.data.subscribe(t=>{let e=t?.modo??"especialidad";this.setModo(e)}),this._auth.revisarSiEsSuperAdmin().subscribe(t=>{this.esSuperAdmin=t,t&&this.cargarInstituciones()}),this.cargarAnios(),this.cargarOptionsInstrumentos(),this.setupBuscadorDocentes(),this.setupBuscadorDocentesEdicion(),this.cargarPerfilYDocente()}cargarPerfilYDocente(){this._auth.pedirPerfil().subscribe({next:t=>{let e=t?.usuario??t?.data?.usuario??t??{},i=(e?.Cargo??"").toString().toUpperCase().trim();this.esPlantelAdministrativo=i.includes("SECRETARIO")||i.includes("ADMINISTRATIVO"),this.esDocente=i.includes("DOCENTE")&&!this.esPlantelAdministrativo;let n=Number(e?.id??0);if(this.docenteIdPerfil=Number.isFinite(n)&&n>0?n:null,this.perfilCargado=!0,this.esDocente&&this.docenteIdPerfil){this.autoCargarDocentePerfil(this.docenteIdPerfil);return}this.cargarPlantelDocentes()},error:()=>{this.esDocente=!1,this.esPlantelAdministrativo=!1,this.docenteIdPerfil=null,this.perfilCargado=!0,this.cargarPlantelDocentes()}})}autoCargarDocentePerfil(t){let e=Number(t??0);if(!Number.isFinite(e)||e<=0){this.plantelDocentes=[];return}this._planteldoc.Seleccionarplanteldocentes(e).subscribe({next:i=>{let n=i?.data??i??null;this.plantelDocentes=n?[n]:[],n&&(this.docenteSeleccionado=n,this.docenteInput.setValue(this.getNombreCompletoDocente(n),{emitEvent:!1}),this.docenteInput.disable({emitEvent:!1}),this.mostrarListaDocentes=!1,this.docentesFiltrados=[],this.pagina=1,this.refrescarTodo(),this.cargarCursosOptionsDesdeTablaCompleta(),this.cargarConteoDocentes())},error:()=>{this.plantelDocentes=[],this.docenteSeleccionado=null}})}setModo(t){if(this.modo=t,t==="complementario"){this.docenteFieldKey="planteldocadmins_idOtros",this.instrumentoFieldKey="InstrumentoMusicalSecundario",this.tituloModo="Complementario";return}if(t==="practicaconjuntos"){this.docenteFieldKey="planteldocadmins_idPC",this.instrumentoFieldKey="InstrumentoMusical",this.tituloModo="Pr\xE1ctica de conjuntos";return}this.docenteFieldKey="planteldocadmins_id",this.instrumentoFieldKey="InstrumentoMusical",this.tituloModo="Especialidad"}get instrumentoOptions(){return this.instrumentoFieldKey==="InstrumentoMusicalSecundario"?this.especialidadSecundariaOptions||[]:this.especialidadOptions||[]}get instrumentoFiltroLabel(){return this.instrumentoFieldKey==="InstrumentoMusicalSecundario"?"Especialidad secundaria":"Especialidad"}normalizar(t){return(t??"").toString().trim().toUpperCase()}onDocenteFocus(){this.esDocente||(this.mostrarListaDocentes=!0)}onDocenteBlur(){window.setTimeout(()=>{this.mostrarListaDocentes=!1},150)}onDocenteEditFocus(){this.mostrarListaDocentesEdit=!0}onDocenteEditBlur(){window.setTimeout(()=>{this.mostrarListaDocentesEdit=!1},150)}normalizarPayloadDocenteIds(t){let e=O({},t??{});return["planteldocadmins_id","planteldocadmins_idPC","planteldocadmins_idOtros"].forEach(n=>{if(!(n in e))return;let o=e[n];if(o===""||o===void 0){e[n]=null;return}let c=Number(o);if(!Number.isFinite(c)||c<=0){e[n]=null;return}e[n]=c}),e}getInstitucionFiltroId(){if(!this.esSuperAdmin)return null;let t=Number(this.institucionesFiltroId??0);return Number.isFinite(t)&&t>0?t:null}cargarInstituciones(){this._inst.Obtenerinstituciones().subscribe({next:t=>{this.instituciones=t?.data||[]},error:()=>{this.instituciones=[]}})}cargarAnios(){this._anios.ObtenerAniosConPredeterminado().subscribe({next:({anios:t,predeterminado:e})=>{this.anios=t||[];let i=Number(e?.id??0);this.selectedAnioId=Number.isFinite(i)&&i>0?i:this.anios?.[0]?.id??null,this.cargarConteoDocentes()},error:()=>{this.anios=[],this.selectedAnioId=null}})}cargarOptionsInstrumentos(){let t=["LVLCURSO","ESPECIALIDAD","ESPECIALIDAD SECUNDARIA"];this._controles.ObtenerOptionsSelectPorCategorias(t).subscribe({next:e=>{this.cursoOptions=e?.LVLCURSO||[],this.especialidadOptions=e?.ESPECIALIDAD||[],this.especialidadSecundariaOptions=e?.["ESPECIALIDAD SECUNDARIA"]||[]},error:()=>{this.cursoOptions=[],this.especialidadOptions=[],this.especialidadSecundariaOptions=[]}})}cargarPlantelDocentes(){if(this.esDocente&&this.docenteIdPerfil){this._planteldoc.Seleccionarplanteldocentes(this.docenteIdPerfil).subscribe({next:t=>{let e=t?.data??t??null,i=e?[e]:[];this.plantelDocentes=i.filter(n=>this.normalizar(n?.Visibilidad)!=="OCULTO").sort((n,o)=>this.getNombreCompletoDocente(n).localeCompare(this.getNombreCompletoDocente(o))),this.autoSeleccionarDocentePerfil(),this.cargarConteoDocentes()},error:()=>{this.plantelDocentes=[]}});return}this._planteldoc.Obtenerplanteldocentes().subscribe({next:t=>{let e=t?.data||[];this.plantelDocentes=e.filter(i=>this.normalizar(i?.Visibilidad)!=="OCULTO").sort((i,n)=>this.getNombreCompletoDocente(i).localeCompare(this.getNombreCompletoDocente(n))),this.cargarConteoDocentes()},error:()=>{this.plantelDocentes=[]}})}autoSeleccionarDocentePerfil(){if(!this.esDocente||!this.docenteIdPerfil)return;let t=(this.plantelDocentes||[]).find(e=>Number(e?.id??0)===Number(this.docenteIdPerfil));t&&(this.docenteSeleccionado=t,this.docenteInput.setValue(this.getNombreCompletoDocente(t),{emitEvent:!1}),this.docenteInput.disable({emitEvent:!1}),this.mostrarListaDocentes=!1,this.docentesFiltrados=[],this.pagina=1,this.refrescarTodo(),this.cargarCursosOptionsDesdeTablaCompleta())}getConteoAsignadosDocente(t){let e=String(t?.id??"").trim();if(!e)return 0;let i=Number(this.docenteConteoMap?.[e]??0);return Number.isFinite(i)&&i>0?i:0}getNombreCompletoDocente(t){let e=(t?.Nombres??"").toString().trim(),i=(t?.Apellidos??"").toString().trim();return`${e} ${i}`.trim()}getDocenteNombreById(t){let e=String(t??"").trim();if(!e||e==="0")return"SIN ASIGNAR";let i=(this.plantelDocentes||[]).find(n=>String(n?.id)===e);return i?this.getNombreCompletoDocente(i):`ID ${e}`}getDocenteActualRow(t){return t?.[this.docenteFieldKey]}getInstrumentoRow(t){return t?.[this.instrumentoFieldKey]}docenteInactivo(t){return this.normalizar(t?.Estado)==="INACTIVO"}filtrarPlantelDocentes(t,e=!1){let i=this.getInstitucionFiltroId(),n=(this.plantelDocentes||[]).filter(o=>i?Number(o?.instituciones_id??0)===i:!0);return e?n.slice(0,50):t?n.filter(o=>this.getNombreCompletoDocente(o).toLowerCase().includes(t)).slice(0,25):[]}setupBuscadorDocentes(){this.docenteInput.valueChanges.subscribe(t=>{if(this.esDocente){this.docentesFiltrados=[],this.mostrarListaDocentes=!1;return}let e=(t??"").toString();if(e===""){this.docentesFiltrados=[],this.docenteSeleccionado=null;return}if(e.trim()===""){this.docentesFiltrados=this.filtrarPlantelDocentes("",!0);return}this.docenteSeleccionado=null,this.docentesFiltrados=this.filtrarPlantelDocentes(e.toLowerCase().trim())})}seleccionarDocente(t){!t||this.docenteInactivo(t)||(this.docenteSeleccionado=t,this.docenteInput.setValue(this.getNombreCompletoDocente(t),{emitEvent:!1}),this.mostrarListaDocentes=!1,this.docentesFiltrados=[],this.pagina=1,this.refrescarTodo(),this.cargarCursosOptionsDesdeTablaCompleta())}limpiarDocente(){this.docenteSeleccionado=null,this.docenteInput.setValue("",{emitEvent:!1}),this.docentesFiltrados=[],this.estudiantes=[],this.collectionSize=0,this.conteoAsignados=0,this.cursoSolicitadoSeleccionado="",this.cursoAsignadoSeleccionado="",this.cursoSolicitadoOptionsDocente=[],this.cursoAsignadoOptionsDocente=[]}setupBuscadorDocentesEdicion(){this.docEditInput.valueChanges.subscribe(t=>{let e=(t??"").toString();if(e===""){this.docentesFiltradosEdit=[],this.newinfoestudiantesifas.patchValue({[this.docenteFieldKey]:""});return}if(e.trim()===""){this.docentesFiltradosEdit=this.filtrarPlantelDocentes("",!0);return}this.newinfoestudiantesifas.patchValue({[this.docenteFieldKey]:""}),this.docentesFiltradosEdit=this.filtrarPlantelDocentes(e.toLowerCase().trim())})}seleccionarDocenteEdicion(t){!t||this.docenteInactivo(t)||(this.newinfoestudiantesifas.patchValue({[this.docenteFieldKey]:t?.id??""}),this.docEditInput.setValue(this.getNombreCompletoDocente(t),{emitEvent:!1}),this.mostrarListaDocentesEdit=!1,this.docentesFiltradosEdit=[])}syncDocenteEdicionConForm(){let t=this.newinfoestudiantesifas.get(this.docenteFieldKey)?.value,e=(this.plantelDocentes||[]).find(i=>String(i?.id)===String(t));this.docEditInput.setValue(e?this.getNombreCompletoDocente(e):"",{emitEvent:!1})}buildParams(t){let e=Number(this.docenteSeleccionado?.id??0),i=(this.especialidadSeleccionada??"").trim()||void 0,n=O({page:this.pagina,per_page:this.pageSize,anio_id:this.selectedAnioId??void 0,search:(this.filterTxt??"").trim()||void 0,search_mode:"any",relevance:0,include_sin_docente:this.esDocente?0:this.includeSinDocente?1:0,sort_by:this.sortBy||void 0,sort_dir:this.sortDir||void 0},t||{});n.include_sin_asignar=1,n.anio_scope="default",e>0&&(n[this.docenteFieldKey]=e),i&&(n[this.instrumentoFieldKey]=i);let o=(this.cursoSolicitadoSeleccionado??"").trim();if(o){let g=(this.cursoSolicitadoOptionsDocente||[]).find(_=>String(_?.label??"").trim()===o);if(g)n.Curso_Solicitado=(g.curso??"").trim(),n.Paralelo_Solicitado=(g.paralelo??"").trim();else{let _=o.split(" ").filter(Boolean);n.Curso_Solicitado=_.slice(0,-1).join(" ")||o,n.Paralelo_Solicitado=_.length>1?_[_.length-1]:""}}let c=(this.cursoAsignadoSeleccionado??"").trim();if(c){let g=(this.cursoAsignadoOptionsDocente||[]).find(_=>String(_?.label??"").trim()===c);if(g)n.CursoAsignado=(g.curso??"").trim(),n.ParaleloAsignado=(g.paralelo??"").trim();else{let _=c.split(" ").filter(Boolean);n.CursoAsignado=_.slice(0,-1).join(" ")||c,n.ParaleloAsignado=_.length>1?_[_.length-1]:""}}let p=this.getInstitucionFiltroId();return p&&(n.instituciones_id=p),n}buildParamsSinCursos(t){let e=Number(this.docenteSeleccionado?.id??0),i=(this.especialidadSeleccionada??"").trim()||void 0,n=O({page:this.pagina,per_page:this.pageSize,anio_id:this.selectedAnioId??void 0,search:(this.filterTxt??"").trim()||void 0,search_mode:"any",relevance:0,include_sin_docente:this.esDocente?0:this.includeSinDocente?1:0,sort_by:this.sortBy||void 0,sort_dir:this.sortDir||void 0},t||{});n.include_sin_asignar=1,n.anio_scope="default",e>0&&(n[this.docenteFieldKey]=e),i&&(n[this.instrumentoFieldKey]=i);let o=this.getInstitucionFiltroId();return o&&(n.instituciones_id=o),n}recalcularCursosOptionsDesdeRows(t){let e=new Map,i=new Map;(t||[]).forEach(o=>{let c=String(o?.Curso_Solicitado??"").trim(),p=String(o?.Paralelo_Solicitado??"").trim(),g=`${c} ${p}`.replace(/\s+/g," ").trim();c&&e.set(g,{label:g,curso:c,paralelo:p});let _=String(o?.CursoAsignado??"").trim(),b=String(o?.ParaleloAsignado??"").trim(),y=`${_} ${b}`.replace(/\s+/g," ").trim();_&&_.toUpperCase()!=="SIN ASIGNAR"&&i.set(y,{label:y,curso:_,paralelo:b})}),this.cursoSolicitadoOptionsDocente=Array.from(e.values()).sort((o,c)=>o.label.localeCompare(c.label)),this.cursoAsignadoOptionsDocente=Array.from(i.values()).sort((o,c)=>o.label.localeCompare(c.label));let n=new Map;this.cursoSolicitadoOptionsDocente.forEach(o=>n.set(o.label,o)),this.cursoAsignadoOptionsDocente.forEach(o=>n.set(o.label,o)),this.cursoMixtoOptionsDocente=Array.from(n.values()).sort((o,c)=>o.label.localeCompare(c.label)),this.cursoSolicitadoSeleccionado&&!(this.cursoSolicitadoOptionsDocente||[]).some(o=>o.label===this.cursoSolicitadoSeleccionado)&&(this.cursoSolicitadoSeleccionado=""),this.cursoAsignadoSeleccionado&&!(this.cursoAsignadoOptionsDocente||[]).some(o=>o.label===this.cursoAsignadoSeleccionado)&&(this.cursoAsignadoSeleccionado=""),this.cursoMixtoSeleccionado&&!(this.cursoMixtoOptionsDocente||[]).some(o=>o.label===this.cursoMixtoSeleccionado)&&(this.cursoMixtoSeleccionado="")}cargarCursosOptionsDesdeTablaCompleta(){if(!this.docenteSeleccionado?.id){this.cursoSolicitadoOptionsDocente=[],this.cursoAsignadoOptionsDocente=[];return}this.isLoadingCursosOptions=!0;let t=this.buildParamsSinCursos({page:1,per_page:5e3,search:void 0});this._infoest.Obtenerinfoestudiantesifas(t).subscribe({next:e=>{let i=e?.data||[];this.recalcularCursosOptionsDesdeRows(i),this.isLoadingCursosOptions=!1},error:()=>{this.cursoSolicitadoOptionsDocente=[],this.cursoAsignadoOptionsDocente=[],this.isLoadingCursosOptions=!1}})}buildDocenteScopedParamsBase(){let t=Number(this.docenteSeleccionado?.id??0),e=(this.especialidadSeleccionada??"").trim()||void 0,i={anio_id:this.selectedAnioId??void 0,include_sin_asignar:1,include_sin_docente:this.includeSinDocente?1:0,anio_scope:"default"},n=this.getInstitucionFiltroId();return n&&(i.instituciones_id=n),t>0&&(i[this.docenteFieldKey]=t),e&&(i[this.instrumentoFieldKey]=e),i}cargarConteoDocentes(){this.isLoadingConteoDocentes=!0;let t=G(O({},this.buildDocenteScopedParamsBase()),{docente_field:this.docenteFieldKey});delete t[this.docenteFieldKey],this._infoest.ObtenerConteoDocentes(t).subscribe({next:e=>{let i=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[],n={};(i||[]).forEach(o=>{let c=String(o?.docente_id??o?.docenteId??o?.id??"").trim();if(!c||c==="0")return;let p=Number(o?.total??o?.cantidad??o?.count??0);n[c]=Number.isFinite(p)&&p>0?p:0}),this.docenteConteoMap=n,this.isLoadingConteoDocentes=!1},error:()=>{this.docenteConteoMap={},this.isLoadingConteoDocentes=!1}})}normalizarSexo(t){let e=(t??"").toString().trim().toUpperCase();return e?e==="M"||e.startsWith("MAS")?"M":e==="F"||e.startsWith("FEM")?"F":e.includes("MASC")?"M":e.includes("FEM")?"F":"":""}copyTextToClipboard(t){return D(this,null,function*(){try{if(navigator?.clipboard?.writeText){yield navigator.clipboard.writeText(t);return}}catch{}let e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)})}copiarTablaParaExcelPlantilla(){return D(this,null,function*(){let t=this.estudiantes||[];if(!t.length){this._tools.MostrarMensaje("info","No hay filas para copiar");return}let i=t.map(n=>{let o=`${(n?.Ap_Paterno??"").toString().trim()} ${(n?.Ap_Materno??"").toString().trim()} ${(n?.Nombre??"").toString().trim()}`.replace(/\s+/g," ").trim(),c=(n?.CI??"").toString().trim(),p=(this.getInstrumentoRow(n)??"").toString().trim(),g=this.normalizarSexo(n?.Sexo),_=g==="F"?"X":"",b=g==="M"?"X":"",y=new Array(5).fill("");return y[0]=o,y[1]=c,y[2]=p,y[3]=b,y[4]=_,y.join("	")}).join(`
`);this._tools.MostrarMensajeLoading();try{yield this.copyTextToClipboard(i),this._tools.MostrarMensajeSuccess()}catch(n){console.error(n),this._tools.MostrarMensajeError()}})}getModoCategoriaPlantillaExcel(){return this.modo==="especialidad"?"MODO INSTRUMENTOS DE ESPECIALIDAD":this.modo==="practicaconjuntos"?"MODO PRACTICA DE CONJUNTOS":this.modo==="complementario"?"MODO INSTRUMENTO COMPLEMENTARIO":null}pedirPlantillaExcelParaModoActual(){return D(this,null,function*(){let t=this.getModoCategoriaPlantillaExcel();if(!t)return null;let i=(yield j(this._plantillasExcel.ObtenerPlantillas(t,!1)))?.data||[];if(i.length===0)return null;if(i.length===1)return i[0];this.plantillasExcelDisponibles=i,this.modalSeleccionPlantillaExcelRef=this._tools.openModal(this.modalSeleccionPlantillaExcel,"lg",{scrollable:!0});try{return(yield this.modalSeleccionPlantillaExcelRef.result)??null}catch{return null}})}getGestionTextoSeleccionada(){return((this.anios||[]).find(e=>Number(e?.id??0)===Number(this.selectedAnioId??0))?.Anio??"").toString().trim()}getCursoFiltroTexto(){let t=(this.cursoSolicitadoSeleccionado??"").toString().trim(),e=(this.cursoAsignadoSeleccionado??"").toString().trim(),i=(this.cursoMixtoSeleccionado??"").toString().trim();return t||e||i||""}getInstitucionNombreFiltro(){if(!this.esSuperAdmin)return"";let t=this.getInstitucionFiltroId();return t?((this.instituciones||[]).find(i=>Number(i?.id??0)===t)?.Nombre??"").toString().trim():""}getTurnoFromEstudiantes(){return((this.estudiantes||[])[0]?.Turno??"").toString().trim()}getSiglaFromEstudiantes(){return((this.estudiantes||[])[0]?.SiglaMateria??"").toString().trim()}buildExcelMetaPayload(t){let e=this.getNombreCompletoDocente(this.docenteSeleccionado),i=this.getGestionTextoSeleccionada(),n=this.getCursoFiltroTexto(),o=this.getMateriaExcelLabel(),c=this.getTurnoFromEstudiantes(),p=this.getInstitucionNombreFiltro(),g=this.getSiglaFromEstudiantes();return{docente:e,materia:o,curso:n,gestion:i,turno:c,institucion:p,sigla:g}}getMateriaBaseExcel(){return this.modo==="complementario"?"INSTRUMENTO COMPLEMENTARIO":this.modo==="practicaconjuntos"?"PRACTICA DE CONJUNTOS":"INSTRUMENTO DE ESPECIALIDAD I"}getInstrumentoSeleccionadoLabel(){let t=(this.especialidadSeleccionada??"").toString().trim();return t?((this.instrumentoOptions||[]).find(n=>(n?.value??"").toString().trim()===t)?.label??"").toString().trim()||t:""}getMateriaExcelLabel(){let t=this.getMateriaBaseExcel(),e=this.getInstrumentoSeleccionadoLabel();return e?`${t} (${e})`:t}buildExcelRowsFromTablaActual(t){return(t||[]).map(e=>{let i=`${(e?.Ap_Paterno??"").toString().trim()} ${(e?.Ap_Materno??"").toString().trim()} ${(e?.Nombre??"").toString().trim()}`.replace(/\s+/g," ").trim(),n=(e?.CI??"").toString().trim(),o=(this.getInstrumentoRow(e)??"").toString().trim(),c=this.normalizarSexo(e?.Sexo);return[i,n,o,c==="M"?"X":"",c==="F"?"X":""]})}descargarBlob(t,e){let i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}generarExcelPlantilla(){return D(this,null,function*(){if(!this.docenteSeleccionado?.id||this.generandoExcel)return;if(!this.getModoCategoriaPlantillaExcel()){this._tools.MostrarMensaje("info","Este modo no tiene generaci\xF3n por plantilla");return}let e=this.estudiantes||[];if(!e.length){this._tools.MostrarMensaje("info","No hay filas para generar");return}this.generandoExcel=!0;try{let i=yield this.pedirPlantillaExcelParaModoActual();if(!i?.id){this._tools.MostrarMensaje("warning","No se encontr\xF3 plantilla Excel para este modo.");return}let n=this.buildExcelRowsFromTablaActual(e),o=this.buildExcelMetaPayload(e),c=C=>(C??"").toString().replace(/[^a-zA-Z0-9_\- ]/g,"").trim(),p=[c(o.docente),c(o.materia),c(o.gestion||""),c(o.curso||"")].filter(C=>!!C).join(" ").trim(),g=yield j(this._plantillasExcel.GenerarExcelDesdePlantilla(Number(i.id),O({rows:n,filename:p||"registro"},o))),_=g?.body??null;if(!_){this._tools.MostrarMensaje("error","No se pudo generar el Excel");return}let b=g?.headers?.get?.("content-disposition")||g?.headers?.get?.("Content-Disposition"),y=(p||"registro")+".xlsx";if(b){let C=b.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i),E=decodeURIComponent((C?.[1]||C?.[2]||"").trim());E&&(y=E)}this.descargarBlob(_,y),this._tools.MostrarMensaje("success",`Excel generado (${e.length} filas)`)}catch(i){console.error(i),this._tools.MostrarMensaje("error","Error al generar el Excel")}finally{this.generandoExcel=!1}})}abrirModalActualizarExcel(){if(!this.docenteSeleccionado?.id){this._tools.MostrarMensaje("info","Seleccione un docente primero");return}if(!(this.estudiantes||[]).length){this._tools.MostrarMensaje("info","No hay datos de estudiantes para actualizar");return}this.archivoExcelParaActualizar=null,this.modalActualizarExcelRef=this._tools.openModal(this.modalActualizarExcel,"md",{scrollable:!0})}onArchivoExcelSeleccionado(t){let e=t.target,i=e?.files?.[0]??null;if(i){let n=(i.name||"").split(".").pop()?.toLowerCase()??"";if(!["xlsx","xlsm","xltx"].includes(n)){this._tools.MostrarMensaje("warning","Solo se permiten archivos .xlsx, .xlsm o .xltx"),this.archivoExcelParaActualizar=null,e.value="";return}}this.archivoExcelParaActualizar=i}ejecutarActualizarExcel(){return D(this,null,function*(){if(!this.archivoExcelParaActualizar){this._tools.MostrarMensaje("warning","Seleccione un archivo Excel primero");return}if(!this.actualizandoExcel){this.actualizandoExcel=!0;try{let t=yield this.pedirPlantillaExcelParaModoActual();if(!t?.id){this._tools.MostrarMensaje("warning","No se encontr\xF3 plantilla Excel para este modo.");return}let e=this.estudiantes||[],i=this.buildExcelRowsFromTablaActual(e),n=this.buildExcelMetaPayload(e),o=y=>(y??"").toString().replace(/[^a-zA-Z0-9_\- ]/g,"").trim(),c=[o(n.docente),o(n.materia),o(n.gestion||""),o(n.curso||"")].filter(y=>!!y).join(" ").trim(),p=yield j(this._plantillasExcel.ActualizarExcelDesdePlantilla(Number(t.id),this.archivoExcelParaActualizar,O({rows:i,filename:c||"registro_actualizado"},n))),g=p?.body??null;if(!g){this._tools.MostrarMensaje("error","No se pudo actualizar el Excel");return}let _=p?.headers?.get?.("content-disposition")||p?.headers?.get?.("Content-Disposition"),b=(c||"registro_actualizado")+".xlsx";if(_){let y=_.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i),C=decodeURIComponent((y?.[1]||y?.[2]||"").trim());C&&(b=C)}this.descargarBlob(g,b),this._tools.MostrarMensaje("success",`Excel actualizado (${e.length} filas)`);try{this.modalActualizarExcelRef?.close?.("done")}catch{}}catch(t){console.error("Error actualizando Excel",t);let e=t?.error?.error||t?.message||"Error al actualizar el Excel";this._tools.MostrarMensaje("error",e)}finally{this.actualizandoExcel=!1}}})}refrescarTodo(){this.docenteSeleccionado?.id&&(this.cargarConteoAsignados(),this.cargarEstudiantes())}refrescarPantalla(){this.cargarPlantelDocentes(),this.cargarConteoDocentes(),this.docenteSeleccionado?.id&&(this.refrescarTodo(),this.cargarCursosOptionsDesdeTablaCompleta())}onFiltroChange(){this.pagina=1,this.refrescarTodo(),this.cargarConteoDocentes(),this.cargarCursosOptionsDesdeTablaCompleta()}onCursoFilterChange(){this.pagina=1,this.refrescarTodo()}onCursoSolicitadoChange(){(this.cursoSolicitadoSeleccionado??"").trim()&&(this.cursoAsignadoSeleccionado="",this.cursoMixtoSeleccionado=""),this.pagina=1,this.refrescarTodo()}onCursoAsignadoChange(){(this.cursoAsignadoSeleccionado??"").trim()&&(this.cursoSolicitadoSeleccionado="",this.cursoMixtoSeleccionado=""),this.pagina=1,this.refrescarTodo()}onCursoMixtoChange(){(this.cursoMixtoSeleccionado??"").trim()&&(this.cursoSolicitadoSeleccionado="",this.cursoAsignadoSeleccionado=""),this.pagina=1,this.cargarEstudiantes()}onPageSizeChange(){this.pagina=1,this.cargarEstudiantes()}abrirModalReporteActual(){if(!this.docenteSeleccionado?.id)return;let t=this.getInstitucionFiltroId(),e=t?(this.instituciones||[]).find(i=>Number(i?.id??0)===Number(t))?.Nombre:null;this.reporteResumen={titulo:`Estudiantes por docente (${this.tituloModo})`,docente:this.getNombreCompletoDocente(this.docenteSeleccionado),anio_id:this.selectedAnioId,instituciones_id:t,institucion:e||"(seg\xFAn perfil)",especialidad:(this.especialidadSeleccionada??"").trim()||"(todas)",buscar:(this.filterTxt??"").trim()||"(sin texto)",incluirSinDocente:this.includeSinDocente?"S\xED":"No",cursoSolicitado:(this.cursoSolicitadoSeleccionado??"").trim()||"(todos)",cursoAsignado:(this.cursoAsignadoSeleccionado??"").trim()||"(todos)",orden:`${this.sortBy} ${this.sortDir}`.trim(),pagina:this.pagina,pageSize:this.pageSize,filas:(this.estudiantes||[]).length,totalFiltrado:this.collectionSize,fecha:new Date},this.modalReporteRef=this._tools.openModal(this.modalReporte,"lg")}uniqueRowsById(t){let e=[],i=new Set;return(t||[]).forEach(n=>{let c=String(n?.id??n?.estudiantesifas_id??n?.estudiante_id??"").trim()||JSON.stringify([n?.Ap_Paterno,n?.Ap_Materno,n?.Nombre,n?.CI,n?.Curso_Solicitado,n?.CursoAsignado]);i.has(c)||(i.add(c),e.push(n))}),e}esCursoAsignadoSinAsignar(t){let e=String(t?.CursoAsignado??"").trim().toUpperCase();return!e||e==="SIN ASIGNAR"}sortRows(t){let e=this.sortDir==="desc"?-1:1,i=this.sortBy||"NombreEstudiante",n=p=>String(p??"").trim().toUpperCase(),o=(p,g)=>{let _=n(p?.Ap_Paterno),b=n(g?.Ap_Paterno),y=n(p?.Ap_Materno),C=n(g?.Ap_Materno),E=n(p?.Nombre),R=n(g?.Nombre),k=_.localeCompare(b);if(k!==0)return k;let z=y.localeCompare(C);if(z!==0)return z;let L=E.localeCompare(R);return L!==0?L:n(p?.CI).localeCompare(n(g?.CI))},c=p=>i==="Curso_Solicitado"?this.cursoSolicitadoLabel(p).toUpperCase():i==="CursoAsignado"?this.cursoAsignadoLabel(p).toUpperCase():i==="Anio"?String(p?.Anio??"").toUpperCase():"";return(t||[]).slice().sort((p,g)=>{let _=0;return i==="NombreEstudiante"?_=o(p,g):_=c(p).localeCompare(c(g)),_*e})}slicePagina(t){let e=(this.pagina-1)*this.pageSize;return(t||[]).slice(e,e+this.pageSize)}buildReporteMetaBase(t){let e=this.getInstitucionFiltroId(),i=e?(this.instituciones||[]).find(o=>Number(o?.id??0)===Number(e))?.Nombre:null,n=(this.anios||[]).find(o=>Number(o?.id??0)===Number(this.selectedAnioId??0))?.Anio;return O({titulo:`Estudiantes por docente (${this.tituloModo})`,tituloModo:this.tituloModo,docente:this.getNombreCompletoDocente(this.docenteSeleccionado),anio_id:this.selectedAnioId,anio_txt:n||"",instituciones_id:e,institucion:i||"(seg\xFAn perfil)",especialidad:(this.especialidadSeleccionada??"").trim()||"(todas)",buscar:(this.filterTxt??"").trim()||"(sin texto)",incluirSinDocente:this.esDocente?"No":this.includeSinDocente?"S\xED":"No",cursoSolicitado:(this.cursoSolicitadoSeleccionado??"").trim()||"(todos)",cursoAsignado:(this.cursoAsignadoSeleccionado??"").trim()||"(todos)",cursoMixto:(this.cursoMixtoSeleccionado??"").trim()||"(todos)",orden:`${this.sortBy} ${this.sortDir}`.trim(),fecha:new Date},t||{})}cursosUnicosDesdeFilas(t,e){let i=new Set;return(t||[]).forEach(n=>{let o=this.cursoSolicitadoLabel(n),c=this.cursoAsignadoLabel(n);e==="solicitado"&&o?i.add(o):e==="asignado"&&c&&c!=="SIN ASIGNAR"?i.add(c):e==="mixto"&&(c&&c!=="SIN ASIGNAR"?i.add(c):o&&i.add(o))}),Array.from(i.values()).sort((n,o)=>n.localeCompare(o)).join(", ")}cargarFilasParaReporte(t){return D(this,null,function*(){if(!this.docenteSeleccionado?.id)return[];let e=5e3;if(t==="MIXTO"){let c=(this.cursoMixtoSeleccionado??"").trim();if(!c){let k=this.buildParamsSinCursos({page:1,per_page:e}),z=yield j(this._infoest.Obtenerinfoestudiantesifas(k).pipe(le(()=>se({data:[]}))));return Array.isArray(z?.data)?z.data:[]}let p=(this.cursoMixtoOptionsDocente||[]).find(k=>String(k?.label??"").trim()===c),g=(p?.curso??"").trim(),_=(p?.paralelo??"").trim(),b=this.buildParamsSinCursos({page:1,per_page:e});b.Curso_Solicitado=g,b.Paralelo_Solicitado=_;let y=this.buildParamsSinCursos({page:1,per_page:e});y.CursoAsignado=g,y.ParaleloAsignado=_;let C=yield j(Ae({sol:this._infoest.Obtenerinfoestudiantesifas(b).pipe(le(()=>se({data:[]}))),asg:this._infoest.Obtenerinfoestudiantesifas(y).pipe(le(()=>se({data:[]})))})),E=Array.isArray(C?.sol?.data)?C.sol.data:[],R=Array.isArray(C?.asg?.data)?C.asg.data:[];return this.uniqueRowsById([...E,...R])}let i=this.buildParams({page:1,per_page:e}),n=yield j(this._infoest.Obtenerinfoestudiantesifas(i).pipe(le(()=>se({data:[]})))),o=Array.isArray(n?.data)?n.data:[];return t==="NO_OFICIAL"?o.filter(c=>this.esCursoAsignadoSinAsignar(c)):t==="OFICIAL"?o.filter(c=>!this.esCursoAsignadoSinAsignar(c)):o})}generarReporteNoOficialDirecto(){return D(this,null,function*(){if(this.docenteSeleccionado?.id){try{this._tools.MostrarMensajeLoading?.()}catch{}try{let t=this.sortRows(yield this.cargarFilasParaReporte("NO_OFICIAL"));if(!t.length){this._tools.MostrarMensaje("info","No hay filas para el reporte (No oficial)");return}let e=(this.cursoSolicitadoSeleccionado||"").includes("(todos)")||!(this.cursoSolicitadoSeleccionado??"").trim()?this.cursosUnicosDesdeFilas(t,"solicitado"):(this.cursoSolicitadoSeleccionado??"").trim(),i=this.buildReporteMetaBase({reporteTipo:"NO_OFICIAL",cursosHeaderTxt:e});yield this._reportes.GenerarListaEstudiantesPorDocenteTablaActual(t,i)}catch(t){console.error(t),this._tools.MostrarMensaje("error","No se pudo generar el reporte (No oficial)")}finally{try{this._tools.OcultarMensajeLoading?.()}catch{}}}})}generarReporteOficialDirecto(){return D(this,null,function*(){if(this.docenteSeleccionado?.id){try{this._tools.MostrarMensajeLoading?.()}catch{}try{let t=this.sortRows(yield this.cargarFilasParaReporte("OFICIAL"));if(!t.length){this._tools.MostrarMensaje("info","No hay filas para el reporte (Oficial)");return}let e=(this.cursoAsignadoSeleccionado||"").includes("(todos)")||!(this.cursoAsignadoSeleccionado??"").trim()?this.cursosUnicosDesdeFilas(t,"asignado"):(this.cursoAsignadoSeleccionado??"").trim(),i=this.buildReporteMetaBase({reporteTipo:"OFICIAL",cursosHeaderTxt:e});yield this._reportes.GenerarListaEstudiantesPorDocenteTablaActual(t,i)}catch(t){console.error(t),this._tools.MostrarMensaje("error","No se pudo generar el reporte (Oficial)")}finally{try{this._tools.OcultarMensajeLoading?.()}catch{}}}})}generarReporteMixtoDirecto(){return D(this,null,function*(){if(this.docenteSeleccionado?.id){try{this._tools.MostrarMensajeLoading?.()}catch{}try{let t=this.sortRows(yield this.cargarFilasParaReporte("MIXTO"));if(!t.length){this._tools.MostrarMensaje("info","No hay filas para el reporte (Mixto)");return}let e=(this.cursoMixtoSeleccionado||"").includes("(todos)")||!(this.cursoMixtoSeleccionado??"").trim()?this.cursosUnicosDesdeFilas(t,"mixto"):(this.cursoMixtoSeleccionado??"").trim(),i=this.buildReporteMetaBase({reporteTipo:"MIXTO",cursosHeaderTxt:e});yield this._reportes.GenerarListaEstudiantesPorDocenteTablaActual(t,i)}catch(t){console.error(t),this._tools.MostrarMensaje("error","No se pudo generar el reporte (Mixto)")}finally{try{this._tools.OcultarMensajeLoading?.()}catch{}}}})}generarReportePdfActual(){return D(this,null,function*(){if(!this.docenteSeleccionado?.id)return;let t=this.estudiantes||[];if(!t.length){this._tools.MostrarMensaje("info","No hay filas para reportar con los filtros actuales");return}try{this._tools.MostrarMensajeLoading?.()}catch{}try{yield this._reportes.GenerarListaEstudiantesPorDocenteTablaActual(t,this.reporteResumen);try{this._tools.OcultarMensajeLoading?.()}catch{}this._tools.closeModal(this.modalReporteRef)}catch(e){console.error(e);try{this._tools.OcultarMensajeLoading?.()}catch{}this._tools.MostrarMensaje("error","No se pudo generar el reporte")}})}cargarEstudiantes(){if(!this.docenteSeleccionado?.id){this.estudiantes=[],this.collectionSize=0;return}if((this.cursoMixtoSeleccionado??"").trim()){this.isLoading=!0,this.cargarFilasParaReporte("MIXTO").then(e=>{let i=this.sortRows(e);this.collectionSize=i.length,this.estudiantes=this.slicePagina(i),this.isLoading=!1}).catch(e=>{console.error("Error al cargar estudiantes (mixto)",e),this.estudiantes=[],this.collectionSize=0,this.isLoading=!1});return}if((this.cursoSolicitadoSeleccionado??"").trim()){this.isLoading=!0,this.cargarFilasParaReporte("NO_OFICIAL").then(e=>{let i=this.sortRows(e);this.collectionSize=i.length,this.estudiantes=this.slicePagina(i),this.isLoading=!1}).catch(e=>{console.error("Error al cargar estudiantes (curso solicitado => sin asignar)",e),this.estudiantes=[],this.collectionSize=0,this.isLoading=!1});return}if((this.cursoAsignadoSeleccionado??"").trim()){this.isLoading=!0,this.cargarFilasParaReporte("OFICIAL").then(e=>{let i=this.sortRows(e);this.collectionSize=i.length,this.estudiantes=this.slicePagina(i),this.isLoading=!1}).catch(e=>{console.error("Error al cargar estudiantes (curso asignado => asignados)",e),this.estudiantes=[],this.collectionSize=0,this.isLoading=!1});return}this.isLoading=!0;let t=this.buildParams();this._infoest.Obtenerinfoestudiantesifas(t).subscribe({next:e=>{let i=e?.data||[];this.estudiantes=this.sortBy==="NombreEstudiante"?this.sortRows(i):i,this.collectionSize=Number(e?.meta?.total??this.estudiantes.length??0),this.isLoading=!1},error:e=>{console.error("Error al cargar estudiantes",e),this.estudiantes=[],this.collectionSize=0,this.isLoading=!1}})}cargarConteoAsignados(){if(!this.docenteSeleccionado?.id){this.conteoAsignados=0;return}let t=this.buildParams({page:1,per_page:1,include_sin_docente:0});this._infoest.Obtenerinfoestudiantesifas(t).subscribe({next:e=>{this.conteoAsignados=Number(e?.meta?.total??0)},error:()=>{this.conteoAsignados=0}})}abrirEditarInscripcion(t){let e=Number(t?.id??0);!Number.isFinite(e)||e<=0||(this._tools.MostrarMensajeLoading(),this._infoest.Seleccionarinfoestudiantesifas(e).subscribe({next:i=>{let n=i?.data??null;if(!n){this._tools.MostrarMensaje("warning","No se pudo cargar la inscripci\xF3n");return}Object.keys(this.newinfoestudiantesifas.controls).forEach(o=>{o in n&&this.newinfoestudiantesifas.get(o)?.setValue(n[o])}),this.syncDocenteEdicionConForm(),this.modalEditarInscripcionRef=this._tools.openModal(this.modalEditarInscripcion,"xl"),this._tools.MostrarMensajeSuccess()},error:i=>{console.error(i),this._tools.MostrarMensajeError()}}))}guardarInscripcion(){if(this.newinfoestudiantesifas.invalid){Object.values(this.newinfoestudiantesifas.controls).forEach(i=>{i.markAsTouched(),i.markAsDirty()}),this._tools.MostrarMensajeFrmIncompleto();return}let t=Number(this.newinfoestudiantesifas.get("id")?.value??0);if(!Number.isFinite(t)||t<=0)return;this.isSaving=!0,this._tools.MostrarMensajeLoading();let e=this.normalizarPayloadDocenteIds(this.newinfoestudiantesifas.value);this._infoest.Modificarinfoestudiantesifas(e,t).subscribe({next:()=>{this.isSaving=!1,this._tools.closeModal(this.modalEditarInscripcionRef),this._tools.MostrarMensajeSuccess(),this.refrescarTodo()},error:i=>{console.error(i),this.isSaving=!1,this._tools.MostrarMensajeError()}})}asignarADocenteSeleccionado(t){let e=Number(this.docenteSeleccionado?.id??0),i=Number(t?.id??0);!Number.isFinite(e)||e<=0||!Number.isFinite(i)||i<=0||(this._tools.MostrarMensajeLoading(),this._infoest.Seleccionarinfoestudiantesifas(i).subscribe({next:n=>{let o=n?.data??null;if(!o){this._tools.MostrarMensaje("warning","No se pudo cargar la inscripci\xF3n");return}let c=this.normalizarPayloadDocenteIds(G(O({},o),{[this.docenteFieldKey]:e}));this._infoest.Modificarinfoestudiantesifas(c,i).subscribe({next:()=>{this._tools.MostrarMensajeSuccess(),this.refrescarTodo()},error:p=>{console.error(p),this._tools.MostrarMensajeError()}})},error:n=>{console.error(n),this._tools.MostrarMensajeError()}}))}quitarDocenteAsignado(t){let e=Number(t?.id??0);!Number.isFinite(e)||e<=0||(this._tools.MostrarMensajeLoading(),this._infoest.Seleccionarinfoestudiantesifas(e).subscribe({next:i=>{let n=i?.data??null;if(!n){this._tools.MostrarMensaje("warning","No se pudo cargar la inscripci\xF3n");return}let o=this.normalizarPayloadDocenteIds(G(O({},n),{[this.docenteFieldKey]:null}));this._infoest.Modificarinfoestudiantesifas(o,e).subscribe({next:()=>{this._tools.MostrarMensajeSuccess(),this.refrescarTodo()},error:c=>{console.error(c),this._tools.MostrarMensajeError()}})},error:i=>{console.error(i),this._tools.MostrarMensajeError()}}))}cursoSolicitadoLabel(t){let e=(t?.Curso_Solicitado??"").toString().trim(),i=(t?.Paralelo_Solicitado??"").toString().trim();return`${e} ${i}`.trim()}cursoAsignadoLabel(t){let e=(t?.CursoAsignado??"").toString().trim(),i=(t?.ParaleloAsignado??"").toString().trim(),n=`${e} ${i}`.trim();return n||"SIN ASIGNAR"}};ae.\u0275fac=function(e){return new(e||ae)(N(it),N(tt),N(et),N(Je),N(qe),N(Ce),N(Ze),N(Se),N(nt),N(Q))},ae.\u0275cmp=W({type:ae,selectors:[["app-estudiantesxdocentesespecialidad"]],viewQuery:function(e,i){if(e&1&&(ue(fi,7),ue(hi,7),ue(bi,7),ue(xi,7)),e&2){let n;me(n=pe())&&(i.modalEditarInscripcion=n.first),me(n=pe())&&(i.modalReporte=n.first),me(n=pe())&&(i.modalSeleccionPlantillaExcel=n.first),me(n=pe())&&(i.modalActualizarExcel=n.first)}},standalone:!1,decls:165,vars:61,consts:[["modalSeleccionPlantillaExcel",""],["modalEditarInscripcion",""],["modalReporte",""],["modalActualizarExcel",""],[1,"container","mt-4"],[1,"row"],[1,"col","text-center"],[1,"display-4","fw-bold","titulosGlobales"],[1,"lead","text-secondary","subtitulosGlobales"],[1,"row","align-items-end",2,"gap","12px"],[1,"col-12","col-lg-5"],[1,"position-relative"],[1,"form-floating"],["type","text","placeholder","Docente",1,"form-control",3,"focus","blur","formControl","disabled"],["class","list-group shadow","style","position: absolute; z-index: 2000; left: 0; right: 0; max-height: 40vh; overflow: auto;",4,"ngIf"],[1,"mt-2","d-flex","align-items-center",2,"gap","10px","flex-wrap","wrap"],["class","badge bg-info",4,"ngIf"],["class","badge bg-secondary",4,"ngIf"],["class","btn btn-outline-secondary btn-sm","type","button","title","Refrescar docentes, conteos y tabla",3,"click",4,"ngIf"],["class","btn btn-outline-secondary btn-sm","type","button",3,"click",4,"ngIf"],["class","col-12 col-lg-2",4,"ngIf"],[1,"col-12","col-lg-2"],[1,"form-select",3,"ngModelChange","change","ngModel"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"col-12","col-lg-3"],[3,"ngValue"],[1,"row","mt-3","align-items-center"],[1,"input-group"],[1,"input-group-text"],["type","text","placeholder","Apellidos, nombres, CI, curso...","title","Presiona Enter para buscar",1,"form-control",3,"ngModelChange","keyup.enter","ngModel"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"col-12","col-lg-4","mt-2","mt-lg-0"],["class","form-check",4,"ngIf"],[1,"button","col-12","col-lg-12","d-flex","justify-content-lg-end","mt-2","mt-lg-0",2,"gap","8px","flex-wrap","wrap"],["type","button","title","Copiar informaci\xF3n",1,"btn","mouse-dir","primary","d-flex","align-items-center","gap-2",3,"click","disabled"],[2,"display","flex","align-items","center","justify-content","center","width","30px","height","30px"],["width","50px","height","50px",3,"options"],[4,"ngIf"],[1,"dir-part"],["type","button","title","Generar registro excel (plantilla)",1,"btn","mouse-dir","primary","d-flex","align-items-center","gap-2",3,"click","disabled"],["type","button","title","Actualizar datos de un archivo Excel existente",1,"btn","mouse-dir","primary","d-flex","align-items-center","gap-2",3,"click","disabled"],[1,"form-select",2,"width","auto",3,"ngModelChange","change","ngModel"],[1,"row","mt-2","align-items-end"],[1,"col-12","col-lg-4"],[1,"form-select",3,"ngModelChange","change","ngModel","disabled"],[1,"mt-2"],["type","button",1,"btn","btn-outline-danger","w-100",3,"click","disabled"],["type","button",1,"btn","btn-outline-primary","w-100",3,"click","disabled"],["type","button",1,"btn","btn-outline-secondary","w-100",3,"click","disabled"],[1,"col-12","col-lg-6"],[1,"mt-4"],[1,"table-responsive"],[1,"table","table-striped","table-hover","table-sm","align-middle"],[1,"text-center",2,"width","45px"],[1,"text-center"],["class","text-center","style","width: 180px;",4,"ngIf"],[4,"ngFor","ngForOf"],["class","d-flex justify-content-center mt-3",4,"ngIf"],[1,"list-group","shadow",2,"position","absolute","z-index","2000","left","0","right","0","max-height","40vh","overflow","auto"],["type","button","class","list-group-item list-group-item-action d-flex justify-content-between align-items-center",3,"disabled","click",4,"ngFor","ngForOf"],["type","button",1,"list-group-item","list-group-item-action","d-flex","justify-content-between","align-items-center",3,"click","disabled"],[1,"d-flex","align-items-center",2,"gap","8px"],["title","Cantidad de estudiantes asignados",1,"badge","bg-info"],[1,"badge","bg-secondary"],[1,"badge","bg-info"],["type","button","title","Refrescar docentes, conteos y tabla",1,"btn","btn-outline-secondary","btn-sm",3,"click"],["type","button",1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"form-check"],["type","checkbox","id","chkSinDoc",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","chkSinDoc",1,"form-check-label","text-black"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm"],[1,"modal-header"],[1,"modal-title"],["type","button",1,"btn-close",3,"click"],[1,"modal-body"],["class","list-group",4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"list-group"],["type","button","class","list-group-item list-group-item-action d-flex justify-content-between align-items-center",3,"click",4,"ngFor","ngForOf"],["type","button",1,"list-group-item","list-group-item-action","d-flex","justify-content-between","align-items-center",3,"click"],[1,"text-muted"],[1,"text-center",2,"width","180px"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[1,"text-center","text-muted"],[1,"badge",3,"ngClass"],["class","text-center","style","gap: 6px;",4,"ngIf"],[1,"text-center",2,"gap","6px"],["class","btn btn-outline-danger btn-sm","type","button","title","Quitar docente asignado",3,"click",4,"ngIf"],["class","btn btn-outline-primary btn-sm","type","button","title","Asignar a docente seleccionado",3,"click",4,"ngIf"],["type","button","title","Quitar docente asignado",1,"btn","btn-outline-danger","btn-sm",3,"click"],["type","button","title","Asignar a docente seleccionado",1,"btn","btn-outline-primary","btn-sm",3,"click"],[1,"d-flex","justify-content-center","mt-3"],["previousLabel","Anterior","nextLabel","Siguiente",3,"pageChange","page","collectionSize","pageSize","maxSize","rotate","ellipses","boundaryLinks"],["novalidate","",3,"formGroup"],["type","text","placeholder","Docente",1,"form-control",3,"focus","blur","formControl"],["class","list-group shadow","style","position: absolute; z-index: 2100; left: 0; right: 0; max-height: 40vh; overflow: auto;",4,"ngIf"],[1,"form-text"],["type","date","formControlName","FechInsc","placeholder","",1,"form-control"],[1,"row","mt-3"],["type","text","formControlName","Curso_Solicitado","placeholder","",1,"form-control"],["type","text","formControlName","Paralelo_Solicitado","placeholder","",1,"form-control"],["type","text","formControlName","Turno","placeholder","",1,"form-control"],["type","text","formControlName","InstrumentoMusical","placeholder","",1,"form-control"],["type","text","formControlName","InstrumentoMusicalSecundario","placeholder","",1,"form-control"],["type","text","formControlName","Categoria","placeholder","",1,"form-control"],["type","text","formControlName","Verificacion","placeholder","",1,"form-control"],["type","text","formControlName","Matricula","placeholder","",1,"form-control"],[1,"col-12"],["formControlName","Observacion","placeholder","",1,"form-control",2,"height","100px"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"list-group","shadow",2,"position","absolute","z-index","2100","left","0","right","0","max-height","40vh","overflow","auto"],["class","alert alert-info",4,"ngIf"],["type","button",1,"btn","btn-danger",3,"click","disabled"],[1,"alert","alert-info"],["type","button","title","cerrar",1,"btn-close",3,"click"],[1,"text-muted","small","mb-3"],[1,"mb-3"],[1,"form-label","fw-semibold"],["type","file","accept",".xlsx,.xlsm,.xltx",1,"form-control",3,"change"],["class","alert alert-info py-2 small mb-0",4,"ngIf"],["type","button",1,"btn","btn-secondary",3,"click","disabled"],["type","button",1,"btn","mouse-dir","primary","d-flex","align-items-center","gap-2",3,"click","disabled"],[1,"alert","alert-info","py-2","small","mb-0"],[1,"bi","bi-file-earmark-spreadsheet","me-1"]],template:function(e,i){if(e&1){let n=M();r(0,"div",4)(1,"div",5)(2,"div",6)(3,"h1",7),d(4),a(),r(5,"p",8),d(6,"Busca un docente, revisa sus estudiantes y reasigna inscripciones"),a()()()(),r(7,"div",9)(8,"div",10)(9,"div",11)(10,"div",12)(11,"input",13),x("focus",function(){return f(n),h(i.onDocenteFocus())})("blur",function(){return f(n),h(i.onDocenteBlur())}),a(),r(12,"label"),d(13,"Buscar docente"),a()(),v(14,Ci,2,1,"div",14),a(),r(15,"div",15),v(16,Si,2,1,"span",16)(17,Ei,2,1,"span",17)(18,Mi,2,0,"button",18)(19,wi,2,0,"button",19),a()(),v(20,Ti,8,3,"div",20),r(21,"div",21)(22,"div",12)(23,"select",22),A("ngModelChange",function(c){return f(n),P(i.selectedAnioId,c)||(i.selectedAnioId=c),h(c)}),x("change",function(){return f(n),h(i.onFiltroChange())}),v(24,Pi,2,2,"option",23),a(),r(25,"label"),d(26,"A\xF1o"),a()()(),r(27,"div",24)(28,"div",12)(29,"select",22),A("ngModelChange",function(c){return f(n),P(i.especialidadSeleccionada,c)||(i.especialidadSeleccionada=c),h(c)}),x("change",function(){return f(n),h(i.onFiltroChange())}),r(30,"option",25),d(31,"(Todas las especialidades)"),a(),v(32,Ai,2,2,"option",23),a(),r(33,"label"),d(34),a()()()(),r(35,"div",26)(36,"div",10)(37,"div",27)(38,"span",28),d(39,"Buscar Estudiante"),a(),r(40,"input",29),A("ngModelChange",function(c){return f(n),P(i.filterTxt,c)||(i.filterTxt=c),h(c)}),x("keyup.enter",function(){return f(n),h(i.onFiltroChange())}),a(),r(41,"button",30),x("click",function(){return f(n),h(i.onFiltroChange())}),d(42,"Filtrar"),a()()(),r(43,"div",31),v(44,Oi,4,1,"div",32),a(),r(45,"div",33)(46,"button",34),x("click",function(){return f(n),h(i.copiarTablaParaExcelPlantilla())}),r(47,"span",35),I(48,"ng-lottie",36),a(),v(49,Ni,2,0,"span",37)(50,ki,3,0,"span",37),I(51,"span",38),a(),r(52,"button",39),x("click",function(){return f(n),h(i.generarExcelPlantilla())}),r(53,"span",35),I(54,"ng-lottie",36),a(),v(55,Ri,2,0,"span",37)(56,Di,3,0,"span",37),I(57,"span",38),a(),r(58,"button",40),x("click",function(){return f(n),h(i.abrirModalActualizarExcel())}),r(59,"span",35),I(60,"ng-lottie",36),a(),v(61,Vi,2,0,"span",37)(62,Fi,3,0,"span",37),I(63,"span",38),a(),r(64,"select",41),A("ngModelChange",function(c){return f(n),P(i.pageSize,c)||(i.pageSize=c),h(c)}),x("change",function(){return f(n),h(i.onPageSizeChange())}),v(65,Li,2,2,"option",23),a()()(),v(66,Ki,7,2,"ng-template",null,0,B),r(68,"div",42)(69,"div",43)(70,"div",12)(71,"select",44),A("ngModelChange",function(c){return f(n),P(i.cursoSolicitadoSeleccionado,c)||(i.cursoSolicitadoSeleccionado=c),h(c)}),x("change",function(){return f(n),h(i.onCursoSolicitadoChange())}),r(72,"option",25),d(73,"(Curso solicitado: todos)"),a(),v(74,$i,2,2,"option",23),a(),r(75,"label"),d(76,"Curso solicitado"),a()(),r(77,"div",45)(78,"button",46),x("click",function(){return f(n),h(i.generarReporteNoOficialDirecto())}),d(79," Reporte NO OFICIAL (Curso solicitado) "),a()()(),r(80,"div",43)(81,"div",12)(82,"select",44),A("ngModelChange",function(c){return f(n),P(i.cursoAsignadoSeleccionado,c)||(i.cursoAsignadoSeleccionado=c),h(c)}),x("change",function(){return f(n),h(i.onCursoAsignadoChange())}),r(83,"option",25),d(84,"(Curso asignado: todos)"),a(),v(85,Ui,2,2,"option",23),a(),r(86,"label"),d(87,"Curso asignado"),a()(),r(88,"div",45)(89,"button",47),x("click",function(){return f(n),h(i.generarReporteOficialDirecto())}),d(90," Reporte OFICIAL (Curso asignado) "),a()()(),r(91,"div",43)(92,"div",12)(93,"select",44),A("ngModelChange",function(c){return f(n),P(i.cursoMixtoSeleccionado,c)||(i.cursoMixtoSeleccionado=c),h(c)}),x("change",function(){return f(n),h(i.onCursoMixtoChange())}),r(94,"option",25),d(95,"(Curso mixto: todos)"),a(),v(96,Gi,2,2,"option",23),a(),r(97,"label"),d(98,"Curso mixto"),a()(),r(99,"div",45)(100,"button",48),x("click",function(){return f(n),h(i.generarReporteMixtoDirecto())}),d(101," Reporte MIXTO (Asignados + no asignados) "),a()()()(),r(102,"div",42)(103,"div",49)(104,"div",12)(105,"select",22),A("ngModelChange",function(c){return f(n),P(i.sortBy,c)||(i.sortBy=c),h(c)}),x("change",function(){return f(n),h(i.onFiltroChange())}),r(106,"option",25),d(107,"Orden: Ap.Paterno/Ap.Materno/Nombre"),a(),r(108,"option",25),d(109,"Orden: Curso solicitado"),a(),r(110,"option",25),d(111,"Orden: Curso asignado"),a(),r(112,"option",25),d(113,"Orden: A\xF1o"),a()(),r(114,"label"),d(115,"Ordenar por"),a()()(),r(116,"div",49)(117,"div",12)(118,"select",22),A("ngModelChange",function(c){return f(n),P(i.sortDir,c)||(i.sortDir=c),h(c)}),x("change",function(){return f(n),h(i.onFiltroChange())}),r(119,"option",25),d(120,"Ascendente"),a(),r(121,"option",25),d(122,"Descendente"),a()(),r(123,"label"),d(124,"Direcci\xF3n"),a()()()(),r(125,"div",50)(126,"div",51)(127,"table",52)(128,"thead")(129,"tr")(130,"th",53),d(131,"#"),a(),r(132,"th"),d(133,"Docente actual"),a(),r(134,"th"),d(135,"Apellidos"),a(),r(136,"th"),d(137,"Nombres"),a(),r(138,"th"),d(139,"Celular"),a(),r(140,"th"),d(141,"Cel. Pap\xE1"),a(),r(142,"th"),d(143,"Cel. Mam\xE1"),a(),r(144,"th"),d(145,"Curso solicitado"),a(),r(146,"th"),d(147),a(),r(148,"th",54),d(149,"A\xF1o"),a(),r(150,"th"),d(151,"Curso asignado"),a(),v(152,Wi,2,0,"th",55),a()(),r(153,"tbody"),v(154,Hi,5,1,"tr",37)(155,qi,3,1,"tr",37)(156,Xi,3,1,"tr",37)(157,Yi,25,14,"tr",56),a()()(),v(158,en,2,7,"div",57),a(),v(159,rn,76,7,"ng-template",null,1,B)(161,cn,12,3,"ng-template",null,2,B)(163,un,21,5,"ng-template",null,3,B)}e&2&&(l(4),w("Estudiantes por docente (",i.tituloModo,")"),l(7),u("formControl",i.docenteInput)("disabled",i.esDocente),l(3),u("ngIf",i.mostrarListaDocentes&&i.docentesFiltrados.length>0),l(2),u("ngIf",i.docenteSeleccionado),l(),u("ngIf",i.docenteSeleccionado),l(),u("ngIf",i.docenteSeleccionado),l(),u("ngIf",i.docenteSeleccionado&&!i.esDocente),l(),u("ngIf",i.esSuperAdmin),l(3),T("ngModel",i.selectedAnioId),l(),u("ngForOf",i.anios),l(5),T("ngModel",i.especialidadSeleccionada),l(),u("ngValue",""),l(2),u("ngForOf",i.instrumentoOptions),l(2),S(i.instrumentoFiltroLabel),l(6),T("ngModel",i.filterTxt),l(4),u("ngIf",i.esPlantelAdministrativo),l(2),u("disabled",!i.docenteSeleccionado||i.isLoading),l(2),u("options",i._tools.optionsarchive),l(),u("ngIf",!i.isLoading),l(),u("ngIf",i.isLoading),l(2),u("disabled",!i.docenteSeleccionado||i.isLoading||i.generandoExcel),l(2),u("options",i._tools.optionsarchive),l(),u("ngIf",!i.generandoExcel),l(),u("ngIf",i.generandoExcel),l(2),u("disabled",!i.docenteSeleccionado||i.isLoading||i.actualizandoExcel),l(2),u("options",i._tools.optionsarchive),l(),u("ngIf",!i.actualizandoExcel),l(),u("ngIf",i.actualizandoExcel),l(2),T("ngModel",i.pageSize),l(),u("ngForOf",i.pageSizeOptions),l(6),T("ngModel",i.cursoSolicitadoSeleccionado),u("disabled",!i.docenteSeleccionado||i.isLoadingCursosOptions),l(),u("ngValue",""),l(2),u("ngForOf",i.cursoSolicitadoOptionsDocente),l(4),u("disabled",!i.docenteSeleccionado||i.isLoading),l(4),T("ngModel",i.cursoAsignadoSeleccionado),u("disabled",!i.docenteSeleccionado||i.isLoadingCursosOptions),l(),u("ngValue",""),l(2),u("ngForOf",i.cursoAsignadoOptionsDocente),l(4),u("disabled",!i.docenteSeleccionado||i.isLoading),l(4),T("ngModel",i.cursoMixtoSeleccionado),u("disabled",!i.docenteSeleccionado||i.isLoadingCursosOptions),l(),u("ngValue",""),l(2),u("ngForOf",i.cursoMixtoOptionsDocente),l(4),u("disabled",!i.docenteSeleccionado||i.isLoading),l(5),T("ngModel",i.sortBy),l(),u("ngValue","NombreEstudiante"),l(2),u("ngValue","Curso_Solicitado"),l(2),u("ngValue","CursoAsignado"),l(2),u("ngValue","Anio"),l(6),T("ngModel",i.sortDir),l(),u("ngValue","asc"),l(2),u("ngValue","desc"),l(26),S(i.instrumentoFiltroLabel),l(5),u("ngIf",!i.esDocente),l(2),u("ngIf",i.isLoading),l(),u("ngIf",!i.isLoading&&!i.docenteSeleccionado),l(),u("ngIf",!i.isLoading&&i.docenteSeleccionado&&(!i.estudiantes||i.estudiantes.length===0)),l(),u("ngForOf",i.estudiantes),l(),u("ngIf",i.docenteSeleccionado))},dependencies:[Fe,q,X,$e,te,ie,Z,xe,ee,J,Ke,Y,Ue,Ge,We,Qe,Xe],styles:["[_nghost-%COMP%]{display:block}.list-group[_ngcontent-%COMP%]{border-radius:10px}.table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{vertical-align:middle}"]});var re=ae;var mn=[{path:"calificaciones",component:Ee},{path:"registrocalificaciones",component:we},{path:"docespecialidadxestudiante",component:re,data:{modo:"especialidad"}},{path:"doccomplementarioxestudiante",component:re,data:{modo:"complementario"}},{path:"docpracticaconjuntosxestudiante",component:re,data:{modo:"practicaconjuntos"}}],$=class ${};$.\u0275fac=function(e){return new(e||$)},$.\u0275mod=he({type:$}),$.\u0275inj=_e({imports:[Te.forChild(mn),Te]});var Ie=$;var U=class U{};U.\u0275fac=function(e){return new(e||U)},U.\u0275mod=he({type:U}),U.\u0275inj=_e({imports:[Le,Ye,Ie]});var ct=U;export{ct as DocentesModule};
